

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="BingoBingo一、前端初始化【1】 Node.js的安装Node.js是一个服务端语言，它的语法和JavaScript类似，所以可以说它是属于前端的后端语言，后端语言和前端语言的区别：  运行环境：后端语言一般运行在服务器端，前端语言运行在客户端的浏览器上  功能：后端语言可以操作文件，可以读写数据库，前端语言不能操作文件，不能读写数据库。 我们一般安装LTS(长线支持版本)： 下载地址：h">
<meta property="og:type" content="article">
<meta property="og:title" content="Bingo">
<meta property="og:url" content="http://example.com/2024/01/26/Bingo/index.html">
<meta property="og:site_name" content="淡淡的说">
<meta property="og:description" content="BingoBingo一、前端初始化【1】 Node.js的安装Node.js是一个服务端语言，它的语法和JavaScript类似，所以可以说它是属于前端的后端语言，后端语言和前端语言的区别：  运行环境：后端语言一般运行在服务器端，前端语言运行在客户端的浏览器上  功能：后端语言可以操作文件，可以读写数据库，前端语言不能操作文件，不能读写数据库。 我们一般安装LTS(长线支持版本)： 下载地址：h">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230319154804003.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809144120246.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809144632604-1563593.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/1625305034687-1563796.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809152937230-1566178.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809170114165-1571675.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809170340889-1571822.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809173707907-1573828-1574000.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809174530483.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230809174654313-1574415.png">
<meta property="og:image" content="http://example.com/pages_images/image-20210421131905290.png">
<meta property="og:image" content="http://example.com/pages_images/image-20210421132219232.png">
<meta property="og:image" content="http://example.com/pages_images/image-20210421132332339.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230808120421012-1467462.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230810115828508-1639909.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230902215057047-3662658.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230810114550550-1639151.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230903081526657-3700128.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230903082116327-3700477.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230903135521988-3720523.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20221217225956923-5475165.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910075648592-4303811.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910075737013-4303858.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910075834197-4303915.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080028512-4304029.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080007204-4304008.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080059356-4304060.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080131346-4304093.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080156304.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080204521-4304126.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080215038-4304136.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080226670-4304148.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910080239800-4304161.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910081413677-4304855.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910081425482-4304866.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910081644136-4305005.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910081622738-4304985.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910081722160.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230916172514218-4856315.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910081758234.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910081811850.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910082059006.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910082121387.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910082138205-4305300.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230910082208783.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230108152017505-8013031.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230108160337125-8013031.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230108160556610-8013031.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230109102502280-8013031.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230109111857349-8013031.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20230109111921050-8013031.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20231006153615310-6577777.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20231006153845387-6577926.png">
<meta property="og:image" content="http://example.com/pages_images/Bingo/image-20231006154047978-6578049.png">
<meta property="article:published_time" content="2024-01-25T20:47:49.000Z">
<meta property="article:modified_time" content="2024-03-29T10:02:17.819Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/pages_images/Bingo/image-20230319154804003.png">
  
  
  
  <title>Bingo - 淡淡的说</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>kunkun</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Bingo"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-01-26 04:47" pubdate>
          2024年1月26日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          51k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          423 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Bingo</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Bingo"><a href="#Bingo" class="headerlink" title="Bingo"></a>Bingo</h1><h1 id="Bingo-1"><a href="#Bingo-1" class="headerlink" title="Bingo"></a>Bingo</h1><h1 id="一、前端初始化"><a href="#一、前端初始化" class="headerlink" title="一、前端初始化"></a>一、前端初始化</h1><h2 id="【1】-Node-js的安装"><a href="#【1】-Node-js的安装" class="headerlink" title="【1】 Node.js的安装"></a>【1】 Node.js的安装</h2><p>Node.js是一个服务端语言，它的语法和JavaScript类似，所以可以说它是属于前端的后端语言，后端语言和前端语言的区别：</p>
<ul>
<li><p>运行环境：后端语言一般运行在服务器端，前端语言运行在客户端的浏览器上</p>
</li>
<li><p>功能：后端语言可以操作文件，可以读写数据库，前端语言不能操作文件，不能读写数据库。</p>
<p>我们一般安装LTS(长线支持版本)：</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://nodejs.org/en/download/%E3%80%90%E4%B8%8A%E9%9D%A2%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E4%BA%86nvm%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%99%E9%87%8C%E4%B8%8D%E7%94%A8%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85%E4%BA%86%E3%80%91">https://nodejs.org/en/download/【上面已经安装了nvm，那么这里不用手动安装了】</a></p>
<p>下载之后双击安装，一路点击下一步就可以了。</p>
</li>
</ul>
<p>node.js的版本有两大分支：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">官方发布的node.js版本：<span class="hljs-number">0</span><span class="hljs-selector-class">.xx</span><span class="hljs-selector-class">.xx</span> 这种版本号就是官方发布的版本<br>社区发布的node.js版本：xx<span class="hljs-selector-class">.xx</span><span class="hljs-selector-class">.x</span>  就是社区开发的版本<br></code></pre></td></tr></table></figure>

<p>Node.js如果安装成功，可以查看Node.js的版本,在终端输入如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">node -v<br>npm  -v   <span class="hljs-comment"># pip</span><br></code></pre></td></tr></table></figure>

<p>在安装node.js完成后，在node.js中会同时帮我们安装一个包管理器npm。我们可以借助npm命令来安装node.js的第三方包。这个工具相当于python的pip管理器，php的composer，go语言的go get，java的maven。</p>
<h2 id="【2】vite创建项目"><a href="#【2】vite创建项目" class="headerlink" title="【2】vite创建项目"></a>【2】vite创建项目</h2><h3 id="2-1、项目搭建"><a href="#2-1、项目搭建" class="headerlink" title="2.1、项目搭建"></a>2.1、项目搭建</h3><p>使用vue自动化工具可以快速搭建单页应用项目目录，vite为现代化的前端开发工作流提供了开箱即用的构建配置。所以我们只需要几分钟即可创建并启动一个带热重载、保存时静态检查以及可用于生产环境的构建配置的项目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span>  C:\Users\Administrator\Desktop\bingo<br>yarn create vite<br><br><span class="hljs-comment"># ？Project name: › bingo_web</span><br><span class="hljs-comment"># ? Select a framework: › - Use arrow-keys. Return to submit.</span><br><span class="hljs-comment"># Vue</span><br><span class="hljs-comment"># ? Select a variant: › - Use arrow-keys. Return to submit.</span><br><span class="hljs-comment"># JavaScript</span><br><span class="hljs-built_in">cd</span> bingo_web<br>yarn &amp;&amp; yarn dev<br></code></pre></td></tr></table></figure>

<p>执行上面命令最终效果如下：</p>
<p><img src="/pages_images/Bingo/image-20230319154804003.png" srcset="/img/loading.gif" lazyload alt="image-20230319154804003"></p>
<p>那么访问一下命令执行完成后提示出来的网址就可以看到网站了：<a target="_blank" rel="noopener" href="http://localhost:5173/">http://localhost:5173/</a></p>
<p><img src="/pages_images/Bingo/image-20230809144120246.png" srcset="/img/loading.gif" lazyload alt="image-20230809144120246"></p>
<p>基于goland设置启动项目按钮</p>
<p><img src="/pages_images/Bingo/image-20230809144632604-1563593.png" srcset="/img/loading.gif" lazyload alt="image-20230809144632604"></p>
<h3 id="2-2、项目目录结构介绍"><a href="#2-2、项目目录结构介绍" class="headerlink" title="2.2、项目目录结构介绍"></a>2.2、项目目录结构介绍</h3><p>项目创建完成之后，我们会看到bingo_web项目其实是一个文件夹，我们进入到文件夹内部就会发现一些目录和文件，我们简单回顾一下里面的部分核心目录与文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">├─node_modules/   <span class="hljs-comment"># node的包目录，项目运行的依赖包存储目录，package.json和package-lock.json文件中会自动记录了这个目录下所有的包以及包的版本信息，</span><br>├─public/  <span class="hljs-comment"># 静态资源目录，项目中的静态资源(css，js，图片等文件)放在这个文件夹</span><br>├─src/       <span class="hljs-comment"># 主开发目录，要开发的客户端代码文件（单文件组件，css样式、工具函数等等）全部在这个目录下</span><br>    ├─assets/  <span class="hljs-comment"># 静态资源存储目录，与public目录作用类似。</span><br>    ├─router/  <span class="hljs-comment"># 路由存储目录，是我们创建项目的时候，如果选择安装vue-router，就自动会生成这个目录。</span><br>    ├─views/   <span class="hljs-comment"># 组件页面存储目录，就是浏览器中用户看到的页面内容，views往往会加载并包含components中的组件进来</span><br>    ├─components/  <span class="hljs-comment"># 组件存储目录，就是浏览器中用户看到的页面的一部分内容。</span><br>    ├─App.vue<br>    ├─main.js<br>    └─style.css<br>├─index.html<br>└─package.json   <span class="hljs-comment">#  如果node_modules没有，但是有package.json，则可以在终端下，通过npm install进行恢复node_modules所有内容。</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3、项目执行流程图"><a href="#2-3、项目执行流程图" class="headerlink" title="2.3、项目执行流程图"></a>2.3、项目执行流程图</h3><p><img src="/pages_images/Bingo/1625305034687-1563796.png" srcset="/img/loading.gif" lazyload alt="1625305034687"></p>
<h3 id="2-4、-css样式清除"><a href="#2-4、-css样式清除" class="headerlink" title="2.4、 css样式清除"></a>2.4、 css样式清除</h3><p>清空src&#x2F;App.vue的代码内容，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br><br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br><br>&lt;/script&gt;<br><br>&lt;style&gt;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>清空src&#x2F;style.css的样式内容，并根据<code>https://github.com/necolas/normalize.css</code>，补充css样式初始化代码。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */</span><br><br><span class="hljs-comment">/* Document</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Correct the line height in all browsers.</span><br><span class="hljs-comment"> * 2. Prevent adjustments of font size after orientation changes in iOS.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">html</span> &#123;<br>  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.15</span>; <span class="hljs-comment">/* 1 */</span><br>  -webkit-text-size-adjust: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/* Sections</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the margin in all browsers.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">body</span> &#123;<br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Render the `main` element consistently in IE.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">main</span> &#123;<br>  <span class="hljs-attribute">display</span>: block;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Correct the font size and margin on `h1` elements within `section` and</span><br><span class="hljs-comment"> * `article` contexts in Chrome, Firefox, and Safari.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">h1</span> &#123;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2em</span>;<br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0.67em</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* Grouping content</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Add the correct box sizing in Firefox.</span><br><span class="hljs-comment"> * 2. Show the overflow in Edge and IE.</span><br><span class="hljs-comment"> */</span><br><br>hr &#123;<br>  <span class="hljs-attribute">box-sizing</span>: content-box; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">overflow</span>: visible; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Correct the inheritance and scaling of font size in all browsers.</span><br><span class="hljs-comment"> * 2. Correct the odd `em` font sizing in all browsers.</span><br><span class="hljs-comment"> */</span><br><br>pre &#123;<br>  <span class="hljs-attribute">font-family</span>: monospace, monospace; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1em</span>; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/* Text-level semantics</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the gray background on active links in IE 10.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">a</span> &#123;<br>  <span class="hljs-attribute">background-color</span>: transparent;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Remove the bottom border in Chrome 57-</span><br><span class="hljs-comment"> * 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">abbr</span><span class="hljs-selector-attr">[title]</span> &#123;<br>  <span class="hljs-attribute">border-bottom</span>: none; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">text-decoration</span>: underline; <span class="hljs-comment">/* 2 */</span><br>  <span class="hljs-attribute">text-decoration</span>: underline dotted; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Add the correct font weight in Chrome, Edge, and Safari.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">b</span>,<br><span class="hljs-selector-tag">strong</span> &#123;<br>  <span class="hljs-attribute">font-weight</span>: bolder;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Correct the inheritance and scaling of font size in all browsers.</span><br><span class="hljs-comment"> * 2. Correct the odd `em` font sizing in all browsers.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">code</span>,<br><span class="hljs-selector-tag">kbd</span>,<br><span class="hljs-selector-tag">samp</span> &#123;<br>  <span class="hljs-attribute">font-family</span>: monospace, monospace; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1em</span>; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Add the correct font size in all browsers.</span><br><span class="hljs-comment"> */</span><br><br>small &#123;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">80%</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Prevent `sub` and `sup` elements from affecting the line height in</span><br><span class="hljs-comment"> * all browsers.</span><br><span class="hljs-comment"> */</span><br><br>sub,<br><span class="hljs-selector-tag">sup</span> &#123;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">75%</span>;<br>  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">0</span>;<br>  <span class="hljs-attribute">position</span>: relative;<br>  <span class="hljs-attribute">vertical-align</span>: baseline;<br>&#125;<br><br>sub &#123;<br>  <span class="hljs-attribute">bottom</span>: -<span class="hljs-number">0.25em</span>;<br>&#125;<br><br><span class="hljs-selector-tag">sup</span> &#123;<br>  <span class="hljs-attribute">top</span>: -<span class="hljs-number">0.5em</span>;<br>&#125;<br><br><span class="hljs-comment">/* Embedded content</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the border on images inside links in IE 10.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">img</span> &#123;<br>  <span class="hljs-attribute">border-style</span>: none;<br>&#125;<br><br><span class="hljs-comment">/* Forms</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Change the font styles in all browsers.</span><br><span class="hljs-comment"> * 2. Remove the margin in Firefox and Safari.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">button</span>,<br><span class="hljs-selector-tag">input</span>,<br>optgroup,<br>select,<br><span class="hljs-selector-tag">textarea</span> &#123;<br>  <span class="hljs-attribute">font-family</span>: inherit; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.15</span>; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Show the overflow in IE.</span><br><span class="hljs-comment"> * 1. Show the overflow in Edge.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">button</span>,<br><span class="hljs-selector-tag">input</span> &#123; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">overflow</span>: visible;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the inheritance of text transform in Edge, Firefox, and IE.</span><br><span class="hljs-comment"> * 1. Remove the inheritance of text transform in Firefox.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">button</span>,<br>select &#123; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">text-transform</span>: none;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Correct the inability to style clickable types in iOS and Safari.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">button</span>,<br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;button&quot;</span>]</span>,<br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;reset&quot;</span>]</span>,<br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;submit&quot;</span>]</span> &#123;<br>  -webkit-appearance: button;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the inner border and padding in Firefox.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">button</span>::-moz-focus-inner,<br>[type=<span class="hljs-string">&quot;button&quot;</span>]::-moz-focus-inner,<br>[type=<span class="hljs-string">&quot;reset&quot;</span>]::-moz-focus-inner,<br>[type=<span class="hljs-string">&quot;submit&quot;</span>]::-moz-focus-inner &#123;<br>  <span class="hljs-attribute">border-style</span>: none;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Restore the focus styles unset by the previous rule.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">button</span>:-moz-focusring,<br>[type=<span class="hljs-string">&quot;button&quot;</span>]:-moz-focusring,<br>[type=<span class="hljs-string">&quot;reset&quot;</span>]:-moz-focusring,<br>[type=<span class="hljs-string">&quot;submit&quot;</span>]:-moz-focusring &#123;<br>  <span class="hljs-attribute">outline</span>: <span class="hljs-number">1px</span> dotted ButtonText;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Correct the padding in Firefox.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">fieldset</span> &#123;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.35em</span> <span class="hljs-number">0.75em</span> <span class="hljs-number">0.625em</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Correct the text wrapping in Edge and IE.</span><br><span class="hljs-comment"> * 2. Correct the color inheritance from `fieldset` elements in IE.</span><br><span class="hljs-comment"> * 3. Remove the padding so developers are not caught out when they zero out</span><br><span class="hljs-comment"> *    `fieldset` elements in all browsers.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">legend</span> &#123;<br>  <span class="hljs-attribute">box-sizing</span>: border-box; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">color</span>: inherit; <span class="hljs-comment">/* 2 */</span><br>  <span class="hljs-attribute">display</span>: table; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 3 */</span><br>  <span class="hljs-attribute">white-space</span>: normal; <span class="hljs-comment">/* 1 */</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Add the correct vertical alignment in Chrome, Firefox, and Opera.</span><br><span class="hljs-comment"> */</span><br><br>progress &#123;<br>  <span class="hljs-attribute">vertical-align</span>: baseline;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the default vertical scrollbar in IE 10+.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">textarea</span> &#123;<br>  <span class="hljs-attribute">overflow</span>: auto;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Add the correct box sizing in IE 10.</span><br><span class="hljs-comment"> * 2. Remove the padding in IE 10.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;checkbox&quot;</span>]</span>,<br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;radio&quot;</span>]</span> &#123;<br>  <span class="hljs-attribute">box-sizing</span>: border-box; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Correct the cursor style of increment and decrement buttons in Chrome.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;number&quot;</span>]</span>::-webkit-inner-spin-button,<br>[type=<span class="hljs-string">&quot;number&quot;</span>]::-webkit-outer-spin-button &#123;<br>  <span class="hljs-attribute">height</span>: auto;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Correct the odd appearance in Chrome and Safari.</span><br><span class="hljs-comment"> * 2. Correct the outline style in Safari.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;search&quot;</span>]</span> &#123;<br>  -webkit-appearance: textfield; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">outline-offset</span>: -<span class="hljs-number">2px</span>; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the inner padding in Chrome and Safari on macOS.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-attr">[type=<span class="hljs-string">&quot;search&quot;</span>]</span>::-webkit-search-decoration &#123;<br>  -webkit-appearance: none;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1. Correct the inability to style clickable types in iOS and Safari.</span><br><span class="hljs-comment"> * 2. Change font properties to `inherit` in Safari.</span><br><span class="hljs-comment"> */</span><br><br>::-webkit-file-upload-button &#123;<br>  -webkit-appearance: button; <span class="hljs-comment">/* 1 */</span><br>  <span class="hljs-attribute">font</span>: inherit; <span class="hljs-comment">/* 2 */</span><br>&#125;<br><br><span class="hljs-comment">/* Interactive</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Add the correct display in Edge, IE 10+, and Firefox.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">details</span> &#123;<br>  <span class="hljs-attribute">display</span>: block;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Add the correct display in all browsers.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-tag">summary</span> &#123;<br>  <span class="hljs-attribute">display</span>: list-item;<br>&#125;<br><br><span class="hljs-comment">/* Misc</span><br><span class="hljs-comment">   ========================================================================== */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Add the correct display in IE 10+.</span><br><span class="hljs-comment"> */</span><br><br>template &#123;<br>  <span class="hljs-attribute">display</span>: none;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Add the correct display in IE 10.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-selector-attr">[hidden]</span> &#123;<br>  <span class="hljs-attribute">display</span>: none;<br>&#125;<br><br><span class="hljs-comment">/* 声明全局样式和项目的初始化样式 */</span><br><span class="hljs-selector-tag">body</span>,<span class="hljs-selector-tag">h1</span>,<span class="hljs-selector-tag">h2</span>,<span class="hljs-selector-tag">h3</span>,<span class="hljs-selector-tag">h4</span>,<span class="hljs-selector-tag">p</span>,<span class="hljs-selector-tag">table</span>,<span class="hljs-selector-tag">tr</span>,<span class="hljs-selector-tag">td</span>,<span class="hljs-selector-tag">ul</span>,<span class="hljs-selector-tag">li</span>,<span class="hljs-selector-tag">a</span>,<span class="hljs-selector-tag">form</span>,<span class="hljs-selector-tag">input</span>,select,option,<span class="hljs-selector-tag">textarea</span>&#123;<br>  <span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">15px</span>;<br>&#125;<br><span class="hljs-selector-tag">a</span>&#123;<br>  <span class="hljs-attribute">text-decoration</span>: none;<br>  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;<br>  <span class="hljs-attribute">cursor</span>: pointer;<br>&#125;<br><span class="hljs-selector-tag">ul</span>,<span class="hljs-selector-tag">li</span>&#123;<br>  <span class="hljs-attribute">list-style</span>: none;<br>&#125;<br><span class="hljs-selector-tag">table</span>&#123;<br>  <span class="hljs-attribute">border-collapse</span>: collapse; <span class="hljs-comment">/* 合并边框 */</span><br>&#125;<br><span class="hljs-selector-tag">img</span>&#123;<br>  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">100%</span>;<br>  <span class="hljs-attribute">max-height</span>: <span class="hljs-number">100%</span>;<br>&#125;<br><span class="hljs-selector-tag">input</span>&#123;<br>  <span class="hljs-attribute">outline</span>: none;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="2-5、主页面板组件"><a href="#2-5、主页面板组件" class="headerlink" title="2.5、主页面板组件"></a>2.5、主页面板组件</h3><p>终端下安装router路由模块，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> bingo_web  <span class="hljs-comment"># 注意，客户端安装模块的所有命令，务必在package.json所在目录下操作。</span><br>yarn add vue-router@4.0.13   --registry https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure>

<p><code>src/router/index.js</code>，路由对象初始化，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><br><span class="hljs-keyword">const</span> routes = [<br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;bingo&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/bingo.vue&quot;</span>)&#125;,  <span class="hljs-comment">// 主页面板</span><br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),<br>  routes<br>&#125;);<br><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure>

<p><code>src/main.js</code>，加载路由对象，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createApp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./style.css&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./App.vue&#x27;</span><br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><br><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br><br></code></pre></td></tr></table></figure>

<p><code>src/App.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;router-view/&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>src目录下创建views页面组件目录并新建bingo.vue组件，<code>src/views/Bingo.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>&lt;h3&gt;Bingo主页面板&lt;/h3&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  name: &quot;Bingo&quot;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://localhost:5173/">http://localhost:5173/</a> 就看到了我们的主页面板页面。</p>
<p><img src="/pages_images/Bingo/image-20230809152937230-1566178.png" srcset="/img/loading.gif" lazyload alt="image-20230809152937230"></p>
<h2 id="【3】ant-design插件"><a href="#【3】ant-design插件" class="headerlink" title="【3】ant-design插件"></a>【3】ant-design插件</h2><h3 id="3-1、Antd组件库"><a href="#3-1、Antd组件库" class="headerlink" title="3.1、Antd组件库"></a>3.1、Antd组件库</h3><p>Ant Design是蚂蚁金服出品基于 React 实现的一套组件库开源框架，最早是在2015年发布的，可以说是目前国内使用率最高的UI组件库，在国际上也有很大的知名度。我们现在学习的是vue框架，官方已经开源出了一套ant-design for vue版本。</p>
<p>Ant Design 官方介绍： “在中台产品的研发过程中，会出现不同的设计规范和实现方式，但其中往往存在很多类似的页面和组件，给设计师和工程师带来很多困扰和重复建设，大大降低了产品的研发效率。”</p>
<p>特点：</p>
<ul>
<li>专为Web应用程序设计的企业级UI。</li>
<li>开箱即用的一组高质量组件。</li>
<li>用具有可预测的静态类型的TypeScript编写。</li>
<li>整套设计资源和开发工具。</li>
<li>支持数十种语言的国际化。</li>
<li>强大的主题自定义细节。</li>
</ul>
<p>常用网址：</p>
<p>Ant Design for React 官网：<a target="_blank" rel="noopener" href="https://ant.design/">https://ant.design/</a> </p>
<p>Ant Design of Vue 官网地址：<a target="_blank" rel="noopener" href="https://www.antdv.com/components/overview-cn/">https://www.antdv.com/components/overview-cn/</a></p>
<h4 id="2-2-1-安装使用"><a href="#2-2-1-安装使用" class="headerlink" title="2.2.1 安装使用"></a>2.2.1 安装使用</h4><p>终端下安装antd组件库，文档：<a target="_blank" rel="noopener" href="https://next.antdv.com/docs/vue/getting-started-cn">https://next.antdv.com/docs/vue/getting-started-cn</a></p>
<p>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> bingo_web  <span class="hljs-comment"># 注意，客户端安装模块的所有命令，务必在package.json所在目录下操作。</span><br>yarn add ant-design-vue@next  --registry https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure>

<p>在<code>src/main.js</code>文件中引入Antd框架。代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createApp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./style.css&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./App.vue&#x27;</span><br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Antd</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;ant-design-vue&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;ant-design-vue/dist/antd.css&#x27;</span>; <span class="hljs-comment">// 在新版本的Antd中，已经被踢出，如果提示css无法加载导致出错，则删除掉这行代码</span><br><br><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Antd</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br><br></code></pre></td></tr></table></figure>

<p>下面我们在<code>src/views/Bingo.vue</code>页面组件中引入一个ant-design的button按钮，查看是否成功安装并引入。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://next.antdv.com/components/button-cn">https://next.antdv.com/components/button-cn</a></p>
<p>代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;站点首页&lt;/div&gt;<br>  &lt;a-button type=&quot;primary&quot;&gt;Primary Button&lt;/a-button&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>/* 子组件中所有的css样式，都应该是局部的，只作用于当前组件，所以需要设置scoped属性 */<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-图表组件"><a href="#2-2-2-图表组件" class="headerlink" title="2.2.2 图表组件"></a>2.2.2 图表组件</h4><p>作为一个运维项目，很多时候需要基于图表可视化展示服务器相关数据，所以我们还需要借助图表开源插件，比如echarts和Highcharts，我们本次采用的是百度开源的echarts。</p>
<p>Echarts官方：<a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html">https://echarts.apache.org/zh/index.html</a></p>
<p>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> bingo_web  <span class="hljs-comment"># 注意，客户端安装模块的所有命令，务必在package.json所在目录下操作。</span><br>yarn add echarts   --registry https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure>

<p>安装完成以后，直接可以在<code>src/views/Bingo.vue</code>页面组件中进行使用Echarts基本示例查看效果，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;站点首页&lt;/div&gt;<br>  &lt;a-button type=&quot;primary&quot;&gt;Primary Button&lt;/a-button&gt;<br>  &lt;div class=&quot;chart&quot; ref=&quot;chart&quot;&gt;&lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;onMounted, ref&#125; from &#x27;vue&#x27;;<br>import * as echarts from &#x27;echarts&#x27;;<br><br>const chart = ref();<br>const option = &#123;<br>  title: &#123;<br>    text: &#x27;Referer of a Website&#x27;,<br>    subtext: &#x27;Fake Data&#x27;,<br>    left: &#x27;center&#x27;<br>  &#125;,<br>  tooltip: &#123;<br>    trigger: &#x27;item&#x27;<br>  &#125;,<br>  legend: &#123;<br>    orient: &#x27;vertical&#x27;,<br>    left: &#x27;left&#x27;<br>  &#125;,<br>  series: [<br>    &#123;<br>      name: &#x27;Access From&#x27;,<br>      type: &#x27;pie&#x27;,<br>      radius: &#x27;50%&#x27;,<br>      data: [<br>        &#123;value: 1048, name: &#x27;Search Engine&#x27;&#125;,<br>        &#123;value: 735, name: &#x27;Direct&#x27;&#125;,<br>        &#123;value: 580, name: &#x27;Email&#x27;&#125;,<br>        &#123;value: 484, name: &#x27;Union Ads&#x27;&#125;,<br>        &#123;value: 300, name: &#x27;Video Ads&#x27;&#125;<br>      ],<br>      emphasis: &#123;<br>        itemStyle: &#123;<br>          shadowBlur: 10,<br>          shadowOffsetX: 0,<br>          shadowColor: &#x27;rgba(0, 0, 0, 0.5)&#x27;<br>        &#125;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;;<br>onMounted(() =&gt; &#123;<br><br>  console.log(&quot;:::&quot;, chart.value)<br>  let myChart = echarts.init(chart.value);<br>  myChart.setOption(option);<br>&#125;)<br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>/* 子组件中所有的css样式，都应该是局部的，只作用于当前组件，所以需要设置scoped属性 */<br>.chart &#123;<br>  width: 500px;<br>  height: 500px;<br>  float: left;<br>  margin: 0 auto 0 100px;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>等待项目重启，查看浏览器效果如下：</p>
<p><img src="/pages_images/Bingo/image-20230809170114165-1571675.png" srcset="/img/loading.gif" lazyload alt="image-20230809170114165"></p>
<h3 id="3-2、页面展示"><a href="#3-2、页面展示" class="headerlink" title="3.2、页面展示"></a>3.2、页面展示</h3><h4 id="3-2-1-首页面板"><a href="#3-2-1-首页面板" class="headerlink" title="3.2.1 首页面板"></a>3.2.1 首页面板</h4><p>上面的主页面板代码太乱了，我们换个面板，让使用者清晰整个站点的重要数据。因为涉及到部分图标的展示，所以我们安装下Antd的图标组件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> bingo_web  <span class="hljs-comment"># 注意，客户端安装模块的所有命令，务必在package.json所在目录下操作。</span><br>yarn add @ant-design/icons-vue --registry https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure>

<p><code>src/views/Bingo.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;a-row class=&quot;top&quot;&gt;<br>    &lt;a-col class=&quot;item&quot; :span=&quot;6&quot;&gt;<br>      &lt;div class=&quot;item-box&quot;&gt;<br>        &lt;usergroup-add-outlined class=&quot;icon-style&quot; /&gt;<br>        &lt;p&gt;用户管理&lt;/p&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>    &lt;a-col class=&quot;item&quot; :span=&quot;6&quot;&gt;<br>      &lt;div class=&quot;item-box&quot;&gt;<br>        &lt;fund-outlined class=&quot;icon-style&quot; /&gt;<br>        &lt;p&gt;资产管理&lt;/p&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>    &lt;a-col class=&quot;item&quot; :span=&quot;6&quot;&gt;<br>      &lt;div class=&quot;item-box&quot;&gt;<br>        &lt;clock-circle-outlined class=&quot;icon-style&quot; /&gt;<br>        &lt;p&gt;任务中心&lt;/p&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>    &lt;a-col class=&quot;item&quot; :span=&quot;6&quot;&gt;<br>      &lt;div class=&quot;item-box&quot;&gt;<br>        &lt;alert-outlined class=&quot;icon-style&quot; /&gt;<br>        &lt;p&gt;告警通知&lt;/p&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>  &lt;/a-row&gt;<br>  &lt;!-- 预警图表与主机信息图表 --&gt;<br>  &lt;a-row class=&quot;data-list&quot;&gt;<br>    &lt;a-col :span=&quot;12&quot; class=&quot;item&quot;&gt;<br>      &lt;div class=&quot;item-box&quot;&gt;<br>        &lt;div class=&quot;alert-chart&quot; ref=&quot;alert&quot;&gt;&lt;/div&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>    &lt;a-col :span=&quot;12&quot; class=&quot;item&quot;&gt;<br>      &lt;div class=&quot;item-box&quot;&gt;<br>        &lt;div class=&quot;host-chart&quot; ref=&quot;host&quot;&gt;&lt;/div&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>    &lt;a-col :span=&quot;14&quot; class=&quot;task-data item&quot;&gt;<br>      &lt;div class=&quot;item-box&quot;&gt;<br>        &lt;a-table :columns=&quot;taskColumns&quot; :data-source=&quot;taskData&quot; :pagination=&quot;false&quot;&gt;<br>          &lt;template #headerCell=&quot;&#123; column &#125;&quot;&gt;<br>            &lt;template v-if=&quot;column.key === &#x27;title&#x27;&quot;&gt;<br>              &lt;span&gt;<br>                &lt;clock-circle-outlined /&gt;<br>                &#123;&#123;column.title&#125;&#125;<br>              &lt;/span&gt;<br>            &lt;/template&gt;<br>          &lt;/template&gt;<br><br>          &lt;template #bodyCell=&quot;&#123; column, record &#125;&quot;&gt;<br>            &lt;template v-if=&quot;column.key === &#x27;user&#x27;&quot;&gt;<br>              &lt;a&gt;<br>                &#123;&#123; record.user &#125;&#125;<br>              &lt;/a&gt;<br>            &lt;/template&gt;<br>            &lt;template v-else-if=&quot;column.key === &#x27;status&#x27;&quot;&gt;<br>              &lt;a-tag :color=&quot;[&#x27;blue&#x27;,&#x27;green&#x27;,&#x27;orange&#x27;,&#x27;red&#x27;][record.status]&quot;&gt;<br>                &#123;&#123;[&#x27;暂停&#x27;, &#x27;运行&#x27;, &#x27;警告&#x27;,&#x27;错误&#x27;][record.status]&#125;&#125;<br>              &lt;/a-tag&gt;<br>            &lt;/template&gt;<br>          &lt;/template&gt;<br>        &lt;/a-table&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>    &lt;a-col :span=&quot;8&quot; class=&quot;item&quot;&gt;<br>      &lt;div class=&quot;item-box timeline&quot;&gt;<br>          &lt;a-timeline&gt;<br>            &lt;a-timeline-item&gt;2015-09-01 08:03:23 王晓君登陆&lt;/a-timeline-item&gt;<br>            &lt;a-timeline-item&gt;2015-09-01 09:30:01 赵川登陆&lt;/a-timeline-item&gt;<br>            &lt;a-timeline-item&gt;2015-09-01 09:59:41 赵川登陆&lt;/a-timeline-item&gt;<br>            &lt;a-timeline-item&gt;2015-09-01 15:03:06 王晓君登陆&lt;/a-timeline-item&gt;<br>          &lt;/a-timeline&gt;<br>      &lt;/div&gt;<br>    &lt;/a-col&gt;<br>  &lt;/a-row&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;UsergroupAddOutlined, FundOutlined,ClockCircleOutlined, AlertOutlined, SmileOutlined, DownOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import &#123; ref, onMounted &#125; from &#x27;vue&#x27;;<br>import * as echarts from &#x27;echarts&#x27;;<br>import &#123;AlertChartOption, HostChartOption&#125; from &quot;../charts/bingo.js&quot;;<br><br>// 预警图表<br>const alert = ref()<br>// 主机图表<br>const host = ref()<br><br>onMounted(()=&gt;&#123;<br>  echarts.init(alert.value).setOption(AlertChartOption);<br>  echarts.init(host.value).setOption(HostChartOption);<br>&#125;)<br><br>const taskColumns = [&#123;<br>  title: &#x27;任务ID&#x27;,<br>  dataIndex: &#x27;id&#x27;,<br>  key: &#x27;id&#x27;,<br>&#125;, &#123;<br>  title: &#x27;任务名&#x27;,<br>  dataIndex: &#x27;title&#x27;,<br>  key: &#x27;title&#x27;,<br>&#125;, &#123;<br>  title: &#x27;用户&#x27;,<br>  dataIndex: &#x27;user&#x27;,<br>  key: &#x27;user&#x27;,<br>&#125;, &#123;<br>  title: &#x27;Status&#x27;,<br>  dataIndex: &#x27;status&#x27;,<br>  key: &#x27;status&#x27;,<br>&#125;];<br><br>const taskData = [&#123;<br>  key: &#x27;1&#x27;,<br>  id: 1,<br>  title: &#x27;巡检测试服务器&#x27;,<br>  user: &#x27;王晓君&#x27;,<br>  status: 1,<br>&#125;, &#123;<br>  key: &#x27;2&#x27;,<br>  id: 2,<br>  title: &#x27;定时备份&#x27;,<br>  user: &#x27;王晓君&#x27;,<br>  status: 0,<br>&#125;, &#123;<br>  key: &#x27;3&#x27;,<br>  id: 3,<br>  title: &#x27;发布xxx项目&#x27;,<br>  user: &#x27;王晓君&#x27;,<br>  status: 2,<br>&#125;, &#123;<br>  key: &#x27;4&#x27;,<br>  id: 4,<br>  title: &#x27;xxxxxx&#x27;,<br>  user: &#x27;王晓君&#x27;,<br>  status: 3,<br>&#125;];<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>/* 子组件中所有的css样式，都应该是局部的，只作用于当前组件，所以需要设置scoped属性 */<br>.top &#123;<br>  margin: 10px 20px;<br>  box-shadow: 0 0 2px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);<br>&#125;<br>.top .item &#123;<br>  width: 60px;<br>  text-align: center;<br>  padding: 10px 0;<br>  cursor: pointer;<br>&#125;<br>.item-box&#123;<br>  border-radius: 5px;<br>  background: #fff;<br>  transition: all .5s linear;<br>&#125;<br>.top .item-box:hover&#123;<br>  background: #ff5500;<br>&#125;<br>.top .item-box:hover .icon-style&#123;<br>  color: #f0f0f0;<br>&#125;<br>.top .item-box:hover p &#123;<br>  color: #f0f0f0;<br>&#125;<br>.icon-style&#123;<br>  font-size: 32px;<br>  color: #ff5500;<br>&#125;<br>.top .item p&#123;<br>  margin-top: 10px;<br>&#125;<br>.data-list&#123;<br>  margin: 10px 20px;<br>  box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);<br>&#125;<br>.alert-chart&#123;<br>  width: 100%;<br>  height: 300px;<br>&#125;<br><br>.host-chart&#123;<br>  width: 100%;<br>  height: 300px;<br>&#125;<br>.item-box&#123;<br>  margin: 10px;<br>  padding-top: 20px;<br>  padding-bottom: 20px;<br>&#125;<br><br>.timeline&#123;<br>  padding-left: 20px;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>因为图表相关的参数代码相对比较多，而且存在复用的可能性，所以我们在src目录下创建一个charts目录，按bingo.vue的页面组件名来创建一个独立的js文件bingo.js来保存图表相关代码，<code>src/charts/bingo.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AlertChartOption</span> = &#123;<br>    <span class="hljs-attr">title</span>: &#123;<br>    <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;本周预警次数&#x27;</span>,<br>    <span class="hljs-attr">left</span>: <span class="hljs-string">&#x27;center&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">tooltip</span>: &#123;<br>    <span class="hljs-attr">trigger</span>: <span class="hljs-string">&#x27;axis&#x27;</span>,<br>    <span class="hljs-attr">axisPointer</span>: &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;shadow&#x27;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">toolbox</span>: &#123;<br>    <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">feature</span>: &#123;<br>      <span class="hljs-attr">mark</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span> &#125;,<br>      <span class="hljs-attr">dataView</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">readOnly</span>: <span class="hljs-literal">false</span> &#125;,<br>      <span class="hljs-attr">restore</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span> &#125;,<br>      <span class="hljs-attr">saveAsImage</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span> &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">grid</span>: &#123;<br>    <span class="hljs-attr">left</span>: <span class="hljs-string">&#x27;2%&#x27;</span>,<br>    <span class="hljs-attr">right</span>: <span class="hljs-string">&#x27;2%&#x27;</span>,<br>    <span class="hljs-attr">bottom</span>: <span class="hljs-string">&#x27;1%&#x27;</span>,<br>    <span class="hljs-attr">containLabel</span>: <span class="hljs-literal">true</span><br>  &#125;,<br>  <span class="hljs-attr">xAxis</span>: [<br>    &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;category&#x27;</span>,<br>      <span class="hljs-attr">data</span>: [<span class="hljs-string">&#x27;星期一&#x27;</span>, <span class="hljs-string">&#x27;星期二&#x27;</span>, <span class="hljs-string">&#x27;星期三&#x27;</span>, <span class="hljs-string">&#x27;星期四&#x27;</span>, <span class="hljs-string">&#x27;星期五&#x27;</span>, <span class="hljs-string">&#x27;星期六&#x27;</span>, <span class="hljs-string">&#x27;星期天&#x27;</span>],<br>      <span class="hljs-attr">axisTick</span>: &#123;<br>        <span class="hljs-attr">alignWithLabel</span>: <span class="hljs-literal">true</span><br>      &#125;<br>    &#125;<br>  ],<br>  <span class="hljs-attr">yAxis</span>: [<br>    &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;value&#x27;</span><br>    &#125;<br>  ],<br>  <span class="hljs-attr">series</span>: [<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;注意&#x27;</span>,<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;bar&#x27;</span>,<br>      <span class="hljs-attr">barWidth</span>: <span class="hljs-string">&#x27;10%&#x27;</span>,<br>      <span class="hljs-attr">data</span>: [<span class="hljs-number">13</span>, <span class="hljs-number">12</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">22</span>, <span class="hljs-number">20</span>, <span class="hljs-number">11</span>]<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;警告&#x27;</span>,<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;bar&#x27;</span>,<br>      <span class="hljs-attr">barWidth</span>: <span class="hljs-string">&#x27;10%&#x27;</span>,<br>      <span class="hljs-attr">data</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">11</span>, <span class="hljs-number">2</span>]<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;故障&#x27;</span>,<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;bar&#x27;</span>,<br>      <span class="hljs-attr">barWidth</span>: <span class="hljs-string">&#x27;10%&#x27;</span>,<br>      <span class="hljs-attr">data</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>]<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;严重&#x27;</span>,<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;bar&#x27;</span>,<br>      <span class="hljs-attr">barWidth</span>: <span class="hljs-string">&#x27;10%&#x27;</span>,<br>      <span class="hljs-attr">data</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<br>    &#125;<br>  ]<br>&#125;;<br><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HostChartOption</span> = &#123;<br>  <span class="hljs-attr">title</span>: &#123;<br>    <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;主机信息&#x27;</span>,<br>    <span class="hljs-attr">left</span>: <span class="hljs-string">&#x27;center&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">tooltip</span>: &#123;<br>    <span class="hljs-attr">trigger</span>: <span class="hljs-string">&#x27;item&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">toolbox</span>: &#123;<br>    <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">feature</span>: &#123;<br>      <span class="hljs-attr">mark</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span> &#125;,<br>      <span class="hljs-attr">dataView</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">readOnly</span>: <span class="hljs-literal">false</span> &#125;,<br>      <span class="hljs-attr">restore</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span> &#125;,<br>      <span class="hljs-attr">saveAsImage</span>: &#123; <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span> &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">legend</span>: &#123;<br>    <span class="hljs-attr">top</span>: <span class="hljs-string">&#x27;bottom&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">series</span>: [<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;主机信息&#x27;</span>,<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;pie&#x27;</span>,<br>      <span class="hljs-attr">radius</span>: <span class="hljs-string">&#x27;60%&#x27;</span>,<br>      <span class="hljs-attr">data</span>: [<br>        &#123; <span class="hljs-attr">value</span>: <span class="hljs-number">45</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;测试服务器&#x27;</span> &#125;,<br>        &#123; <span class="hljs-attr">value</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;web服务器&#x27;</span> &#125;,<br>        &#123; <span class="hljs-attr">value</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;代理服务器&#x27;</span> &#125;,<br>        &#123; <span class="hljs-attr">value</span>: <span class="hljs-number">14</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;数据库服务器&#x27;</span> &#125;,<br>        &#123; <span class="hljs-attr">value</span>: <span class="hljs-number">79</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;未分类&#x27;</span> &#125;<br>      ],<br>      <span class="hljs-attr">emphasis</span>: &#123;<br>        <span class="hljs-attr">itemStyle</span>: &#123;<br>          <span class="hljs-attr">shadowBlur</span>: <span class="hljs-number">10</span>,<br>          <span class="hljs-attr">shadowOffsetX</span>: <span class="hljs-number">0</span>,<br>          <span class="hljs-attr">shadowColor</span>: <span class="hljs-string">&#x27;rgba(0, 0, 0, 0.5)&#x27;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230809170340889-1571822.png" srcset="/img/loading.gif" lazyload alt="image-20230809170340889"></p>
<h4 id="3-2-2-公共页面"><a href="#3-2-2-公共页面" class="headerlink" title="3.2.2 公共页面"></a>3.2.2 公共页面</h4><p>由于除了登录页面之外我们后面所有的组件都具备顶部导航栏和左侧菜单栏的效果，所以我们可以直接将公共部分页面内容放到了一个Base.vue组件中，里面通过 ant design vue中的布局组件来组织页面排版。</p>
<p>布局组件：<a target="_blank" rel="noopener" href="https://next.antdv.com/components/layout-cn">https://next.antdv.com/components/layout-cn</a></p>
<p><code>src/views/Base.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;a-layout style=&quot;min-height: 100vh&quot;&gt;<br>    &lt;a-layout-sider v-model:collapsed=&quot;collapsed&quot; collapsible&gt;<br>      &lt;div class=&quot;logo&quot; /&gt;<br>      &lt;a-menu v-model:selectedKeys=&quot;selectedKeys&quot; theme=&quot;dark&quot; mode=&quot;inline&quot;&gt;<br>        &lt;a-menu-item key=&quot;1&quot;&gt;<br>          &lt;pie-chart-outlined /&gt;<br>          &lt;span&gt;Option 1&lt;/span&gt;<br>        &lt;/a-menu-item&gt;<br>        &lt;a-menu-item key=&quot;2&quot;&gt;<br>          &lt;desktop-outlined /&gt;<br>          &lt;span&gt;Option 2&lt;/span&gt;<br>        &lt;/a-menu-item&gt;<br>        &lt;a-sub-menu key=&quot;sub1&quot;&gt;<br>          &lt;template #title&gt;<br>            &lt;span&gt;<br>              &lt;user-outlined /&gt;<br>              &lt;span&gt;User&lt;/span&gt;<br>            &lt;/span&gt;<br>          &lt;/template&gt;<br>          &lt;a-menu-item key=&quot;3&quot;&gt;Tom&lt;/a-menu-item&gt;<br>          &lt;a-menu-item key=&quot;4&quot;&gt;Bill&lt;/a-menu-item&gt;<br>          &lt;a-menu-item key=&quot;5&quot;&gt;Alex&lt;/a-menu-item&gt;<br>        &lt;/a-sub-menu&gt;<br>        &lt;a-sub-menu key=&quot;sub2&quot;&gt;<br>          &lt;template #title&gt;<br>            &lt;span&gt;<br>              &lt;team-outlined /&gt;<br>              &lt;span&gt;Team&lt;/span&gt;<br>            &lt;/span&gt;<br>          &lt;/template&gt;<br>          &lt;a-menu-item key=&quot;6&quot;&gt;Team 1&lt;/a-menu-item&gt;<br>          &lt;a-menu-item key=&quot;8&quot;&gt;Team 2&lt;/a-menu-item&gt;<br>        &lt;/a-sub-menu&gt;<br>        &lt;a-menu-item key=&quot;9&quot;&gt;<br>          &lt;file-outlined /&gt;<br>          &lt;span&gt;File&lt;/span&gt;<br>        &lt;/a-menu-item&gt;<br>      &lt;/a-menu&gt;<br>    &lt;/a-layout-sider&gt;<br>    &lt;a-layout&gt;<br>      &lt;a-layout-header style=&quot;background: #fff; padding: 0&quot; /&gt;<br>      &lt;a-layout-content style=&quot;margin: 0 16px&quot;&gt;<br>        &lt;a-breadcrumb style=&quot;margin: 16px 0&quot;&gt;<br>          &lt;a-breadcrumb-item&gt;User&lt;/a-breadcrumb-item&gt;<br>          &lt;a-breadcrumb-item&gt;Bill&lt;/a-breadcrumb-item&gt;<br>        &lt;/a-breadcrumb&gt;<br>        &lt;div :style=&quot;&#123; padding: &#x27;24px&#x27;, background: &#x27;#fff&#x27;, minHeight: &#x27;360px&#x27; &#125;&quot;&gt;<br>          Bill is a cat.<br>        &lt;/div&gt;<br>      &lt;/a-layout-content&gt;<br>      &lt;a-layout-footer style=&quot;text-align: center&quot;&gt;<br>        Ant Design ©2018 Created by Ant UED<br>      &lt;/a-layout-footer&gt;<br>    &lt;/a-layout&gt;<br>  &lt;/a-layout&gt;<br>&lt;/template&gt;<br>&lt;script setup&gt;<br>import &#123; PieChartOutlined, DesktopOutlined, UserOutlined, TeamOutlined, FileOutlined &#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import &#123; ref &#125; from &#x27;vue&#x27;;<br><br>const collapsed = ref(false);<br>const selectedKeys = ref([&#x27;1&#x27;]);<br>&lt;/script&gt;<br><br>&lt;style&gt;<br>#components-layout-demo-side .logo &#123;<br>  height: 32px;<br>  margin: 16px;<br>  background: rgba(255, 255, 255, 0.3);<br>&#125;<br><br>.site-layout .site-layout-background &#123;<br>  background: #fff;<br>&#125;<br>[data-theme=&#x27;dark&#x27;] .site-layout .site-layout-background &#123;<br>  background: #141414;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>先注释掉原来的Bingo.vue组件的路由信息，<code>src/rouer/index.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><span class="hljs-keyword">const</span> routes = [<br>  <span class="hljs-comment">// &#123; path: &#x27;/bingo&#x27;, meta: &#123;title: &quot;主页面板&quot;&#125;, name: &#x27;bingo&#x27;, component: ()=&gt;import(&quot;../views/bingo.vue&quot;)&#125;,</span><br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/bingo&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Base&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Base.vue&quot;</span>)&#125;,<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),<br>  routes<br>&#125;);<br><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span>(to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>)&#123;<br>    <span class="hljs-comment">// 修改页面原有标题</span><br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span><br>  &#125;<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure>

<p>实现页面嵌套</p>
<p><code>src/views/Base.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;a-layout style=&quot;min-height: 100vh&quot;&gt;<br>    &lt;a-layout-sider v-model:collapsed=&quot;collapsed&quot; collapsible&gt;<br>      &lt;div class=&quot;logo&quot;&gt;<br>        &lt;span&gt;bingo&lt;/span&gt;<br>      &lt;/div&gt;<br>      &lt;a-menu v-for=&quot;menu in menu_list&quot; v-model:selectedKeys=&quot;selectedKeys&quot; theme=&quot;dark&quot; mode=&quot;inline&quot;&gt;<br>        &lt;a-menu-item v-if=&quot;menu.children.length===0&quot; :key=&quot;menu.id&quot;&gt;<br>          &lt;router-link :to=&quot;menu.menu_url&quot;&gt;<br>            &lt;desktop-outlined/&gt;<br>            &lt;span&gt; &#123;&#123; menu.title &#125;&#125;&lt;/span&gt;<br>          &lt;/router-link&gt;<br>        &lt;/a-menu-item&gt;<br>        &lt;a-sub-menu v-else :key=&quot;menu.id&quot;&gt;<br>          &lt;template #title&gt;<br>            &lt;span&gt;<br>              &lt;user-outlined/&gt;<br>              &lt;span&gt;&#123;&#123; menu.title &#125;&#125;&lt;/span&gt;<br>            &lt;/span&gt;<br>          &lt;/template&gt;<br>          &lt;a-menu-item v-for=&quot;child_menu in menu.children&quot; :key=&quot;child_menu.id&quot;&gt;<br>            &lt;router-link :to=&quot;child_menu.menu_url&quot;&gt;&#123;&#123; child_menu.title &#125;&#125;&lt;/router-link&gt;<br>          &lt;/a-menu-item&gt;<br>        &lt;/a-sub-menu&gt;<br>      &lt;/a-menu&gt;<br>    &lt;/a-layout-sider&gt;<br>    &lt;a-layout&gt;<br>      &lt;a-layout-header style=&quot;background: #fff;text-align: center&quot;&gt;<br>        &lt;a-row&gt;<br>          &lt;a-col :span=&quot;2&quot; :offset=&quot;22&quot;&gt;<br>            &lt;a-dropdown placement=&quot;bottom&quot;&gt;<br>              &lt;p class=&quot;user&quot;&gt;&lt;UserOutlined /&gt; root&lt;/p&gt;<br>              &lt;template #overlay&gt;<br>                &lt;a-menu&gt;<br>                  &lt;a-menu-item&gt;&lt;LockOutlined/&gt; 修改密码&lt;/a-menu-item&gt;<br>                  &lt;a-menu-item&gt;&lt;LogoutOutlined/&gt; 退出登陆&lt;/a-menu-item&gt;<br>                &lt;/a-menu&gt;<br>              &lt;/template&gt;<br>            &lt;/a-dropdown&gt;<br>          &lt;/a-col&gt;<br>        &lt;/a-row&gt;<br>      &lt;/a-layout-header&gt;<br>      &lt;a-layout-content style=&quot;margin: 0 16px&quot;&gt;<br>        &lt;a-breadcrumb style=&quot;margin: 16px 0&quot;&gt;<br>          &lt;a-breadcrumb-item&gt;&lt;a href=&quot;&quot;&gt;首页&lt;/a&gt;&lt;/a-breadcrumb-item&gt;<br>          &lt;a-breadcrumb-item&gt;信息面板&lt;/a-breadcrumb-item&gt;<br>        &lt;/a-breadcrumb&gt;<br>        &lt;div :style=&quot;&#123; padding: &#x27;24px&#x27;, background: &#x27;#fff&#x27;, minHeight: &#x27;550px&#x27;&#125;&quot;&gt;<br>          &lt;router-view&gt;&lt;/router-view&gt;<br>        &lt;/div&gt;<br>      &lt;/a-layout-content&gt;<br>      &lt;a-layout-footer style=&quot;text-align: center&quot;&gt;<br>        &lt;p&gt;Copyright © 2023 bingo&lt;/p&gt;<br>        Power By &lt;a href=&quot;&quot;&gt;LinMo Jiang &amp;amp; Bazinga Yuan&lt;/a&gt;<br>      &lt;/a-layout-footer&gt;<br>    &lt;/a-layout&gt;<br>  &lt;/a-layout&gt;<br>&lt;/template&gt;<br>&lt;script setup&gt;<br>import &#123; LogoutOutlined, LockOutlined, DesktopOutlined, UserOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import &#123; ref &#125; from &#x27;vue&#x27;;<br><br>const collapsed = ref(false);<br>const selectedKeys = ref([&#x27;1&#x27;]);<br><br>const menu_list = ref([<br>  &#123;<br>    id: 1, icon: &#x27;mail&#x27;, title: &#x27;信息面板&#x27;, menu_url: &#x27;/bingo/&#x27;, children: []<br>  &#125;,<br>  &#123;<br>    id: 2, icon: &#x27;mail&#x27;, title: &#x27;资产管理&#x27;, menu_url: &#x27;/bingo/manage&#x27;, children: [<br>      &#123;id: 9, icon: &#x27;mail&#x27;, title: &#x27;主机管理&#x27;, menu_url: &#x27;/bingo/manage/host&#x27;&#125;,<br>      &#123;id: 10, icon: &#x27;mail&#x27;, title: &#x27;DB管理&#x27;, menu_url: &#x27;/bingo/manage/db&#x27;&#125;,<br>      &#123;id: 11, icon: &#x27;mail&#x27;, title: &#x27;IDC机房&#x27;, menu_url: &#x27;/bingo/manage/idc&#x27;&#125;,<br>      &#123;id: 12, icon: &#x27;mail&#x27;, title: &#x27;资产配置&#x27;, menu_url: &#x27;/bingo/manage/config&#x27;&#125;,<br>    ]<br>  &#125;,<br>  &#123;<br>    &quot;id&quot;: 3, icon: &#x27;bold&#x27;, title: &#x27;作业管理&#x27;, menu_url: &#x27;/bingo/work&#x27;, children: [<br>      &#123;id: 13, icon: &#x27;mail&#x27;, title: &#x27;批量任务&#x27;, menu_url: &#x27;/bingo/work/tasks&#x27;&#125;,<br>      &#123;id: 14, icon: &#x27;mail&#x27;, title: &#x27;计划任务&#x27;, menu_url: &#x27;/bingo/work/cron&#x27;, children: []&#125;,<br>      &#123;id: 15, icon: &#x27;mail&#x27;, title: &#x27;任务模板&#x27;, menu_url: &#x27;/bingo/work/template&#x27;&#125;,<br>    ]<br>  &#125;,<br>  &#123;<br>    id: 4, icon: &#x27;highlight&#x27;, title: &#x27;代码管理&#x27;, menu_url: &#x27;/bingo/code&#x27;, children: [<br>      &#123;id: 16, icon: &#x27;mail&#x27;, title: &#x27;应用管理&#x27;, menu_url: &#x27;/bingo/code/app&#x27;&#125;,<br>      &#123;id: 17, icon: &#x27;mail&#x27;, title: &#x27;发布申请&#x27;, menu_url: &#x27;/bingo/code/release&#x27;&#125;,<br>      &#123;id: 18, icon: &#x27;mail&#x27;, title: &#x27;代码仓库&#x27;, menu_url: &#x27;/bingo/code/repo&#x27;&#125;,<br>      &#123;id: 19, icon: &#x27;mail&#x27;, title: &#x27;镜像仓库&#x27;, menu_url: &#x27;/bingo/code/image&#x27;&#125;,<br>    ]<br>  &#125;,<br>  &#123;<br>    id: 5, icon: &#x27;mail&#x27;, title: &#x27;配置管理&#x27;, menu_url: &#x27;/bingo/config&#x27;, children: [<br>      &#123;id: 20, title: &#x27;环境管理&#x27;, menu_url: &#x27;/bingo/config/env&#x27;&#125;,<br>      &#123;id: 21, title: &#x27;服务配置&#x27;, menu_url: &#x27;/bingo/config/services&#x27;&#125;,<br>      &#123;id: 22, title: &#x27;应用配置&#x27;, menu_url: &#x27;/bingo/config/app&#x27;&#125;<br>    ]<br>  &#125;,<br>  &#123;<br>    id: 6, icon: &#x27;mail&#x27;, title: &#x27;监控预警&#x27;, menu_url: &#x27;/bingo/monitor&#x27;, children: [<br>      &#123;id: 23, title: &#x27;报警历史&#x27;, menu_url: &#x27;/bingo/monitor/history&#x27;&#125;,<br>      &#123;id: 24, title: &#x27;报警联系人&#x27;, menu_url: &#x27;/bingo/monitor/user&#x27;&#125;,<br>      &#123;id: 25, title: &#x27;报警联系组&#x27;, menu_url: &#x27;/bingo/monitor/group&#x27;&#125;<br>    ]<br>  &#125;,<br>  &#123;<br>    id: 7, icon: &#x27;mail&#x27;, title: &#x27;用户管理&#x27;, menu_url: &#x27;/bingo/auth&#x27;, children: [<br>      &#123;id: 26, title: &#x27;账户管理&#x27;, menu_url: &#x27;/bingo/auth/user&#x27;&#125;,<br>      &#123;id: 27, title: &#x27;角色管理&#x27;, menu_url: &#x27;/bingo/auth/role&#x27;&#125;,<br>      &#123;id: 28, title: &#x27;权限管理&#x27;, menu_url: &#x27;/bingo/auth/permission&#x27;&#125;,<br>      &#123;id: 29, title: &#x27;菜单管理&#x27;, menu_url: &#x27;/bingo/auth/menu&#x27;&#125;,<br>    ]<br>  &#125;,<br>  &#123;<br>    id: 8, icon: &#x27;mail&#x27;, title: &#x27;系统设置&#x27;, menu_url: &#x27;/bingo/sys&#x27;, children: []<br>  &#125;,<br>])<br><br>&lt;/script&gt;<br><br>&lt;style&gt;<br>.logo &#123;<br>  font-style: italic;<br>  text-align: center;<br>  font-size: 20px;<br>  color:#fff;<br>  margin: 0 0 10px;<br>  line-height: 42px;<br>  height: 42px;<br>  background: rgba(255, 255, 255, 0.1);<br>&#125;<br>.user&#123;<br>  position: relative;<br>&#125;<br>.user:after&#123;<br>  content: &quot;&quot;;<br>  border: 4px solid transparent;<br>  border-top: 4px solid #000;<br>  position: absolute;<br>  width: 0;<br>  height: 0;<br>  top: 30px;<br>  right: 12px;<br>  margin: auto;<br>&#125;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>基于router的嵌套子路由实现页面嵌套效果，所以在上面56行代码中，我们使用了<code>&lt;router-view&gt;&lt;/router-view&gt;</code>用于提供给路由组件将来替换子模板内容，接下来，我们还需要修改下路由配置才能看到真正效果。<code>src/router/index.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><span class="hljs-keyword">const</span> routes = [<br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/bingo&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Base&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Base.vue&quot;</span>), <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;主页面板&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;bingo&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Bingo.vue&quot;</span>)&#125;,<br>    ]&#125;,<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),<br>  routes<br>&#125;);<br><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span>(to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>)&#123;<br>    <span class="hljs-comment">// 修改页面原有标题</span><br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span><br>  &#125;<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure>

<p>等待项目重启，效果如下：</p>
<p><img src="/pages_images/Bingo/image-20230809173707907-1573828-1574000.png" srcset="/img/loading.gif" lazyload alt="image-20230809173707907"></p>
<p>接下来，我们可以再次创建一个页面组件，用于将来管理公司的主机资产，<code>src/views/Host.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;host&quot;&gt;<br>    &lt;h1&gt;host页面&lt;/h1&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br><br></code></pre></td></tr></table></figure>

<p>绑定路由，<code>src/router/index.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><span class="hljs-keyword">const</span> routes = [<br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/bingo&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Base&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Base.vue&quot;</span>), <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;主页面板&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;bingo&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/bingo.vue&quot;</span>)&#125;,<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;manage/host&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;主机管理&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Host&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Host.vue&quot;</span>)&#125;,<br>    ]&#125;,<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),<br>  routes<br>&#125;);<br><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span>(to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>)&#123;<br>    <span class="hljs-comment">// 修改页面原有标题</span><br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span><br>  &#125;<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230809174530483.png" srcset="/img/loading.gif" lazyload alt="image-20230809174530483"></p>
<h4 id="3-2-3-登陆界面"><a href="#3-2-3-登陆界面" class="headerlink" title="3.2.3 登陆界面"></a>3.2.3 登陆界面</h4><p>src&#x2F;views&#x2F;Login.vue，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;login box&quot;&gt;<br>    &lt;img src=&quot;./pages_images/Bingo/login.jpg&quot; alt=&quot;&quot;&gt;<br>    &lt;div class=&quot;login&quot;&gt;<br>      &lt;div class=&quot;login-title&quot;&gt;<br>        &lt;p class=&quot;hi&quot;&gt;Hello,Bingo!&lt;/p&gt;<br>      &lt;/div&gt;<br>      &lt;div class=&quot;login_box&quot;&gt;<br>        &lt;div class=&quot;title&quot;&gt;<br>          &lt;span&gt;登录&lt;/span&gt;<br>        &lt;/div&gt;<br>        &lt;div class=&quot;inp&quot;&gt;<br>          &lt;a-input v-model:value=&quot;username&quot; type=&quot;text&quot; placeholder=&quot;用户名&quot; class=&quot;user&quot;&gt;&lt;/a-input&gt;<br>          &lt;a-input v-model:value=&quot;password&quot; type=&quot;password&quot; class=&quot;pwd&quot; placeholder=&quot;密码&quot;&gt;&lt;/a-input&gt;<br>          &lt;div class=&quot;remember&quot;&gt;<br>            &lt;a-checkbox type=&quot;checkbox&quot; v-model:checked=&quot;remember&quot;&gt;记住密码&lt;/a-checkbox&gt;<br>          &lt;/div&gt;<br>          &lt;button class=&quot;login_btn&quot; @click=&quot;login&quot;&gt;登录&lt;/button&gt;<br>        &lt;/div&gt;<br>      &lt;/div&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;ref&#125; from &quot;vue&quot;;<br><br>const username = ref(&#x27;&#x27;);<br>const password = ref(&#x27;&#x27;);<br>const remember = ref(true);<br><br>const login = () =&gt; &#123;<br><br>&#125;<br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.login.box &#123;<br>  overflow: hidden;<br>  height: 100vh;<br>&#125;<br><br>.login .hi &#123;<br>  font-size: 20px;<br>  font-style: italic;<br>&#125;<br><br>.box &#123;<br>  width: 100%;<br>  height: 100%;<br>  position: relative;<br>  overflow: hidden;<br>&#125;<br><br>.box img &#123;<br>  width: 100%;<br>  min-height: 100%;<br>&#125;<br><br>.box .login &#123;<br>  position: absolute;<br>  width: 500px;<br>  height: 400px;<br>  left: 0;<br>  margin: auto;<br>  right: 0;<br>  bottom: 0;<br>  top: -338px;<br>&#125;<br><br>.login .login-title &#123;<br>  width: 100%;<br>  text-align: center;<br>&#125;<br><br>.login-title img &#123;<br>  width: 190px;<br>  height: auto;<br>&#125;<br><br>.login-title p &#123;<br>  font-size: 18px;<br>  color: #fff;<br>  letter-spacing: .29px;<br>  padding-top: 10px;<br>  padding-bottom: 50px;<br>&#125;<br><br>.login_box &#123;<br>  width: 400px;<br>  height: auto;<br>  background: rgba(255, 255, 255, 0.3);<br>  box-shadow: 0 2px 4px 0 rgba(0, 0, 0, .5);<br>  border-radius: 4px;<br>  margin: 0 auto;<br>  padding-bottom: 40px;<br>&#125;<br><br>.login_box .title &#123;<br>  font-size: 20px;<br>  color: #9b9b9b;<br>  letter-spacing: .32px;<br>  border-bottom: 1px solid #e6e6e6;<br>  display: flex;<br>  justify-content: space-around;<br>  padding: 50px 60px 0 60px;<br>  margin-bottom: 20px;<br>  cursor: pointer;<br>&#125;<br><br>.login_box .title span:nth-of-type(1) &#123;<br>  color: #4a4a4a;<br>  border-bottom: 2px solid #396fcc;<br>&#125;<br><br>.inp &#123;<br>  width: 350px;<br>  margin: 0 auto;<br>&#125;<br><br>.inp input &#123;<br>  outline: 0;<br>  width: 100%;<br>  height: 45px;<br>  border-radius: 4px;<br>  border: 1px solid #d9d9d9;<br>  text-indent: 20px;<br>  font-size: 14px;<br>  background: #fff !important;<br>&#125;<br><br>.inp .user &#123;<br>  margin-bottom: 16px;<br>&#125;<br><br>.login_btn &#123;<br>  width: 100%;<br>  height: 45px;<br>  background: #396fcc;<br>  border-radius: 5px;<br>  font-size: 16px;<br>  color: #fff;<br>  letter-spacing: .26px;<br>  margin-top: 30px;<br>&#125;<br><br>.remember &#123;<br>  margin-top: 10px;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>登陆页面不存在菜单等公共部分页面，所以我们单独注册路由，<code>src/router/index.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><span class="hljs-keyword">const</span> routes = [<br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/bingo&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Base&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Base.vue&quot;</span>), <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;主页面板&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;bingo&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/bingo.vue&quot;</span>)&#125;,<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;manage/host&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;主机管理&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Host&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Host.vue&quot;</span>)&#125;,<br>    ]&#125;,<br><br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-attr">meta</span>: &#123;<span class="hljs-attr">title</span>: <span class="hljs-string">&quot;用户登录&quot;</span>&#125;, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Login&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Login.vue&quot;</span>)&#125;,<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),<br>  routes<br>&#125;);<br><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span>(to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>)&#123;<br>    <span class="hljs-comment">// 修改页面原有标题</span><br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span><br>  &#125;<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure>

<p>登陆界面效果如下：</p>
<p><img src="/pages_images/Bingo/image-20230809174654313-1574415.png" srcset="/img/loading.gif" lazyload alt="image-20230809174654313"></p>
<h1 id="二、后端初始化"><a href="#二、后端初始化" class="headerlink" title="二、后端初始化"></a>二、后端初始化</h1><h2 id="2-1、搭建项目"><a href="#2-1、搭建项目" class="headerlink" title="2.1、搭建项目"></a>2.1、搭建项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> bingo_api<br><span class="hljs-built_in">cd</span> bingo_api<br>go mod init bingo_api<br></code></pre></td></tr></table></figure>

<p>创建好项目之后，通过goland打开，在编辑器的配置中，切换源代理GOPROXY</p>
<p><img src="/pages_images/image-20210421131905290.png" srcset="/img/loading.gif" lazyload alt="image-20210421131905290"></p>
<p><img src="/pages_images/image-20210421132219232.png" srcset="/img/loading.gif" lazyload alt="image-20210421132219232"></p>
<p><img src="/pages_images/image-20210421132332339.png" srcset="/img/loading.gif" lazyload alt="image-20210421132332339"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">GOPROXY https://proxy.golang.org,direct<br><span class="hljs-comment"># 阿里云</span><br><span class="hljs-built_in">export</span> GOPROXY=https://mirrors.aliyun.com/goproxy/<br><span class="hljs-comment"># 七牛云</span><br><span class="hljs-built_in">export</span> GOPROXY= https://goproxy.cn<br></code></pre></td></tr></table></figure>

<p>如果没有goland的同学，可以自己买个激活码，当然也可以使用其他的编辑器。</p>
<h2 id="2-2、目录结构"><a href="#2-2、目录结构" class="headerlink" title="2.2、目录结构"></a>2.2、目录结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">└── bingo_api/<br>     ├── logs/          <span class="hljs-comment"># 项目运行时/开发时日志目录</span><br>     └── application/   <span class="hljs-comment"># 开发主应用目录</span><br>          ├── api/        <span class="hljs-comment"># 接口层目录</span><br>          ├── config/     <span class="hljs-comment"># 配置目录</span><br>          ├── constants/  <span class="hljs-comment"># 全局常量目录</span><br>          ├── initialize/ <span class="hljs-comment"># 项目初始化目录</span><br>          ├── middleware/ <span class="hljs-comment"># 中间件层目录</span><br>          ├── model/      <span class="hljs-comment"># 模型层目录</span><br>          ├── router/     <span class="hljs-comment"># 路由目录</span><br>          ├── services/   <span class="hljs-comment"># 业务层目录</span><br>          ├── utils/      <span class="hljs-comment"># 工具库目录</span><br>          ├── validator/  <span class="hljs-comment"># 验证逻辑目录</span><br>          └── main.go     <span class="hljs-comment"># 项目入口文件</span><br></code></pre></td></tr></table></figure>

<p>上面的目录结构图可以在终端下使用tree输出。如果没有安装tree，安装下就有了。</p>
<p>安装gin框架</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/gin-gonic/gin<br></code></pre></td></tr></table></figure>

<p>application&#x2F;main.go，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 1.创建路由</span><br>	router := gin.Default()<br>	<span class="hljs-comment">// 2.绑定路由规则，执行的函数</span><br>	<span class="hljs-comment">// gin.Context，封装了request和response</span><br>	router.GET(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>		<span class="hljs-comment">// panic(&amp;middleware.Api&#123;Code: http.StatusInternalServerError, Message: &quot;测试错误！&quot;&#125;)</span><br>		c.String(http.StatusOK, <span class="hljs-string">&quot;Hello Bingo!&quot;</span>)<br>	&#125;)<br>	<span class="hljs-comment">// 3.监听端口，默认在8080，因为客户端的vue已经运行占用了8080了，所以改成8000</span><br>	router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="2-3、路由初始化"><a href="#2-3、路由初始化" class="headerlink" title="2.3、路由初始化"></a>2.3、路由初始化</h2><p><code>application/main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/initialize&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 1. 路由初始化</span><br>	Router := initialize.InitRouter()<br>	<span class="hljs-comment">// 2.监听端口，默认在8080</span><br>	Router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>application/initialize/router.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouter</span><span class="hljs-params">()</span></span> *gin.Engine &#123;<br><br>	<span class="hljs-comment">// 1. 创建路由</span><br>	Router := gin.Default()<br>	<span class="hljs-comment">// 2. Api路由分组</span><br>	ApiGroup := Router.Group(<span class="hljs-string">&quot;/test&quot;</span>)<br>	ApiGroup.GET(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>		context.String(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;Bingo Start&quot;</span>)<br>	&#125;)<br><br>	<span class="hljs-keyword">return</span> Router<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-4、配置初始化"><a href="#2-4、配置初始化" class="headerlink" title="2.4、配置初始化"></a>2.4、配置初始化</h2><p>初始化配置模块，<code>application/config/config.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>)<br><br><span class="hljs-comment">// 外界go开发项目： 配置文件都是 json、yaml、ini</span><br><br><span class="hljs-comment">// Config 整个项目的配置</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;  <br>	Mode <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;mode&quot;`</span><br>  Host <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;host&quot;`</span><br>	Port <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;port&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// Conf 全局配置变量</span><br><span class="hljs-keyword">var</span> Conf = <span class="hljs-built_in">new</span>(Config)<br><br><span class="hljs-comment">// Init 初始化配置；从指定文件加载配置文件</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Init</span><span class="hljs-params">(filePath <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	filePath 配置文件json文件的路径</span><br><span class="hljs-comment">	*/</span><br>	b, err := ioutil.ReadFile(filePath)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">return</span> json.Unmarshal(b, Conf)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>准备一个配置文件，项目根目录下创建<code>config.json</code>，代码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;api.bingo.cn&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debug&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8000</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>调用配置初始化函数，<code>applicaton/main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/initialize&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;path/filepath&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 1. filepath.Dir(&quot;.&quot;) 是一个 Go 语言中的函数调用，用于获取当前目录的父目录。</span><br>	dir, err := filepath.Abs(filepath.Dir(<span class="hljs-string">&quot;.&quot;</span>))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br><br>	fmt.Println(<span class="hljs-string">&quot;dir&quot;</span>, dir)<br><br>	<span class="hljs-comment">// 2. 配置初始化</span><br>	<span class="hljs-keyword">if</span> err := config.Init(fmt.Sprintf(<span class="hljs-string">&quot;%s/config.json&quot;</span>, dir)); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br><br>	<span class="hljs-comment">// 3. 设置调试模式</span><br>	gin.SetMode(config.Conf.Mode)<br><br>	<span class="hljs-comment">// 4. 创建路由</span><br>	Router := initialize.InitRouter()<br><br>	<span class="hljs-comment">// 监听端口</span><br>	Router.Run(fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, config.Conf.Host, config.Conf.Port))<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="2-5、日志初始化"><a href="#2-5、日志初始化" class="headerlink" title="2.5、日志初始化"></a>2.5、日志初始化</h2><p>zap是Uber开发的非常快的、结构化的，分日志级别的Go日志库。根据Uber-go Zap的文档，它的性能比类似的结构化日志包更好，也比标准库更快。</p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/uber-go/zap">https://github.com/uber-go/zap</a></p>
<p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u go.uber.org/zap<br>go get -u go.uber.org/zap/zapcore<br>go get -u github.com/natefinch/lumberjack<br></code></pre></td></tr></table></figure>

<h3 id="【1】日志等级"><a href="#【1】日志等级" class="headerlink" title="【1】日志等级"></a>【1】日志等级</h3><p>从上往下，等级越高。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang">DebugLevel   zap.S().Debug  <span class="hljs-comment">// 调试，开发人员自己调试程序时输入的信息</span><br>InfoLevel    zap.S().Info   <span class="hljs-comment">// 信息，程序在运行过程中，输入的细节信息</span><br>WarnLevel    zap.S().Warn   <span class="hljs-comment">// 警告，程序遇到一些能运行，但是有可能在运行以后出现不预期的结果。                                    </span><br>ErrorLevel   zap.S().Error  <span class="hljs-comment">// 错误，程序遇到了一些功能性上，程序在判断上，出现了预期的错误。</span><br>PanicLevel   zap.S().Panic  <span class="hljs-comment">// 异常，程序遇到了一些功能性上，程序在判断上，出现了不预期的错误。</span><br>FatalLevel   zap.S().Fatal  <span class="hljs-comment">// 致命，程序遇到了致命语法级别错误，根本可能不能运行的，或者运行以后，无法执行的。</span><br></code></pre></td></tr></table></figure>

<h3 id="【2】基本使用"><a href="#【2】基本使用" class="headerlink" title="【2】基本使用"></a>【2】基本使用</h3><p><code>application/initialize/logger.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitLogger</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 日志初始化</span><br>	<span class="hljs-comment">// logger, _ := zap.NewProduction()  // 用于项目生产阶段，格式: json【适合用于集成到第三方日志分析系统中的】</span><br>	logger, _ := zap.NewDevelopment()    <span class="hljs-comment">// 用于项目开发阶段，格式: 普通文本格式【适合在终端查看】</span><br>	<span class="hljs-comment">// 替换了zap的全局日志配置</span><br>	zap.ReplaceGlobals(logger)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/initialize&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;path/filepath&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 获取一个基于整个目录入口所在的路径</span><br>	dir, err := filepath.Abs(filepath.Dir(<span class="hljs-string">&quot;.&quot;</span>))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br><br>	<span class="hljs-comment">// 配置初始化</span><br>	<span class="hljs-keyword">if</span> err := config.Init(fmt.Sprintf(<span class="hljs-string">&quot;%s/config.json&quot;</span>, dir)); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br><br>	<span class="hljs-comment">// 设置调试模式</span><br>	gin.SetMode(config.Conf.Mode)<br><br>	<span class="hljs-comment">// 创建路由</span><br>	Router := initialize.InitRouter()<br><br>	<span class="hljs-comment">// 日志初始化</span><br>	initialize.InitLogger()<br>	<span class="hljs-comment">// zap 提供了一个S函数和L函数给我们开发者使用，调用S函数或L函数，可以得到一个全局的线程安全的logger对象</span><br>	zap.S().Infof(<span class="hljs-string">&quot;服务端启动...端口：%d&quot;</span>, config.Conf.Port)<br><br>	<span class="hljs-comment">// 监听端口</span><br>	<span class="hljs-keyword">if</span> err := Router.Run(fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, config.Conf.Host, config.Conf.Port)); err != <span class="hljs-literal">nil</span> &#123;<br>		zap.S().Panic(<span class="hljs-string">&quot;服务端启动失败：&quot;</span>, err.Error())<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="【3】日志配置"><a href="#【3】日志配置" class="headerlink" title="【3】日志配置"></a>【3】日志配置</h3><p>配置文件中指定日志输出的文件名，单个日志文件的大小，周期，以及日志文件的备份数量。</p>
<p>新增日志相关的配置项，<code>application/config/config.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>)<br><br><span class="hljs-comment">// Config 整个项目的配置</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>	Mode       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;mode&quot;`</span><br>  Host       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;host&quot;`</span><br>	Port       <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;port&quot;`</span><br>	*LogConfig <span class="hljs-string">`json:&quot;log&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// LogConfig 日志配置</span><br><span class="hljs-keyword">type</span> LogConfig <span class="hljs-keyword">struct</span> &#123;<br>	Level      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;level&quot;`</span><br>	Filename   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;filename&quot;`</span><br>	MaxSize    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;maxsize&quot;`</span><br>	MaxAge     <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;max_age&quot;`</span><br>	MaxBackups <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;max_backups&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// Conf 全局配置变量</span><br><span class="hljs-keyword">var</span> Conf = <span class="hljs-built_in">new</span>(Config)<br><br><span class="hljs-comment">// Init 初始化配置；从指定文件加载配置文件</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Init</span><span class="hljs-params">(filePath <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	b, err := ioutil.ReadFile(filePath)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">return</span> json.Unmarshal(b, Conf)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>config.json</code>，代码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debug&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;api.bingo.cn&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8080</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debug&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;filename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;logs/bingo.log&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;maxsize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_backups&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><code>application/initialize/logger.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/natefinch/lumberjack&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap/zapcore&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> Logger *zap.Logger<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitLogger</span><span class="hljs-params">(cfg *config.LogConfig)</span></span> (err <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">// 日志初始化</span><br>	<span class="hljs-comment">// 定制日志的格式</span><br>	writeSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge)<br>	encoder := getEncoder()<br>	<span class="hljs-keyword">var</span> l = <span class="hljs-built_in">new</span>(zapcore.Level)<br>	<span class="hljs-keyword">if</span> err = l.UnmarshalText([]<span class="hljs-type">byte</span>(cfg.Level)); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	core := zapcore.NewCore(encoder, writeSyncer, l)<br>	Logger = zap.New(core, zap.AddCaller())<br>	<span class="hljs-comment">// logger, _ := zap.NewProduction()  // 用于项目生产阶段，格式: json【适合用于集成到第三方日志分析系统中的】</span><br>	<span class="hljs-comment">// logger, _ := zap.NewDevelopment()    // 用于项目开发阶段，格式: 普通文本格式【适合在终端查看】</span><br>	<span class="hljs-comment">// 替换了zap的全局日志配置</span><br>	zap.ReplaceGlobals(Logger)<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getEncoder</span><span class="hljs-params">()</span></span> zapcore.Encoder &#123;<br>	encoderConfig := zap.NewProductionEncoderConfig()<br>	encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder<br>	encoderConfig.TimeKey = <span class="hljs-string">&quot;time&quot;</span><br>	encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder<br>	encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder<br>	encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder<br>	<span class="hljs-keyword">return</span> zapcore.NewJSONEncoder(encoderConfig)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getLogWriter</span><span class="hljs-params">(filename <span class="hljs-type">string</span>, maxSize, maxBackup, maxAge <span class="hljs-type">int</span>)</span></span> zapcore.WriteSyncer &#123;<br>	lumberJackLogger := &amp;lumberjack.Logger&#123;<br>		Filename:   filename,<br>		MaxSize:    maxSize,<br>		MaxBackups: maxBackup,<br>		MaxAge:     maxAge,<br>	&#125;<br>	<span class="hljs-keyword">return</span> zapcore.AddSync(lumberJackLogger)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>application/main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;path/filepath&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/initialize&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 1. 获取一个基于整个目录入口所在的路径</span><br>	dir, err := filepath.Abs(filepath.Dir(<span class="hljs-string">&quot;.&quot;</span>))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br><br>	<span class="hljs-comment">// 2. 配置初始化</span><br>	<span class="hljs-keyword">if</span> err := config.Init(fmt.Sprintf(<span class="hljs-string">&quot;%s/config.json&quot;</span>, dir)); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br><br>	<span class="hljs-comment">// 设置调试模式</span><br>	gin.SetMode(config.Conf.Mode)<br><br>	<span class="hljs-comment">// 3. 日志初始化</span><br>	<span class="hljs-keyword">if</span> err := initialize.InitLogger(config.Conf.LogConfig); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;init logger failed, err:%v\n&quot;</span>, err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	zap.S().Debugf(<span class="hljs-string">&quot;调试信息:%d&quot;</span>, config.Conf.Port)<br><br>	<span class="hljs-comment">// 4.创建路由</span><br>	Router := initialize.InitRouter()<br><br>	<span class="hljs-comment">// 5. zap 提供了一个S函数和L函数给我们开发者使用，调用S函数或L函数，可以得到一个全局的线程安全的logger对象</span><br>	zap.S().Infof(<span class="hljs-string">&quot;服务端启动...端口：%d&quot;</span>, config.Conf.Port)<br><br>	<span class="hljs-comment">// 监听端口</span><br>	<span class="hljs-keyword">if</span> err := Router.Run(fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, config.Conf.Host, config.Conf.Port)); err != <span class="hljs-literal">nil</span> &#123;<br>		zap.S().Panic(<span class="hljs-string">&quot;服务端启动失败：&quot;</span>, err.Error())<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>中间件中对每次的请求响应进行日志记录，<code>application/middleware/logger.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> middleware<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;net&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;net/http/httputil&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;runtime/debug&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// GinLogger 接收gin框架默认的日志</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GinLogger</span><span class="hljs-params">()</span></span> gin.HandlerFunc &#123;<br>	<span class="hljs-comment">// 需要记录的是每次客户端访问时的上下文信息，所以此处返回一个匿名函数，在客户端请求时，触发中间件的时候，自动执行这个匿名函数</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>		start := time.Now()<br>		path := c.Request.URL.Path<br>		c.Next()<br>		cost := time.Since(start)<br>		<span class="hljs-comment">// 记录日志</span><br>		zap.S().Info(path,<br>			zap.Int(<span class="hljs-string">&quot;status&quot;</span>, c.Writer.Status()),<br>			zap.String(<span class="hljs-string">&quot;method&quot;</span>, c.Request.Method),<br>			zap.String(<span class="hljs-string">&quot;ip&quot;</span>, c.ClientIP()),<br>			zap.String(<span class="hljs-string">&quot;user-agent&quot;</span>, c.Request.UserAgent()),<br>			zap.Duration(<span class="hljs-string">&quot;cost timer&quot;</span>, cost),<br>		)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>注册中间件，<code>application/initialize/router.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouter</span><span class="hljs-params">()</span></span> *gin.Engine &#123;<br><br>	<span class="hljs-comment">// 1. 创建路由</span><br>	Router := gin.Default()<br>	Router.Use(middleware.GinLogger())<br><br>	<span class="hljs-comment">// 2. Api路由分组</span><br>	ApiGroup := Router.Group(<span class="hljs-string">&quot;/test&quot;</span>)<br><br>	ApiGroup.GET(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>		context.String(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;Bingo Start&quot;</span>)<br>	&#125;)<br><br>	<span class="hljs-keyword">return</span> Router<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-6、全局异常处理"><a href="#2-6、全局异常处理" class="headerlink" title="2.6、全局异常处理"></a>2.6、全局异常处理</h2><p><code>applicaton/middleware/exceptions.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> middleware<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Api <span class="hljs-keyword">struct</span> &#123;<br>	Code    <span class="hljs-type">int</span><br>	Message <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ExceptionMiddleware</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	 <span class="hljs-comment">/**</span><br><span class="hljs-comment">	 异常处理</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">switch</span> t := r.(<span class="hljs-keyword">type</span>) &#123;<br>			<span class="hljs-keyword">case</span> *Api:<br>				zap.S().Error(t.Message)<br>				c.JSON(t.Code, gin.H&#123;<br>					<span class="hljs-string">&quot;message&quot;</span>: t.Message,<br>				&#125;)<br>			<span class="hljs-keyword">default</span>:<br>				zap.S().Error(<span class="hljs-string">&quot;服务器内部异常&quot;</span>)<br>				c.JSON(http.StatusInternalServerError, gin.H&#123;<br>					<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;服务器内部异常&quot;</span>,<br>				&#125;)<br>			&#125;<br>			c.Abort()<br>		&#125;<br>	&#125;()<br><br>	c.Next()<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>initialize/router.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">Router.Use(middleware.ExceptionMiddleware)<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230808120421012-1467462.png" srcset="/img/loading.gif" lazyload alt="image-20230808120421012"></p>
<h2 id="2-7、数据库初始化"><a href="#2-7、数据库初始化" class="headerlink" title="2.7、数据库初始化"></a>2.7、数据库初始化</h2><h3 id="【1】mysql的初始化"><a href="#【1】mysql的初始化" class="headerlink" title="【1】mysql的初始化"></a>【1】mysql的初始化</h3><h4 id="1-创建数据库"><a href="#1-创建数据库" class="headerlink" title="1. 创建数据库"></a>1. 创建数据库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database bingo default charset=utf8mb4;<br>-- mysql5.5以后推出的utf8mb4，这个是真正的utf8，能够容纳所有的中文，以前的utf-8会出现错乱的中文编码。<br></code></pre></td></tr></table></figure>

<p>为当前项目创建数据库用户[这个用户只能看到bingo这个数据库]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 创建用户：create user &#x27;用户名&#x27;@&#x27;主机地址&#x27; identified by &#x27;密码&#x27;;<br>create user &#x27;bingo_user&#x27;@&#x27;%&#x27; identified by &#x27;bingo&#x27;;  # %表示任意主机都可以通过当前账户登录到mysql<br># 分配权限：grant 权限选项 on 数据库名.数据表 to &#x27;用户名&#x27;@&#x27;主机地址&#x27; with grant option;<br>grant all privileges on bingo.* to &#x27;bingo_user&#x27;@&#x27;%&#x27; with grant option;<br></code></pre></td></tr></table></figure>

<h4 id="2-MySQL初始化"><a href="#2-MySQL初始化" class="headerlink" title="2. MySQL初始化"></a>2. MySQL初始化</h4><p>文档：<a target="_blank" rel="noopener" href="https://gorm.io/zh_CN/docs/">https://gorm.io/zh_CN/docs/</a></p>
<p>增加数据库连接的配置项，<code>config/config.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>)<br><br><span class="hljs-comment">// 外界go开发项目： 配置文件都是 json、yaml、ini</span><br><br><span class="hljs-comment">// LogConfig 日志配置</span><br><span class="hljs-keyword">type</span> LogConfig <span class="hljs-keyword">struct</span> &#123;<br>	Level      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;level&quot;`</span><br>	Filename   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;filename&quot;`</span><br>	MaxSize    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;maxsize&quot;`</span><br>	MaxAge     <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;max_age&quot;`</span><br>	MaxBackups <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;max_backups&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// DatabaseConfig 数据库配置</span><br><span class="hljs-keyword">type</span> DatabaseConfig <span class="hljs-keyword">struct</span> &#123;<br>	Driver          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;driver&quot;`</span><br>	Host            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;host&quot;`</span><br>	Port            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;port&quot;`</span><br>	Database        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;database&quot;`</span><br>	Username        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;username&quot;`</span><br>	Password        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span><br>	Charset         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;charset&quot;`</span><br>	MaximumConn     <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;maximum_connection&quot;`</span><br>	MaximumFreeConn <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;maximum_free_connection&quot;`</span><br>	TimeOut         <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;timeout&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// Config 整个项目的配置</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>	Mode            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;mode&quot;`</span><br>  Host            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;host&quot;`</span><br>	Port            <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;port&quot;`</span><br>	*LogConfig      <span class="hljs-string">`json:&quot;log&quot;`</span><br>	*DatabaseConfig <span class="hljs-string">`json:&quot;database&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// Conf 全局配置变量</span><br><span class="hljs-keyword">var</span> Conf = <span class="hljs-built_in">new</span>(Config)<br><br><span class="hljs-comment">// Init 初始化配置；从指定文件加载配置文件</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Init</span><span class="hljs-params">(filePath <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	filePath 配置文件json文件的路径</span><br><span class="hljs-comment">	*/</span><br>	b, err := ioutil.ReadFile(filePath)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">return</span> json.Unmarshal(b, Conf)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>增加数据库连接的配置项，<code>applicetion/config.json</code>，代码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debug&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;api.bingo.cn&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8080</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debug&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;filename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;logs/bingo.log&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;maxsize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_backups&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;database&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;driver&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mysql&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3306&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;database&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bingo&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bingo_user&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bingo&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;charset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;utf8mb4&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;maximum_connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;maximum_free_connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timeout&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>封装初始化数据库连接工具函数，<code>applicetion/database/mysql.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> database<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/jinzhu/gorm&quot;</span><br>	_ <span class="hljs-string">&quot;github.com/jinzhu/gorm/dialects/mysql&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> Orm *gorm.DB<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetOrm</span><span class="hljs-params">(cfg *config.DatabaseConfig)</span></span> *gorm.DB &#123;<br>	dsn := fmt.Sprintf(<span class="hljs-string">&quot;%s:%s@tcp(%s:%s)/%s?charset=%s&amp;parseTime=true&amp;loc=Local&quot;</span>,<br>		cfg.Username,<br>		cfg.Password,<br>		cfg.Host,<br>		cfg.Port,<br>		cfg.Database,<br>		cfg.Charset)<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	Orm, err = gorm.Open(cfg.Driver, dsn)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		zap.S().Errorf(<span class="hljs-string">&quot;database connection fail: %v&quot;</span>, err.Error())<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>	<span class="hljs-comment">// 最大链接数</span><br>	Orm.DB().SetMaxOpenConns(cfg.MaximumConn)<br>	<span class="hljs-comment">// 最大空闲连接数</span><br>	Orm.DB().SetMaxIdleConns(cfg.MaximumFreeConn)<br>	<span class="hljs-comment">// 每个链接的最大生命周期</span><br>	Orm.DB().SetConnMaxLifetime(time.Duration(cfg.TimeOut))<br>	<span class="hljs-keyword">if</span> Orm.Error != <span class="hljs-literal">nil</span> &#123;<br>		zap.S().Errorf(<span class="hljs-string">&quot;database error: %v&quot;</span>, Orm.Error)<br>		<span class="hljs-built_in">panic</span>(Orm.Error)<br>	&#125;<br><br>	zap.S().Infof(<span class="hljs-string">&quot;mysql连接成功: %v&quot;</span>, dsn)<br><br>	<span class="hljs-keyword">return</span> Orm<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">最大连接数（MaxOpenConns）：它限制了连接池中可以同时打开的连接数量。</span><br><span class="hljs-comment">通过设置最大连接数，可以防止过多的连接同时被创建，从而避免数据库服务器过载或资源耗尽的情况。</span><br><span class="hljs-comment">如果达到最大连接数限制，新的数据库连接请求将被阻塞，直到有连接被释放回连接池。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">最大空闲连接数（MaxIdleConns）：它限制了连接池中可以保持空闲的连接数量。</span><br><span class="hljs-comment">连接池中的空闲连接可以避免频繁地创建和销毁连接，从而提高性能。</span><br><span class="hljs-comment">设置适当的最大空闲连接数可以根据应用程序的负载情况平衡连接的创建和销毁成本，确保连接池中始终有足够的连接供应用程序使用。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">设置连接的最大生命周期可以确保连接在一段时间后被释放，以防止连接长时间保持打开状态而导致资源耗尽。</span><br><span class="hljs-comment">*/</span><br><br></code></pre></td></tr></table></figure>

<p><code>applicetion/initialize/db.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/database&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitDB</span><span class="hljs-params">(cfg *config.DatabaseConfig)</span></span> &#123;<br>	Orm := database.GetOrm(cfg)<br>	Orm.AutoMigrate(&amp;model.User&#123;&#125;)<br>	<span class="hljs-comment">// 禁用复数</span><br>	Orm.SingularTable(<span class="hljs-literal">true</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 数据库初始化</span><br>initialize.InitDB(config.Conf.DatabaseConfig)<br></code></pre></td></tr></table></figure>

<h2 id="2-8、热自启"><a href="#2-8、热自启" class="headerlink" title="2.8、热自启"></a>2.8、热自启</h2><p>要在 Go Gin 项目中实现热重启（Hot Reload），可以使用第三方工具 <code>fresh</code>。<code>fresh</code> 是一个 Go 应用程序的自动重启工具，它能够在代码发生变化时重新编译并启动应用程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/pilu/fresh<br></code></pre></td></tr></table></figure>

<p>修改dir的值即可，<code>bingo_api/application/main.go</code></p>
<p>终端下要在main.go入门程序所在位置，运行执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fresh<br></code></pre></td></tr></table></figure>

<h2 id="2-9、axios-跨域支持"><a href="#2-9、axios-跨域支持" class="headerlink" title="2.9、axios&amp;跨域支持"></a>2.9、axios&amp;跨域支持</h2><h3 id="2-9-1、安装配置axios"><a href="#2-9-1、安装配置axios" class="headerlink" title="2.9.1、安装配置axios"></a>2.9.1、安装配置axios</h3><p>后面需要获取服务端的api接口数据，意味着要发送http请求，我们使用axios模块来请求服务端。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> bingo_web  <span class="hljs-comment"># 注意，客户端安装模块的所有命令，务必在package.json所在目录下操作。</span><br>yarn add axios@1.2.1  --registry https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure>

<p>创建<code>src/http/index.js</code>，编写axos对象初始化代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;axios&quot;</span>;<br><span class="hljs-keyword">import</span> settings <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../settings&quot;</span>;<br><br><span class="hljs-keyword">const</span> http =  axios.<span class="hljs-title function_">create</span>(&#123;<br>  <span class="hljs-attr">baseURL</span>: settings.<span class="hljs-property">host</span>,<br>  <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">false</span>,<br>&#125;)<br><br><span class="hljs-comment">// 请求拦截器</span><br>http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">config</span>)=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;http请求之前进行请求头组装，会自动执行请求拦截器&quot;</span>);<br>    <span class="hljs-keyword">return</span> config;<br>&#125;, <span class="hljs-function">(<span class="hljs-params">error</span>)=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;http请求之后发生错误，会自动执行请求拦截器&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>&#125;);<br><br><br><span class="hljs-comment">// 响应拦截器</span><br>http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">response</span>)=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;服务端响应数据以后在执行then之前，会自动执行响应拦截器&quot;</span>);<br>    <span class="hljs-keyword">return</span> response;<br>&#125;, <span class="hljs-function">(<span class="hljs-params">error</span>)=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;服务端响应错误以后在执行catch之前，会自动执行响应拦截器&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> http;<br></code></pre></td></tr></table></figure>

<p><code>src/settings/index.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> settings = &#123;<br>    <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;http://api.bingo.cn:8000/&quot;</span>,<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> settings;<br></code></pre></td></tr></table></figure>

<p>从上面效果，可以看到当前客户端已经安装配置好了router路由模块以及axios请求模块，并可以正常使用的。</p>
<h3 id="2-9-2、跨域支持"><a href="#2-9-2、跨域支持" class="headerlink" title="2.9.2、跨域支持"></a>2.9.2、跨域支持</h3><p>先用postman发送请求测试一下接口是否正常：</p>
<p><img src="/pages_images/Bingo/image-20230810115828508-1639909.png" srcset="/img/loading.gif" lazyload alt="image-20230810115828508"></p>
<p><code>src/http/requests.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./index.js&quot;</span>;<br><br><span class="hljs-comment">// 获取站点配置信息</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">get_api_test</span> = (<span class="hljs-params">params, headers</span>) =&gt; &#123;<br>    <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;test/&quot;</span>, &#123;params, headers&#125;)<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>然后在<code>views\Host.vue</code>发送ajax请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;host&quot;&gt;<br>    &lt;h1&gt;host页面&lt;/h1&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;get_api_test&#125; from &quot;../http/requests.js&quot;;<br><br>get_api_test().then(response =&gt; &#123;<br>  console.log(&quot;response:::&quot;, response)<br>&#125;)<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br><br></code></pre></td></tr></table></figure>

<p>遇到跨域请求失败</p>
<p><img src="/pages_images/Bingo/image-20230902215057047-3662658.png" srcset="/img/loading.gif" lazyload alt="image-20230902215057047"></p>
<h3 id="【1】服务端实现跨域支持"><a href="#【1】服务端实现跨域支持" class="headerlink" title="【1】服务端实现跨域支持"></a>【1】服务端实现跨域支持</h3><p>基于gin的官方CORS中间件实现跨域资源共享，<code>bingo_api/applicaton/middleware/cors.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> middleware<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-contrib/cors&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> CORS = cors.New(cors.Config&#123;<br>	<span class="hljs-comment">//准许跨域请求网站,多个使用,分开,限制使用*</span><br>	AllowOrigins: []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;*&quot;</span>&#125;,<br>	<span class="hljs-comment">//准许使用的请求方式</span><br>	AllowMethods: []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;PUT&quot;</span>, <span class="hljs-string">&quot;PATCH&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;DELETE&quot;</span>&#125;,<br>	<span class="hljs-comment">//准许使用的请求表头</span><br>	AllowHeaders: []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;Origin&quot;</span>, <span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Content-Type&quot;</span>&#125;,<br>	<span class="hljs-comment">//显示的请求表头</span><br>	ExposeHeaders: []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;Content-Type&quot;</span>&#125;,<br>	<span class="hljs-comment">//凭证共享,确定共享</span><br>	AllowCredentials: <span class="hljs-literal">true</span>,<br>	<span class="hljs-comment">//容许跨域的原点网站,可以直接return true就万事大吉了</span><br>	AllowOriginFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(origin <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;,<br>	<span class="hljs-comment">//超时时间设定</span><br>	MaxAge: <span class="hljs-number">24</span> * time.Hour,<br>&#125;)<br><br></code></pre></td></tr></table></figure>

<p>调用中间件，在<code>bingo_api/application/initialize/router.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">Router.Use(middleware.CORS)<br></code></pre></td></tr></table></figure>

<p>完成了上面的步骤，我们就可以再访问host，通过后端提供数据给前端使用ajax访问了。</p>
<p><img src="/pages_images/Bingo/image-20230810114550550-1639151.png" srcset="/img/loading.gif" lazyload alt="image-20230810114550550"></p>
<h3 id="【2】客户端实现跨域支持"><a href="#【2】客户端实现跨域支持" class="headerlink" title="【2】客户端实现跨域支持"></a>【2】客户端实现跨域支持</h3><p>在<code>vue.config.js</code>中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/* 跨域代理 */</span><br><span class="hljs-attr">proxy</span>: &#123;<br>    <span class="hljs-string">&quot;/api&quot;</span>: &#123;<br>        <span class="hljs-comment">/* 目标代理服务器地址 */</span><br>        <span class="hljs-attr">target</span>: <span class="hljs-string">&quot;http://api.bingo_api.cn:8080/api&quot;</span>, <span class="hljs-comment">//</span><br>        <span class="hljs-comment">/* 允许跨域 */</span><br>        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">ws</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">pathRewrite</span>: &#123;<br>            <span class="hljs-string">&quot;^/api&quot;</span>: <span class="hljs-string">&quot;&quot;</span>   <span class="hljs-comment">// 　/api表示需要去匹配请求时的url，然后替换成target的值，由node.js发出请求</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="三、用户中心"><a href="#三、用户中心" class="headerlink" title="三、用户中心"></a>三、用户中心</h1><h2 id="3-1、用户模型"><a href="#3-1、用户模型" class="headerlink" title="3.1、用户模型"></a>3.1、用户模型</h2><p>创建用户模型，测试数据库初始化是否正常使用<code>/application/model/user.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> model<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/database&quot;</span><br>	<span class="hljs-string">&quot;gorm.io/gorm&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">用户实体</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>	gorm.Model<br>	Username     <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;unique_index;size:255;comment:&#x27;账户名&#x27;&quot; json:&quot;username&quot; sql:&quot;index&quot;`</span><br>	HashPassword <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;not null;size:255;comment:&#x27;密码&#x27;&quot; json:&quot;-&quot;`</span><br>	Password     <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;-&quot; json:&quot;password,omitempty&quot;`</span><br>	Nickname     <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;size:255;comment:&#x27;昵称&#x27;&quot; json:&quot;nickname&quot; sql:&quot;index&quot;`</span><br>	Mobile       <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;index;size:15;comment:&#x27;手机&#x27;;&quot; json:&quot;mobile&quot;`</span><br>	Email        <span class="hljs-type">string</span> <span class="hljs-string">`valid:&quot;email&quot; gorm:&quot;index;size:255;comment:&#x27;邮箱&#x27;;&quot; json:&quot;email&quot;`</span><br>	Avatar       <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;size:255;comment:&#x27;头像&#x27;&quot; json:&quot;avatar&quot;`</span><br>	Sex          <span class="hljs-type">bool</span>   <span class="hljs-string">`gorm:&quot;type:boolean;default:true;comment:&#x27;性别&#x27;&quot; json:&quot;sex&quot;`</span><br>	Ip           <span class="hljs-type">string</span> <span class="hljs-string">`valid:&quot;ip&quot; gorm:&quot;size:255;comment:&#x27;IP地址&#x27;;&quot; json:&quot;ip&quot;`</span><br>	Status       <span class="hljs-type">bool</span>   <span class="hljs-string">`gorm:&quot;type:boolean;default:true;comment:&#x27;状态&#x27;&quot; json:&quot;status&quot;`</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">设置表名</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user_info&quot;</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">创建用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(user User)</span></span> Insert() (id <span class="hljs-type">uint</span>, err <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">//添加数据</span><br>	result := Orm.Create(&amp;user)<br>	<span class="hljs-keyword">return</span> user.ID, result.Error<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据指定ID获取用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(user *User)</span></span> GetOneById(id <span class="hljs-type">uint</span>) &#123;<br>	Orm.First(&amp;user, id)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据账户信息(用户名、手机、邮箱)获取用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(user *User)</span></span> GetOneByAccount(account <span class="hljs-type">string</span>) &#123;<br>	Orm.First(&amp;user, <span class="hljs-string">&quot;username = ? or mobile = ? or email= ?&quot;</span>, account, account, account)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取所有用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(user User)</span></span> GetAll() []User &#123;<br>	<span class="hljs-keyword">var</span> users []User<br>	Orm.Find(&amp;users)<br>	<span class="hljs-keyword">return</span> users<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">更新密码</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(user User)</span></span> ChangePassword(HashPasswrd <span class="hljs-type">string</span>) &#123;<br>	user.HashPassword = HashPasswrd<br>	Orm.Save(&amp;user)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>项目初始化并数据迁移，<code>initialize/db.go</code>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">package initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/database&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br>func InitDB(cfg *config.DatabaseConfig) &#123;<br>	fmt.Println(<span class="hljs-string">&quot;hello ...&quot;</span>)<br>	Orm := database.GetOrm(cfg)<br>	// 禁用复数<br>	Orm.SingularTable(true)<br>	// 数据迁移<br>	Orm.AutoMigrate(&amp;model.User&#123;&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="3-2、创建账户的API接口"><a href="#3-2、创建账户的API接口" class="headerlink" title="3.2、创建账户的API接口"></a>3.2、创建账户的API接口</h2><p>该接口目前仅用于测试添加超级用户，将来需要补充上权限。</p>
<p>业务层代码，<code>bingo_api/application/services/user.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> services<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">创建用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(ctx *gin.Context)</span></span> (<span class="hljs-type">uint</span>, <span class="hljs-type">error</span>) &#123;<br>	user := User&#123;&#125;<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;user); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>	&#125;<br><br>	user.HashPassword, err = MakeHashPassword(user.Password)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> user.Insert()<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取指定ID的用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserById</span><span class="hljs-params">(id <span class="hljs-type">uint</span>)</span></span> (user User) &#123;<br>	user = User&#123;&#125;<br>	user.GetOneById(id)<br>	<span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据账户信息(用户名、手机、邮箱)获取用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserByAccount</span><span class="hljs-params">(account <span class="hljs-type">string</span>)</span></span> (user User) &#123;<br>	user = User&#123;&#125;<br>	user.GetOneByAccount(account)<br>	<span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取所有用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetAllUser</span><span class="hljs-params">()</span></span> []User &#123;<br>	user := User&#123;&#125;<br>	<span class="hljs-keyword">return</span> user.GetAll()<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">更新密码</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ChangeUserPassword</span><span class="hljs-params">(user User, RawPassword <span class="hljs-type">string</span>)</span></span> &#123;<br>	password, _ := MakeHashPassword(RawPassword)<br>	user.ChangePassword(password)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>工具方法，<code>bingo_api/application/utils/string.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	<span class="hljs-string">&quot;golang.org/x/crypto/bcrypt&quot;</span><br>	<span class="hljs-string">&quot;math/rand&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Random</span><span class="hljs-params">(n <span class="hljs-type">int</span>, chars <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>	&#125;<br>	r := rand.New(rand.NewSource(time.Now().UnixNano()))<br>	bytes := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, n, n)<br>	l := <span class="hljs-built_in">len</span>(chars)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>		bytes[i] = chars[r.Intn(l)]<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(bytes)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RandomLetters</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	生成指定长度的字符串(字母)</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">return</span> Random(n, LETTERS)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RandomNumeric</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	生成指定长度的字符串(数字)</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">return</span> Random(n, NUMBERS)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RandomLettersNumeric</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	生成指定长度的字符串(数字+字母)</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">return</span> Random(n, LETTERS_NUMBERIC)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RandomAscii</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	生成指定长度的字符串(字母+数字+特殊字符)</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">return</span> Random(n, ASCII)<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> 加密密码</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MakeHashPassword</span><span class="hljs-params">(RawPassword <span class="hljs-type">string</span>)</span></span> (HashPasswrd <span class="hljs-type">string</span>, err <span class="hljs-type">error</span>) &#123;<br>	pwd := []<span class="hljs-type">byte</span>(RawPassword)<br>	hash, err := bcrypt.GenerateFromPassword(pwd, bcrypt.MinCost)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	HashPasswrd = <span class="hljs-type">string</span>(hash)<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">验证密码</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CheckPassword</span><span class="hljs-params">(HashPassword <span class="hljs-type">string</span>, RawPassword <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>	ByteHash := []<span class="hljs-type">byte</span>(HashPassword)<br>	BytePwd := []<span class="hljs-type">byte</span>(RawPassword)<br>	err := bcrypt.CompareHashAndPassword(ByteHash, BytePwd)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>常量文件中创建常用字符集合的常量，<code>bingo_api/application/constants/common.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">常用字符集合</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">const</span> NUMBERS <span class="hljs-type">string</span> = <span class="hljs-string">&quot;0123456789&quot;</span><br><span class="hljs-keyword">const</span> LETTERS <span class="hljs-type">string</span> = <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span><br><span class="hljs-keyword">const</span> SPECIALS <span class="hljs-type">string</span> = <span class="hljs-string">&quot;~!@#$%^*()_+-=[]&#123;&#125;|;:,./&lt;&gt;?&quot;</span><br><span class="hljs-keyword">const</span> LETTERS_NUMBERIC <span class="hljs-type">string</span> = LETTERS + NUMBERS<br><span class="hljs-keyword">const</span> ASCII <span class="hljs-type">string</span> = LETTERS_NUMBERIC + SPECIALS<br><br></code></pre></td></tr></table></figure>

<p>接口层，bingo_api&#x2F;application&#x2F;api&#x2F;user.go，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> api<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/services&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">用户认证登陆</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserAuthenticate</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-keyword">var</span> data <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>		<span class="hljs-string">&quot;userame&quot;</span>: <span class="hljs-string">&quot;xiaoming&quot;</span>,<br>		<span class="hljs-string">&quot;age&quot;</span>:     <span class="hljs-string">&quot;16&quot;</span>,<br>	&#125;<br>	ctx.JSON(http.StatusOK, data)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">创建用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserCreate</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><br>	id, err := CreateUser(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || id &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusOK, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeCreateUserFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: constants.CreateUserFail,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusCreated, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.CreateUserSuccess,<br>		<span class="hljs-string">&quot;data&quot;</span>:    id,<br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>消息提示常量，<code>bingo_api/application/constants/message.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-keyword">const</span> (<br>	CreateUserSuccess = <span class="hljs-string">&quot;创建用户成功！&quot;</span><br>	CreateUserFail    = <span class="hljs-string">&quot;创建用户失败！&quot;</span><br>)<br><br></code></pre></td></tr></table></figure>

<p>消息ID常量，<code>bingo_api/application/constants/code.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-keyword">const</span> (<br>	CodeSuccess = <span class="hljs-number">0</span> <span class="hljs-comment">// 成功！</span><br>	CodeCreateUserFail = <span class="hljs-number">1001</span>  <span class="hljs-comment">// 创建用户失败！</span><br>)<br></code></pre></td></tr></table></figure>

<p>路由层，<code>bingo_api/application/router/user.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/api&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitUserRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	用户相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	UserRouter := Router.Group(<span class="hljs-string">&quot;user&quot;</span>)<br>	&#123;<br>		<span class="hljs-comment">// 用户认证登陆</span><br>		utils.Register(UserRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;authenticate&quot;</span>, api.UserAuthenticate)<br>		<span class="hljs-comment">// 用户创建</span><br>		utils.Register(UserRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, api.UserCreate)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/utils/router</code>，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(r *gin.RouterGroup, httpMethods []<span class="hljs-type">string</span>, relativePath <span class="hljs-type">string</span>, handlers ...gin.HandlerFunc)</span></span> gin.IRoutes &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	路由注册函数[一次性给同一个视图绑定多个不同的HTTP请求方法]</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">var</span> routes gin.IRoutes<br>	<span class="hljs-keyword">for</span> _, httpMethod := <span class="hljs-keyword">range</span> httpMethods &#123;<br>		routes = r.Handle(httpMethod, relativePath, handlers...)<br>	&#125;<br>	<span class="hljs-keyword">return</span> routes<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/initialize/router</code>，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/router&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouter</span><span class="hljs-params">()</span></span> *gin.Engine &#123;<br><br>	<span class="hljs-comment">// 1. 创建路由</span><br>	Router := gin.Default()<br>	Router.Use(middleware.GinLogger())<br>	Router.Use(middleware.ExceptionMiddleware)<br>	Router.Use(middleware.CORS)<br><br>	<span class="hljs-comment">// 2. Api路由分组</span><br>	ApiGroup := Router.Group(<span class="hljs-string">&quot;/test&quot;</span>)<br><br>	ApiGroup.GET(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>		<span class="hljs-comment">//panic(&quot;raise an error!!!&quot;)</span><br>		context.String(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;Bingo Start&quot;</span>)<br>	&#125;)<br><br>	InitUserRouter(ApiGroup)<br><br>	<span class="hljs-keyword">return</span> Router<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="3-3、validator-User"><a href="#3-3、validator-User" class="headerlink" title="3.3、validator User"></a>3.3、validator User</h2><p>接下来，我们肯定是需要验证客户端提交的数据是否合法。因此，我们还需要安装一个插件：validator。validator本身提供了基于struct结构体的tag标签提供了一系列的验证规则和提供了自定义验证规范的方式给我们可以快速的完成客户端数据的校验工作。但是，validator默认返回的错误信息是英文的，因为我们还要翻译下错误信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 验证模块</span><br>go get -u github.com/go-playground/validator/v10<br><span class="hljs-comment"># 翻译模块</span><br>go get -u github.com/go-playground/locales/zh<br>go get -u github.com/go-playground/universal-translator<br>go get -u github.com/go-playground/validator/v10/translations/zh<br></code></pre></td></tr></table></figure>

<p><code>model/user.go</code>代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">用户实体</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>	gorm.Model<br>	Username      <span class="hljs-type">string</span> <span class="hljs-string">`validate:&quot;required,gte=5&quot; label:&quot;账户名&quot; gorm:&quot;unique_index;size:255;comment:&#x27;账户名&#x27;&quot; json:&quot;username&quot;`</span><br>	HashPassword  <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;not null;size:255;comment:&#x27;密码&#x27;&quot; json:&quot;-&quot;`</span><br>	Password      <span class="hljs-type">string</span> <span class="hljs-string">`validate:&quot;required&quot; label:&quot;登陆密码&quot; gorm:&quot;-&quot; json:&quot;password,omitempty&quot;`</span><br>	Nickname      <span class="hljs-type">string</span> <span class="hljs-string">`label:&quot;昵称&quot; gorm:&quot;size:255;comment:&#x27;昵称&#x27;&quot; json:&quot;nickname&quot; sql:&quot;index&quot;`</span><br>	Mobile        <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;index;size:15;comment:&#x27;手机&#x27;;&quot; json:&quot;mobile&quot;`</span><br>	Email         <span class="hljs-type">string</span> <span class="hljs-string">`validate:&quot;omitempty,email&quot; gorm:&quot;index;size:255;comment:&#x27;邮箱&#x27;;&quot; json:&quot;email&quot;`</span><br>	Avatar        <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;size:255;comment:&#x27;头像&#x27;&quot; json:&quot;avatar&quot;`</span><br>	Sex           <span class="hljs-type">bool</span>   <span class="hljs-string">`gorm:&quot;type:boolean;default:true;comment:&#x27;性别&#x27;&quot; json:&quot;sex&quot;`</span><br>	Ip            <span class="hljs-type">string</span> <span class="hljs-string">`validate:&quot;omitempty,ipv4&quot; gorm:&quot;size:255;comment:&#x27;IP地址&#x27;;&quot; json:&quot;ip&quot;`</span><br>	Status        <span class="hljs-type">bool</span>   <span class="hljs-string">`gorm:&quot;type:boolean;default:true;comment:&#x27;状态&#x27;&quot; json:&quot;status&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/utils/vaidator.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/go-playground/locales/zh&quot;</span><br>	ut <span class="hljs-string">&quot;github.com/go-playground/universal-translator&quot;</span><br>	<span class="hljs-string">&quot;github.com/go-playground/validator/v10&quot;</span><br>	. <span class="hljs-string">&quot;github.com/go-playground/validator/v10/translations/zh&quot;</span><br>	<span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">生成验证器</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GenValidate</span><span class="hljs-params">()</span></span> (*validator.Validate, ut.Translator) &#123;<br>	zhCh := zh.New()<br>	validate := validator.New()<br>	<span class="hljs-comment">//注册一个函数，获取struct tag里自定义的label作为字段名</span><br>	validate.RegisterTagNameFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(fld reflect.StructField)</span></span> <span class="hljs-type">string</span> &#123;<br>		name := fld.Tag.Get(<span class="hljs-string">&quot;label&quot;</span>)<br>		<span class="hljs-keyword">return</span> name<br>	&#125;)<br><br>	UniversalTranslator := ut.New(zhCh)<br>	trans, _ := UniversalTranslator.GetTranslator(<span class="hljs-string">&quot;zh&quot;</span>)<br>	_ = RegisterDefaultTranslations(validate, trans)<br>	<span class="hljs-keyword">return</span> validate, trans<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>application/validator/user.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> validator<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;github.com/go-playground/validator/v10&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">登录验证器</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserValidator</span><span class="hljs-params">(user *User)</span></span> <span class="hljs-type">error</span> &#123;<br>	validate, trans := GenValidate()<br>	err := validate.Struct(user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">for</span> _, err := <span class="hljs-keyword">range</span> err.(validator.ValidationErrors) &#123;<br>			<span class="hljs-keyword">return</span> errors.New(err.Translate(trans))<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>services/user.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> services<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/validator&quot;</span><br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">用户登录认证</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserLogin</span><span class="hljs-params">(ctx *gin.Context)</span></span> (user User, err <span class="hljs-type">error</span>) &#123;<br>	user = User&#123;&#125;<br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;user); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> user, err<br>	&#125;<br><br>	<span class="hljs-comment">// 校验输入字段</span><br>	<span class="hljs-keyword">if</span> err = validator.UserValidator(&amp;user); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> user, err<br>	&#125;<br><br>	user.GetOneByAccount(user.Username)<br>	<span class="hljs-keyword">if</span> user.ID &lt; <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span> user, errors.New(constants.NoSuchUser)<br>	&#125;<br><br>	ret := CheckPassword(user.HashPassword, user.Password)<br><br>	<span class="hljs-keyword">if</span> !ret &#123;<br>		err = errors.New(constants.PasswordError)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">创建用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(ctx *gin.Context)</span></span> (<span class="hljs-type">uint</span>, <span class="hljs-type">error</span>) &#123;<br>	user := User&#123;&#125;<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;user); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>	&#125;<br><br>	<span class="hljs-comment">// 校验输入字段</span><br>	<span class="hljs-keyword">if</span> err = validator.UserValidator(&amp;user); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;err:::&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>	&#125;<br><br>	user.HashPassword, err = MakeHashPassword(user.Password)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> user.Insert()<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取指定ID的用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserById</span><span class="hljs-params">(id <span class="hljs-type">uint</span>)</span></span> (user User) &#123;<br>	user = User&#123;&#125;<br>	user.GetOneById(id)<br>	<span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据账户信息(用户名、手机、邮箱)获取用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserByAccount</span><span class="hljs-params">(account <span class="hljs-type">string</span>)</span></span> (user User) &#123;<br>	user = User&#123;&#125;<br>	user.GetOneByAccount(account)<br>	<span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取所有用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetAllUser</span><span class="hljs-params">()</span></span> []User &#123;<br>	user := User&#123;&#125;<br>	<span class="hljs-keyword">return</span> user.GetAll()<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">更新密码</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ChangeUserPassword</span><span class="hljs-params">(user User, RawPassword <span class="hljs-type">string</span>)</span></span> &#123;<br>	password, _ := MakeHashPassword(RawPassword)<br>	user.ChangePassword(password)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>api/user.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> api<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/services&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">用户认证登陆</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserAuthenticate</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	user, err := UserLogin(ctx)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || user.ID &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusOK, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeNoSuchUser,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusCreated, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>:    user,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">创建用户</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserCreate</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><br>	id, err := CreateUser(ctx)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || id &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusOK, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeCreateUserFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: constants.CreateUserFail + err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusCreated, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.CreateUserSuccess,<br>		<span class="hljs-string">&quot;data&quot;</span>:    id,<br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>constants/message.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-keyword">const</span> (<br>	Success           = <span class="hljs-string">&quot;成功！&quot;</span><br>	CreateUserFail    = <span class="hljs-string">&quot;创建用户失败！&quot;</span><br>	CreateUserSuccess = <span class="hljs-string">&quot;创建用户成功！&quot;</span><br>	NoSuchUser        = <span class="hljs-string">&quot;用户不存在！&quot;</span><br>	PasswordError     = <span class="hljs-string">&quot;密码错误！&quot;</span><br>)<br><br><br></code></pre></td></tr></table></figure>

<p><code>constants/code.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-keyword">const</span> (<br>	CodeSuccess = <span class="hljs-number">0</span> <span class="hljs-comment">// 成功！</span><br>	CodeCreateUserFail = <span class="hljs-number">1001</span>  <span class="hljs-comment">// 创建用户失败！</span><br>	CodeNoSuchUser = <span class="hljs-number">1002</span>  <span class="hljs-comment">// 当前用户不存在！</span><br>)<br><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230903081526657-3700128.png" srcset="/img/loading.gif" lazyload alt="image-20230903081526657"></p>
<h2 id="3-4、JWT"><a href="#3-4、JWT" class="headerlink" title="3.4、JWT"></a>3.4、JWT</h2><p>在用户注册或登录后，我们想记录用户的登录状态，或者为用户创建身份认证的凭证。我们使用Json Web Token认证机制。</p>
<p>很多公司开发的一些移动端可能不支持cookie，并且我们通过cookie和session做接口登录认证的话，效率其实并不是很高，我们的接口可能提供给多个客户端，session数据保存在服务端，那么就需要每次都调用session数据进行验证，比较耗时，所以引入了token认证的概念，我们可以通过jwt来完成原来cookie或者session的认证效果，接下来看看jwt是怎么实现的。</p>
<blockquote>
<p>Json web token (JWT), 是为了在网络应用环境间传递声明(token，一段字符串)而执行的一种基于JSON的开放标准（(RFC 7519).该token被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。JWT的声明(token，一段字符串)一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于身份认证，也可被数据加密。</p>
</blockquote>
<p><img src="/pages_images/Bingo/image-20230903082116327-3700477.png" srcset="/img/loading.gif" lazyload alt="image-20230903082116327"></p>
<p>JWT就一段字符串，由三段信息构成的，将这三段信息文本用<code>.</code>拼接一起就构成了Jwt字符串。就像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ<br></code></pre></td></tr></table></figure>

<p>第一部分我们称它为头部（header)，第二部分我们称其为载荷（payload, 类似于飞机上承载的物品)，第三部分是签证（signature).</p>
<p><strong>header</strong></p>
<p>jwt的头部承载两部分信息：</p>
<ul>
<li>声明token类型，这里是jwt，除了jwt就是Bearer</li>
<li>声明签名加密的算法 通常直接使用 HMAC SHA256</li>
</ul>
<p>完整的头部就像下面这样的JSON&#x2F;map： </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>  <span class="hljs-string">&quot;typ&quot;</span>: <span class="hljs-string">&quot;JWT&quot;</span>,<br>  <span class="hljs-string">&quot;alg&quot;</span>: <span class="hljs-string">&quot;HS256&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后将头部进行base64.StdEncoding.EncodeToString编码，构成了第一部分.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9<br></code></pre></td></tr></table></figure>

<p>Test:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/base64&quot;</span><br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 头部信息</span><br>	headerData := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>		<span class="hljs-string">&quot;typ&quot;</span>: <span class="hljs-string">&quot;JWT&quot;</span>,<br>		<span class="hljs-string">&quot;alg&quot;</span>: <span class="hljs-string">&quot;HS256&quot;</span>,<br>	&#125;<br><br>	headerJson, _ := json.Marshal(headerData)<br>	headerBytes := []<span class="hljs-type">byte</span>(<span class="hljs-type">string</span>(headerJson))<br>	<span class="hljs-comment">// base64编码</span><br>	headerString := strings.TrimRight(base64.URLEncoding.EncodeToString(headerBytes), <span class="hljs-string">&quot;=&quot;</span>)<br>	fmt.Println(headerString)<br><br>	<span class="hljs-comment">// base64解码</span><br>	headerBytes, _ = base64.URLEncoding.DecodeString(headerString)<br>	fmt.Println(<span class="hljs-type">string</span>(headerBytes)) <span class="hljs-comment">// &#123;&quot;alg&quot;:&quot;HS256&quot;,&quot;typ&quot;:&quot;JWT&quot;&#125;</span><br><br>	<span class="hljs-keyword">type</span> Header <span class="hljs-keyword">struct</span> &#123;<br>		Alg <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;alg&quot;`</span><br>		Typ <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;typ&quot;`</span><br>	&#125;<br><br>	header := Header&#123;&#125;<br>	json.Unmarshal([]<span class="hljs-type">byte</span>(headerBytes), &amp;header)<br>	fmt.Printf(<span class="hljs-string">&quot;%#v&quot;</span>, header)<br>&#125;<br><br><span class="hljs-comment">// 各个语言中都有base64编码和解码的功能，所以我们jwt为了安全，需要配合第三段签证加密</span><br><br></code></pre></td></tr></table></figure>

<p><strong>payload</strong></p>
<p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息可以存放下面三个部分信息。</p>
<blockquote>
<ul>
<li>标准声明（注册声明、预定义声明，registered claims）</li>
<li>公共声明（public claims）</li>
<li>私有声明（private claims）</li>
</ul>
</blockquote>
<p><strong>标准声明</strong> (官方规范，是建议但不强制使用) ：</p>
<blockquote>
<ul>
<li><p><strong>iss</strong>: jwt签发者</p>
</li>
<li><p><strong>sub</strong>: jwt所面向的用户</p>
</li>
<li><p><strong>aud</strong>: 接收jwt的一方</p>
</li>
<li><p><strong>exp</strong>: jwt的过期时间，这个过期时间必须要大于签发时间</p>
</li>
<li><p><strong>nbf</strong>: 定义在什么时间之前，该jwt都是不可用的.</p>
</li>
<li><p><strong>iat</strong>: jwt的签发时间</p>
</li>
<li><p><strong>jti</strong>: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p>
<p>以上是JWT 规定的7个官方字段，供选用</p>
</li>
</ul>
</blockquote>
<p><strong>公共声明</strong> ： 公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端直接可以查看.</p>
<p><strong>私有声明</strong> ： 私有声明是服务端和客户端所共同定义的声明，一般使用了ace算法进行对称加密和解密的，意味着该部分信息可以归类为明文信息。</p>
<p>定义一个payload，json格式的数据:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>    <span class="hljs-string">&quot;sub&quot;</span>:   <span class="hljs-string">&quot;1234567890&quot;</span>,<br>		<span class="hljs-string">&quot;exp&quot;</span>:   <span class="hljs-string">&quot;3422335555&quot;</span>,<br>		<span class="hljs-string">&quot;name&quot;</span>:  <span class="hljs-string">&quot;yuan&quot;</span>,<br>		<span class="hljs-string">&quot;admin&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>		<span class="hljs-string">&quot;info&quot;</span>:  <span class="hljs-string">&quot;123abc456&quot;</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后将其进行base64.StdEncoding.EncodeToString编码，得到JWT的第二部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">eyJhZG1pbiI6IjEiLCJleHAiOiIzNDIyMzM1NTU1IiwiaW5mbyI6IjEyM2FiYzQ1NiIsIm5hbWUiOiJ5dWFuIiwic3ViIjoiMTIzNDU2Nzg5MCJ9<br></code></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/base64&quot;</span><br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>	payloadData := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>		<span class="hljs-string">&quot;sub&quot;</span>:   <span class="hljs-string">&quot;1234567890&quot;</span>,<br>		<span class="hljs-string">&quot;exp&quot;</span>:   <span class="hljs-string">&quot;3422335555&quot;</span>,<br>		<span class="hljs-string">&quot;name&quot;</span>:  <span class="hljs-string">&quot;yuan&quot;</span>,<br>		<span class="hljs-string">&quot;admin&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>		<span class="hljs-string">&quot;info&quot;</span>:  <span class="hljs-string">&quot;123abc456&quot;</span>,<br>	&#125;<br>	payloadBytes, _ := json.Marshal(payloadData)<br><br>	<span class="hljs-comment">// base64编码</span><br>	payloadString := strings.TrimRight(base64.URLEncoding.EncodeToString(payloadBytes), <span class="hljs-string">&quot;=&quot;</span>)<br>	fmt.Println(payloadString)<br><br>	<span class="hljs-comment">// base64解码</span><br>	payloadBytes, _ = base64.URLEncoding.DecodeString(payloadString)<br>	fmt.Println(<span class="hljs-type">string</span>(payloadBytes))<br><br>	<span class="hljs-keyword">type</span> Payload <span class="hljs-keyword">struct</span> &#123;<br>		Sub   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;sub&quot;`</span><br>		Exp   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;exp&quot;`</span><br>		Name  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>		Admin <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;admin&quot;`</span><br>		Info  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;info&quot;`</span><br>	&#125;<br><br>	payload := Payload&#123;&#125;<br>	json.Unmarshal([]<span class="hljs-type">byte</span>(payloadBytes), &amp;payload)<br>	fmt.Printf(<span class="hljs-string">&quot;%#v&quot;</span>, payload)<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>signature</strong></p>
<p>JWT的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<ul>
<li>header (base64编码后的)</li>
<li>payload (base64编码后的)</li>
<li>secret 密钥</li>
</ul>
<p>这个部分需要base64加密后的header和base64加密后的payload使用<code>.</code>连接组成的字符串，然后通过header中声明的加密算法进行加盐<code>secret</code>组合加密，然后就构成了jwt的第三部分。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;crypto/hmac&quot;</span><br>	<span class="hljs-string">&quot;crypto/sha256&quot;</span><br>	<span class="hljs-string">&quot;encoding/base64&quot;</span><br>	<span class="hljs-string">&quot;encoding/hex&quot;</span><br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>	<span class="hljs-comment">// 头部</span><br>	header := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>		<span class="hljs-string">&quot;typ&quot;</span>: <span class="hljs-string">&quot;JWT&quot;</span>,<br>		<span class="hljs-string">&quot;alg&quot;</span>: <span class="hljs-string">&quot;HS256&quot;</span>,<br>	&#125;<br>	ret, _ := json.Marshal(header)<br>	headerString := base64.URLEncoding.EncodeToString(ret)<br>	fmt.Println(headerString)<br><br>	<span class="hljs-comment">// 载荷</span><br>	payload := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>		<span class="hljs-string">&quot;sub&quot;</span>:   <span class="hljs-string">&quot;1234567890&quot;</span>,<br>		<span class="hljs-string">&quot;exp&quot;</span>:   <span class="hljs-string">&quot;3422335555&quot;</span>,<br>		<span class="hljs-string">&quot;name&quot;</span>:  <span class="hljs-string">&quot;yuan&quot;</span>,<br>		<span class="hljs-string">&quot;admin&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>		<span class="hljs-string">&quot;info&quot;</span>:  <span class="hljs-string">&quot;123abc456&quot;</span>,<br>	&#125;<br>	ret, _ = json.Marshal(payload)<br><br>	<span class="hljs-comment">// base64编码</span><br>	payloadString := strings.TrimRight(base64.URLEncoding.EncodeToString(ret), <span class="hljs-string">&quot;=&quot;</span>)<br>	fmt.Println(payloadString)<br><br>	<span class="hljs-comment">// 签证</span><br>	<span class="hljs-comment">// HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret)</span><br>	secret := <span class="hljs-string">&quot;secret&quot;</span><br>	sign := fmt.Sprintf(<span class="hljs-string">&quot;%s.%s&quot;</span>, headerString, payloadString)<br>	key := []<span class="hljs-type">byte</span>(secret)<br>	h := hmac.New(sha256.New, key)<br>	h.Write([]<span class="hljs-type">byte</span>(sign))<br>	signature := hex.EncodeToString(h.Sum(<span class="hljs-literal">nil</span>))<br><br>	fmt.Printf(<span class="hljs-string">&quot;%s.%s.%s&quot;</span>, headerString, payloadString, signature)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>将这三部分用<code>.</code>连接成一个完整的字符串,构成了最终的jwt:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6IjEiLCJleHAiOiIzNDIyMzM1NTU1IiwiaW5mbyI6IjEyM2FiYzQ1NiIsIm5hbWUiOiJ5dWFuIiwic3ViIjoiMTIzNDU2Nzg5MCJ9.d7346bb5a519703477f400fc5e2eb5c341c79acce75b699f0aed0cbaf0e2fcfb<br></code></pre></td></tr></table></figure>

<p><strong>注意：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gfm">jwt的优点：<br>1. 实现分布式的单点登陆非常方便<br>2. 数据实际保存在客户端，所以我们可以分担服务端的存储压力<br>3. JWT不仅可用于认证，还可用于信息交换。善用JWT有助于减少服务器请求数据库的次数，jwt的构成非常简单，字节占用很小，所以它是非常便于传输的。<br><br>jwt的缺点：<br>1. 数据保存在了客户端，我们服务端只认jwt，不识别客户端。<br>2. jwt可以设置过期时间，但是因为数据保存在了客户端，所以对于过期时间不好调整。<br>3. 因为jwt发放以后保存在了客户端，而且验证过程中并没有到数据库查验用户的状态，所以会出现用户被删除了/被拉黑，依然可以通过token访问进来。<br><br># secret_key轻易不要改，一改所有客户端都要重新登录<br></code></pre></td></tr></table></figure>

<h2 id="3-5、go-jwt基本使用"><a href="#3-5、go-jwt基本使用" class="headerlink" title="3.5、go-jwt基本使用"></a>3.5、go-jwt基本使用</h2><h3 id="（1）go-jwt的基本功能测试"><a href="#（1）go-jwt的基本功能测试" class="headerlink" title="（1）go-jwt的基本功能测试"></a>（1）go-jwt的基本功能测试</h3><p><strong>关于签发和核验JWT，我们可以使用go-jwt包来完成。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/dgrijalva/jwt-go<br></code></pre></td></tr></table></figure>

<p><code>Test/jwt/main.go</code>，测试代码，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/dgrijalva/jwt-go&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// 消息提示常量</span><br><span class="hljs-keyword">const</span> (<br>	TokenExpired     = <span class="hljs-string">&quot;认证令牌过期！&quot;</span><br>	TokenNotValidYet = <span class="hljs-string">&quot;令牌尚未激活！&quot;</span><br>	TokenMalformed   = <span class="hljs-string">&quot;认证令牌格式有误！&quot;</span><br>	TokenInvalid     = <span class="hljs-string">&quot;无效的认证令牌！&quot;</span><br>)<br><br><span class="hljs-comment">// SecretKey 秘钥</span><br><span class="hljs-keyword">var</span> (<br>	SecretKey <span class="hljs-type">string</span> = <span class="hljs-string">&quot;secret&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">JWT</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> JWT <span class="hljs-keyword">struct</span> &#123;<br>	SigningKey []<span class="hljs-type">byte</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">载荷</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> PublicClaims <span class="hljs-keyword">struct</span> &#123;<br>	ID       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;id&quot;`</span><br>	Username <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;username&quot;`</span><br>	jwt.StandardClaims<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">新建一个jwt实例</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewJWT</span><span class="hljs-params">()</span></span> *JWT &#123;<br>	<span class="hljs-keyword">return</span> &amp;JWT&#123;<br>		[]<span class="hljs-type">byte</span>(GetSecretKey()),<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取SecretKey</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetSecretKey</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> SecretKey<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">生成一个AccessToken</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *JWT)</span></span> AccessToken(claims PublicClaims) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)<br>	<span class="hljs-keyword">return</span> token.SignedString(j.SigningKey)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">从Token中提取载荷</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *JWT)</span></span> GetPayloadByToken(tokenString <span class="hljs-type">string</span>) (*PublicClaims, <span class="hljs-type">error</span>) &#123;<br>	token, err := jwt.ParseWithClaims(tokenString, &amp;PublicClaims&#123;&#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>		<span class="hljs-keyword">return</span> j.SigningKey, <span class="hljs-literal">nil</span><br>	&#125;)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> ve, ok := err.(*jwt.ValidationError); ok &#123;<br>			<span class="hljs-keyword">if</span> ve.Errors&amp;jwt.ValidationErrorMalformed != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenMalformed)<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ve.Errors&amp;jwt.ValidationErrorExpired != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenExpired)<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ve.Errors&amp;jwt.ValidationErrorNotValidYet != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenNotValidYet)<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenInvalid)<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> claims, ok := token.Claims.(*PublicClaims); ok &amp;&amp; token.Valid &#123;<br>		<span class="hljs-keyword">return</span> claims, <span class="hljs-literal">nil</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenInvalid)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">更新token</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *JWT)</span></span> RefreshToken(tokenString <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	jwt.TimeFunc = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> time.Time &#123;<br>		<span class="hljs-keyword">return</span> time.Unix(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>	&#125;<br>	token, err := jwt.ParseWithClaims(tokenString, &amp;PublicClaims&#123;&#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>		<span class="hljs-keyword">return</span> j.SigningKey, <span class="hljs-literal">nil</span><br>	&#125;)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">if</span> claims, ok := token.Claims.(*PublicClaims); ok &amp;&amp; token.Valid &#123;<br>		jwt.TimeFunc = time.Now<br>		<span class="hljs-built_in">println</span>(time.Now().Add(<span class="hljs-number">1</span> * time.Hour).Unix())<br>		claims.StandardClaims.ExpiresAt = time.Now().Add(<span class="hljs-number">1</span> * time.Hour).Unix()<br>		<span class="hljs-keyword">return</span> j.AccessToken(*claims)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, errors.New(TokenInvalid)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	publicClaims := PublicClaims&#123;<br>		ID:       <span class="hljs-string">&quot;1&quot;</span>,<br>		Username: <span class="hljs-string">&quot;yuan&quot;</span>,<br>	&#125;<br>	newJwt := NewJWT()<br>	token, _ := newJwt.AccessToken(publicClaims)<br>	<span class="hljs-built_in">println</span>(token)<br><br>	refreshToken, _ := newJwt.RefreshToken(token)<br>	fmt.Println(<span class="hljs-string">&quot;refresh token:&quot;</span>, refreshToken)<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>接下来，把jwt集成到项目中即可在用户注册或登录成功后，返回token即可。</p>
<h3 id="（2）基于go-jwt的jwt包封装"><a href="#（2）基于go-jwt的jwt包封装" class="headerlink" title="（2）基于go-jwt的jwt包封装"></a>（2）基于go-jwt的jwt包封装</h3><p>新增配置项，把秘钥设置为配置信息，<code>bingo_api/application/config/config.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;github.com/dgrijalva/jwt-go&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>)<br><br><span class="hljs-comment">// ... 代码省略</span><br><span class="hljs-comment">// ... 代码省略</span><br><span class="hljs-comment">// ... 代码省略</span><br><br><span class="hljs-comment">// Config 整个项目的配置</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>	Mode                <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;mode&quot;`</span><br>	Port                <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;port&quot;`</span><br>	SecretKey           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;secret_key&quot;`</span><br>	*LogConfig          <span class="hljs-string">`json:&quot;log&quot;`</span><br>	*DatabaseConfig     <span class="hljs-string">`json:&quot;database&quot;`</span><br>	*jwt.StandardClaims <span class="hljs-string">`json:&quot;jwt&quot;`</span><br>&#125;<br><span class="hljs-comment">// ... 代码省略</span><br><span class="hljs-comment">// ... 代码省略</span><br><span class="hljs-comment">// ... 代码省略</span><br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/config.json</code>，代码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debug&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8000</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-comment">// 代码省略...</span><br>  <span class="hljs-attr">&quot;secret_key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Ub=~sV,U1QXmvHObh_My6#6-O9&gt;&#125;zK&#123;8&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;jwt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;exp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1800</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/utils/jwt.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;github.com/dgrijalva/jwt-go&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>)<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">JWT基本结构体</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> JWT <span class="hljs-keyword">struct</span> &#123;<br>	SigningKey []<span class="hljs-type">byte</span><br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 载荷</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">type</span> PublicClaims <span class="hljs-keyword">struct</span> &#123;<br>	ID         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;id&quot;`</span><br>	Username   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;username&quot;`</span><br>	Nickname   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nickname&quot;`</span><br>	Avatar     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar&quot;`</span><br>	jwt.StandardClaims<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">新建一个jwt实例</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewJWT</span><span class="hljs-params">()</span></span> *JWT &#123;<br>	<span class="hljs-keyword">return</span> &amp;JWT&#123;<br>		[]<span class="hljs-type">byte</span>(config.Conf.SecretKey),<br>	&#125;<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">生成一个AccessToken</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *JWT)</span></span> AccessToken(claims PublicClaims) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">// 获取当前时间</span><br>	now := time.Now()<br>	<span class="hljs-comment">// 获取当前时间的Unix时间戳</span><br>	nowAt := now.Unix()<br>	<span class="hljs-comment">// 设置token的签发时间</span><br>	claims.IssuedAt = nowAt<br>	<span class="hljs-comment">// 设置jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br>	claims.Id = uuid4()<br>	<span class="hljs-comment">// 判断：如果配置项中有设置token的过期时间</span><br>	<span class="hljs-keyword">if</span> config.Conf.ExpiresAt &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// 则在token的载荷信息中记录，当前token的起用时间和过期时间</span><br>		expAt := now.Add(time.Duration(config.Conf.ExpiresAt) * time.Second).Unix()<br>		claims.ExpiresAt = expAt<br>		claims.NotBefore = nowAt<br>	&#125;<br>	<span class="hljs-comment">// 判断：如果配置中有设置token的起用时间</span><br>	<span class="hljs-keyword">if</span> config.Conf.NotBefore &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// 则在token的载荷信息中记录，当前token的起用时间</span><br>		nbfAt := now.Add(time.Duration(config.Conf.NotBefore) * time.Second).Unix()<br>		claims.NotBefore = nbfAt<br>	&#125;<br><br>	token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)<br>	<span class="hljs-keyword">return</span> token.SignedString(j.SigningKey)<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">从Token中提取载荷</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *JWT)</span></span> GetPayloadByToken(tokenString <span class="hljs-type">string</span>) (*PublicClaims, <span class="hljs-type">error</span>) &#123;<br>	token, err := jwt.ParseWithClaims(tokenString, &amp;PublicClaims&#123;&#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>		<span class="hljs-keyword">return</span> j.SigningKey, <span class="hljs-literal">nil</span><br>	&#125;)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> ve, ok := err.(*jwt.ValidationError); ok &#123;<br>			<span class="hljs-keyword">if</span> ve.Errors&amp;jwt.ValidationErrorMalformed != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenIsMalformed)<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ve.Errors&amp;jwt.ValidationErrorExpired != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenIsExpired)<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ve.Errors&amp;jwt.ValidationErrorNotValidYet != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenIsNotValidYet)<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenIsInvalid)<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> claims, ok := token.Claims.(*PublicClaims); ok &amp;&amp; token.Valid &#123;<br>		<span class="hljs-keyword">return</span> claims, <span class="hljs-literal">nil</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(TokenIsInvalid)<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">更新token</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *JWT)</span></span> RefreshToken(tokenString <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	jwt.TimeFunc = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> time.Time &#123;<br>		<span class="hljs-keyword">return</span> time.Unix(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>	&#125;<br>	token, err := jwt.ParseWithClaims(tokenString, &amp;PublicClaims&#123;&#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>		<span class="hljs-keyword">return</span> j.SigningKey, <span class="hljs-literal">nil</span><br>	&#125;)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">if</span> claims, ok := token.Claims.(*PublicClaims); ok &amp;&amp; token.Valid &#123;<br>		jwt.TimeFunc = time.Now<br>		<span class="hljs-built_in">println</span>(time.Now().Add(<span class="hljs-number">1</span> * time.Hour).Unix())<br>		claims.StandardClaims.ExpiresAt = time.Now().Add(<span class="hljs-number">1</span> * time.Hour).Unix()<br>		<span class="hljs-keyword">return</span> j.AccessToken(*claims)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, errors.New(TokenIsInvalid)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>声明错误提示的常量，<code>bingo_api/application/constants/message.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-keyword">const</span> (<br>	Success           = <span class="hljs-string">&quot;成功！&quot;</span><br>	CreateUserFail    = <span class="hljs-string">&quot;创建用户失败！&quot;</span><br>	CreateUserSuccess = <span class="hljs-string">&quot;创建用户成功！&quot;</span><br>	NoSuchUser        = <span class="hljs-string">&quot;用户不存在！&quot;</span><br>	PasswordError     = <span class="hljs-string">&quot;密码错误！&quot;</span><br><br>	TokenIsExpired     = <span class="hljs-string">&quot;认证令牌过期！&quot;</span><br>	TokenIsNotValidYet = <span class="hljs-string">&quot;令牌尚未激活！&quot;</span><br>	TokenIsMalformed   = <span class="hljs-string">&quot;认证令牌格式有误！&quot;</span><br>	TokenIsInvalid     = <span class="hljs-string">&quot;无效的认证令牌！&quot;</span><br>)<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/constants/code.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-keyword">const</span> (<br>	CodeSuccess        = <span class="hljs-number">0</span>    <span class="hljs-comment">// 成功！</span><br>	CodeFail           = <span class="hljs-number">-1</span>   <span class="hljs-comment">// 失败！</span><br>	CodeAuthticateFail = <span class="hljs-number">-2</span>   <span class="hljs-comment">// 认证失败！</span><br>	CodeCreateUserFail = <span class="hljs-number">1001</span> <span class="hljs-comment">// 创建用户失败！</span><br>	CodeNoSuchUser     = <span class="hljs-number">1002</span> <span class="hljs-comment">// 当前用户不存在</span><br>)<br></code></pre></td></tr></table></figure>

<p>声明一个辅助函数，用于生成UUID格式字符串，提供给jwt的载荷。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/satori/go.uuid<br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/utils/string.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	uuid <span class="hljs-string">&quot;github.com/satori/go.uuid&quot;</span><br>	<span class="hljs-string">&quot;golang.org/x/crypto/bcrypt&quot;</span><br>	<span class="hljs-string">&quot;math/rand&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>)<br><br><span class="hljs-comment">// 代码省略...</span><br><span class="hljs-comment">// 代码省略...</span><br><span class="hljs-comment">// 代码省略...</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 生成UUID4</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">uuid4</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s&quot;</span>, uuid.NewV4())<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>生成token接口测试</strong></p>
<p><code>services/user.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserLogin</span><span class="hljs-params">(ctx *gin.Context)</span></span> (user User, err <span class="hljs-type">error</span>) &#123;<br>	user = User&#123;&#125;<br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;user); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> user, err<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> err = validator.UserValidator(&amp;user); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> user, err<br>	&#125;<br><br>	user.GetOneByAccount(user.Username)<br>	<span class="hljs-keyword">if</span> user.ID &lt; <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span> user, errors.New(constants.NoSuchUser)<br>	&#125;<br><br>	ret := CheckPassword(user.HashPassword, user.Password)<br><br>	<span class="hljs-keyword">if</span> !ret &#123;<br>		err = errors.New(constants.PasswordError)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/api/user.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> api<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;strconv&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/services&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>)<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">用户认证登陆</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserAuthenticate</span><span class="hljs-params">(ctx *gin.Context)</span></span>&#123;<br><br>	<span class="hljs-comment">// 用户登陆认证业务</span><br>	user, err := UserLogin(ctx)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || user.ID &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusOK, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeNoSuchUser,<br>			<span class="hljs-string">&quot;message&quot;</span>: constants.NoSuchUser+err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">// 生成token</span><br>	newJwt := NewJWT()<br>	publicClaims := PublicClaims &#123;<br>		ID: strconv.Itoa(<span class="hljs-type">int</span>(user.ID)),<br>		Username: user.Username,<br>		Nickname: user.Nickname,<br>		Avatar  : user.Avatar,<br>	&#125;<br><br>	token, err := newJwt.AccessToken(publicClaims)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br><br>	ctx.JSON(http.StatusCreated, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>: constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;token&quot;</span>: token,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br><br><span class="hljs-comment">// 代码省略...</span><br><span class="hljs-comment">// 代码省略...</span><br><span class="hljs-comment">// 代码省略...</span><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230903135521988-3720523.png" srcset="/img/loading.gif" lazyload alt="image-20230903135521988"></p>
<p><strong>验证token</strong></p>
<p>声明中间件用于验证JWT token 的合法性（有效期、格式）。</p>
<p><code>bingo_api/application/middleware/jwt.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> middleware<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br><span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>)<br><br><span class="hljs-comment">// JWTAuthorization 验证token</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">JWTAuthorization</span><span class="hljs-params">()</span></span> gin.HandlerFunc &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>		token := c.Request.Header.Get(<span class="hljs-string">&quot;Authorization&quot;</span>)<br>		<span class="hljs-keyword">if</span> token == <span class="hljs-string">&quot;&quot;</span> &#123;<br>			c.JSON(http.StatusOK, gin.H&#123;<br>				<span class="hljs-string">&quot;code&quot;</span>: constants.CodeAuthticateFail,<br>				<span class="hljs-string">&quot;message&quot;</span>: constants.TokenIsInvalid,<br>			&#125;)<br>			c.Abort()<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		zap.S().Debugf(<span class="hljs-string">&quot;get token: %#v&quot;</span>, token)<br><br>		j := NewJWT()<br>		<span class="hljs-comment">// parseToken 解析token包含的信息</span><br>		claims, err := j.GetPayloadByToken(token)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			c.JSON(http.StatusOK, gin.H&#123;<br>				<span class="hljs-string">&quot;code&quot;</span>: constants.CodeAuthticateFail,<br>				<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>			&#125;)<br>			c.Abort()<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		<span class="hljs-comment">// 存储认证的载荷信息和token，保留至后面使用。</span><br>		c.Set(<span class="hljs-string">&quot;claims&quot;</span>, claims)<br>		c.Set(<span class="hljs-string">&quot;access_token&quot;</span>, token)<br>		c.Next()<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>测试，给之前声明的创建用户的接口，加上token验证中间件。</p>
<p>在 <code>initialize/router.go</code>中设置jwt验证中间件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 注册中间件</span><br>Router.Use(middleware.JWTAuthorization(), middleware.GinLogger(), middleware.GinRecovery(<span class="hljs-literal">true</span>))<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这是全局中间件，像登录这样的请求不可能有token的，所以不要设置全局</p>
</blockquote>
<p>比如我们给创建用户时添加token验证，在bingo_api&#x2F;application&#x2F;router&#x2F;user.go，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br><br>	<span class="hljs-string">&quot;bingo_api/application/api&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitUserRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	用户相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	UserRouter := Router.Group(<span class="hljs-string">&quot;user&quot;</span>)<br>  <span class="hljs-comment">// UserRouter.Use(middleware.JWTAuthorization())</span><br>	&#123;<br>		<span class="hljs-comment">// 用户认证登陆</span><br>		utils.Register(UserRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;authenticate&quot;</span>, api.UserAuthenticate)<br>		<span class="hljs-comment">// 用户创建</span><br>		<span class="hljs-comment">// utils.Register(UserRouter, []string&#123;&quot;POST&quot;&#125;, &quot;&quot;, api.UserCreate)</span><br>		utils.Register(UserRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, middleware.JWTAuthorization(), api.UserCreate)<br>	&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>通过postman测试，可以发现，Token认证中间件正常工作。</p>
<p><img src="/pages_images/Bingo/image-20221217225956923-5475165.png" srcset="/img/loading.gif" lazyload alt="image-20221217225956923"></p>
<h2 id="3-6、token本地存储"><a href="#3-6、token本地存储" class="headerlink" title="3.6、token本地存储"></a>3.6、token本地存储</h2><p>如果要在项目中使用axios进行ajax请求，肯定需要在新建一个axios的初始化脚本文件<code>src/utils/http.js</code>中进行初始化配置。</p>
<p>axios的初始化配置一般包括以下3部分：</p>
<ol>
<li>创建axios请求实例对象</li>
<li>配置baseURL设置整个站点ajax请求的api服务端站点公共地址</li>
<li>配置axios请求拦截器和响应拦截器。</li>
</ol>
<p><code>src/utils/http.js</code>，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;axios&quot;</span><br><br><span class="hljs-keyword">const</span> http = axios.<span class="hljs-title function_">create</span>(&#123;<br>    <span class="hljs-comment">// timeout: 2500,                          // 请求超时，有大文件上传需要关闭这个配置</span><br>    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&quot;http://api.bingo.cn:8080/api&quot;</span>,     <span class="hljs-comment">// 设置api服务端的默认地址[如果基于服务端实现的跨域，这里可以填写api服务端的地址，如果基于nodejs客户端测试服务器实现的跨域，则这里不能填写api服务端地址]</span><br>    <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">false</span>,                    <span class="hljs-comment">// 是否允许客户端ajax请求时携带cookie</span><br>&#125;)<br><br><span class="hljs-comment">// 请求拦截器</span><br>http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;http请求之前&quot;</span>);<br>    <span class="hljs-keyword">return</span> config;<br>&#125;, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;http请求错误&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>&#125;);<br><br><span class="hljs-comment">// 响应拦截器</span><br>http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;服务端响应数据成功以后，返回结果给客户端的第一时间，执行then之前&quot;</span>);<br>    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === -<span class="hljs-number">2</span>) &#123;<br>        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;/login&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> response;<br>&#125;, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;服务端响应错误内容的时候。...&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> http;<br></code></pre></td></tr></table></figure>

<p><code>Login.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;login box&quot;&gt;<br>    &lt;img src=&quot;./pages_images/Bingo/login.jpg&quot; alt=&quot;&quot;&gt;<br>    &lt;div class=&quot;login&quot;&gt;<br>      &lt;div class=&quot;login-title&quot;&gt;<br>        &lt;p class=&quot;hi&quot;&gt;Hello,bingo!&lt;/p&gt;<br>      &lt;/div&gt;<br>      &lt;div class=&quot;login_box&quot;&gt;<br>        &lt;div class=&quot;title&quot;&gt;<br>          &lt;span&gt;登录&lt;/span&gt;<br>        &lt;/div&gt;<br>        &lt;div class=&quot;inp&quot;&gt;<br>          &lt;a-input v-model:value=&quot;user.account&quot; type=&quot;text&quot; placeholder=&quot;用户名&quot; class=&quot;user&quot;&gt;&lt;/a-input&gt;<br>          &lt;a-input v-model:value=&quot;user.password&quot; type=&quot;password&quot; class=&quot;pwd&quot; placeholder=&quot;密码&quot;&gt;&lt;/a-input&gt;<br>          &lt;div class=&quot;rember&quot;&gt;<br>            &lt;p&gt;<br>              &lt;a-checkbox v-model:checked=&quot;user.remember&quot;&gt;记住密码&lt;/a-checkbox&gt;<br>            &lt;/p&gt;<br>          &lt;/div&gt;<br>          &lt;button class=&quot;login_btn&quot; @click=&quot;loginHandler&quot;&gt;登录&lt;/button&gt;<br><br>        &lt;/div&gt;<br><br>      &lt;/div&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import http from &quot;../http&quot;<br>import &#123;reactive&#125; from &quot;vue&quot;<br>import &#123;message&#125; from &#x27;ant-design-vue&#x27;;<br>import router from &#x27;../router/index.js&#x27;<br><br><br>const user = reactive(&#123;<br>  account: &quot;&quot;,  // 登录账号/手机号/邮箱<br>  password: &quot;&quot;, // 登录密码<br>  remember: false, // 是否记住登录状态<br>  login() &#123;<br>    // 用户登录<br>    return http.post(&quot;/user/authenticate&quot;, &#123;<br>      &quot;username&quot;: this.account,<br>      &quot;password&quot;: this.password,<br>    &#125;)<br>  &#125;<br>&#125;)<br><br>const loginHandler = () =&gt; &#123;<br>  user.login().then((response) =&gt; &#123;<br>    // 先清空原有的token<br>    localStorage.removeItem(&quot;token&quot;);<br>    sessionStorage.removeItem(&quot;token&quot;);<br><br>    if (response.data.code === 0) &#123;<br>      if (user.remember) &#123;<br>        // 记住登录<br>        localStorage.token = response.data.data.token;<br>      &#125; else &#123;<br>        sessionStorage.token = response.data.data.token;<br>      &#125;<br>      // 跳转到首页<br><br>      message.success(&#123;<br>        duration: 0.8,<br>        content: `登录成功！`,<br>        onClose() &#123;<br>          router.push(&quot;/bingo/&quot;)<br>        &#125;<br>      &#125;)<br>    &#125; else &#123;<br>      message.error(&#x27;用户名或者密码有误，请重新输入！&#x27;);<br>    &#125;<br><br>  &#125;)<br>&#125;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.login .hi &#123;<br>  font-size: 20px;<br>  font-family: &quot;Times New Roman&quot;;<br>  font-style: italic;<br>&#125;<br><br>.box &#123;<br>  width: 100%;<br>  height: 100%;<br>  position: relative;<br>  overflow: hidden;<br>&#125;<br><br>.box img &#123;<br>  width: 100%;<br>  min-height: 100%;<br>&#125;<br><br>.box .login &#123;<br>  position: absolute;<br>  width: 500px;<br>  height: 400px;<br>  left: 0;<br>  margin: auto;<br>  right: 0;<br>  bottom: 0;<br>  top: -338px;<br>&#125;<br><br>.login .login-title &#123;<br>  width: 100%;<br>  text-align: center;<br>&#125;<br><br>.login-title img &#123;<br>  width: 190px;<br>  height: auto;<br>&#125;<br><br>.login-title p &#123;<br>  font-size: 18px;<br>  color: #fff;<br>  letter-spacing: .29px;<br>  padding-top: 10px;<br>  padding-bottom: 50px;<br>&#125;<br><br>.login_box &#123;<br>  width: 400px;<br>  height: auto;<br>  background: rgba(255, 255, 255, 0.3);<br>  box-shadow: 0 2px 4px 0 rgba(0, 0, 0, .5);<br>  border-radius: 4px;<br>  margin: 0 auto;<br>  padding-bottom: 40px;<br>&#125;<br><br>.login_box .title &#123;<br>  font-size: 20px;<br>  color: #9b9b9b;<br>  letter-spacing: .32px;<br>  border-bottom: 1px solid #e6e6e6;<br>  display: flex;<br>  justify-content: space-around;<br>  padding: 50px 60px 0 60px;<br>  margin-bottom: 20px;<br>  cursor: pointer;<br>&#125;<br><br>.login_box .title span:nth-of-type(1) &#123;<br>  color: #4a4a4a;<br>  border-bottom: 2px solid #396fcc;<br>&#125;<br><br>.inp &#123;<br>  width: 350px;<br>  margin: 0 auto;<br>&#125;<br><br>.inp input &#123;<br>  outline: 0;<br>  width: 100%;<br>  height: 45px;<br>  border-radius: 4px;<br>  border: 1px solid #d9d9d9;<br>  text-indent: 20px;<br>  font-size: 14px;<br>  background: #fff !important;<br>&#125;<br><br>.inp input.user &#123;<br>  margin-bottom: 16px;<br>&#125;<br><br>.inp .rember &#123;<br>  display: flex;<br>  justify-content: space-between;<br>  align-items: center;<br>  position: relative;<br>  margin-top: 10px;<br>&#125;<br><br>.inp .rember p:first-of-type &#123;<br>  font-size: 12px;<br>  color: #4a4a4a;<br>  letter-spacing: .19px;<br>  margin-left: 22px;<br>  display: -ms-flexbox;<br>  display: flex;<br>  -ms-flex-align: center;<br>  align-items: center;<br>  /*position: relative;*/<br>&#125;<br><br>.inp .rember p:nth-of-type(2) &#123;<br>  font-size: 14px;<br>  color: #9b9b9b;<br>  letter-spacing: .19px;<br>  cursor: pointer;<br>&#125;<br><br>.inp .rember input &#123;<br>  outline: 0;<br>  width: 30px;<br>  height: 45px;<br>  border-radius: 4px;<br>  border: 1px solid #d9d9d9;<br>  text-indent: 20px;<br>  font-size: 14px;<br>  background: #fff !important;<br>&#125;<br><br>.inp .rember p span &#123;<br>  display: inline-block;<br>  font-size: 12px;<br>  width: 100px;<br>  /*position: absolute;*/<br>  /*left: 20px;*/<br><br>&#125;<br><br>#geetest &#123;<br>  margin-top: 20px;<br>&#125;<br><br>.login_btn &#123;<br>  width: 100%;<br>  height: 45px;<br>  background: #396fcc;<br>  border-radius: 5px;<br>  font-size: 16px;<br>  color: #fff;<br>  letter-spacing: .26px;<br>  margin-top: 30px;<br>&#125;<br><br>.inp .go_login &#123;<br>  text-align: center;<br>  font-size: 14px;<br>  color: #9b9b9b;<br>  letter-spacing: .26px;<br>  padding-top: 20px;<br>&#125;<br><br>.inp .go_login span &#123;<br>  color: #84cc39;<br>  cursor: pointer;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<h2 id="3-7、封装token管理文件"><a href="#3-7、封装token管理文件" class="headerlink" title="3.7、封装token管理文件"></a>3.7、封装token管理文件</h2><p>一般情况下，我们会在js文件中存放一些需要在多个界面中进行共享的信息。比如用户的登录状态、用户名称、头像、地理位置信息、商品的收藏、购物车中的物品等，这些状态信息，我们可以放在统一的地方，对它进行保存和管理。</p>
<p><code>Login.vue</code>中调用storage.js中的方法管理token</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;login box&quot;&gt;<br>    &lt;img src=&quot;./pages_images/Bingo/login.jpg&quot; alt=&quot;&quot;&gt;<br>    &lt;div class=&quot;login&quot;&gt;<br>      &lt;div class=&quot;login-title&quot;&gt;<br>        &lt;p class=&quot;hi&quot;&gt;Hello,bingo!&lt;/p&gt;<br>      &lt;/div&gt;<br>      &lt;div class=&quot;login_box&quot;&gt;<br>        &lt;div class=&quot;title&quot;&gt;<br>          &lt;span&gt;登录&lt;/span&gt;<br>        &lt;/div&gt;<br>        &lt;div class=&quot;inp&quot;&gt;<br>          &lt;a-input v-model:value=&quot;user.account&quot; type=&quot;text&quot; placeholder=&quot;用户名&quot; class=&quot;user&quot;&gt;&lt;/a-input&gt;<br>          &lt;a-input v-model:value=&quot;user.password&quot; type=&quot;password&quot; class=&quot;pwd&quot; placeholder=&quot;密码&quot;&gt;&lt;/a-input&gt;<br>          &lt;div class=&quot;rember&quot;&gt;<br>            &lt;p&gt;<br>              &lt;a-checkbox v-model:checked=&quot;user.remember&quot;&gt;记住密码&lt;/a-checkbox&gt;<br>            &lt;/p&gt;<br>          &lt;/div&gt;<br>          &lt;button class=&quot;login_btn&quot; @click=&quot;loginHandler&quot;&gt;登录&lt;/button&gt;<br><br>        &lt;/div&gt;<br><br>      &lt;/div&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import http from &quot;../http&quot;<br>import &#123;reactive&#125; from &quot;vue&quot;<br>import &#123;message&#125; from &#x27;ant-design-vue&#x27;;<br>import router from &#x27;@/router/index.js&#x27;<br>import storage from &#x27;@/utils/storage.js&#x27;<br><br><br>const user = reactive(&#123;<br>  account: &quot;&quot;,  // 登录账号/手机号/邮箱<br>  password: &quot;&quot;, // 登录密码<br>  remember: false, // 是否记住登录状态<br>  login() &#123;<br>    // 用户登录<br>    return http.post(&quot;/user/authenticate&quot;, &#123;<br>      &quot;username&quot;: this.account,<br>      &quot;password&quot;: this.password,<br>    &#125;)<br>  &#125;<br>&#125;)<br><br>const loginHandler = () =&gt; &#123;<br>  user.login().then((response) =&gt; &#123;<br>    <br>    if (response.data.code === 0) &#123;<br>      // vuex存储用户登录信息，保存token<br>      storage.tokenHandle(response.data.data.token)<br><br>      // 跳转到首页<br>      message.success(&#123;<br>        duration: 0.8,<br>        content: `登录成功！`,<br>        onClose() &#123;<br>          router.push(&quot;/bingo/&quot;)<br>        &#125;<br>      &#125;)<br>    &#125; else &#123;<br>      message.error(&#x27;用户名或者密码有误，请重新输入！&#x27;);<br>    &#125;<br><br>  &#125;)<br>&#125;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.login .hi &#123;<br>  font-size: 20px;<br>  font-family: &quot;Times New Roman&quot;;<br>  font-style: italic;<br>&#125;<br><br>.box &#123;<br>  width: 100%;<br>  height: 100%;<br>  position: relative;<br>  overflow: hidden;<br>&#125;<br><br>.box img &#123;<br>  width: 100%;<br>  min-height: 100%;<br>&#125;<br><br>.box .login &#123;<br>  position: absolute;<br>  width: 500px;<br>  height: 400px;<br>  left: 0;<br>  margin: auto;<br>  right: 0;<br>  bottom: 0;<br>  top: -338px;<br>&#125;<br><br>.login .login-title &#123;<br>  width: 100%;<br>  text-align: center;<br>&#125;<br><br>.login-title img &#123;<br>  width: 190px;<br>  height: auto;<br>&#125;<br><br>.login-title p &#123;<br>  font-size: 18px;<br>  color: #fff;<br>  letter-spacing: .29px;<br>  padding-top: 10px;<br>  padding-bottom: 50px;<br>&#125;<br><br>.login_box &#123;<br>  width: 400px;<br>  height: auto;<br>  background: rgba(255, 255, 255, 0.3);<br>  box-shadow: 0 2px 4px 0 rgba(0, 0, 0, .5);<br>  border-radius: 4px;<br>  margin: 0 auto;<br>  padding-bottom: 40px;<br>&#125;<br><br>.login_box .title &#123;<br>  font-size: 20px;<br>  color: #9b9b9b;<br>  letter-spacing: .32px;<br>  border-bottom: 1px solid #e6e6e6;<br>  display: flex;<br>  justify-content: space-around;<br>  padding: 50px 60px 0 60px;<br>  margin-bottom: 20px;<br>  cursor: pointer;<br>&#125;<br><br>.login_box .title span:nth-of-type(1) &#123;<br>  color: #4a4a4a;<br>  border-bottom: 2px solid #396fcc;<br>&#125;<br><br>.inp &#123;<br>  width: 350px;<br>  margin: 0 auto;<br>&#125;<br><br>.inp input &#123;<br>  outline: 0;<br>  width: 100%;<br>  height: 45px;<br>  border-radius: 4px;<br>  border: 1px solid #d9d9d9;<br>  text-indent: 20px;<br>  font-size: 14px;<br>  background: #fff !important;<br>&#125;<br><br>.inp input.user &#123;<br>  margin-bottom: 16px;<br>&#125;<br><br>.inp .rember &#123;<br>  display: flex;<br>  justify-content: space-between;<br>  align-items: center;<br>  position: relative;<br>  margin-top: 10px;<br>&#125;<br><br>.inp .rember p:first-of-type &#123;<br>  font-size: 12px;<br>  color: #4a4a4a;<br>  letter-spacing: .19px;<br>  margin-left: 22px;<br>  display: -ms-flexbox;<br>  display: flex;<br>  -ms-flex-align: center;<br>  align-items: center;<br>  /*position: relative;*/<br>&#125;<br><br>.inp .rember p:nth-of-type(2) &#123;<br>  font-size: 14px;<br>  color: #9b9b9b;<br>  letter-spacing: .19px;<br>  cursor: pointer;<br>&#125;<br><br>.inp .rember input &#123;<br>  outline: 0;<br>  width: 30px;<br>  height: 45px;<br>  border-radius: 4px;<br>  border: 1px solid #d9d9d9;<br>  text-indent: 20px;<br>  font-size: 14px;<br>  background: #fff !important;<br>&#125;<br><br>.inp .rember p span &#123;<br>  display: inline-block;<br>  font-size: 12px;<br>  width: 100px;<br>  /*position: absolute;*/<br>  /*left: 20px;*/<br><br>&#125;<br><br>#geetest &#123;<br>  margin-top: 20px;<br>&#125;<br><br>.login_btn &#123;<br>  width: 100%;<br>  height: 45px;<br>  background: #396fcc;<br>  border-radius: 5px;<br>  font-size: 16px;<br>  color: #fff;<br>  letter-spacing: .26px;<br>  margin-top: 30px;<br>&#125;<br><br>.inp .go_login &#123;<br>  text-align: center;<br>  font-size: 14px;<br>  color: #9b9b9b;<br>  letter-spacing: .26px;<br>  padding-top: 20px;<br>&#125;<br><br>.inp .go_login span &#123;<br>  color: #84cc39;<br>  cursor: pointer;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>在<code>src/utils</code>中创建storage.js文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> storage = &#123;<br>    <span class="hljs-attr">state</span>: &#123;<br>        <span class="hljs-attr">user</span>: &#123;&#125;,<br>        <span class="hljs-attr">token</span>: <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-attr">remember</span>: <span class="hljs-literal">false</span><br>    &#125;,<br>    <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;this.state.token:::&quot;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>)<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">token</span> === <span class="hljs-string">&quot;&quot;</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        &#125;<br>        <span class="hljs-keyword">let</span> payload = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">token</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>]  <span class="hljs-comment">// 载荷</span><br>        <span class="hljs-keyword">let</span> payload_data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title function_">atob</span>(payload)) <span class="hljs-comment">// 用户信息</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;payload_data:::&quot;</span>, payload_data)<br>        <span class="hljs-comment">// 从jwt的载荷中提取用户信息</span><br>        <span class="hljs-keyword">let</span> now = <span class="hljs-built_in">parseInt</span>((<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() - <span class="hljs-number">0</span>) / <span class="hljs-number">1000</span>);<br>        <span class="hljs-keyword">if</span> (payload_data.<span class="hljs-property">exp</span> === <span class="hljs-literal">undefined</span>) &#123;<br>            <span class="hljs-comment">// 没登录</span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearStorage</span>()<br>            <span class="hljs-keyword">return</span> &#123;&#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">parseInt</span>(payload_data.<span class="hljs-property">exp</span>) &lt; now) &#123;<br>            <span class="hljs-comment">// 过期处理</span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearStorage</span>()<br>            <span class="hljs-keyword">return</span> &#123;&#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> payload_data;<br>    &#125;,<br>    <span class="hljs-title function_">tokenHandle</span>(<span class="hljs-params">token</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">token</span> = token;<br>        <span class="hljs-comment">// 解析token，获取用户载荷</span><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">user</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUserInfo</span>()<br>        <span class="hljs-comment">// 同步本地存储</span><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setStorage</span>()<br><br>    &#125;,<br>    <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;login&#x27;</span>,<br>    <span class="hljs-title function_">setStorage</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">remember</span>) &#123;<br>            <span class="hljs-variable language_">localStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable language_">sessionStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>)<br>        &#125;<br>    &#125;,<br>    <span class="hljs-title function_">getStorage</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;localStorage[this.key]:::&quot;</span>, <span class="hljs-variable language_">localStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>])<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;sessionStorage[this.key]:::&quot;</span>, <span class="hljs-variable language_">sessionStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>])<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">localStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] === <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-variable language_">sessionStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] === <span class="hljs-literal">undefined</span>) &#123;<br>            <span class="hljs-keyword">return</span> &#123;&#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">localStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]) &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>])<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">sessionStorage</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>])<br>        &#125;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;state:::&quot;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>)<br>    &#125;,<br>    <span class="hljs-title function_">clearStorage</span>(<span class="hljs-params"></span>) &#123;<br><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = &#123;<br>            <span class="hljs-attr">user</span>: &#123;&#125;,<br>            <span class="hljs-attr">token</span>: <span class="hljs-string">&quot;&quot;</span>,<br>            <span class="hljs-attr">remember</span>: <span class="hljs-literal">false</span><br>        &#125;<br>        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>)<br>        <span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>)<br><br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> storage<br></code></pre></td></tr></table></figure>

<h2 id="3-8、路由守卫"><a href="#3-8、路由守卫" class="headerlink" title="3.8、路由守卫"></a>3.8、路由守卫</h2><p>完成了登录功能以后，我们要防止用户翻墙访问需要认证身份的页面时，可以基于vue-router的导航守卫来完成。</p>
<p>没有登陆状态，没有token的用户无法进入项目站点，<code>src/router/index.js</code>，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123;createRouter, createWebHistory&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><span class="hljs-keyword">import</span> storage <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../utils/storage&quot;</span>;<br><br><span class="hljs-keyword">const</span> routes = [<br><br>    &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/bingo&#x27;</span>,<br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Base&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Base.vue&quot;</span>),<br>        <span class="hljs-attr">children</span>: [<br>            &#123;<br>                <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>                <span class="hljs-attr">meta</span>: &#123;<br>                    <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;面板管理&quot;</span>,<br>                    <span class="hljs-attr">authorization</span>: <span class="hljs-literal">false</span><br>                &#125;,<br>                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;bingo&#x27;</span>,<br>                <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Bingo.vue&quot;</span>)<br>            &#125;,<br>            &#123;<br>                <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;manage/host&#x27;</span>,<br>                <span class="hljs-attr">meta</span>: &#123;<br>                    <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;主机管理&quot;</span>,<br>                    <span class="hljs-attr">authorization</span>: <span class="hljs-literal">true</span><br>                &#125;,<br>                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;host&#x27;</span>,<br>                <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Host.vue&quot;</span>)<br>            &#125;,<br>        ]<br>    &#125;,<br><br>    &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>        <span class="hljs-attr">meta</span>: &#123;<br>            <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;账户登陆&#x27;</span>,<br>            <span class="hljs-attr">authorization</span>: <span class="hljs-literal">false</span><br>        &#125;,<br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;login&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;../views/Login.vue&quot;</span>)<br>    &#125;,<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>    <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),<br>    routes<br>&#125;);<br><br><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;from:&quot;</span>, <span class="hljs-keyword">from</span>)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;to:&quot;</span>, to)<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span><br>    storage.<span class="hljs-title function_">getStorage</span>()<br><br><br>    <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>.<span class="hljs-property">authorization</span> &amp;&amp; !storage.<span class="hljs-title function_">getUserInfo</span>()) &#123;<br>        <span class="hljs-title function_">next</span>(&#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;login&quot;</span>&#125;)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_">next</span>()<br>    &#125;<br>&#125;);<br><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure>

<p>本地拿到token以后，我们发送任何需要登录之后才能发送的请求，都需要先对token的有效性进行认证，然后将token携带到请求头中，来通过后台接口的 token的校验。</p>
<h2 id="3-9、客户端注销登陆"><a href="#3-9、客户端注销登陆" class="headerlink" title="3.9、客户端注销登陆"></a>3.9、客户端注销登陆</h2><p><code>src/views/Base.vue</code>，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> storage <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../utils/storage.js&#x27;</span><br>...<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  storage.<span class="hljs-title function_">clearStorage</span>()<br>  router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;/login&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="四、资产管理"><a href="#四、资产管理" class="headerlink" title="四、资产管理"></a>四、资产管理</h1><h2 id="4-1、主机管理"><a href="#4-1、主机管理" class="headerlink" title="4.1、主机管理"></a>4.1、主机管理</h2><h3 id="1-主机前端页面"><a href="#1-主机前端页面" class="headerlink" title="1. 主机前端页面"></a>1. 主机前端页面</h3><p><code>Host.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;host&quot;&gt;<br><br>    &lt;div&gt;<br>      &lt;a-button type=&quot;primary&quot; @click=&quot;showModal&quot; style=&quot;margin: 8px 0&quot;&gt;添加主机&lt;/a-button&gt;<br>      &lt;a-modal width=&quot;860px&quot; v-model:visible=&quot;visible&quot; title=&quot;Basic Modal&quot; @ok=&quot;handleOk&quot; @cancel=&quot;cancelForm&quot;&gt;<br><br>        &lt;a-form<br>            ref=&quot;formRef&quot;<br>            name=&quot;custom-validation&quot;<br>            :model=&quot;hostForm.form&quot;<br>            :rules=&quot;hostForm.rules&quot;<br>            v-bind=&quot;layout&quot;<br>            @finish=&quot;handleFinish&quot;<br>            @validate=&quot;handleValidate&quot;<br>            @finishFailed=&quot;handleFinishFailed&quot;<br>        &gt;<br>          &lt;a-form-item label=&quot;主机类别&quot; prop=&quot;zone&quot; name=&quot;category&quot;&gt;<br>            &lt;a-row&gt;<br>              &lt;a-col :span=&quot;12&quot;&gt;<br>                &lt;a-select<br>                    ref=&quot;select&quot;<br>                    v-model:value=&quot;hostForm.form.category&quot;<br>                    @change=&quot;handleCategorySelectChange&quot;<br><br>                &gt;<br>                  &lt;a-select-option :value=&quot;category.id&quot; v-for=&quot;category in categoryList.data&quot; :key=&quot;category.id&quot;&gt;<br>                    &#123;&#123; category.name &#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-col&gt;<br><br>            &lt;/a-row&gt;<br><br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;主机名称&quot; name=&quot;name&quot;&gt;<br>            &lt;a-input v-model:value=&quot;hostForm.form.name&quot; type=&quot;text&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br><br>          &lt;a-form-item label=&quot;连接地址&quot; name=&quot;username&quot;&gt;<br><br>            &lt;a-row&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;用户名&quot; addon-before=&quot;ssh&quot; v-model:value=&quot;hostForm.form.username&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;ip地址&quot; addon-before=&quot;@&quot; v-model:value=&quot;hostForm.form.ip_addr&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;端口号&quot; addon-before=&quot;-p&quot; v-model:value=&quot;hostForm.form.port&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>            &lt;/a-row&gt;<br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;连接密码&quot; name=&quot;password&quot;&gt;<br>            &lt;a-input v-model:value=&quot;hostForm.form.password&quot; type=&quot;password&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;备注信息&quot; name=&quot;remark&quot;&gt;<br>            &lt;a-textarea placeholder=&quot;请输入主机备注信息&quot; v-model:value=&quot;hostForm.form.remark&quot; type=&quot;text&quot;<br>                        :auto-size=&quot;&#123; minRows: 3, maxRows: 5 &#125;&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br><br>          &lt;a-form-item :wrapper-col=&quot;&#123; span: 14, offset: 4 &#125;&quot;&gt;<br>            &lt;a-button @click=&quot;resetForm&quot;&gt;Reset&lt;/a-button&gt;<br>          &lt;/a-form-item&gt;<br>        &lt;/a-form&gt;<br><br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br><br>    &lt;a-table bordered :data-source=&quot;dataSource&quot; :columns=&quot;columns&quot;&gt;<br>      &lt;template #bodyCell=&quot;&#123; column, text, record &#125;&quot;&gt;<br>        &lt;template v-if=&quot;column.dataIndex === &#x27;name&#x27;&quot;&gt;<br>          &lt;div class=&quot;editable-cell&quot;&gt;<br>            &lt;div v-if=&quot;editableData[record.key]&quot; class=&quot;editable-cell-input-wrapper&quot;&gt;<br>              &lt;a-input v-model:value=&quot;editableData[record.key].name&quot; @pressEnter=&quot;save(record.key)&quot;/&gt;<br>              &lt;check-outlined class=&quot;editable-cell-icon-check&quot; @click=&quot;save(record.key)&quot;/&gt;<br>            &lt;/div&gt;<br>            &lt;div v-else class=&quot;editable-cell-text-wrapper&quot;&gt;<br>              &#123;&#123; text || &#x27; &#x27; &#125;&#125;<br>              &lt;edit-outlined class=&quot;editable-cell-icon&quot; @click=&quot;edit(record.key)&quot;/&gt;<br>            &lt;/div&gt;<br>          &lt;/div&gt;<br>        &lt;/template&gt;<br>        &lt;template v-else-if=&quot;column.dataIndex === &#x27;operation_edit&#x27;&quot;&gt;<br><br>          &lt;a&gt;edit&lt;/a&gt;<br><br>        &lt;/template&gt;<br>        &lt;template v-else-if=&quot;column.dataIndex === &#x27;operation_del&#x27;&quot;&gt;<br>          &lt;a-popconfirm<br>              v-if=&quot;dataSource.length&quot;<br>              title=&quot;Sure to delete?&quot;<br>              @confirm=&quot;onDelete(record.key)&quot;<br>          &gt;<br>            &lt;a&gt;Delete&lt;/a&gt;<br>          &lt;/a-popconfirm&gt;<br>        &lt;/template&gt;<br>      &lt;/template&gt;<br>    &lt;/a-table&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;computed, reactive, ref&#125; from &#x27;vue&#x27;;<br>import &#123;CheckOutlined, EditOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import &#123;cloneDeep&#125; from &#x27;lodash-es&#x27;;<br><br><br>// 主机表格<br>const columns = [&#123;<br>  title: &#x27;类别&#x27;,<br>  dataIndex: &#x27;category_name&#x27;,<br>&#125;, &#123;<br>  title: &#x27;主机名称&#x27;,<br>  dataIndex: &#x27;name&#x27;,<br>&#125;, &#123;<br>  title: &#x27;IP地址&#x27;,<br>  dataIndex: &#x27;ip_addr&#x27;,<br>&#125;, &#123;<br>  title: &#x27;端口&#x27;,<br>  dataIndex: &#x27;port&#x27;,<br>&#125;, &#123;<br>  title: &#x27;备注&#x27;,<br>  dataIndex: &#x27;remark&#x27;,<br>&#125;, &#123;<br>  title: &#x27;编辑&#x27;,<br>  dataIndex: &#x27;operation_edit&#x27;,<br>&#125;, &#123;<br>  title: &#x27;删除&#x27;,<br>  dataIndex: &#x27;operation_del&#x27;,<br>&#125;];<br>const dataSource = ref([<br>  &#123;<br>    &#x27;id&#x27;: 1,<br>    &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;izbp13e05jqwodd605vm3gz&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;47.58.131.12&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;,<br>  &#123;<br>    &#x27;id&#x27;: 2,<br>    &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;iZbp1a3jw4l12ho53ivhkkZ&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;12.18.125.22&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;,<br>  &#123;<br>    &#x27;id&#x27;: 3,<br>    &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;iZbp1b1xqfqw257gs563k2iZ&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;12.19.135.130&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;,<br>  &#123;<br>    &#x27;id&#x27;: 4,<br>    &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;iZbp1b1jw4l01ho53muhkkZ&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;47.98.101.89&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;<br>]);<br>const count = computed(() =&gt; dataSource.value.length + 1);<br>const editableData = reactive(&#123;&#125;);<br>const edit = key =&gt; &#123;<br>  editableData[key] = cloneDeep(dataSource.value.filter(item =&gt; key === item.key)[0]);<br>&#125;;<br>const save = key =&gt; &#123;<br>  Object.assign(dataSource.value.filter(item =&gt; key === item.key)[0], editableData[key]);<br>  delete editableData[key];<br>&#125;;<br>const onDelete = key =&gt; &#123;<br>  dataSource.value = dataSource.value.filter(item =&gt; item.key !== key);<br>&#125;;<br><br>// 添加主机<br>const visible = ref(false);<br>const showModal = () =&gt; &#123;<br>  visible.value = true;<br>&#125;;<br>const handleOk = e =&gt; &#123;<br>  resetForm()<br>  visible.value = false;<br>&#125;;<br><br>const cancelForm = e =&gt; &#123;<br>  resetForm()<br>  visible.value = false;<br>&#125;;<br>const hostForm = reactive(&#123;<br>  labelCol: &#123;span: 6&#125;,<br>  wrapperCol: &#123;span: 14&#125;,<br>  other: &#x27;&#x27;,<br>  form: &#123;<br>    name: &#x27;&#x27;,<br>    category: &quot;&quot;,<br>    ip_addr: &#x27;&#x27;,<br>    username: &#x27;&#x27;,<br>    port: &#x27;&#x27;,<br>    remark: &#x27;&#x27;,<br>    password: &#x27;&#x27;<br>  &#125;,<br>  rules: &#123;<br>    name: [<br>      &#123;required: true, message: &#x27;请输入主机名称&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    password: [<br>      &#123;required: true, message: &#x27;请输入连接密码&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    category: [<br>      &#123;required: true, message: &#x27;请选择类别&#x27;, trigger: &#x27;change&#x27;&#125;<br>    ],<br>    username: [<br>      &#123;required: true, message: &#x27;请输入用户名&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    ip_addr: [<br>      &#123;required: true, message: &#x27;请输入连接地址&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;max: 30, message: &#x27;长度最大15位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    port: [<br>      &#123;required: true, message: &#x27;请输入端口号&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;max: 5, message: &#x27;长度最大5位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ]<br>  &#125;<br>&#125;);<br>const formRef = ref();<br>const layout = &#123;<br>  labelCol: &#123;<br>    span: 4,<br>  &#125;,<br>  wrapperCol: &#123;<br>    span: 24,<br>  &#125;,<br>&#125;;<br>const handleFinish = values =&gt; &#123;<br>  console.log(values, hostForm);<br>&#125;;<br><br>const handleFinishFailed = errors =&gt; &#123;<br>  console.log(errors);<br>&#125;;<br><br>const resetForm = () =&gt; &#123;<br>  formRef.value.resetFields();<br>&#125;;<br><br>const handleValidate = (...args) =&gt; &#123;<br>  console.log(args);<br>&#125;;<br>const categoryList = reactive(&#123;<br>  data: []<br>&#125;)<br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910075648592-4303811.png" srcset="/img/loading.gif" lazyload alt="image-20230910075648592"></p>
<p><img src="/pages_images/Bingo/image-20230910075737013-4303858.png" srcset="/img/loading.gif" lazyload alt="image-20230910075737013"></p>
<h3 id="2-主机模型"><a href="#2-主机模型" class="headerlink" title="2. 主机模型"></a>2. 主机模型</h3><p><code>bingo_api/application/model/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> model<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/jinzhu/gorm&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/database&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">主机类别实体</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> HostCategory <span class="hljs-keyword">struct</span> &#123;<br>	gorm.Model<br>	<span class="hljs-comment">// 唯一索引 unique_index</span><br>	Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot; gorm:&quot;type:varchar(255); unique_index&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> HostCategoryInstance <span class="hljs-keyword">struct</span> &#123;<br>	ID   <span class="hljs-type">uint</span>   <span class="hljs-string">`json:&quot;id&quot;`</span><br>	Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">设置表名</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category HostCategory)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;host_category&quot;</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category *HostCategory)</span></span> Insert() <span class="hljs-type">error</span> &#123;<br>	err := Orm.Create(&amp;category).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取主机分类列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category HostCategory)</span></span> GetAll() ([]HostCategoryInstance, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> categories []HostCategoryInstance<br>	err := Orm.Table(category.TableName()).Order(<span class="hljs-string">&quot; id DESC &quot;</span>).Select(<span class="hljs-string">&quot;id, name&quot;</span>).Scan(&amp;categories).Error<br>	<span class="hljs-keyword">return</span> categories, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据指定ID获取主机类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category *HostCategory)</span></span> GetOneById(id <span class="hljs-type">uint</span>) <span class="hljs-type">error</span> &#123;<br>	err := Orm.First(&amp;category, id).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">主机信息模型</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> Host <span class="hljs-keyword">struct</span> &#123;<br>	gorm.Model<br>	Name           <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;name&quot; gorm:&quot;type:varchar(255)&quot;`</span><br>	IpAddr         <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;ip_addr&quot; gorm:&quot;type:varchar(255)&quot;`</span><br>	Port           <span class="hljs-type">uint</span>         <span class="hljs-string">`json:&quot;port&quot; gorm:&quot;type:int&quot;`</span><br>	Username       <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;username&quot; gorm:&quot;varchar(255)&quot;`</span><br>	Password       <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;password,omitempty&quot; gorm:&quot;varchar(255)&quot;`</span><br>	Remark         <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;remark,omitempty&quot; gorm:&quot;varchar(255)&quot;`</span><br>	HostCategoryID <span class="hljs-type">uint</span>         <span class="hljs-string">`json:&quot;host_category_id&quot;`</span><br>	HostCategory   HostCategory <span class="hljs-string">`json:&quot;host_category&quot;  gorm:&quot;foreignKey:HostCategoryID;references:ID&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> HostInstance <span class="hljs-keyword">struct</span> &#123;<br>	ID           <span class="hljs-type">uint</span>   <span class="hljs-string">`json:&quot;id&quot;`</span><br>	Name         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>	IpAddr       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ip_addr&quot;`</span><br>	Port         <span class="hljs-type">uint</span>   <span class="hljs-string">`json:&quot;port&quot;`</span><br>	Username     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;username&quot;`</span><br>	CategoryID   <span class="hljs-type">uint</span>   <span class="hljs-string">`json:&quot;category_id&quot;`</span><br>	CategoryName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;category_name&quot;`</span><br>	Remark       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">设置表名</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(host Host)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;host_info&quot;</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(host *Host)</span></span> Insert() <span class="hljs-type">error</span> &#123;<br>	err := Orm.Create(&amp;host).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取所有主机列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(host Host)</span></span> GetAll(name <span class="hljs-type">string</span>, hostCategoryId <span class="hljs-type">uint</span>, IpAddr <span class="hljs-type">string</span>) ([]Host, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> hosts []Host<br>	query := Orm.Table(host.TableName())<br>	<span class="hljs-keyword">if</span> name != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		query = query.Where(<span class="hljs-string">&quot; name LIKE ? &quot;</span>, <span class="hljs-string">&quot;%&quot;</span>+name+<span class="hljs-string">&quot;%&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> hostCategoryId &gt; <span class="hljs-number">0</span> &#123;<br>		query = query.Where(<span class="hljs-string">&quot; host_category_id = ? &quot;</span>, hostCategoryId)<br>	&#125;<br>	<span class="hljs-keyword">if</span> IpAddr != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		query = query.Where(<span class="hljs-string">&quot; ip_addr LIKE ? &quot;</span>, <span class="hljs-string">&quot;%&quot;</span>+IpAddr+<span class="hljs-string">&quot;%&quot;</span>)<br>	&#125;<br><br>	err := query.Order(<span class="hljs-string">&quot; id DESC &quot;</span>).Preload(<span class="hljs-string">&quot;HostCategory&quot;</span>).Find(&amp;hosts).Error<br>	<span class="hljs-keyword">return</span> hosts, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据指定ID获取主机</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(host *Host)</span></span> GetOneById(id <span class="hljs-type">uint</span>) <span class="hljs-type">error</span> &#123;<br>	err := Orm.First(&amp;host, id).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">删除主机</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(host *Host)</span></span> Delete() (err <span class="hljs-type">error</span>) &#123;<br>	err = Orm.Delete(&amp;host).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// ... 代码省略</span><br>	<span class="hljs-comment">// ... 代码省略</span><br>  <br>	<span class="hljs-comment">// 数据迁移</span><br>	Orm.AutoMigrate(&amp;model.User&#123;&#125;)<br>	Orm.AutoMigrate(&amp;model.Host&#123;&#125;)<br>	Orm.AutoMigrate(&amp;model.HostCategory&#123;&#125;)<br><br>	<span class="hljs-comment">// ... 代码省略</span><br>	<span class="hljs-comment">// ... 代码省略</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>项目重启后，项目就会自动新生成主机表和主机分类表。</p>
<h3 id="3、主机相关API开发"><a href="#3、主机相关API开发" class="headerlink" title="3、主机相关API开发"></a>3、主机相关API开发</h3><h4 id="【1】添加主机类别"><a href="#【1】添加主机类别" class="headerlink" title="【1】添加主机类别"></a>【1】添加主机类别</h4><p><code>bingo_api/application/services/host.go</code>，代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> services<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/validator&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateHostCategory</span><span class="hljs-params">(ctx *gin.Context)</span></span> (HostCategoryInstance, <span class="hljs-type">error</span>) &#123;<br>	hostCategory := HostCategory&#123;&#125;<br>	<span class="hljs-keyword">var</span> instance HostCategoryInstance<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;hostCategory); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br>	<span class="hljs-keyword">if</span> err = validator.HostCategoryValidator(&amp;hostCategory); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br>	err = hostCategory.Insert()<br>	instance = HostCategoryInstance&#123;<br>		ID:   hostCategory.ID,<br>		Name: hostCategory.Name,<br>	&#125;<br>	<span class="hljs-keyword">return</span> instance, err<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/validator/host.go</code>，代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> validator<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;github.com/go-playground/validator/v10&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机类别的验证器</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostCategoryValidator</span><span class="hljs-params">(hostCategory *HostCategory)</span></span> <span class="hljs-type">error</span> &#123;<br>	validate, trans := GenValidate()<br>	err := validate.Struct(hostCategory)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">for</span> _, err := <span class="hljs-keyword">range</span> err.(validator.ValidationErrors) &#123;<br>			<span class="hljs-keyword">return</span> errors.New(err.Translate(trans))<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/api/host.go</code>，代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> api<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/services&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostCategoryCreate</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	hostCategory, err := CreateHostCategory(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || hostCategory.ID &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeCreateHostCategoryFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]model.HostCategoryInstance&#123;<br>			<span class="hljs-string">&quot;hostCategory&quot;</span>: hostCategory,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/constants/code.go</code>，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">CodeCreateHostCategoryFail</span> = <span class="hljs-number">1010</span> <span class="hljs-comment">// 创建主机类别失败！</span><br><span class="hljs-title class_">CodeGetHostCategoryFail</span>    = <span class="hljs-number">1011</span> <span class="hljs-comment">// 无法获取主机类别列表！</span><br><span class="hljs-title class_">CodeCreateHostFail</span>         = <span class="hljs-number">1012</span> <span class="hljs-comment">// 添加主机信息失败！</span><br><span class="hljs-title class_">CodeHostCategoryNotExist</span>   = <span class="hljs-number">1013</span> <span class="hljs-comment">// 主机类别不存在！</span><br><span class="hljs-title class_">CodeGetHostFail</span>            = <span class="hljs-number">1014</span> <span class="hljs-comment">// 无法获取主机列表</span><br></code></pre></td></tr></table></figure>

<p>设计主机应用路由，<code>bingo_api/application/router/host.go</code>，代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/api&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitHostRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	主机相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	HostRouter := Router.Group(<span class="hljs-string">&quot;host&quot;</span>)<br><br>	&#123;<br>		<span class="hljs-comment">// 主机类别-添加</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.HostCategoryCreate)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>注册主机应用路由 <code>bingo_api/application/initialize/router.go</code>，代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/router&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouter</span><span class="hljs-params">()</span></span> *gin.Engine &#123;<br>	<span class="hljs-comment">// 1. 创建路由</span><br>	Router := gin.Default()<br>	Router.Use(middleware.GinLogger(), middleware.GinRecovery(<span class="hljs-literal">true</span>))<br>	Router.Use(middleware.ExceptionMiddleware)<br>	Router.Use(middleware.CORS)<br>	<span class="hljs-comment">// 2. Api路由分组</span><br>	ApiGroup := Router.Group(<span class="hljs-string">&quot;/api&quot;</span>)<br>	<span class="hljs-comment">// 3. 初始化用户相关路由</span><br>	router.InitUserRouter(ApiGroup)<br>	router.InitHostRouter(ApiGroup)<br>	zap.S().Info(<span class="hljs-string">&quot;路由初始化完成....&quot;</span>)<br>	<span class="hljs-keyword">return</span> Router<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910075834197-4303915.png" srcset="/img/loading.gif" lazyload alt="image-20230910075834197"></p>
<h4 id="【2】查看主机类别"><a href="#【2】查看主机类别" class="headerlink" title="【2】查看主机类别"></a>【2】查看主机类别</h4><p><code>bingo_api/application/services/host.go</code>，代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取主机类别列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetHostCategoryList</span><span class="hljs-params">(ctx *gin.Context)</span></span> ([]HostCategoryInstance, <span class="hljs-type">error</span>)&#123;<br>	hostCategory := HostCategory&#123;&#125;<br>	hostCategoryList, err := hostCategory.GetAll()<br>	<span class="hljs-keyword">return</span> hostCategoryList, err<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/api/host.go</code>，代码：</p>
<figure class="highlight golang"><figcaption><span>l</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取所有主机类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostCategoryList</span><span class="hljs-params">(ctx *gin.Context)</span></span>&#123;<br>	<span class="hljs-comment">// 调用业务层获取主机类别列表</span><br>	hostCategoryList, err := GetHostCategoryList(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeGetHostCategoryFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;host_category_list&quot;</span>: hostCategoryList,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/router/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/api&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitHostRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	主机相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	HostRouter := Router.Group(<span class="hljs-string">&quot;host&quot;</span>)<br><br>	&#123;<br>		<span class="hljs-comment">// 主机类别-添加</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.HostCategoryCreate)<br>		<span class="hljs-comment">// 主机类别-查看</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.HostCategoryList)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910080028512-4304029.png" srcset="/img/loading.gif" lazyload alt="image-20230910080028512"></p>
<h4 id="【3】添加主机"><a href="#【3】添加主机" class="headerlink" title="【3】添加主机"></a>【3】添加主机</h4><p><code>bingo_api/application/services/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateHost</span><span class="hljs-params">(ctx *gin.Context)</span></span> (HostInstance, <span class="hljs-type">error</span>)&#123;<br>	host := Host&#123;&#125;<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	<span class="hljs-keyword">var</span> instance HostInstance<br>	<span class="hljs-keyword">var</span> hostCategory HostCategory<br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;host) ;err !=<span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> err = validator.HostValidator(&amp;host); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	err = host.Insert()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	err = hostCategory.GetOneById(host.HostCategoryID)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	instance = HostInstance&#123;<br>		ID:               host.ID,<br>		Name:             host.Name,<br>		IpAddr:           host.IpAddr,<br>		Port:             host.Port,<br>		Username:         host.Username,<br>		Remark:           host.Remark,<br>		CategoryID:       host.HostCategoryID,<br>		CategoryName:     hostCategory.Name,<br>	&#125;<br>	<span class="hljs-keyword">return</span> instance, err<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/validator/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机的验证器</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostValidator</span><span class="hljs-params">(host *Host)</span></span> <span class="hljs-type">error</span> &#123;<br>	validate, trans := GenValidate()<br>	err := validate.Struct(host)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">for</span> _, err := <span class="hljs-keyword">range</span> err.(validator.ValidationErrors) &#123;<br>			<span class="hljs-keyword">return</span> errors.New(err.Translate(trans))<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> host.HostCategoryID &lt; <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span> errors.New(constants.HostCategoryNotExist)<br>	&#125;<br><br>	<span class="hljs-keyword">var</span> hostCategory HostCategory<br>	err = hostCategory.GetOneById(host.HostCategoryID)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> errors.New(constants.HostCategoryNotExist)<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/constants/message.go</code>，代码：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">HostCategoryNotExist</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;主机类别不存在！&quot;</span><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/api/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostCreate</span><span class="hljs-params">(ctx *gin.Context)</span></span>&#123;<br>	<span class="hljs-comment">// 调用业务层创建主机信息</span><br>	host, err := CreateHost(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || host.ID &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeCreateHostFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;host&quot;</span>: host,<br>		&#125;,<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/router/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/api&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitHostRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	主机相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	HostRouter := Router.Group(<span class="hljs-string">&quot;host&quot;</span>)<br><br>	&#123;<br>		<span class="hljs-comment">// 主机类别-添加</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.HostCategoryCreate)<br>		<span class="hljs-comment">// 主机类别-查看</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.HostCategoryList)<br>		<span class="hljs-comment">// 主机信息-添加</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, middleware.JWTAuthorization(), api.HostCreate)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910080007204-4304008.png" srcset="/img/loading.gif" lazyload alt="image-20230910080007204"></p>
<h4 id="【4】查看主机"><a href="#【4】查看主机" class="headerlink" title="【4】查看主机"></a>【4】查看主机</h4><p><code>bingo_api/application/services/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取主机列表信息</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetHostList</span><span class="hljs-params">(name <span class="hljs-type">string</span>, hostCategoryId <span class="hljs-type">uint</span>, hostname <span class="hljs-type">string</span>)</span></span> ([]HostInstance, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> hostList []Host<br>	<span class="hljs-keyword">var</span> instanceList []HostInstance<br>	<span class="hljs-keyword">var</span> host Host<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	hostList, err = host.GetAll(name, <span class="hljs-type">uint</span>(hostCategoryId), hostname)<br>	<span class="hljs-keyword">for</span> _, hostItem := <span class="hljs-keyword">range</span> hostList &#123;<br>		instanceList = <span class="hljs-built_in">append</span>(instanceList, HostInstance&#123;<br>			ID:           hostItem.ID,<br>			Name:         hostItem.Name,<br>			IpAddr:       hostItem.IpAddr,<br>			Port:         hostItem.Port,<br>			Username:     hostItem.Username,<br>			CategoryID:   hostItem.HostCategory.ID,<br>			CategoryName: hostItem.HostCategory.Name,<br>			Remark:       hostItem.Remark,<br>		&#125;)<br>	&#125;<br>	<span class="hljs-keyword">return</span> instanceList, err<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/api/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 主机列表</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostList</span><span class="hljs-params">(ctx *gin.Context)</span></span>&#123;<br>	<span class="hljs-comment">// 接受参数</span><br>	name, _ := ctx.GetQuery(<span class="hljs-string">&quot;name&quot;</span>)<br>	hostname, _ := ctx.GetQuery(<span class="hljs-string">&quot;host&quot;</span>)<br>	hostCategoryId, _ := strconv.Atoi(ctx.Query(<span class="hljs-string">&quot;host_category_id&quot;</span>))<br>	hostList, err := GetHostList(name, <span class="hljs-type">uint</span>(hostCategoryId), hostname)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeGetHostFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;host_list&quot;</span>: hostList,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/router/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/api&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitHostRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	主机相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	HostRouter := Router.Group(<span class="hljs-string">&quot;host&quot;</span>)<br><br>	&#123;<br>		<span class="hljs-comment">// 主机类别-添加</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.HostCategoryCreate)<br>		<span class="hljs-comment">// 主机类别-查看</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.HostCategoryList)<br>		<span class="hljs-comment">// 主机信息-添加</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, middleware.JWTAuthorization(), api.HostCreate)<br>		<span class="hljs-comment">// 主机 - 列表</span><br>		utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, middleware.JWTAuthorization(), api.HostList)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910080059356-4304060.png" srcset="/img/loading.gif" lazyload alt="image-20230910080059356"></p>
<p> 查看主机列表：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;host_list&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;izbp13e05jqwodd605vm3gz&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;ip_addr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;47.58.131.12&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;category_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;category_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;测试服务器&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;remark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;remark...&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iZbp1b1jw4l01ho53muhkkZ&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;ip_addr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;47.98.101.89&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;category_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;category_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;测试服务器&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;remark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;remark...&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iZbp1b1xqfqw257gs563k2iZ&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;ip_addr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;12.19.135.130&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;category_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;category_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;数据库服务器&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;remark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;remark...&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;成功！&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="【5】删除主机接口"><a href="#【5】删除主机接口" class="headerlink" title="【5】删除主机接口"></a>【5】删除主机接口</h4><p><code>bingo_api/application/services/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">删除主机列表信息</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeleteHost</span><span class="hljs-params">(hostId <span class="hljs-type">uint</span>)</span></span> (HostInstance, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> delHost Host<br>	<span class="hljs-keyword">var</span> instance HostInstance<br><br>	err := delHost.GetOneById(hostId)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br>	err = delHost.Delete()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	instance = HostInstance&#123;<br>		Name:       delHost.Name,<br>		IpAddr:     delHost.IpAddr,<br>		Port:       delHost.Port,<br>		Username:   delHost.Username,<br>		Remark:     delHost.Remark,<br>		CategoryID: delHost.HostCategoryID,<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> instance, err<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/api/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">删除主机</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostDelete</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 接受参数</span><br>	idStr, _ := ctx.GetQuery(<span class="hljs-string">&quot;id&quot;</span>)<br>	delId, _ := strconv.Atoi(idStr)<br>	host, err := DeleteHost(<span class="hljs-type">uint</span>(delId))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeDelHostFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;delete_host&quot;</span>: host,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>bingo_api/application/router/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 主机 - 删除</span><br>utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;DELETE&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, middleware.JWTAuthorization(), api.HostDelete)<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910080131346-4304093.png" srcset="/img/loading.gif" lazyload alt="image-20230910080131346"></p>
<h3 id="4、客户端与api联调"><a href="#4、客户端与api联调" class="headerlink" title="4、客户端与api联调"></a>4、客户端与api联调</h3><p><code>Host.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;host&quot;&gt;<br><br>    &lt;div&gt;<br>      &lt;a-button type=&quot;primary&quot; @click=&quot;showModal&quot; style=&quot;margin: 8px 0&quot;&gt;添加主机&lt;/a-button&gt;<br>      &lt;a-modal width=&quot;860px&quot; v-model:visible=&quot;visible&quot; title=&quot;Basic Modal&quot; @ok=&quot;handleOk&quot; @cancel=&quot;cancelForm&quot;&gt;<br><br>        &lt;a-form<br>            ref=&quot;formRef&quot;<br>            name=&quot;custom-validation&quot;<br>            :model=&quot;hostForm.form&quot;<br>            :rules=&quot;hostForm.rules&quot;<br>            v-bind=&quot;layout&quot;<br>            @finish=&quot;handleFinish&quot;<br>            @validate=&quot;handleValidate&quot;<br>            @finishFailed=&quot;handleFinishFailed&quot;<br>        &gt;<br>          &lt;a-form-item label=&quot;主机类别&quot; prop=&quot;zone&quot; name=&quot;category&quot;&gt;<br>            &lt;a-row&gt;<br>              &lt;a-col :span=&quot;12&quot;&gt;<br>                &lt;a-select<br>                    ref=&quot;select&quot;<br>                    v-model:value=&quot;hostForm.form.category&quot;<br>                    @change=&quot;handleCategorySelectChange&quot;<br><br>                &gt;<br>                  &lt;a-select-option :value=&quot;category.id&quot; v-for=&quot;category in categoryList.data&quot; :key=&quot;category.id&quot;&gt;<br>                    &#123;&#123; category.name &#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-col&gt;<br><br>            &lt;/a-row&gt;<br><br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;主机名称&quot; name=&quot;name&quot;&gt;<br>            &lt;a-input v-model:value=&quot;hostForm.form.name&quot; type=&quot;text&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br><br>          &lt;a-form-item label=&quot;连接地址&quot; name=&quot;username&quot;&gt;<br><br>            &lt;a-row&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;用户名&quot; addon-before=&quot;ssh&quot; v-model:value=&quot;hostForm.form.username&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;ip地址&quot; addon-before=&quot;@&quot; v-model:value=&quot;hostForm.form.ip_addr&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;端口号&quot; addon-before=&quot;-p&quot; v-model:value=&quot;hostForm.form.port&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>            &lt;/a-row&gt;<br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;连接密码&quot; name=&quot;password&quot;&gt;<br>            &lt;a-input v-model:value=&quot;hostForm.form.password&quot; type=&quot;password&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;备注信息&quot; name=&quot;remark&quot;&gt;<br>            &lt;a-textarea placeholder=&quot;请输入主机备注信息&quot; v-model:value=&quot;hostForm.form.remark&quot; type=&quot;text&quot;<br>                        :auto-size=&quot;&#123; minRows: 3, maxRows: 5 &#125;&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br><br>          &lt;a-form-item :wrapper-col=&quot;&#123; span: 14, offset: 4 &#125;&quot;&gt;<br>            &lt;a-button @click=&quot;resetForm&quot;&gt;Reset&lt;/a-button&gt;<br>          &lt;/a-form-item&gt;<br>        &lt;/a-form&gt;<br><br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br><br>    &lt;a-table bordered :data-source=&quot;dataSource&quot; :columns=&quot;columns&quot;&gt;<br>      &lt;template #bodyCell=&quot;&#123; column, text, record &#125;&quot;&gt;<br>        &lt;template v-if=&quot;column.dataIndex === &#x27;name&#x27;&quot;&gt;<br>          &lt;div class=&quot;editable-cell&quot;&gt;<br>            &lt;div v-if=&quot;editableData[record.key]&quot; class=&quot;editable-cell-input-wrapper&quot;&gt;<br>              &lt;a-input v-model:value=&quot;editableData[record.key].name&quot; @pressEnter=&quot;save(record.key)&quot;/&gt;<br>              &lt;check-outlined class=&quot;editable-cell-icon-check&quot; @click=&quot;save(record.key)&quot;/&gt;<br>            &lt;/div&gt;<br>            &lt;div v-else class=&quot;editable-cell-text-wrapper&quot;&gt;<br>              &#123;&#123; text || &#x27; &#x27; &#125;&#125;<br>              &lt;edit-outlined class=&quot;editable-cell-icon&quot; @click=&quot;edit(record.key)&quot;/&gt;<br>            &lt;/div&gt;<br>          &lt;/div&gt;<br>        &lt;/template&gt;<br>        &lt;template v-else-if=&quot;column.dataIndex === &#x27;operation_edit&#x27;&quot;&gt;<br><br>          &lt;a&gt;edit&lt;/a&gt;<br><br>        &lt;/template&gt;<br>        &lt;template v-else-if=&quot;column.dataIndex === &#x27;operation_del&#x27;&quot;&gt;<br>          &lt;a-popconfirm<br>              v-if=&quot;dataSource.length&quot;<br>              title=&quot;Sure to delete?&quot;<br>              @confirm=&quot;onDelete(record.key)&quot;<br>          &gt;<br>            &lt;a&gt;Delete&lt;/a&gt;<br>          &lt;/a-popconfirm&gt;<br>        &lt;/template&gt;<br>      &lt;/template&gt;<br>    &lt;/a-table&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;computed, reactive, ref,onMounted&#125; from &#x27;vue&#x27;;<br>import &#123;CheckOutlined, EditOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import &#123;cloneDeep&#125; from &#x27;lodash-es&#x27;;<br>import http from &quot;../http/index.js&quot;;<br><br>// 主机表格<br>const columns = [&#123;<br>  title: &#x27;类别&#x27;,<br>  dataIndex: &#x27;category_name&#x27;,<br>&#125;, &#123;<br>  title: &#x27;主机名称&#x27;,<br>  dataIndex: &#x27;name&#x27;,<br>&#125;, &#123;<br>  title: &#x27;IP地址&#x27;,<br>  dataIndex: &#x27;ip_addr&#x27;,<br>&#125;, &#123;<br>  title: &#x27;端口&#x27;,<br>  dataIndex: &#x27;port&#x27;,<br>&#125;, &#123;<br>  title: &#x27;备注&#x27;,<br>  dataIndex: &#x27;remark&#x27;,<br>&#125;, &#123;<br>  title: &#x27;编辑&#x27;,<br>  dataIndex: &#x27;operation_edit&#x27;,<br>&#125;, &#123;<br>  title: &#x27;删除&#x27;,<br>  dataIndex: &#x27;operation_del&#x27;,<br>&#125;];<br>const dataSource = ref([<br>  &#123;<br>    &#x27;id&#x27;: 1,<br>    &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;izbp13e05jqwodd605vm3gz&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;47.58.131.12&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;,<br>  &#123;<br>    &#x27;id&#x27;: 2,<br>    &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;iZbp1a3jw4l12ho53ivhkkZ&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;12.18.125.22&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;,<br>  &#123;<br>    &#x27;id&#x27;: 3,<br>    &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;iZbp1b1xqfqw257gs563k2iZ&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;12.19.135.130&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;,<br>  &#123;<br>    &#x27;id&#x27;: 4,<br>    &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,<br>    &#x27;name&#x27;: &#x27;iZbp1b1jw4l01ho53muhkkZ&#x27;,<br>    &#x27;ip_addr&#x27;: &#x27;47.98.101.89&#x27;,<br>    &#x27;port&#x27;: 22,<br>    &#x27;remark&#x27;: &#x27;&#x27;<br>  &#125;<br>]);<br>const count = computed(() =&gt; dataSource.value.length + 1);<br>const editableData = reactive(&#123;&#125;);<br>const edit = key =&gt; &#123;<br>  editableData[key] = cloneDeep(dataSource.value.filter(item =&gt; key === item.key)[0]);<br>&#125;;<br>const save = key =&gt; &#123;<br>  Object.assign(dataSource.value.filter(item =&gt; key === item.key)[0], editableData[key]);<br>  delete editableData[key];<br>&#125;;<br>const onDelete = key =&gt; &#123;<br>  dataSource.value = dataSource.value.filter(item =&gt; item.key !== key);<br>&#125;;<br><br>// 添加主机<br>const visible = ref(false);<br>const showModal = () =&gt; &#123;<br>  visible.value = true;<br>&#125;;<br>const handleOk = e =&gt; &#123;<br>  resetForm()<br>  visible.value = false;<br>&#125;;<br><br>const cancelForm = e =&gt; &#123;<br>  resetForm()<br>  visible.value = false;<br>&#125;;<br>const hostForm = reactive(&#123;<br>  labelCol: &#123;span: 6&#125;,<br>  wrapperCol: &#123;span: 14&#125;,<br>  other: &#x27;&#x27;,<br>  form: &#123;<br>    name: &#x27;&#x27;,<br>    category: &quot;&quot;,<br>    ip_addr: &#x27;&#x27;,<br>    username: &#x27;&#x27;,<br>    port: &#x27;&#x27;,<br>    remark: &#x27;&#x27;,<br>    password: &#x27;&#x27;<br>  &#125;,<br>  rules: &#123;<br>    name: [<br>      &#123;required: true, message: &#x27;请输入主机名称&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    password: [<br>      &#123;required: true, message: &#x27;请输入连接密码&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    category: [<br>      &#123;required: true, message: &#x27;请选择类别&#x27;, trigger: &#x27;change&#x27;&#125;<br>    ],<br>    username: [<br>      &#123;required: true, message: &#x27;请输入用户名&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    ip_addr: [<br>      &#123;required: true, message: &#x27;请输入连接地址&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;max: 30, message: &#x27;长度最大15位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    port: [<br>      &#123;required: true, message: &#x27;请输入端口号&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;max: 5, message: &#x27;长度最大5位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ]<br>  &#125;<br>&#125;);<br>const formRef = ref();<br>const layout = &#123;<br>  labelCol: &#123;<br>    span: 4,<br>  &#125;,<br>  wrapperCol: &#123;<br>    span: 24,<br>  &#125;,<br>&#125;;<br>const handleFinish = values =&gt; &#123;<br>  console.log(values, hostForm);<br>&#125;;<br><br>const handleFinishFailed = errors =&gt; &#123;<br>  console.log(errors);<br>&#125;;<br><br>const resetForm = () =&gt; &#123;<br>  formRef.value.resetFields();<br>&#125;;<br><br>const handleValidate = (...args) =&gt; &#123;<br>  console.log(args);<br>&#125;;<br>const categoryList = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 前后端联调<br><br>// 查看主机列表<br>const getHostList = () =&gt; &#123;<br>  http.get(&quot;/host&quot;).then((res) =&gt; &#123;<br>    console.log(&quot;host_list:::&quot;, res)<br>    dataSource.value = res.data.data.host_list<br>  &#125;)<br>&#125;<br>// 查看主机类别列表<br>const getHostCategory = () =&gt; &#123;<br>  http.get(&quot;/host/category&quot;).then((res) =&gt; &#123;<br>    console.log(&quot;host_category_list:::&quot;, res)<br>    categoryList.data = res.data.data.host_category_list<br>  &#125;)<br>&#125;<br><br><br>onMounted(function ()&#123;<br>   // ajax请求：获取后端的主机列表<br>   getHostList()<br><br>   // ajax：获取主机类别列表<br>  getHostCategory()<br><br>&#125;)<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>因为后端接口设置了token认证，所以在发请求时需要携带token，为了方便处理，放置在axios请求拦截器中，在<code>utils/http.js</code>中，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;axios&quot;</span><br><span class="hljs-keyword">import</span> storage <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/utils/storage&quot;</span>;<br><br><span class="hljs-keyword">const</span> http = axios.<span class="hljs-title function_">create</span>(&#123;<br>    <span class="hljs-comment">// timeout: 2500,                          // 请求超时，有大文件上传需要关闭这个配置</span><br>    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&quot;http://api.bingo.cn:8080/api&quot;</span>,     <span class="hljs-comment">// 设置api服务端的默认地址[如果基于服务端实现的跨域，这里可以填写api服务端的地址，如果基于nodejs客户端测试服务器实现的跨域，则这里不能填写api服务端地址]</span><br>    <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">false</span>,                    <span class="hljs-comment">// 是否允许客户端ajax请求时携带cookie</span><br>&#125;)<br><br><span class="hljs-comment">// 请求拦截器</span><br>http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;http请求之前&quot;</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;storage.state.token::::::::&quot;</span>, storage.<span class="hljs-property">state</span>.<span class="hljs-property">token</span>)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;storage.state.user::::::::&quot;</span>, storage.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>)<br>    <span class="hljs-comment">// 设置token ，每一个http发出的axios请求都会携带该请求头</span><br>    config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = storage.<span class="hljs-property">state</span>.<span class="hljs-property">token</span><br><br>    <span class="hljs-keyword">return</span> config;<br>&#125;, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;http请求错误&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>&#125;);<br><br><span class="hljs-comment">// 响应拦截器</span><br>http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;服务端响应数据成功以后，返回结果给客户端的第一时间，执行then之前&quot;</span>);<br>    <span class="hljs-keyword">return</span> response;<br>&#125;, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;服务端响应错误内容的时候。...&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> http;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910080156304.png" srcset="/img/loading.gif" lazyload alt="image-20230910080156304"></p>
<p><img src="/pages_images/Bingo/image-20230910080204521-4304126.png" srcset="/img/loading.gif" lazyload alt="image-20230910080204521"></p>
<p><img src="/pages_images/Bingo/image-20230910080215038-4304136.png" srcset="/img/loading.gif" lazyload alt="image-20230910080215038"></p>
<p><img src="/pages_images/Bingo/image-20230910080226670-4304148.png" srcset="/img/loading.gif" lazyload alt="image-20230910080226670"></p>
<p><img src="/pages_images/Bingo/image-20230910080239800-4304161.png" srcset="/img/loading.gif" lazyload alt="image-20230910080239800"></p>
<h2 id="4-2、基于ssh的主机验证"><a href="#4-2、基于ssh的主机验证" class="headerlink" title="4.2、基于ssh的主机验证"></a>4.2、基于ssh的主机验证</h2><h3 id="4-2-1、ssh命令"><a href="#4-2-1、ssh命令" class="headerlink" title="4.2.1、ssh命令"></a>4.2.1、ssh命令</h3><p>ssh命令是openssh套件中的客户端连接工具，可以给予ssh加密协议实现安全的远程登录服务器，实现对服务器的远程管理。</p>
<p>简单说，SSH是一种网络协议，用于计算机之间的加密登录。如果一个用户从本地计算机，使用SSH协议登录另一台远程计算机，我们就可以认为，这种登录是安全的，即使被中途截获，密码也不会泄露。最早的时候，互联网通信都是明文通信，一旦被截获，内容就暴露无疑。1995年，芬兰学者Tatu Ylonen设计了SSH协议，将登录信息全部加密，成为互联网安全的一个基本解决方案，迅速在全世界获得推广，目前已经成为Linux系统的标准配置。</p>
<p>SSH(远程连接工具)连接原理：ssh服务是一个守护进程(demon)，系统后台监听客户端的连接，ssh服务端的进程名为sshd,负责实时监听客户端的请求(IP 22端口)，包括公共秘钥等交换等信息。</p>
<p>ssh服务端由2部分组成： openssh(提供ssh服务) openssl(提供加密的程序)</p>
<blockquote>
<ol>
<li>检查主机上有没有安装SSH服务，使用命令：ssh 若提示命令未找到，则需要安装ssh服务；步骤如下：输入sudo apt-get update命令以实现更新Ubuntu系统–&gt;输入sudo apt-get install openssh-server命令以安装ssh 若输出ssh命令的使用说明，则代表已经安装了。</li>
<li>检查主机上有没有启动SSH服务，使用命令：service –status-all | grep ssh 若服务已经启动的话，可以看到[+] ssh 若服务还没启动的话，可以看到[-] ssh</li>
<li>启动ssh服务，使用命令sudo service sshd start</li>
</ol>
</blockquote>
<p>SSH远程登录之口令登录</p>
<blockquote>
<p><code>ssh 用户名@IP地址 -p 端口号 </code></p>
<p>SSH的默认端口是22</p>
</blockquote>
<p><img src="/pages_images/Bingo/image-20230910081413677-4304855.png" srcset="/img/loading.gif" lazyload alt="image-20230910081413677"></p>
<p><img src="/pages_images/Bingo/image-20230910081425482-4304866.png" srcset="/img/loading.gif" lazyload alt="image-20230910081425482"></p>
<h3 id="4-2-2、go语言的ssh包"><a href="#4-2-2、go语言的ssh包" class="headerlink" title="4.2.2、go语言的ssh包"></a>4.2.2、go语言的ssh包</h3><p>依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get <span class="hljs-string">&quot;golang.org/x/crypto/ssh&quot;</span><br>go get <span class="hljs-string">&quot;github.com/pkg/sftp&quot;</span><br></code></pre></td></tr></table></figure>

<p>ssh文档：<a target="_blank" rel="noopener" href="https://pkg.go.dev/golang.org/x/crypto/ssh#Client">https://pkg.go.dev/golang.org/x/crypto/ssh#Client</a></p>
<p>sftp文档：<a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/pkg/sftp#Client">https://pkg.go.dev/github.com/pkg/sftp#Client</a></p>
<p><code>ssh/utils/ssh.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/pkg/sftp&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;golang.org/x/crypto/ssh&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// SSH 客户端连接信息的结构体</span><br><span class="hljs-keyword">type</span> SSH <span class="hljs-keyword">struct</span> &#123;<br>	IP         <span class="hljs-type">string</span>       <span class="hljs-comment">// IP地址</span><br>	Port       <span class="hljs-type">int</span>          <span class="hljs-comment">// 端口号</span><br>	Username   <span class="hljs-type">string</span>       <span class="hljs-comment">// 用户名</span><br>	Mode       <span class="hljs-type">string</span>       <span class="hljs-comment">// 认证方式[password:密码，key:秘钥认证]</span><br>	Password   <span class="hljs-type">string</span>       <span class="hljs-comment">// 密码</span><br>	Key        <span class="hljs-type">string</span>       <span class="hljs-comment">// 认证私钥</span><br>	Client     *ssh.Client  <span class="hljs-comment">// ssh客户端</span><br>	SftpClient *sftp.Client <span class="hljs-comment">// sftp客户端</span><br>	LastResult <span class="hljs-type">string</span>       <span class="hljs-comment">// 最近一次执行命令的结果</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSSH</span><span class="hljs-params">(ip <span class="hljs-type">string</span>, username <span class="hljs-type">string</span>, password <span class="hljs-type">string</span>, key <span class="hljs-type">string</span>, mode <span class="hljs-type">string</span>, port ...<span class="hljs-type">int</span>)</span></span> *SSH &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	创建命令行实例</span><br><span class="hljs-comment">	@param ip IP地址</span><br><span class="hljs-comment">	@param username 用户名</span><br><span class="hljs-comment">	@param password 登陆密码</span><br><span class="hljs-comment">	@param key 认证私钥</span><br><span class="hljs-comment">	@param mode 认证模式( password: 密码 | key: 秘钥 )</span><br><span class="hljs-comment">	@param port 端口号, 不填写则默认为22</span><br><span class="hljs-comment">	*/</span><br><br>	client := <span class="hljs-built_in">new</span>(SSH)<br>	client.IP = ip<br>	client.Username = username<br>	client.Password = password<br>	client.Key = key<br>	client.Mode = mode<br><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(port) &lt;= <span class="hljs-number">0</span> &#123;<br>		client.Port = <span class="hljs-number">22</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		client.Port = port[<span class="hljs-number">0</span>]<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> client<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SSH)</span></span> Connect() <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	SSH连接</span><br><span class="hljs-comment">	*/</span><br>	config := ssh.ClientConfig&#123;<br>		User:            s.Username,<br>		HostKeyCallback: ssh.InsecureIgnoreHostKey(),<br>		Timeout:         <span class="hljs-number">10</span> * time.Second,<br>	&#125;<br><br>	<span class="hljs-comment">// 判断SSH连接的认证方式</span><br>	<span class="hljs-keyword">if</span> s.Mode == <span class="hljs-string">&quot;key&quot;</span> &#123;<br>		signer, err := ssh.ParsePrivateKey([]<span class="hljs-type">byte</span>(s.Key))<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			zap.S().Fatalf(<span class="hljs-string">&quot;ssh key signer failed: %v&quot;</span>, err)<br>		&#125;<br>		config.Auth = []ssh.AuthMethod&#123;ssh.PublicKeys(signer)&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;s.Password&quot;</span>, s.Password)<br>		config.Auth = []ssh.AuthMethod&#123;ssh.Password(s.Password)&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 创建SSH客户端</span><br>	addr := fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, s.IP, s.Port)<br>	sshClient, err := ssh.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, addr, &amp;config)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	s.Client = sshClient<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s SSH)</span></span> Run(command <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	执行Shell命令</span><br><span class="hljs-comment">	@param command 要执行的命令，多个命令采用 ; 隔开</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">if</span> s.Client == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> err := s.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 创建一个客户端SSH</span><br>	session, err := s.Client.NewSession()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">defer</span> session.Close()<br>	<span class="hljs-comment">// 执行Shell命令</span><br>	buf, err := session.CombinedOutput(command)<br><br>	s.LastResult = <span class="hljs-type">string</span>(buf)<br>	<span class="hljs-keyword">return</span> s.LastResult, err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s SSH)</span></span> AddPublicKeyToRemoteHost(publicKey <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	将公钥写入目标主机</span><br><span class="hljs-comment">	700 是文档拥有可读可写可执行，同一组用户或者其他用户都不具有操作权限</span><br><span class="hljs-comment">	600 是文件拥有者可读可写，不可执行，同一组用户或者其他用户都不具有操作权限</span><br><span class="hljs-comment">	*/</span><br>	command := fmt.Sprintf(<span class="hljs-string">&quot;mkdir -p -m 700 ~/.ssh &amp;&amp; echo %v &gt;&gt; ~/.ssh/authorized_keys &amp;&amp; chmod 600 ~/.ssh/authorized_keys&quot;</span>, strings.TrimSpace(publicKey))<br>	_, err := s.Run(command)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		message := fmt.Sprintf(<span class="hljs-string">&quot;%v: %v&quot;</span>, <span class="hljs-string">&quot;添加公钥失败！&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> errors.New(message)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>OK，接下来，我们就可以测试下封装效果了。</p>
<p>首先测试基于密码的ssh连接，<code>test/ssh/main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910081644136-4305005.png" srcset="/img/loading.gif" lazyload alt="image-20230910081644136"></p>
<p>测试基于密钥的ssh连接，首先在本地创建公私钥，通过ssh相关命令</p>
<blockquote>
<p>ssh-keygen -t rsa</p>
</blockquote>
<p><img src="/pages_images/Bingo/image-20230910081622738-4304985.png" srcset="/img/loading.gif" lazyload alt="image-20230910081622738"></p>
<p>运行结束以后，在$HOME&#x2F;.ssh&#x2F;目录下，会新生成两个文件：id_rsa.pub和id_rsa。前者是你的公钥，后者是你的私钥。</p>
<p>基于密码登录，将公钥发送到连接的远程服务器<code>/.ssh/authorized_keys</code>中，后面在基于私钥就可以免密登录了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;ssh_test/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	Host := <span class="hljs-string">&quot;10.211.55.3&quot;</span><br>	User := <span class="hljs-string">&quot;root&quot;</span><br>	Password := <span class="hljs-string">&quot;yuan0316&quot;</span><br>	Port := <span class="hljs-number">22</span><br>	Key := <span class="hljs-string">&quot;&quot;</span><br>	Mode := <span class="hljs-string">&quot;password&quot;</span><br><br>	<span class="hljs-comment">// 首次SSH连接使用密码</span><br>	cli := utils.NewSSH(Host, User, Password, Key, Mode, Port)<br>	fmt.Println(cli.Password, cli.Username, cli.IP)<br>	<span class="hljs-keyword">if</span> err := cli.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;连接失败！&quot;</span>, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;连接成功！&quot;</span>)<br>	&#125;<br><br>	publicKey, _ := os.ReadFile(<span class="hljs-string">&quot;./keys/id_rsa.pub&quot;</span>) <span class="hljs-comment">// 这里放公钥字符串</span><br>	fmt.Println(<span class="hljs-string">&quot;publicKey:::&quot;</span>, <span class="hljs-type">string</span>(publicKey))<br>	err := cli.AddPublicKeyToRemoteHost(<span class="hljs-type">string</span>(publicKey)) <span class="hljs-comment">// 将本地的公钥发送到远程服务器的指定位置</span><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err)<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来就可以基于私钥进行免密登录了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;ssh_test/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	Host := <span class="hljs-string">&quot;10.211.55.3&quot;</span><br>	User := <span class="hljs-string">&quot;root&quot;</span><br>	Password := <span class="hljs-string">&quot;yuan0316&quot;</span><br>	Port := <span class="hljs-number">22</span><br>	Key := <span class="hljs-string">&quot;&quot;</span><br>	Mode := <span class="hljs-string">&quot;password&quot;</span><br><br>	<span class="hljs-comment">// 第2次以后采用秘钥连接</span><br>	Mode = <span class="hljs-string">&quot;key&quot;</span><br>	Password = <span class="hljs-string">&quot;&quot;</span><br><br>	privateKey, _ := os.ReadFile(<span class="hljs-string">&quot;./keys/id_rsa&quot;</span>) <span class="hljs-comment">// 这里放公钥字符串</span><br><br>	Key = <span class="hljs-type">string</span>(privateKey)<br><br>	cli := utils.NewSSH(Host, User, Password, Key, Mode, Port)<br><br>	<span class="hljs-keyword">if</span> err := cli.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;连接失败:%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;连接成功！\n&quot;</span>)<br>	&#125;<br><br>	<span class="hljs-keyword">defer</span> cli.Client.Close()<br><br>	output, err := cli.Run(<span class="hljs-string">&quot;ls&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;执行失败！&quot;</span>)<br>	&#125;<br>	fmt.Printf(<span class="hljs-string">&quot;output:\n%v&quot;</span>, output)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="4-2-3、基于ssh的主机验证"><a href="#4-2-3、基于ssh的主机验证" class="headerlink" title="4.2.3、基于ssh的主机验证"></a>4.2.3、基于ssh的主机验证</h3><p>前面我们已经完成了主机列表展示和添加了，我们实现添加主机时，新添加主机需要填写连接主机的用户名和密码，我们接下来就需要通过密码来进行主机首次连接验证，如果用户名和密码没有问题，接着我们就要给该主机写入公钥设置免密登陆，之后才能添加到主机列表中，以后对这个主机的操作都能够完成免密操作，所以基于上面封装好的SSH工具包，我们有两件事情要做：</p>
<blockquote>
<ol>
<li>在添加主机时连接一次远程主机</li>
<li>配置远程的公私钥进行免密登录</li>
</ol>
</blockquote>
<p>流程图：</p>
<p><img src="/pages_images/Bingo/image-20230910081722160.png" srcset="/img/loading.gif" lazyload alt="image-20230910081722160"></p>
<h4 id="【1】设置全局公私钥"><a href="#【1】设置全局公私钥" class="headerlink" title="【1】设置全局公私钥"></a>【1】设置全局公私钥</h4><p>因为添加主机时，允许不上传秘钥，所以为了实现免密登陆，所以我们需要提前准备一个全局的秘钥对保存在服务端。</p>
<p>基于前面我们提到的生成公私钥的指令使用ssh-keygen生成一对秘钥。当然，前面如果已经生成了，则直接复制2个文件，保存到项目根目录下的keys目录下即可。</p>
<blockquote>
<ol>
<li>bingo_api&#x2F;keys&#x2F;id_rsa文件保存私钥内容，bingo_api&#x2F;keys&#x2F;id_rsa.pub保存公钥内容</li>
<li>注意：生成的秘钥如果是换行的，不要胡乱修改！！！末尾没有空行的！！！切记！！！</li>
<li>保存了秘钥文件以后，接下来就在项目启动初始化项目配置的时候，读取到读取中。</li>
</ol>
</blockquote>
<p><code>application/config/config.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// SSHGlobalKeys SSH全局秘钥对</span><br><span class="hljs-keyword">type</span> SSHGlobalKeys <span class="hljs-keyword">struct</span> &#123;<br>	PrivateKeyPath <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;private_key_path&quot;`</span><br>	PublicKeyPath  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;public_key_path&quot;`</span><br>	PrivateKey     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;private_key&quot;`</span><br>	PublicKey      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;public_key&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// Config 整个项目的配置</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>	Mode                <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;mode&quot;`</span><br>	Port                <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;port&quot;`</span><br>	SecretKey           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;secret_key&quot;`</span><br>	*LogConfig          <span class="hljs-string">`json:&quot;log&quot;`</span><br>	*DatabaseConfig     <span class="hljs-string">`json:&quot;database&quot;`</span><br>	*RedisConfigGroup   <span class="hljs-string">`json:&quot;redis&quot;`</span><br>	*jwt.StandardClaims <span class="hljs-string">`json:&quot;jwt&quot;`</span><br>	*SSHGlobalKeys      <span class="hljs-string">`json:&quot;ssh_global_keys&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// Conf 全局配置变量</span><br><span class="hljs-keyword">var</span> Conf = <span class="hljs-built_in">new</span>(Config)<br><br><span class="hljs-comment">// Init 初始化配置；从指定文件加载配置文件</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Init</span><span class="hljs-params">(filePath <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	filePath 配置文件json文件的路径</span><br><span class="hljs-comment">	*/</span><br>	b, err := ioutil.ReadFile(filePath)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	err = json.Unmarshal(b, Conf)<br>	<span class="hljs-comment">// 读取SSH全局秘钥对</span><br>	publicKey, _ := ioutil.ReadFile(Conf.SSHGlobalKeys.PublicKeyPath)<br>	privateKey, _ := ioutil.ReadFile(Conf.SSHGlobalKeys.PrivateKeyPath)<br>	Conf.SSHGlobalKeys.PublicKey = <span class="hljs-type">string</span>(publicKey)<br>	Conf.SSHGlobalKeys.PrivateKey = <span class="hljs-type">string</span>(privateKey)<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>config.json中注意，务必填写绝对路径，否则无法识别，代码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;ssh_global_keys&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;private_key_path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;....../bingo/bingo_api/keys/id_rsa&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;public_key_path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;....../bingo/bingo_api/keys/id_rsa.pub&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>完成上面步骤以后，那么我们的Urils项目中就存在了一对随时可以更新，随时可以使用的全局秘钥对了。</p>
<p>那么接下来就可以在添加主机时，直接完成主机信息的验证和写入公钥信息到远程主机了。</p>
<h4 id="【2】主机管理实现免密登录"><a href="#【2】主机管理实现免密登录" class="headerlink" title="【2】主机管理实现免密登录"></a>【2】主机管理实现免密登录</h4><p>主机信息存储公私钥，原来的主机模型中，仅有一个key字段，所以为了方便保存公私钥，因此，我们可以拆分成2个字段保存。</p>
<p><code>application/models/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Host <span class="hljs-keyword">struct</span> &#123;<br>	gorm.Model<br>	Name           <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;name&quot; gorm:&quot;type:varchar(255)&quot;`</span><br>	IpAddr         <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;ip_addr&quot; gorm:&quot;type:varchar(255)&quot;`</span><br>	Port           <span class="hljs-type">uint</span>         <span class="hljs-string">`json:&quot;port&quot; gorm:&quot;type:int&quot;`</span><br>	Username       <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;username&quot; gorm:&quot;varchar(255)&quot;`</span><br>	Password       <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;password,omitempty&quot; gorm:&quot;varchar(255)&quot;`</span><br>	Remark         <span class="hljs-type">string</span>       <span class="hljs-string">`json:&quot;remark,omitempty&quot; gorm:&quot;varchar(255)&quot;`</span><br>	HostCategoryID <span class="hljs-type">uint</span>         <span class="hljs-string">`json:&quot;host_category_id&quot;`</span><br>	HostCategory   HostCategory <span class="hljs-string">`json:&quot;host_category&quot;  gorm:&quot;foreignKey:HostCategoryID;references:ID&quot;`</span><br><br>	PrivateKey <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;private_key,omitempty&quot; gorm:&quot;type:text&quot;`</span><br>	PublicKey  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;public_key,omitempty&quot; gorm:&quot;type:text&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>调整了模型以后，我们就需要让orm框架重新迁移当前Host模型。</p>
<p><code>application/service/host.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 数据解析注释，在validator的host.go中解析</span><br><span class="hljs-comment">/*if err = ctx.ShouldBindJSON(&amp;host); err != nil &#123;</span><br><span class="hljs-comment">		return instance, err</span><br><span class="hljs-comment">	&#125;*/</span><br></code></pre></td></tr></table></figure>

<p><code>application/validator/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> validator<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;github.com/go-playground/validator/v10&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>	<span class="hljs-string">&quot;mime/multipart&quot;</span><br>	<span class="hljs-string">&quot;strconv&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机类别的验证器</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostCategoryValidator</span><span class="hljs-params">(hostCategory *HostCategory)</span></span> <span class="hljs-type">error</span> &#123;<br>	validate, trans := GenValidate()<br>	err := validate.Struct(hostCategory)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">for</span> _, err := <span class="hljs-keyword">range</span> err.(validator.ValidationErrors) &#123;<br>			<span class="hljs-keyword">return</span> errors.New(err.Translate(trans))<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加主机的验证器</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostValidator</span><span class="hljs-params">(host *Host, ctx *gin.Context)</span></span> <span class="hljs-type">error</span> &#123;<br>  <span class="hljs-comment">// (1) 接收数据</span><br><br>	<span class="hljs-comment">// 接收多文件上传的表单数据</span><br>	form, err := ctx.MultipartForm()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;form:::&quot;</span>, form)<br><br>	<span class="hljs-comment">// 手动接收表单信息并赋值</span><br>	<span class="hljs-comment">// form.Value接收文本字段 form.File接收上传文件</span><br>	hostCategoryId, _ := strconv.Atoi(form.Value[<span class="hljs-string">&quot;host_category_id&quot;</span>][<span class="hljs-number">0</span>])<br>	host.HostCategoryID = <span class="hljs-type">uint</span>(hostCategoryId)<br>	port, _ := strconv.Atoi(form.Value[<span class="hljs-string">&quot;port&quot;</span>][<span class="hljs-number">0</span>])<br>	host.Port = <span class="hljs-type">uint</span>(port)<br>	host.Username = form.Value[<span class="hljs-string">&quot;username&quot;</span>][<span class="hljs-number">0</span>]<br>	host.Password = form.Value[<span class="hljs-string">&quot;password&quot;</span>][<span class="hljs-number">0</span>]<br>	host.Name = form.Value[<span class="hljs-string">&quot;name&quot;</span>][<span class="hljs-number">0</span>]<br>	host.IpAddr = form.Value[<span class="hljs-string">&quot;ip_addr&quot;</span>][<span class="hljs-number">0</span>]<br>	host.Remark = form.Value[<span class="hljs-string">&quot;remark&quot;</span>][<span class="hljs-number">0</span>]<br>	fmt.Println(<span class="hljs-string">&quot;host:::&quot;</span>, host)<br><br>  <span class="hljs-comment">// (2) 校验数据</span><br>  <span class="hljs-comment">// 校验基本规则</span><br>	validate, trans := GenValidate()<br>	err = validate.Struct(host)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">for</span> _, err := <span class="hljs-keyword">range</span> err.(validator.ValidationErrors) &#123;<br>			fmt.Println(<span class="hljs-string">&quot;err:::&quot;</span>, err)<br><br>			<span class="hljs-keyword">return</span> errors.New(err.Translate(trans))<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 校验类型范围</span><br>	<span class="hljs-keyword">if</span> host.HostCategoryID &lt; <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span> errors.New(constants.HostCategoryNotExist)<br>	&#125;<br><br>	<span class="hljs-keyword">var</span> hostCategory HostCategory<br>	err = hostCategory.GetOneById(host.HostCategoryID)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> errors.New(constants.HostCategoryNotExist)<br>	&#125;<br>	<span class="hljs-comment">// 校验主机是否可以ping通，可以的话，将公钥上传到服务器指定位置，方便后面的免密登录</span><br>	err = ping(host, form)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ping</span><span class="hljs-params">(host *Host, form *multipart.Form)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>  <br>  <span class="hljs-comment">// （1）获取公私钥</span><br>	<span class="hljs-comment">// 从表单中提取上传文件</span><br>	keys := form.File[<span class="hljs-string">&quot;files[]&quot;</span>] <span class="hljs-comment">// 务必与客户端上传时设置的字段名一致，否无接收不了</span><br>	<span class="hljs-comment">// 根据上传文件个数判断</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(keys) == <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-comment">// 报错，允许上传一个文件</span><br>		<span class="hljs-keyword">return</span> errors.New(constants.Missingkeys)<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(keys) == <span class="hljs-number">2</span> &#123;<br>		<span class="hljs-comment">// 上传秘钥对两个文件</span><br>		<span class="hljs-comment">// 获取第一个文件</span><br>		fileHandle1, err := keys[<span class="hljs-number">0</span>].Open()<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> err<br>		&#125;<br>		<span class="hljs-keyword">defer</span> fileHandle1.Close()<br>		fileByte, _ := ioutil.ReadAll(fileHandle1)<br>		key1 := <span class="hljs-type">string</span>(fileByte)<br><br>		<span class="hljs-comment">// 获取第二个文件</span><br>		fileHandle2, err := keys[<span class="hljs-number">1</span>].Open()<br>		<span class="hljs-keyword">defer</span> fileHandle2.Close()<br>		fileByte, _ = ioutil.ReadAll(fileHandle2)<br>		key2 := <span class="hljs-type">string</span>(fileByte)<br><br>		<span class="hljs-keyword">if</span> strings.Contains(key1, <span class="hljs-string">&quot;PRIVATE&quot;</span>) &#123; <span class="hljs-comment">// 通过判断秘钥中的内容，区分公钥和私钥。</span><br>			host.PrivateKey, host.PublicKey = key1, key2<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			host.PrivateKey, host.PublicKey = key2, key1<br>		&#125;<br><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// todo 采用全局公私钥作为默认值</span><br>		host.PublicKey, host.PrivateKey = config.Conf.PublicKey, config.Conf.PrivateKey<br>	&#125;<br><br>	<span class="hljs-comment">// （2）确认好公私钥，创建ssh对象，进行ssh操作</span><br>	cli := NewSSH(host.IpAddr, host.Username, host.Password, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>, <span class="hljs-type">int</span>(host.Port))<br>	<span class="hljs-comment">// 基于密码首次SSH连接</span><br>	<span class="hljs-keyword">if</span> err := cli.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;err&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> errors.New(constants.HostInfoEror)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;cli.Client:::&quot;</span>, cli.Client)<br>	fmt.Println(<span class="hljs-string">&quot;host.PublicKey:::&quot;</span>, host.PublicKey)<br><br>	<span class="hljs-comment">// 验证主机信息成功以后，接下来就可以把公钥写入到远程主机了。</span><br>	<span class="hljs-keyword">if</span> err := cli.AddPublicKeyToRemoteHost(host.PublicKey); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> errors.New(constants.SSHKeyIsInvalid)<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> err<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>constants/message.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> constants<br><br><span class="hljs-keyword">const</span> (<br>    <span class="hljs-comment">// ....</span><br>	HostInfoEror    = <span class="hljs-string">&quot;主机信息有误！！&quot;</span><br>	SSHKeyIsInvalid = <span class="hljs-string">&quot;无效的秘钥信息！&quot;</span><br>	Missingkeys     = <span class="hljs-string">&quot;丢失公钥或者私钥&quot;</span><br>)<br></code></pre></td></tr></table></figure>

<p>接下来，清除连接服务端的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/.ssh<br><span class="hljs-built_in">cat</span> authorized_keys<br><span class="hljs-built_in">rm</span> -rf authorized_keys<br><span class="hljs-built_in">touch</span> authorized_keys<br></code></pre></td></tr></table></figure>

<p>这样该目标主机的ssh记录就全部删除了。我们就可以基于<code>bingo_api/test/ssh/main.go</code>文件的测试例子，验证是否已经给远程主机建立了免密登陆。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;ssh_test/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	Host := <span class="hljs-string">&quot;10.211.55.3&quot;</span><br>	User := <span class="hljs-string">&quot;root&quot;</span><br>	Password := <span class="hljs-string">&quot;yuan0316&quot;</span><br>	Port := <span class="hljs-number">22</span><br>	Key := <span class="hljs-string">&quot;&quot;</span><br>	Mode := <span class="hljs-string">&quot;password&quot;</span><br><br>	<span class="hljs-comment">// 第2次以后采用秘钥连接</span><br>	Mode = <span class="hljs-string">&quot;key&quot;</span><br>	Password = <span class="hljs-string">&quot;&quot;</span><br><br>	privateKey, _ := os.ReadFile(<span class="hljs-string">&quot;./keys/id_rsa&quot;</span>) <span class="hljs-comment">// 这里放公钥字符串</span><br>	fmt.Println(<span class="hljs-string">&quot;publicKey:::&quot;</span>, <span class="hljs-type">string</span>(privateKey))<br><br>	Key = <span class="hljs-type">string</span>(privateKey)<br><br>	cli := utils.NewSSH(Host, User, Password, Key, Mode, Port)<br><br>	<span class="hljs-keyword">if</span> err := cli.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;连接失败:%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;连接成功！\n&quot;</span>)<br>	&#125;<br><br>	<span class="hljs-keyword">defer</span> cli.Client.Close()<br><br>	output, err := cli.Run(<span class="hljs-string">&quot;ls&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;执行失败！&quot;</span>)<br>	&#125;<br>	fmt.Printf(<span class="hljs-string">&quot;output:\n%v&quot;</span>, output)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>正常远程服务器中的公钥删除后，直接运行上面的代码会连接失败。</p>
<h4 id="【3】postman测试接口"><a href="#【3】postman测试接口" class="headerlink" title="【3】postman测试接口"></a>【3】postman测试接口</h4><p><img src="/pages_images/Bingo/image-20230916172514218-4856315.png" srcset="/img/loading.gif" lazyload alt="image-20230916172514218"></p>
<h4 id="【4】前端联调"><a href="#【4】前端联调" class="headerlink" title="【4】前端联调"></a>【4】前端联调</h4><p><code>Host.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;host&quot;&gt;<br><br>    &lt;div&gt;<br>      &lt;a-button type=&quot;primary&quot; @click=&quot;showModal&quot; style=&quot;margin: 8px 0&quot;&gt;添加主机&lt;/a-button&gt;<br>      &lt;a-modal width=&quot;860px&quot; v-model:visible=&quot;visible&quot; title=&quot;Basic Modal&quot; @ok=&quot;onHostFormSubmit&quot; @cancel=&quot;cancelForm&quot;&gt;<br><br>        &lt;a-form<br>            ref=&quot;formRef&quot;<br>            name=&quot;custom-validation&quot;<br>            :model=&quot;hostForm.form&quot;<br>            :rules=&quot;hostForm.rules&quot;<br>            v-bind=&quot;layout&quot;<br>            @finish=&quot;handleFinish&quot;<br>            @validate=&quot;handleValidate&quot;<br>            @finishFailed=&quot;handleFinishFailed&quot;<br>        &gt;<br>          &lt;a-form-item label=&quot;主机类别&quot; prop=&quot;zone&quot; name=&quot;category&quot;&gt;<br>            &lt;a-row&gt;<br>              &lt;a-col :span=&quot;12&quot;&gt;<br>                &lt;a-select<br>                    ref=&quot;select&quot;<br>                    v-model:value=&quot;hostForm.form.host_category_id&quot;<br>                    @change=&quot;handleCategorySelectChange&quot;<br>                &gt;<br>                  &lt;a-select-option :value=&quot;category.id&quot; v-for=&quot;category in categoryList.data&quot; :key=&quot;category.id&quot;&gt;<br>                    &#123;&#123; category.name &#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-col&gt;<br><br>            &lt;/a-row&gt;<br><br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;主机名称&quot; name=&quot;name&quot;&gt;<br>            &lt;a-input v-model:value=&quot;hostForm.form.name&quot; type=&quot;text&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br><br>          &lt;a-form-item label=&quot;连接地址&quot; name=&quot;username&quot;&gt;<br><br>            &lt;a-row&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;用户名&quot; addon-before=&quot;ssh&quot; v-model:value=&quot;hostForm.form.username&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;ip地址&quot; addon-before=&quot;@&quot; v-model:value=&quot;hostForm.form.ip_addr&quot; type=&quot;text&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>              &lt;a-col :span=&quot;8&quot;&gt;<br>                &lt;a-input placeholder=&quot;端口号&quot; addon-before=&quot;-p&quot; v-model:value=&quot;hostForm.form.port&quot; type=&quot;number&quot;<br>                         autocomplete=&quot;off&quot;/&gt;<br>              &lt;/a-col&gt;<br>            &lt;/a-row&gt;<br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;连接密码&quot; name=&quot;password&quot;&gt;<br>            &lt;a-input v-model:value=&quot;hostForm.form.password&quot; type=&quot;password&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br>          &lt;a-form-item has-feedback label=&quot;备注信息&quot; name=&quot;remark&quot;&gt;<br>            &lt;a-textarea placeholder=&quot;请输入主机备注信息&quot; v-model:value=&quot;hostForm.form.remark&quot; type=&quot;text&quot;<br>                        :auto-size=&quot;&#123; minRows: 3, maxRows: 5 &#125;&quot; autocomplete=&quot;off&quot;/&gt;<br>          &lt;/a-form-item&gt;<br><br><br>          &lt;a-form-item :wrapper-col=&quot;&#123; span: 14, offset: 4 &#125;&quot;&gt;<br>            &lt;a-button @click=&quot;resetForm&quot;&gt;Reset&lt;/a-button&gt;<br>          &lt;/a-form-item&gt;<br>        &lt;/a-form&gt;<br><br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br><br>    &lt;a-table bordered :data-source=&quot;hostList.data&quot; :columns=&quot;columns&quot;&gt;<br>      &lt;template #bodyCell=&quot;&#123; column, text, record &#125;&quot;&gt;<br>        &lt;template v-if=&quot;column.dataIndex === &#x27;name&#x27;&quot;&gt;<br>          &lt;div class=&quot;editable-cell&quot;&gt;<br>            &lt;div v-if=&quot;editableData[record.key]&quot; class=&quot;editable-cell-input-wrapper&quot;&gt;<br>              &lt;a-input v-model:value=&quot;editableData[record.key].name&quot; @pressEnter=&quot;save(record.key)&quot;/&gt;<br>              &lt;check-outlined class=&quot;editable-cell-icon-check&quot; @click=&quot;save(record.key)&quot;/&gt;<br>            &lt;/div&gt;<br>            &lt;div v-else class=&quot;editable-cell-text-wrapper&quot;&gt;<br>              &#123;&#123; text || &#x27; &#x27; &#125;&#125;<br>              &lt;edit-outlined class=&quot;editable-cell-icon&quot; @click=&quot;edit(record.key)&quot;/&gt;<br>            &lt;/div&gt;<br>          &lt;/div&gt;<br>        &lt;/template&gt;<br>        &lt;template v-else-if=&quot;column.dataIndex === &#x27;operation_edit&#x27;&quot;&gt;<br><br>          &lt;a&gt;<br>            &lt;edit-outlined/&gt;<br>          &lt;/a&gt;<br><br>        &lt;/template&gt;<br>        &lt;template v-else-if=&quot;column.dataIndex === &#x27;operation_del&#x27;&quot;&gt;<br>          &lt;a-popconfirm<br>              v-if=&quot;hostList.data.length&quot;<br>              title=&quot;Sure to delete?&quot;<br>              @confirm=&quot;onDelete(record)&quot;<br>          &gt;<br>            &lt;a&gt;<br>              &lt;delete-outlined/&gt;<br>            &lt;/a&gt;<br>          &lt;/a-popconfirm&gt;<br>        &lt;/template&gt;<br>      &lt;/template&gt;<br>    &lt;/a-table&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;computed, onMounted, reactive, ref&#125; from &#x27;vue&#x27;;<br>import &#123;CheckOutlined, DeleteOutlined, EditOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import &#123;cloneDeep&#125; from &#x27;lodash-es&#x27;;<br>import http from &quot;@/utils/http&quot;;<br>import &#123;message&#125; from &#x27;ant-design-vue&#x27;;<br><br>// 主机表格<br>const columns = [&#123;<br>  title: &#x27;类别&#x27;,<br>  dataIndex: &#x27;category_name&#x27;,<br>&#125;, &#123;<br>  title: &#x27;主机名称&#x27;,<br>  dataIndex: &#x27;name&#x27;,<br>&#125;, &#123;<br>  title: &#x27;IP地址&#x27;,<br>  dataIndex: &#x27;ip_addr&#x27;,<br>&#125;, &#123;<br>  title: &#x27;端口&#x27;,<br>  dataIndex: &#x27;port&#x27;,<br>&#125;, &#123;<br>  title: &#x27;备注&#x27;,<br>  dataIndex: &#x27;remark&#x27;,<br>&#125;, &#123;<br>  title: &#x27;编辑&#x27;,<br>  dataIndex: &#x27;operation_edit&#x27;,<br>&#125;, &#123;<br>  title: &#x27;删除&#x27;,<br>  dataIndex: &#x27;operation_del&#x27;,<br>&#125;];<br>const hostList = reactive(&#123;data: []&#125;)<br>;<br>const count = computed(() =&gt; hostList.data.length + 1);<br>const editableData = reactive(&#123;&#125;);<br>const edit = key =&gt; &#123;<br>  editableData[key] = cloneDeep(hostList.data.filter(item =&gt; key === item.key)[0]);<br>&#125;;<br>const save = key =&gt; &#123;<br>  Object.assign(hostList.data.filter(item =&gt; key === item.key)[0], editableData[key]);<br>  delete editableData[key];<br>&#125;;<br>const onDelete = record =&gt; &#123;<br><br>  console.log(&quot;delete id&quot;, record)<br>  http.delete(`/host`, &#123;<br>    params: &#123;<br>      &quot;id&quot;: record.id<br>    &#125;<br>  &#125;).then((response) =&gt; &#123;<br><br>    hostList.data = hostList.data.filter(item =&gt; item.id !== record.id);<br>    message.success(&#x27;删除主机成功！&#x27;)<br><br>  &#125;).catch((err) =&gt; &#123;<br>    message.error(&#x27;删除主机失败！&#x27;)<br>  &#125;);<br><br><br>&#125;;<br><br>// 添加主机<br>const visible = ref(false);<br>const showModal = () =&gt; &#123;<br>  visible.value = true;<br>&#125;;<br><br>const onHostFormSubmit = () =&gt; &#123;<br><br>  // 将数据提交到后台进行保存，但是先进行连接校验，验证没有问题，再保存<br>  hostForm.form.port = parseInt(hostForm.form.port)<br><br>  const formData = new FormData();<br>  for (let attr in hostForm.form) &#123;<br>    formData.append(attr, hostForm.form[attr])<br>  &#125;<br><br>  http.post(`/host`, formData).then((response) =&gt; &#123;<br>    console.log(&quot;response.data.data.host:::&quot;, response.data.data.host)<br>    hostList.data.unshift(response.data.data.host)<br>    // 清空<br>    resetForm()<br>    visible.value = false;<br>    message.success(&#x27;成功添加主机信息！&#x27;, 1)<br><br>  &#125;).catch((err) =&gt; &#123;<br>    // 清空<br>    resetForm()<br>    visible.value = false;<br>    console.log(&quot;err:::&quot;, err)<br>    message.error(&#x27;添加主机失败!&#x27;, 1.5)<br>  &#125;);<br>&#125;<br><br>const cancelForm = e =&gt; &#123;<br>  resetForm()<br>  visible.value = false;<br>&#125;;<br>const hostForm = reactive(&#123;<br>  labelCol: &#123;span: 6&#125;,<br>  wrapperCol: &#123;span: 14&#125;,<br>  other: &#x27;&#x27;,<br>  form: &#123;<br>    name: &#x27;&#x27;,<br>    host_category_id: &quot;&quot;,<br>    ip_addr: &#x27;&#x27;,<br>    username: &#x27;&#x27;,<br>    port: &#x27;&#x27;,<br>    remark: &#x27;&#x27;,<br>    password: &#x27;&#x27;<br>  &#125;,<br>  rules: &#123;<br>    name: [<br>      &#123;required: true, message: &#x27;请输入主机名称&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    password: [<br>      &#123;required: true, message: &#x27;请输入连接密码&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    host_category_id: [<br>      &#123;required: true, message: &#x27;请选择类别&#x27;, trigger: &#x27;change&#x27;&#125;<br>    ],<br>    username: [<br>      &#123;required: true, message: &#x27;请输入用户名&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 30, message: &#x27;长度在3-10位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    ip_addr: [<br>      &#123;required: true, message: &#x27;请输入连接地址&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;max: 30, message: &#x27;长度最大15位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ],<br>    port: [<br>      &#123;required: true, message: &#x27;请输入端口号&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;max: 5, message: &#x27;长度最大5位&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ]<br>  &#125;<br>&#125;);<br>const formRef = ref();<br>const layout = &#123;<br>  labelCol: &#123;<br>    span: 4,<br>  &#125;,<br>  wrapperCol: &#123;<br>    span: 24,<br>  &#125;,<br>&#125;;<br>const handleFinish = values =&gt; &#123;<br>  console.log(values, hostForm);<br>&#125;;<br><br>const handleFinishFailed = errors =&gt; &#123;<br>  console.log(errors);<br>&#125;;<br><br>const resetForm = () =&gt; &#123;<br>  formRef.value.resetFields();<br>&#125;;<br><br>const handleValidate = (...args) =&gt; &#123;<br>  console.log(args);<br>&#125;;<br><br>const handleCategorySelectChange = (value) =&gt; &#123;<br>  // 切换主机类别的回调处理<br>  console.log(value)<br>&#125;<br><br>const categoryList = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 查看主机列表<br>const getHostList = () =&gt; &#123;<br>  http.get(&quot;/host&quot;).then((res) =&gt; &#123;<br>    console.log(&quot;host_list:::&quot;, res)<br>    hostList.data = res.data.data.host_list<br>  &#125;)<br>&#125;<br>// 查看主机类别列表<br>const getHostCategory = () =&gt; &#123;<br>  http.get(&quot;/host/category&quot;).then((res) =&gt; &#123;<br>    console.log(&quot;host_category_list:::&quot;, res.data.data.host_category_list)<br>    categoryList.data = res.data.data.host_category_list<br>  &#125;)<br>&#125;<br><br><br>onMounted(() =&gt; &#123;<br>  getHostList()<br>  getHostCategory()<br>&#125;)<br><br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910081758234.png" srcset="/img/loading.gif" lazyload alt="image-20230910081758234"></p>
<p><img src="/pages_images/Bingo/image-20230910081811850.png" srcset="/img/loading.gif" lazyload alt="image-20230910081811850"></p>
<p>添加成功后检查远程服务器的<code>~/.ssh/authorized_keys</code>中是否添加公钥成功，成功后再执行上面的测试代码，即可连接成功。</p>
<p>这里有一个功能，在添加主机的模态对话框中应该配有上传公私钥的按钮，同学们可以自己补充！</p>
<p>到这里，我们的ssh免密登录功能就实现完成了。</p>
<h2 id="4-3、基于ws实现Console"><a href="#4-3、基于ws实现Console" class="headerlink" title="4.3、基于ws实现Console"></a>4.3、基于ws实现Console</h2><h3 id="4-3-1、Websocket介绍"><a href="#4-3-1、Websocket介绍" class="headerlink" title="4.3.1、Websocket介绍"></a>4.3.1、Websocket介绍</h3><p>Websocket（简称：ws）是web前端HTML5提供的一种浏览器与服务器进行全双工通讯的网络技术，属于应用层协议，它基于TCP协议开发而来，并复用HTTP的握手通道。</p>
<blockquote>
<ol>
<li>调用简单，由浏览器进行了封装提供强大的操作接口，直接使用浏览器的websocket对象即可通过事件与服务端进行websocket通信。</li>
<li>支持二进制，</li>
<li>支持双向通信, 更灵活, 更实时性， 更高效，可扩展性更好</li>
</ol>
</blockquote>
<p> 基于WebSocket实现WebSSH的目的在于解决以下几个问题：</p>
<blockquote>
<ol>
<li>取代xshell，secureRT，putty等ssh终端，达到主机信息管理和远程控制管理一体化。</li>
<li>可以方便身份认证, 访问控制</li>
<li>方便使用, 不受电脑环境的影响</li>
</ol>
</blockquote>
<p>流程图：</p>
<p><img src="/pages_images/Bingo/image-20230910082059006.png" srcset="/img/loading.gif" lazyload alt="image-20230910082059006"></p>
<p>大概步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">1. 浏览器提供console点击按钮，当用户点击以后，将主机的id发送给gin后台, 并通过HTTP请求与后台协商升级ws协议. 协议升级完成后, 后续的数据交换则遵照webSocket的协议.<br><br>2. 后台将HTTP请求升级为web Socket协议, 得到一个和浏览器数据交换的连接通道<br><br>3. 后台将数据进行解密拿到主机信息, 创建一个SSH 客户端, 与远程主机的SSH 服务端协商加密, 互相认证, 然后通过OpenChannel建立一个SSH Channel<br><br>4. 后台和远程主机有了通讯的信道, 然后后台将终端的大小等信息通过SSH Channel请求远程主机创建一个 pty(伪终端), 并请求启动当前用户的默认 shell<br><br>5. 后台通过 Socket连接通道拿到用户输入, 再通过SSH Channel将输入传给pty, pty将这些数据交给远程主机处理后按照前面指定的终端标准输出到SSH Channel中, 同时键盘输入也会发送给SSH Channel<br><br>6. 后台从SSH Channel中拿到按照终端大小的标准输出后又通过Socket连接将输出返回给浏览器, 由此变实现了Web SSH Terminal<br></code></pre></td></tr></table></figure>

<h3 id="4-3-2、基于ws的websocket测试"><a href="#4-3-2、基于ws的websocket测试" class="headerlink" title="4.3.2、基于ws的websocket测试"></a>4.3.2、基于ws的websocket测试</h3><p><strong>前端实现</strong></p>
<p>前端的终端效果我们使用xterm.js来完成。</p>
<p>Xterm.js的安装和使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install xterm<br></code></pre></td></tr></table></figure>

<p>初始化xterm.js，在<code>src/main.js</code>中添加代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;xterm/css/xterm.css&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;xterm/lib/xterm&#x27;</span><br></code></pre></td></tr></table></figure>

<p>创建组件，<code>views/Console.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;console&quot;&gt;<br>    &lt;div id=&quot;terminal&quot;&gt;&lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;onMounted&#125; from &quot;vue&quot;;<br>import &#123;Terminal&#125; from &#x27;xterm&#x27;<br>import settings from &quot;@/settings&quot;;<br>import &#123;useRoute&#125; from &quot;vue-router&quot;<br><br>const route = useRoute()<br><br>// 因爲xterm终端需要修改HTML代码，所以必须等vue显示了页面内容以后才能执行xterm相关的代码<br>onMounted(<br>    () =&gt; &#123;<br>      let term = new Terminal(&#123;<br>        rendererType: &#x27;canvas&#x27;, // 渲染类型<br>        cols: 100, // 列数<br>        rows: 50, // 行数<br>        convertEol: true, // 启用时，光标将设置为下一行的开头<br>        scrollback: 100, // 终端中的回滚量<br>        disableStdin: false, // 是否应禁用输入。<br>        cursorStyle: &#x27;underline&#x27;, // 光标样式<br>        cursorBlink: true, // 光标闪烁<br>        theme: &#123;<br>          foreground: &#x27;#ffffff&#x27;, // 字体<br>          background: &#x27;#060101&#x27;, // 背景色<br>          cursor: &#x27;help&#x27; // 设置光标<br>        &#125;<br>      &#125;)<br><br>      // 连接Websocket<br>      // let ws = new WebSocket(`$&#123;settings.wsHost&#125;/host/$&#123;route.params.id&#125;/console`)<br>      let ws = new WebSocket(`ws://localhost:8888/ping`)<br>      let cmd = &#x27;&#x27;;  // 拼接用户输入的内容<br><br>      ws.onmessage = (event) =&gt; &#123;<br>        term.write(event.data);<br>      &#125;<br><br>      term.prompt = () =&gt; &#123;<br>        term.write(&#x27;\r\n&#x27;)<br>      &#125;<br><br>      // 当用户按了键盘时<br>      term.onKey(e =&gt; &#123;<br>        console.log(e.key)<br>        const ev = e.domEvent<br>        const printable = !ev.altKey &amp;&amp; !ev.altGraphKey &amp;&amp; !ev.ctrlKey &amp;&amp; !ev.metaKey<br><br>        if (ev.key === &quot;Enter&quot;) &#123; // 回车<br>          // 按下回车键进行指令的发送<br>          console.log(&quot;cmd&quot;, cmd)<br>          ws.send(cmd)<br>          term.write(&#x27;\r\n&#x27;)<br>        &#125; else if (ev.key === &quot;Backspace&quot;) &#123; // 删除<br><br>          cmd -= e.key<br>          // Do not delete the prompt<br>          if (term._core.buffer.x &gt; 2) &#123;<br>            term.write(&#x27;\b \b&#x27;)<br>          &#125;<br>        &#125; else if (printable) &#123;<br>          term.write(e.key)<br>          cmd += e.key<br>        &#125;<br>      &#125;)<br><br>      // 显示一个ssh终端窗口<br>      term.open(document.getElementById(&#x27;terminal&#x27;))<br>    &#125;<br>)<br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>设置路由router：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Console</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../views/Console&#x27;</span><br><span class="hljs-comment">// ...</span><br>&#123;<br>    <span class="hljs-attr">meta</span>: &#123;<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;远程主机管理&#x27;</span>,<br>        <span class="hljs-attr">authentication</span>: <span class="hljs-literal">true</span><br>    &#125;,<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;host/console/:id&#x27;</span>, <span class="hljs-comment">// :id 就是当前点击的主机信息的ID主键</span><br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Console&#x27;</span>,<br>      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Console</span><br>&#125;,<br></code></pre></td></tr></table></figure>

<p>在<code>Host.vue</code>中，主机列表后面的console对应的地址，实现参数跳转。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vue">const columns = [<br>...<br>&#123;<br>  title: &#x27;console&#x27;,<br>  dataIndex: &#x27;console&#x27;,<br>&#125;,<br>...<br>]<br>...<br>&lt;template v-else-if=&quot;column.dataIndex === &#x27;console&#x27;&quot;&gt;<br>&lt;router-link :to=&quot;`/bingo/host/console/$&#123;record.id&#125;`&quot;&gt;Console&lt;/router-link&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910082121387.png" srcset="/img/loading.gif" lazyload alt="image-20230910082121387"></p>
<p><strong>后端实现</strong></p>
<p>安装依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get github.com/gorilla/websocket<br></code></pre></td></tr></table></figure>

<p>官方文档：<a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/gorilla/websocket">https://pkg.go.dev/github.com/gorilla/websocket</a></p>
<p>后端实现websocket的参考代码，在<code>test/webssh/main.go</code>中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;github.com/gorilla/websocket&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> upGrader = websocket.Upgrader&#123;<br>	CheckOrigin: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *http.Request)</span></span> <span class="hljs-type">bool</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;,<br>&#125;<br><br><span class="hljs-comment">//webSocket请求ping 返回pong</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ping</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">//升级get请求为webSocket协议</span><br>	ws, err := upGrader.Upgrade(c.Writer, c.Request, <span class="hljs-literal">nil</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ws *websocket.Conn)</span></span> &#123;<br>		_ = ws.Close()<br>	&#125;(ws)<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// 读取ws中的数据</span><br>		mt, message, err := ws.ReadMessage()<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> <span class="hljs-type">string</span>(message) == <span class="hljs-string">&quot;ping&quot;</span> &#123;<br>			message = []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>)<br>		&#125;<br>		<span class="hljs-comment">//写入ws数据</span><br>		err = ws.WriteMessage(mt, message)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	bindAddress := <span class="hljs-string">&quot;localhost:8888&quot;</span><br>	r := gin.Default()<br>	r.GET(<span class="hljs-string">&quot;/ping&quot;</span>, ping)<br>	r.Run(bindAddress)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910082138205-4305300.png" srcset="/img/loading.gif" lazyload alt="image-20230910082138205"></p>
<h3 id="4-3-3、Console功能"><a href="#4-3-3、Console功能" class="headerlink" title="4.3.3、Console功能"></a>4.3.3、Console功能</h3><h4 id="【前端实现】"><a href="#【前端实现】" class="headerlink" title="【前端实现】"></a><strong>【前端实现】</strong></h4><p>修改组件<code>views/Console.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div className=&quot;console&quot;&gt;<br>    &lt;div id=&quot;terminal&quot;&gt;&lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;onMounted&#125; from &quot;vue&quot;;<br>import &#123;Terminal&#125; from &#x27;xterm&#x27;<br>import settings from &quot;@/settings&quot;;<br>import &#123;useRoute&#125; from &quot;vue-router&quot;<br><br>const route = useRoute()<br><br>// 因爲xterm终端需要修改HTML代码，所以必须等vue显示了页面内容以后才能执行xterm相关的代码<br>onMounted(<br>    () =&gt; &#123;<br>      let term = new Terminal(&#123;<br>        rendererType: &#x27;canvas&#x27;, // 渲染类型<br>        cols: 100, // 列数<br>        rows: 50, // 行数<br>        convertEol: true, // 启用时，光标将设置为下一行的开头<br>        scrollback: 100, // 终端中的回滚量<br>        disableStdin: false, // 是否应禁用输入。<br>        cursorStyle: &#x27;underline&#x27;, // 光标样式<br>        cursorBlink: true, // 光标闪烁<br>        theme: &#123;<br>          foreground: &#x27;#ffffff&#x27;, // 字体<br>          background: &#x27;#060101&#x27;, // 背景色<br>          cursor: &#x27;help&#x27; // 设置光标<br>        &#125;<br>      &#125;)<br><br>      // 连接Websocket<br>      let ws = new WebSocket(`$&#123;settings.wsHost&#125;/host/$&#123;route.params.id&#125;/console`)<br>      let cmd = &#x27;&#x27;;  // 拼接用户输入的内容<br><br>      ws.onmessage = (event) =&gt; &#123;<br><br>        console.log(&quot;cmd:&quot;, cmd)<br>        console.log(&quot;event.data:&quot;, event.data)<br><br>        if (!cmd) &#123;<br>          //所要执行的操作<br>          term.write(event.data);<br>        &#125; else &#123;<br>          cmd = &#x27;&#x27;<br>          term.write(event.data)<br>        &#125;<br>      &#125;<br><br>      term.prompt = () =&gt; &#123;<br>        term.write(&#x27;\r\n&#x27;)<br>      &#125;<br><br>      // 当用户按了键盘时<br>      term.onKey(e =&gt; &#123;<br>        console.log(e.key)<br>        const ev = e.domEvent<br>        const printable = !ev.altKey &amp;&amp; !ev.altGraphKey &amp;&amp; !ev.ctrlKey &amp;&amp; !ev.metaKey<br><br>        if (ev.key === &quot;Enter&quot;) &#123; // 回车<br>          // 按下回车键进行指令的发送<br>          console.log(&quot;cmd&quot;, cmd)<br>          ws.send(cmd)<br>          term.write(&#x27;\r\n&#x27;)<br>        &#125; else if (ev.key === &quot;Backspace&quot;) &#123; // 删除<br>          cmd = cmd.slice(0, cmd.length - 1)<br>          // Do not delete the prompt<br>          if (term._core.buffer.x &gt; 2) &#123;<br>            term.write(&#x27;\b \b&#x27;)<br>          &#125;<br>        &#125; else if (printable) &#123;<br>          term.write(e.key)<br>          cmd += e.key<br>        &#125;<br>      &#125;)<br><br>      // 显示一个ssh终端窗口<br>      term.open(document.getElementById(&#x27;terminal&#x27;))<br>    &#125;<br>)<br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br><br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p><code>setting.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> settings = &#123;<br>    <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;http://127.0.0.1:8090/api&quot;</span>,<br>    <span class="hljs-attr">wsHost</span>: <span class="hljs-string">&#x27;ws://127.0.0.1:8090/api&#x27;</span>, <span class="hljs-comment">// websocket服务端的api服务端地址</span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> settings;<br></code></pre></td></tr></table></figure>

<h4 id="【后端实现】"><a href="#【后端实现】" class="headerlink" title="【后端实现】"></a><strong>【后端实现】</strong></h4><p><code>application/utils/ws.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gorilla/websocket&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> UpGrader = websocket.Upgrader&#123;<br>	<span class="hljs-comment">// 设置允许跨域进行ws通信</span><br>	CheckOrigin: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *http.Request)</span></span> <span class="hljs-type">bool</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;,<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>application/utils/ssh.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/constants&quot;</span><br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gorilla/websocket&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;golang.org/x/crypto/ssh&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// SSH 客户端连接信息的结构体</span><br><span class="hljs-keyword">type</span> SSH <span class="hljs-keyword">struct</span> &#123;<br>	IP       <span class="hljs-type">string</span>      <span class="hljs-comment">// IP地址</span><br>	Port     <span class="hljs-type">int</span>         <span class="hljs-comment">// 端口号</span><br>	Username <span class="hljs-type">string</span>      <span class="hljs-comment">// 用户名</span><br>	Mode     <span class="hljs-type">string</span>      <span class="hljs-comment">// 认证方式[password:密码，key:秘钥认证]</span><br>	Password <span class="hljs-type">string</span>      <span class="hljs-comment">// 密码</span><br>	Key      <span class="hljs-type">string</span>      <span class="hljs-comment">// 认证私钥</span><br>	Client   *ssh.Client <span class="hljs-comment">// ssh客户端</span><br><br>	<span class="hljs-comment">// console</span><br>	Session    *ssh.Session <span class="hljs-comment">// ssh会话对象</span><br>	Channel    ssh.Channel  <span class="hljs-comment">// ssh通信管道</span><br>	LastResult <span class="hljs-type">string</span>       <span class="hljs-comment">// 最近一次执行命令的结果</span><br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSSH</span><span class="hljs-params">(ip <span class="hljs-type">string</span>, username <span class="hljs-type">string</span>, password <span class="hljs-type">string</span>, key <span class="hljs-type">string</span>, mode <span class="hljs-type">string</span>, port ...<span class="hljs-type">int</span>)</span></span> *SSH &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	创建命令行实例</span><br><span class="hljs-comment">	@param ip IP地址</span><br><span class="hljs-comment">	@param username 用户名</span><br><span class="hljs-comment">	@param password 登陆密码</span><br><span class="hljs-comment">	@param key 认证私钥</span><br><span class="hljs-comment">	@param mode 认证模式( password: 密码 | key: 秘钥 )</span><br><span class="hljs-comment">	@param port 端口号, 不填写则默认为22</span><br><span class="hljs-comment">	*/</span><br><br>	client := <span class="hljs-built_in">new</span>(SSH)<br>	client.IP = ip<br>	client.Username = username<br>	client.Password = password<br>	client.Key = key<br>	client.Mode = mode<br><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(port) &lt;= <span class="hljs-number">0</span> &#123;<br>		client.Port = <span class="hljs-number">22</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		client.Port = port[<span class="hljs-number">0</span>]<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> client<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SSH)</span></span> Connect() <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	SSH连接</span><br><span class="hljs-comment">	*/</span><br>	config := ssh.ClientConfig&#123;<br>		User:            s.Username,<br>		HostKeyCallback: ssh.InsecureIgnoreHostKey(),<br>		Timeout:         <span class="hljs-number">10</span> * time.Second,<br>	&#125;<br><br>	<span class="hljs-comment">// 判断SSH连接的认证方式</span><br>	<span class="hljs-keyword">if</span> s.Mode == <span class="hljs-string">&quot;key&quot;</span> &#123;<br>		<span class="hljs-comment">//fmt.Println(&quot;s.Key&quot;, s.Key)</span><br>		signer, err := ssh.ParsePrivateKey([]<span class="hljs-type">byte</span>(s.Key))<br>		fmt.Println(<span class="hljs-string">&quot;signer&quot;</span>, signer)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			zap.S().Fatalf(<span class="hljs-string">&quot;ssh key signer failed: %v&quot;</span>, err)<br>		&#125;<br>		config.Auth = []ssh.AuthMethod&#123;ssh.PublicKeys(signer)&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;s.Password&quot;</span>, s.Password)<br>		config.Auth = []ssh.AuthMethod&#123;ssh.Password(s.Password)&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 创建SSH客户端</span><br>	addr := fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, s.IP, s.Port)<br>	sshClient, err := ssh.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, addr, &amp;config)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	s.Client = sshClient<br>	fmt.Println(<span class="hljs-string">&quot;sshClient&quot;</span>, sshClient)<br><br>	<span class="hljs-comment">// 创建一个客户端SSH</span><br>	session, err := s.Client.NewSession()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	s.Session = session<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s SSH)</span></span> Run(command <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	执行Shell命令</span><br><span class="hljs-comment">	@param command 要执行的命令，多个命令采用 ; 隔开</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">if</span> s.Client == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> err := s.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 创建一个客户端SSH</span><br>	session, err := s.Client.NewSession()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">defer</span> session.Close()<br>	<span class="hljs-comment">// 执行Shell命令</span><br>	buf, err := session.CombinedOutput(command)<br><br>	s.LastResult = <span class="hljs-type">string</span>(buf)<br>	<span class="hljs-keyword">return</span> s.LastResult, err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s SSH)</span></span> AddPublicKeyToRemoteHost(publicKey <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	将公钥写入目标主机</span><br><span class="hljs-comment">	700 是文档拥有可读可写可执行，同一组用户或者其他用户都不具有操作权限</span><br><span class="hljs-comment">	600 是文件拥有者可读可写，不可执行，同一组用户或者其他用户都不具有操作权限</span><br><span class="hljs-comment">	*/</span><br>	command := fmt.Sprintf(<span class="hljs-string">&quot;mkdir -p -m 700 ~/.ssh &amp;&amp; echo %v &gt;&gt; ~/.ssh/authorized_keys &amp;&amp; chmod 600 ~/.ssh/authorized_keys&quot;</span>, strings.TrimSpace(publicKey))<br>	_, err := s.Run(command)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		message := fmt.Sprintf(<span class="hljs-string">&quot;%v: %v&quot;</span>, constants.AddPublicKeyFail, err)<br>		<span class="hljs-keyword">return</span> errors.New(message)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">*************************** Web2SSH  ***************************</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">type</span> MyReader <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// 监听websocket</span><br>	ws *websocket.Conn<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r MyReader)</span></span> Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">// 从客户端（VUE）接受的命令字符串</span><br>	fmt.Println(<span class="hljs-string">&quot;正在监听：&quot;</span>, r.ws.RemoteAddr())<br>	_, cmd, err := r.ws.ReadMessage()<br>	fmt.Println(<span class="hljs-string">&quot;received cmd:&quot;</span>, cmd)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;err&quot;</span>, err)<br>	&#125;<br>	cmdB := []<span class="hljs-type">byte</span>(<span class="hljs-type">string</span>(cmd) + <span class="hljs-string">&quot;\n&quot;</span>)<br>	<span class="hljs-comment">// 将命令字符串写入到p中</span><br>	<span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> cmdB &#123;<br>		p[i] = v<br>	&#125;<br>	n = <span class="hljs-built_in">len</span>(cmdB)<br><br>	<span class="hljs-keyword">return</span> n, err<br>&#125;<br><br><span class="hljs-keyword">type</span> MyWriter <span class="hljs-keyword">struct</span> &#123;<br>	ws *websocket.Conn<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w MyWriter)</span></span> Write(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) &#123;<br><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p) != <span class="hljs-number">0</span> &#123;<br>		err := w.ws.WriteMessage(websocket.TextMessage, p)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;err&quot;</span>, err)<br>			<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(p), err<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(p), err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s SSH)</span></span> Web2SSH(ws *websocket.Conn) &#123;<br><br>	<span class="hljs-comment">// （1）配置和创建一个伪终端</span><br>	modes := ssh.TerminalModes&#123;<br>		ssh.ECHO:          <span class="hljs-number">0</span>,     <span class="hljs-comment">// 关闭回显示,</span><br>		ssh.TTY_OP_ISPEED: <span class="hljs-number">14400</span>, <span class="hljs-comment">// 设置传输速率</span><br>		ssh.TTY_OP_OSPEED: <span class="hljs-number">14400</span>, <span class="hljs-comment">// 设置传输速率</span><br>	&#125;<br>	<span class="hljs-comment">// 激活终端</span><br>	err := s.Session.RequestPty(<span class="hljs-string">&quot;xterm&quot;</span>, <span class="hljs-number">25</span>, <span class="hljs-number">80</span>, modes)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;err&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-comment">// （2）激活shell</span><br>	<span class="hljs-comment">// stdin,stdout赋值</span><br>	r := <span class="hljs-built_in">new</span>(MyReader)<br>	r.ws = ws<br>	w := <span class="hljs-built_in">new</span>(MyWriter)<br>	w.ws = ws<br>	s.Session.Stdin = r<br>	s.Session.Stdout = w<br><br>	err = s.Session.Shell() <span class="hljs-comment">// 关于session激活</span><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;err&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-comment">// 结果等待</span><br>	err = s.Session.Wait()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;err&quot;</span>, err)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>appliation/api/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*websocket请求*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostConsole</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 一、准备阶段</span><br>	<span class="hljs-comment">// 同意升级websocket请求</span><br>	ws, err := UpGrader.Upgrade(ctx.Writer, ctx.Request, <span class="hljs-literal">nil</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">// 根据ID获取主机连接信息</span><br>	id, err := strconv.Atoi(ctx.Param(<span class="hljs-string">&quot;id&quot;</span>))<br>	fmt.Println(<span class="hljs-string">&quot;id&quot;</span>, id)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	host := model.Host&#123;&#125;<br>	err = host.GetOneById(<span class="hljs-type">uint</span>(<span class="hljs-type">int</span>(id)))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;host:::&quot;</span>, host)<br><br>	<span class="hljs-comment">// 创建SSh远程连接，</span><br>	cli := NewSSH(host.IpAddr, host.Username, <span class="hljs-string">&quot;&quot;</span>, host.PrivateKey, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-type">int</span>(host.Port))<br>	<span class="hljs-keyword">if</span> err := cli.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;密钥登录成功！&quot;</span>)<br><br>	<span class="hljs-comment">// 二、实现一个web-ssh命令通信</span><br><br>	cli.Web2SSH(ws)<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>application/router/host.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">HostRouter := Router.Group(<span class="hljs-string">&quot;host&quot;</span>)<br><span class="hljs-comment">// HostRouter.Use(middleware.JWTAuthorization())</span><br>&#123;<br><span class="hljs-comment">// 用户认证登陆</span><br>HostRouter.POST(<span class="hljs-string">&quot;/&quot;</span>, api.HostCreate)<br>HostRouter.GET(<span class="hljs-string">&quot;/&quot;</span>, api.HostList)<br><br><span class="hljs-comment">// 主机类别-添加</span><br>utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, api.HostCategoryCreate)<br><span class="hljs-comment">// 主机类别-查看</span><br>utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, api.HostCategoryList)<br><span class="hljs-comment">// 主机 - 列表</span><br>utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, api.HostList)<br><span class="hljs-comment">// 主机 - 删除</span><br>utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;DELETE&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, api.HostDelete)<br><span class="hljs-comment">// 主机 - console功能</span><br>utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;:id/console&quot;</span>, api.HostConsole)<br><br>	&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230910082208783.png" srcset="/img/loading.gif" lazyload alt="image-20230910082208783"></p>
<h1 id="五、批量命令"><a href="#五、批量命令" class="headerlink" title="五、批量命令"></a>五、批量命令</h1><h2 id="5-1-展示主机信息"><a href="#5-1-展示主机信息" class="headerlink" title="5.1 展示主机信息"></a>5.1 展示主机信息</h2><p>创建组件，<code>src/views/MultiExec.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;multi_exec&quot;&gt;<br>    &lt;div&gt;<br>      &lt;h3&gt;执行主机：&lt;/h3&gt;<br>      &lt;div&gt;<br>        &lt;a-tag closable @close=&quot;log(info_index)&quot; v-for=&quot;(info,info_index) in show_host_info.data&quot; :key=&quot;info.id&quot;&gt;<br>          &#123;&#123;`$&#123;info.name&#125;($&#123;info.ip_addr&#125;:$&#123;info.port&#125;)`&#125;&#125;<br>        &lt;/a-tag&gt;<br>      &lt;/div&gt;<br>    &lt;/div&gt;<br>    &lt;div style=&quot;margin-top: 10px;&quot;&gt;<br>      &lt;a-button @click=&quot;showModal&quot;&gt;&lt;plus-outlined /&gt;从主机列表中选择&lt;/a-button&gt;<br>      &lt;a-modal :visible=&quot;visible&quot; title=&quot;选择执行主机&quot; @ok=&quot;handleOk&quot; @cancel=&quot;hideModel&quot; width=&quot;960px&quot;&gt;<br>        &lt;div&gt;<br>          &lt;a-row&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item label=&quot;主机类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;<br>                &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; v-model=&quot;host_form.form.category&quot;&gt;<br>                  &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value, index) in category_list.data&quot; :key=&quot;value.id&quot;&gt;<br>                    &#123;&#123;value.name&#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;主机别名：&quot;&gt;<br>                &lt;a-input placeholder=&quot;请输入&quot;/&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;已选：&quot;&gt;<br>                &lt;span style=&quot;margin-left: 8px&quot;&gt;<br>                  &lt;template v-if=&quot;hasSelected&quot;&gt;<br>                    &#123;&#123; `$&#123;selectedRowKeys.length&#125;` &#125;&#125; 台主机<br>                  &lt;/template&gt;<br>                &lt;/span&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-button type=&quot;primary&quot; style=&quot;margin-top: 3px;&quot;&gt; &lt;sync-outlined&gt;&lt;/sync-outlined&gt;刷新&lt;/a-button&gt;<br>            &lt;/a-col&gt;<br>          &lt;/a-row&gt;<br>        &lt;/div&gt;<br>        &lt;div&gt;<br>          &lt;a-table<br>              :columns=&quot;columns&quot;<br>              :data-source=&quot;host_list.data&quot;<br>              :pagination=&quot;false&quot;<br>              :rowKey=&quot;record =&gt; record.id&quot;<br>              :row-selection=&quot;&#123; selectedRowKeys: selectedRowKeys, onChange: onSelectChange &#125;&quot;<br>          &gt;&lt;/a-table&gt;<br>        &lt;/div&gt;<br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;ref, reactive, computed&#125; from &quot;vue&quot;;<br>import &#123;PlusOutlined, SyncOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br><br>// 表单分栏布局长度，弹窗的首行表单配置信息<br>const formItemLayout = reactive(&#123;<br>  labelCol: &#123;span: 8&#125;,<br>  wrapperCol: &#123;span: 14&#125;<br>&#125;)<br>// 表单的字段设置，弹窗的表格的每一列数据的配置信息<br>const columns = ref([<br>  &#123;<br>    slots: &#123;title: &#x27;customTitle&#x27;&#125;,<br>    scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;<br>  &#125;, &#123;<br>    title: &#x27;类别&#x27;,<br>    dataIndex: &#x27;category_name&#x27;,<br>    key: &#x27;category_name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;主机名称&#x27;,<br>    dataIndex: &#x27;name&#x27;,<br>    key: &#x27;name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;连接地址&#x27;,<br>    dataIndex: &#x27;ip_addr&#x27;,<br>    key: &#x27;ip_addr&#x27;,<br>    width: 200<br>  &#125;, &#123;<br>    title: &#x27;端口&#x27;,<br>    dataIndex: &#x27;port&#x27;,<br>    key: &#x27;port&#x27;<br>  &#125;, &#123;<br>    title: &#x27;备注信息&#x27;,<br>    dataIndex: &#x27;description&#x27;,<br>    key: &#x27;description&#x27;<br>  &#125;<br>])<br><br>// 显示选中的所有主机内容<br>const show_host_info = reactive(&#123;<br>  data:[]<br>&#125;)<br>const visible = ref(false) // 是否显示主机列表的弹窗<br><br>// 主机表单信息<br>const host_form = reactive(&#123;<br>  form: &#123;<br>    category: undefined // 当前选择的主机分类ID<br>  &#125;<br>&#125;)<br><br>// 当前显示咋表格中的主机列表数据<br>const host_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 主机分类列表<br>const category_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 已经勾选的主机ID列表<br>const selectedRowKeys = ref([])<br>// 选中的主机id列表<br>const selected_host_ids = ref([])<br><br>// 计算属性<br>const hasSelected = computed(()=&gt;&#123;<br>  return selectedRowKeys.length &gt; 0<br>&#125;)<br><br>// 显示弹窗<br>const showModal = ()=&gt;&#123;<br>  visible.value = true<br>&#125;<br><br>// 关闭弹窗<br>const hideModel = ()=&gt;&#123;<br>  visible.value = false;<br>&#125;<br><br>// 选中主机时触发的，selectedRowKeys被选中的主机id列表<br>const onSelectChange = (selectedKeys)=&gt;&#123;<br>  selectedRowKeys.value = selectedKeys<br>&#125;<br><br>const handleOk = ()=&gt;&#123;<br><br>&#125;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.multi_exec&#123;<br>  text-align: left;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p>路由代码，<code>src/router/index.js</code>，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">MultiExec</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../views/MultiExec&#x27;</span><br><span class="hljs-comment">// ...       </span><br>&#123;<br>        <span class="hljs-attr">meta</span>: &#123;<br>            <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;批量任务&#x27;</span>,<br>            <span class="hljs-attr">authenticate</span>: <span class="hljs-literal">true</span><br>        &#125;,<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;multi_exec&#x27;</span>,<br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;MultiExec&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-title class_">MultiExec</span><br>&#125;,<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230108152017505-8013031.png" srcset="/img/loading.gif" lazyload alt="image-20230108152017505"></p>
<p>获取主机分类和主机信息的列表数据并展示，<code>src/views/MultiExec.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;multi_exec&quot;&gt;<br>    &lt;div&gt;<br>      &lt;h3&gt;执行主机：&lt;/h3&gt;<br>      &lt;div&gt;<br>        &lt;a-tag closable @close=&quot;delete_select_host(info_index)&quot; v-for=&quot;(info,info_index) in show_host_info.data&quot;<br>               :key=&quot;info.id&quot;&gt;<br>          &#123;&#123; `$&#123;info.name&#125;($&#123;info.ip_addr&#125;:$&#123;info.port&#125;)` &#125;&#125;<br>        &lt;/a-tag&gt;<br>      &lt;/div&gt;<br>    &lt;/div&gt;<br>    &lt;div style=&quot;margin-top: 10px;&quot;&gt;<br>      &lt;a-button @click=&quot;showModal&quot;&gt;<br>        &lt;plus-outlined/&gt;<br>        从主机列表中选择<br>      &lt;/a-button&gt;<br>      &lt;a-modal :visible=&quot;visible&quot; title=&quot;选择执行主机&quot; @ok=&quot;handleOk&quot; @cancel=&quot;hideModel&quot; width=&quot;960px&quot;&gt;<br>        &lt;div&gt;<br>          &lt;a-row&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item label=&quot;主机类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;<br>                &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; v-model:value=&quot;host_form.form.host_category_id&quot;<br>                          @change=&quot;has_change_category&quot;&gt;<br>                  &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value, index) in category_list.data&quot; :key=&quot;value.id&quot;&gt;<br>                    &#123;&#123; value.name &#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;主机别名：&quot;&gt;<br>                &lt;a-input @blur=&quot;nameFilter&quot; v-model:value=&quot;host_form.form.name&quot; placeholder=&quot;请输入&quot;/&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;已选：&quot;&gt;<br>                &lt;span style=&quot;margin-left: 8px&quot;&gt;<br>									&#123;&#123; `$&#123;selectedRowKeys.length&#125;` &#125;&#125;台主机<br>                &lt;/span&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-button type=&quot;primary&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;refresh_data&quot;&gt;<br>                &lt;sync-outlined&gt;&lt;/sync-outlined&gt;<br>                刷新<br>              &lt;/a-button&gt;<br>            &lt;/a-col&gt;<br>          &lt;/a-row&gt;<br>        &lt;/div&gt;<br>        &lt;div&gt;<br>          &lt;a-table<br>              :columns=&quot;columns&quot;<br>              :data-source=&quot;host_list.data&quot;<br>              :pagination=&quot;false&quot;<br>              :rowKey=&quot;record =&gt; record.id&quot;<br>              :row-selection=&quot;&#123; selectedRowKeys: selectedRowKeys, onChange: onSelectChange &#125;&quot;<br>          &gt;&lt;/a-table&gt;<br>        &lt;/div&gt;<br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;computed, reactive, ref&#125; from &quot;vue&quot;;<br>import &#123;PlusOutlined, SyncOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import settings from &quot;../settings&quot;;<br>import axios from &quot;@/utils/http&quot;;<br><br>// 表单分栏布局长度，弹窗的首行表单配置信息<br>const formItemLayout = reactive(&#123;<br>  labelCol: &#123;span: 8&#125;,<br>  wrapperCol: &#123;span: 14&#125;<br>&#125;)<br>// 表单的字段设置，弹窗的表格的每一列数据的配置信息<br>const columns = ref([<br>  &#123;<br>    slots: &#123;title: &#x27;customTitle&#x27;&#125;,<br>    scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;<br>  &#125;, &#123;<br>    title: &#x27;类别&#x27;,<br>    dataIndex: &#x27;category_name&#x27;,<br>    key: &#x27;category_name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;主机名称&#x27;,<br>    dataIndex: &#x27;name&#x27;,<br>    key: &#x27;name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;连接地址&#x27;,<br>    dataIndex: &#x27;ip_addr&#x27;,<br>    key: &#x27;ip_addr&#x27;,<br>    width: 200<br>  &#125;, &#123;<br>    title: &#x27;端口&#x27;,<br>    dataIndex: &#x27;port&#x27;,<br>    key: &#x27;port&#x27;<br>  &#125;, &#123;<br>    title: &#x27;备注信息&#x27;,<br>    dataIndex: &#x27;description&#x27;,<br>    key: &#x27;description&#x27;<br>  &#125;<br>])<br><br>// 显示选中的所有主机内容<br>const show_host_info = reactive(&#123;<br>  data: []<br>&#125;)<br>const visible = ref(false) // 是否显示主机列表的弹窗<br><br>// 主机表单信息<br>const host_form = reactive(&#123;<br>  form: &#123;<br>    host_category_id: undefined,// 当前选择的主机分类ID<br>    name:&quot;&quot;<br>  &#125;<br>&#125;)<br><br>// 当前显示咋表格中的主机列表数据<br>const host_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 主机分类列表<br>const category_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 已经勾选的主机ID列表<br>const selectedRowKeys = ref([])<br>// 选中的主机id列表<br>const selected_host_ids = ref([])<br><br>// 计算属性<br>const hasSelected = computed(() =&gt; &#123;<br>  return selectedRowKeys.length &gt; 0<br>&#125;)<br><br>// 显示弹窗<br>const showModal = () =&gt; &#123;<br>  visible.value = true<br>&#125;<br><br>// 关闭弹窗<br>const hideModel = () =&gt; &#123;<br>  visible.value = false;<br>&#125;<br><br>// 选中主机时触发的，selectedRowKeys被选中的主机id列表<br>const onSelectChange = (selectedKeys) =&gt; &#123;<br>  selectedRowKeys.value = selectedKeys<br>&#125;<br><br>const get_host_category_list = () =&gt; &#123;<br>  // 获取主机类别<br>  axios.get(`$&#123;settings.host&#125;/host/category`).then((response) =&gt; &#123;<br>    category_list.data = response.data.data.host_category_list<br>  &#125;)<br>&#125;<br>get_host_category_list()<br><br><br>const get_host_list = () =&gt; &#123;<br>  // 获取主机列表<br>  console.log(&quot;host_form.form&quot;,host_form.form)<br>  let params = host_form.form<br>  axios.get(`$&#123;settings.host&#125;/host`, &#123;<br>    params: params,<br>  &#125;).then((response) =&gt; &#123;<br>    host_list.data = response.data.data.host_list<br>  &#125;)<br>&#125;<br><br>get_host_list()<br><br>const has_change_category = (category) =&gt; &#123;<br>  // 切换主机分类时，重新获取主机列表<br>  console.log(&quot;category&quot;, category)<br>  get_host_list()<br>&#125;<br><br>const nameFilter = (event) =&gt; &#123;<br>  // 切换主机分类时，重新获取主机列表<br>  console.log(host_form.form.name)<br>  get_host_list()<br>&#125;<br><br><br>const refresh_data = () =&gt; &#123;<br>  // 刷新页面<br>  // location.reload()<br>  // 刷新数据<br>  get_host_list()<br>  host_form.form.host_category_id = undefined<br>  selectedRowKeys.value = []<br>&#125;<br><br>const handleOk = () =&gt; &#123;<br>  selected_host_ids.value = []<br>  show_host_info.data = []<br>  host_list.data.forEach((v, k) =&gt; &#123;<br>    if (selectedRowKeys.value.includes(v.id)) &#123; // 判断某元素是否在数组中用includes比较合适，不能用in<br>      show_host_info.data.push(&#123;<br>        id: v.id,<br>        name: v.name,<br>        ip_addr: v.ip_addr,<br>        port: v.port<br>      &#125;)<br>      selected_host_ids.value.push(v.id)<br>    &#125;<br>  &#125;)<br>  // 关闭弹窗<br>  visible.value = false<br>&#125;<br><br>const delete_select_host = (infoIndex) =&gt; &#123;<br>  // 移除已经勾选的主机信息<br>  show_host_info.data.splice(infoIndex, 1)<br>  let idsList = selected_host_ids.value.splice(infoIndex, 1)<br>  let idIndex = selectedRowKeys.value.indexOf(idsList[0])<br>  selectedRowKeys.value.splice(idIndex, 1)<br>&#125;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.multi_exec &#123;<br>  text-align: left;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230108160337125-8013031.png" srcset="/img/loading.gif" lazyload alt="image-20230108160337125"></p>
<h2 id="5-2-指令输入框"><a href="#5-2-指令输入框" class="headerlink" title="5.2 指令输入框"></a>5.2 指令输入框</h2><h3 id="5-2-1、Ace-editor-编辑器"><a href="#5-2-1、Ace-editor-编辑器" class="headerlink" title="5.2.1、Ace-editor 编辑器"></a>5.2.1、Ace-editor 编辑器</h3><p>文档地址： <a target="_blank" rel="noopener" href="https://github.com/CarterLi/vue3-ace-editor">https://github.com/CarterLi/vue3-ace-editor</a></p>
<p>客户端根目录下，下载安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install --save-dev vue3-ace-editor<br></code></pre></td></tr></table></figure>

<p>在需要引入编辑器插件到MultiExec.vue中使用，<code>src/views/MultiExec.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;div class=&quot;cmd&quot;&gt;<br>      &lt;div&gt;执行指令： &lt;/div&gt;<br>      &lt;v-ace-editor v-model:value=&quot;content&quot; lang=&quot;sh&quot; theme=&quot;chrome&quot; style=&quot;height: 300px; font-size: 20px;margin-bottom: 1rem;&quot;&gt;&lt;/v-ace-editor&gt;<br>&lt;/div&gt;<br>&lt;div&gt;<br>  &lt;a-button type=&quot;primary&quot; &gt;&lt;thunderbolt-outlined&gt;&lt;/thunderbolt-outlined&gt;开始执行&lt;/a-button&gt;<br>&lt;/div&gt;<br><br>...<br>&lt;script setup&gt;<br>...<br>import &#123;VAceEditor&#125; from &#x27;vue3-ace-editor&#x27;;<br>import &#x27;ace-builds/src-noconflict/theme-chrome&#x27;;<br>import &#x27;ace-builds/src-noconflict/ext-language_tools&#x27;;<br>import &#x27;ace-builds/src-noconflict/mode-sh&#x27;;<br>import &#123;ThunderboltOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>...  <br><br><br>// 用户输入的模板命令<br>const content = ref(&quot;&quot;)<br>&lt;/script&gt;  <br>  <br><br></code></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;multi_exec&quot;&gt;<br>    &lt;div&gt;<br>      &lt;h3&gt;执行主机：&lt;/h3&gt;<br>      &lt;div&gt;<br>        &lt;a-tag closable @close=&quot;delete_select_host(info_index)&quot; v-for=&quot;(info,info_index) in show_host_info.data&quot;<br>               :key=&quot;info.id&quot;&gt;<br>          &#123;&#123; `$&#123;info.name&#125;($&#123;info.ip_addr&#125;:$&#123;info.port&#125;)` &#125;&#125;<br>        &lt;/a-tag&gt;<br>      &lt;/div&gt;<br>    &lt;/div&gt;<br>    &lt;div style=&quot;margin-top: 10px;&quot;&gt;<br>      &lt;a-button @click=&quot;showModal&quot;&gt;<br>        &lt;plus-outlined/&gt;<br>        从主机列表中选择<br>      &lt;/a-button&gt;<br>      &lt;a-modal :visible=&quot;visible&quot; title=&quot;选择执行主机&quot; @ok=&quot;handleOk&quot; @cancel=&quot;hideModel&quot; width=&quot;960px&quot;&gt;<br>        &lt;div&gt;<br>          &lt;a-row&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item label=&quot;主机类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;<br>                &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; v-model:value=&quot;host_form.form.category&quot;<br>                          @change=&quot;has_change_category&quot;&gt;<br>                  &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value, index) in category_list.data&quot; :key=&quot;value.id&quot;&gt;<br>                    &#123;&#123; value.name &#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;主机别名：&quot;&gt;<br>                &lt;a-input placeholder=&quot;请输入&quot;/&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;已选：&quot;&gt;<br>                &lt;span style=&quot;margin-left: 8px&quot;&gt;<br>									&#123;&#123; `$&#123;selectedRowKeys.length&#125;` &#125;&#125;台主机<br>                &lt;/span&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-button type=&quot;primary&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;refresh_data&quot;&gt;<br>                &lt;sync-outlined&gt;&lt;/sync-outlined&gt;<br>                刷新<br>              &lt;/a-button&gt;<br>            &lt;/a-col&gt;<br>          &lt;/a-row&gt;<br>        &lt;/div&gt;<br>        &lt;div&gt;<br>          &lt;a-table<br>              :columns=&quot;columns&quot;<br>              :data-source=&quot;host_list.data&quot;<br>              :pagination=&quot;false&quot;<br>              :rowKey=&quot;record =&gt; record.id&quot;<br>              :row-selection=&quot;&#123; selectedRowKeys: selectedRowKeys, onChange: onSelectChange &#125;&quot;<br>          &gt;&lt;/a-table&gt;<br>        &lt;/div&gt;<br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br><br><br>    &lt;div class=&quot;cmd&quot;&gt;<br>      &lt;div&gt;执行指令：&lt;/div&gt;<br>      &lt;v-ace-editor v-model:value=&quot;content&quot; lang=&quot;sh&quot; theme=&quot;chrome&quot;<br>                    style=&quot;height: 300px; font-size: 20px;margin-bottom: 1rem;&quot;&gt;&lt;/v-ace-editor&gt;<br>    &lt;/div&gt;<br>    &lt;div&gt;<br>      &lt;a-button type=&quot;primary&quot;&gt;<br>        &lt;thunderbolt-outlined&gt;&lt;/thunderbolt-outlined&gt;<br>        开始执行<br>      &lt;/a-button&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;computed, reactive, ref&#125; from &quot;vue&quot;;<br>import &#123;PlusOutlined, SyncOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import settings from &quot;../settings&quot;;<br>import axios from &quot;@/utils/http&quot;;<br><br><br>// vue3-ace-editor<br>import &#123;VAceEditor&#125; from &#x27;vue3-ace-editor&#x27;;<br>import &#x27;ace-builds/src-noconflict/theme-chrome&#x27;;<br>import &#x27;ace-builds/src-noconflict/ext-language_tools&#x27;;<br>import &#x27;ace-builds/src-noconflict/mode-sh&#x27;;<br>import &#123;ThunderboltOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br><br>// 表单分栏布局长度，弹窗的首行表单配置信息<br>const formItemLayout = reactive(&#123;<br>  labelCol: &#123;span: 8&#125;,<br>  wrapperCol: &#123;span: 14&#125;<br>&#125;)<br>// 表单的字段设置，弹窗的表格的每一列数据的配置信息<br>const columns = ref([<br>  &#123;<br>    slots: &#123;title: &#x27;customTitle&#x27;&#125;,<br>    scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;<br>  &#125;, &#123;<br>    title: &#x27;类别&#x27;,<br>    dataIndex: &#x27;category_name&#x27;,<br>    key: &#x27;category_name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;主机名称&#x27;,<br>    dataIndex: &#x27;name&#x27;,<br>    key: &#x27;name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;连接地址&#x27;,<br>    dataIndex: &#x27;ip_addr&#x27;,<br>    key: &#x27;ip_addr&#x27;,<br>    width: 200<br>  &#125;, &#123;<br>    title: &#x27;端口&#x27;,<br>    dataIndex: &#x27;port&#x27;,<br>    key: &#x27;port&#x27;<br>  &#125;, &#123;<br>    title: &#x27;备注信息&#x27;,<br>    dataIndex: &#x27;description&#x27;,<br>    key: &#x27;description&#x27;<br>  &#125;<br>])<br><br>// 显示选中的所有主机内容<br>const show_host_info = reactive(&#123;<br>  data: []<br>&#125;)<br>const visible = ref(false) // 是否显示主机列表的弹窗<br><br>// 主机表单信息<br>const host_form = reactive(&#123;<br>  form: &#123;<br>    category: undefined // 当前选择的主机分类ID<br>  &#125;<br>&#125;)<br><br>// 当前显示咋表格中的主机列表数据<br>const host_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 主机分类列表<br>const category_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 已经勾选的主机ID列表<br>const selectedRowKeys = ref([])<br>// 选中的主机id列表<br>const selected_host_ids = ref([])<br><br>// 计算属性<br>const hasSelected = computed(() =&gt; &#123;<br>  return selectedRowKeys.length &gt; 0<br>&#125;)<br><br>// 显示弹窗<br>const showModal = () =&gt; &#123;<br>  visible.value = true<br>&#125;<br><br>// 关闭弹窗<br>const hideModel = () =&gt; &#123;<br>  visible.value = false;<br>&#125;<br><br>// 选中主机时触发的，selectedRowKeys被选中的主机id列表<br>const onSelectChange = (selectedKeys) =&gt; &#123;<br>  selectedRowKeys.value = selectedKeys<br>&#125;<br><br>const get_host_category_list = () =&gt; &#123;<br>  // 获取主机类别<br>  axios.get(`$&#123;settings.host&#125;/host/category`).then((response) =&gt; &#123;<br>    category_list.data = response.data.data.host_category_list<br>  &#125;)<br>&#125;<br>get_host_category_list()<br><br><br>const get_host_list = (category = null) =&gt; &#123;<br>  // 获取主机列表<br>  let params = &#123;&#125;<br>  if (category !== null) &#123;<br>    params.host_category_id = category<br>  &#125;<br>  axios.get(`$&#123;settings.host&#125;/host`, &#123;<br>    params: params,<br>  &#125;).then((response) =&gt; &#123;<br>    host_list.data = response.data.data.host_list<br>  &#125;)<br>&#125;<br><br>get_host_list()<br><br>const has_change_category = (category) =&gt; &#123;<br>  // 切换主机分类时，重新获取主机列表<br>  get_host_list(category)<br>&#125;<br><br>const refresh_data = () =&gt; &#123;<br>  // 刷新页面<br>  // location.reload()<br>  // 刷新数据<br>  get_host_list()<br>  host_form.form.category = undefined<br>  selectedRowKeys.value = []<br>&#125;<br><br>const handleOk = () =&gt; &#123;<br>  selected_host_ids.value = []<br>  show_host_info.data = []<br>  host_list.data.forEach((v, k) =&gt; &#123;<br>    if (selectedRowKeys.value.includes(v.id)) &#123; // 判断某元素是否在数组中用includes比较合适，不能用in<br>      show_host_info.data.push(&#123;<br>        id: v.id,<br>        name: v.name,<br>        ip_addr: v.ip_addr,<br>        port: v.port<br>      &#125;)<br>      selected_host_ids.value.push(v.id)<br>    &#125;<br>  &#125;)<br>  // 关闭弹窗<br>  visible.value = false<br>&#125;<br><br>const delete_select_host = (infoIndex) =&gt; &#123;<br>  // 移除已经勾选的主机信息<br>  show_host_info.data.splice(infoIndex, 1)<br>  let idsList = selected_host_ids.value.splice(infoIndex, 1)<br>  let idIndex = selectedRowKeys.value.indexOf(idsList[0])<br>  selectedRowKeys.value.splice(idIndex, 1)<br>&#125;<br><br>// 用户输入的模板命令<br>const content = ref(&quot;&quot;)<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.multi_exec &#123;<br>  text-align: left;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230108160556610-8013031.png" srcset="/img/loading.gif" lazyload alt="image-20230108160556610"></p>
<h3 id="5-2-2、发送执行指令请求"><a href="#5-2-2、发送执行指令请求" class="headerlink" title="5.2.2、发送执行指令请求"></a>5.2.2、发送执行指令请求</h3><p><code>src/views/MultiExec.vue</code>，代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;execute_cmd&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">thunderbolt-outlined</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">thunderbolt-outlined</span>&gt;</span>开始执行<span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>// 中间代码省略....<br>import &#123;message&#125; from &quot;ant-design-vue&quot;;<br>// 中间代码省略....<br>const execute_cmd = () =&gt; &#123;<br>  // 远程执行命令<br>  console.log(content.value)<br>  console.log(selected_host_ids)<br>  // 执行指令操作<br>  axios.post(`$&#123;settings.host&#125;/host/cmd`, &#123;<br>    host_ids: selected_host_ids.value,<br>    cmd: content.value<br>  &#125;).then((res) =&gt; &#123;<br>    message.success(&quot;远程主机已经执行命令...&quot;)<br>  &#125;).catch((error =&gt; &#123;<br>    message.error(&quot;远程主机执行命令失败！&quot;)<br>  &#125;))<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<h3 id="5-2-3、服务端批量处理指令"><a href="#5-2-3、服务端批量处理指令" class="headerlink" title="5.2.3、服务端批量处理指令"></a>5.2.3、服务端批量处理指令</h3><p><code>application/model/host.go</code>，模型，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> CmdParam <span class="hljs-keyword">struct</span> &#123;<br>	Cmd     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;cmd&quot;`</span><br>	HostIds []<span class="hljs-type">int</span>  <span class="hljs-string">`json:&quot;host_ids&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>application/services/host.go</code>，业务，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">执行终端命令</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ExecuteCMD</span><span class="hljs-params">(id <span class="hljs-type">int</span>, cmd <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	host := Host&#123;&#125;<br>	err := host.GetOneById(<span class="hljs-type">uint</span>(id))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br><br>	cli := utils.NewSSH(host.IpAddr, host.Username, <span class="hljs-string">&quot;&quot;</span>, host.PrivateKey, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-type">int</span>(host.Port))<br>	<span class="hljs-keyword">if</span> err := cli.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, errors.New(constants.HostInfoEror)<br>	&#125;<br><br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cli *utils.SSH)</span></span> &#123;<br>		_ = cli.Client.Close()<br>		_ = cli.Session.Close()<br>	&#125;(cli)<br><br>	output, err := cli.Run(cmd)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> output, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">批量主机执行指令</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ExecuteCMDList</span><span class="hljs-params">(HostIds []<span class="hljs-type">int</span>, Cmd <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> HostIds &#123;<br>		fmt.Println(id)<br>		_, err := ExecuteCMD(id, Cmd)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> err<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>application/api/host.go</code>，接口，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment">远程主机批量执行指令</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HostRunCmdList</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 根据主机ID获取主机信息</span><br>	<span class="hljs-keyword">var</span> param = model.CmdParam&#123;&#125;<br>	err := ctx.ShouldBindJSON(&amp;param)<br>	fmt.Println(<span class="hljs-string">&quot;param:::&quot;</span>, param)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.ParamError,<br>			<span class="hljs-string">&quot;message&quot;</span>: err,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	err = ExecuteCMDList(param.HostIds, param.Cmd)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.ExecuteCMDFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>application/constants/code.go</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">ParamError     = -3   // 客户端请求参数有误！<br>ExecuteCMDFail = 1015 // 执行命令失败！<br></code></pre></td></tr></table></figure>

<p><code>application/router/host.go</code>，路由，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 主机 - 批量任务-执行指令</span><br>utils.Register(HostRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;cmd&quot;</span>, middleware.JWTAuthorization(), api.HostRunCmdList)<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20230109102502280-8013031.png" srcset="/img/loading.gif" lazyload alt="image-20230109102502280"></p>
<p>在进入选中服务器的终端环境，便可以查到新创建的文件。</p>
<p>在日常运维过程中，有些指令会经常重复被调用，所以前端还可以通过创建指令模板持久化保存到数据库中，然后执行指令模板的方式来执行模板中提前写好的指令。</p>
<h2 id="5-3-指令模板"><a href="#5-3-指令模板" class="headerlink" title="5.3 指令模板"></a>5.3 指令模板</h2><h3 id="5-3-1-服务端实现指令模板管理"><a href="#5-3-1-服务端实现指令模板管理" class="headerlink" title="5.3.1 服务端实现指令模板管理"></a>5.3.1 服务端实现指令模板管理</h3><p>服务端提供指令模板的存储模型以及操作接口，<code>application/model/command.go</code>，模型，代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> model<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/jinzhu/gorm&quot;</span><br>	. <span class="hljs-string">&quot;bingo/application/database&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">指令模板类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> CommandCategory <span class="hljs-keyword">struct</span> &#123;<br>	gorm.Model<br>	Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot; gorm:&quot;type:varchar(255);unique_index&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> CommandCategoryInstance <span class="hljs-keyword">struct</span> &#123;<br>	ID   <span class="hljs-type">uint</span>   <span class="hljs-string">`json:&quot;id&quot;`</span><br>	Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">设置表名</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category CommandCategory)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;command_category&quot;</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加指令模板类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category *CommandCategory)</span></span> Insert() <span class="hljs-type">error</span> &#123;<br>	err := Orm.Create(&amp;category).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取指令模板分类列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category CommandCategory)</span></span> GetAll() ([]CommandCategoryInstance, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> categories []CommandCategoryInstance<br>	err := Orm.Table(category.TableName()).Order(<span class="hljs-string">&quot; id DESC &quot;</span>).Select(<span class="hljs-string">&quot;id, name&quot;</span>).Scan(&amp;categories).Error<br>	<span class="hljs-keyword">return</span> categories, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据指定ID获取指令模板类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(category *CommandCategory)</span></span> GetOneById(id <span class="hljs-type">uint</span>) <span class="hljs-type">error</span> &#123;<br>	err := Orm.First(&amp;category, id).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">指令模板</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> Command <span class="hljs-keyword">struct</span> &#123;<br>	gorm.Model<br>	Name              <span class="hljs-type">string</span>          <span class="hljs-string">`json:&quot;name&quot; gorm:&quot;type:varchar(255)&quot;`</span><br>	Content           <span class="hljs-type">string</span>          <span class="hljs-string">`json:&quot;content&quot; gorm:&quot;type:text&quot;`</span><br>	CommandCategoryID <span class="hljs-type">uint</span>            <span class="hljs-string">`json:&quot;command_category_id&quot;`</span><br>	CommandCategory   CommandCategory <span class="hljs-string">`json:&quot;command_category&quot;  gorm:&quot;foreignKey:CommandCategoryID;references:ID&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> CommandInstance <span class="hljs-keyword">struct</span> &#123;<br>	ID           <span class="hljs-type">uint</span>   <span class="hljs-string">`json:&quot;id&quot;`</span><br>	Name         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>	Content      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;content&quot;`</span><br>	CategoryID   <span class="hljs-type">uint</span>   <span class="hljs-string">`json:&quot;category_id&quot;`</span><br>	CategoryName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;category_name&quot;`</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">设置表名</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(command Command)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;command_template&quot;</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加指令模板</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(command *Command)</span></span> Insert() <span class="hljs-type">error</span> &#123;<br>	err := Orm.Create(&amp;command).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取所有指令模板列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(command Command)</span></span> GetAll(name <span class="hljs-type">string</span>, commandCategoryId <span class="hljs-type">uint</span>) ([]Command, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> commands []Command<br>	query := Orm.Table(command.TableName())<br>	<span class="hljs-keyword">if</span> name != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		query = query.Where(<span class="hljs-string">&quot; name LIKE ? &quot;</span>, <span class="hljs-string">&quot;%&quot;</span>+name+<span class="hljs-string">&quot;%&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> commandCategoryId &gt; <span class="hljs-number">0</span> &#123;<br>		query = query.Where(<span class="hljs-string">&quot; command_category_id = ? &quot;</span>, commandCategoryId)<br>	&#125;<br><br>	err := query.Order(<span class="hljs-string">&quot; id DESC &quot;</span>).Preload(<span class="hljs-string">&quot;CommandCategory&quot;</span>).Find(&amp;commands).Error<br>	<span class="hljs-keyword">return</span> commands, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">根据指定ID获取指令模板</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(command *Command)</span></span> GetOneById(id <span class="hljs-type">uint</span>) <span class="hljs-type">error</span> &#123;<br>	err := Orm.Preload(<span class="hljs-string">&quot;CommandCategory&quot;</span>).First(&amp;command, id).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">删除指令模板</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(command *Command)</span></span> Delete() (err <span class="hljs-type">error</span>) &#123;<br>	err = Orm.Delete(&amp;command).Error<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注册路由，<code>application/main.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">Orm.AutoMigrate(&amp;model.CommandCategory&#123;&#125;)<br>Orm.AutoMigrate(&amp;model.Command&#123;&#125;)<br></code></pre></td></tr></table></figure>

<p><code>application/services/command.go</code>，业务，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> services<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	. <span class="hljs-string">&quot;bingo/application/model&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加指令模板类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateCmdCategory</span><span class="hljs-params">(ctx *gin.Context)</span></span> (CommandCategoryInstance, <span class="hljs-type">error</span>) &#123;<br>	hostCategory := CommandCategory&#123;&#125;<br>	<span class="hljs-keyword">var</span> instance CommandCategoryInstance<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;hostCategory); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br>	err = hostCategory.Insert()<br>	instance = CommandCategoryInstance&#123;<br>		ID:   hostCategory.ID,<br>		Name: hostCategory.Name,<br>	&#125;<br>	<span class="hljs-keyword">return</span> instance, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取指令模板类别列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetCmdCategoryList</span><span class="hljs-params">(ctx *gin.Context)</span></span> ([]CommandCategoryInstance, <span class="hljs-type">error</span>) &#123;<br>	hostCategory := CommandCategory&#123;&#125;<br>	hostCategoryList, err := hostCategory.GetAll()<br>	<span class="hljs-keyword">return</span> hostCategoryList, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加指令模板</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateCmd</span><span class="hljs-params">(ctx *gin.Context)</span></span> (CommandInstance, <span class="hljs-type">error</span>) &#123;<br>	cmd := Command&#123;&#125;<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	<span class="hljs-keyword">var</span> instance CommandInstance<br>	<span class="hljs-keyword">var</span> cmdCategory CommandCategory<br><br>	<span class="hljs-keyword">if</span> err = ctx.ShouldBindJSON(&amp;cmd); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	err = cmd.Insert()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	err = cmdCategory.GetOneById(cmd.CommandCategoryID)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> instance, err<br>	&#125;<br><br>	instance = CommandInstance&#123;<br>		ID:           cmd.ID,<br>		Name:         cmd.Name,<br>		Content:      cmd.Content,<br>		CategoryID:   cmdCategory.ID,<br>		CategoryName: cmdCategory.Name,<br>	&#125;<br>	<span class="hljs-keyword">return</span> instance, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取指令模板列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetCmdList</span><span class="hljs-params">(name <span class="hljs-type">string</span>, cmdCategoryId <span class="hljs-type">uint</span>)</span></span> ([]CommandInstance, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> cmdList []Command<br>	<span class="hljs-keyword">var</span> instanceList []CommandInstance<br>	<span class="hljs-keyword">var</span> cmd Command<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	cmdList, err = cmd.GetAll(name, cmdCategoryId)<br>	<span class="hljs-keyword">for</span> _, cmdItem := <span class="hljs-keyword">range</span> cmdList &#123;<br>		instanceList = <span class="hljs-built_in">append</span>(instanceList, CommandInstance&#123;<br>			ID:           cmdItem.ID,<br>			Name:         cmdItem.Name,<br>			Content:      cmdItem.Content,<br>			CategoryID:   cmdItem.CommandCategory.ID,<br>			CategoryName: cmdItem.CommandCategory.Name,<br>		&#125;)<br>	&#125;<br>	<span class="hljs-keyword">return</span> instanceList, err<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取指令模板信息</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetCmd</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> (CommandInstance, <span class="hljs-type">error</span>) &#123;<br>	cmd := Command&#123;&#125;<br>	err := cmd.GetOneById(<span class="hljs-type">uint</span>(id))<br>	instance := CommandInstance&#123;<br>		ID:           <span class="hljs-type">uint</span>(id),<br>		Name:         cmd.Name,<br>		Content:      cmd.Content,<br>		CategoryID:   cmd.CommandCategory.ID,<br>		CategoryName: cmd.CommandCategory.Name,<br>	&#125;<br>	<span class="hljs-keyword">return</span> instance, err<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>application/api/command.go</code>，接口，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> api<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;strconv&quot;</span><br>	<span class="hljs-string">&quot;urils/application/constants&quot;</span><br>	<span class="hljs-string">&quot;urils/application/services&quot;</span><br>)<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加指令模板类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CmdCategoryCreate</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 调用业务层完成指令模板类别的添加操作</span><br>	cmdCategory, err := services.CreateCmdCategory(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || cmdCategory.ID &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeCreateCmdCategoryFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;cmdCategory&quot;</span>: cmdCategory,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">获取所有指令模板类别</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CmdCategoryList</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 调用业务层获取指令模板类别列表</span><br>	cmdCategoryList, err := services.GetCmdCategoryList(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeGetCmdCategoryFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;cmd_category_list&quot;</span>: cmdCategoryList,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">添加指令模板</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CmdCreate</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 调用业务层创建指令模板信息</span><br>	cmd, err := services.CreateCmd(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || cmd.ID &lt; <span class="hljs-number">1</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeCreateCmdFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;cmd&quot;</span>: cmd,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">指令模板列表</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CmdList</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 接受查询指令模板列表时的筛选参数</span><br>	name, _ := ctx.GetQuery(<span class="hljs-string">&quot;name&quot;</span>)<br>	cmdCategoryId, _ := strconv.Atoi(ctx.Query(<span class="hljs-string">&quot;command_category_id&quot;</span>))<br>	<span class="hljs-comment">// 调用业务层获取指令模板列表</span><br>	cmdList, err := services.GetCmdList(name, <span class="hljs-type">uint</span>(cmdCategoryId))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeGetCmdFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;cmd_list&quot;</span>: cmdList,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">指令模板信息</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CmdInfo</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 根据模板ID获取指令模板信息</span><br>	id, err := strconv.Atoi(ctx.Param(<span class="hljs-string">&quot;id&quot;</span>))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeGetCmdFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	cmd, err := services.GetCmd(id)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusBadRequest, gin.H&#123;<br>			<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeGetCmdFail,<br>			<span class="hljs-string">&quot;message&quot;</span>: err.Error(),<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	ctx.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:    constants.CodeSuccess,<br>		<span class="hljs-string">&quot;message&quot;</span>: constants.Success,<br>		<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>			<span class="hljs-string">&quot;cmd&quot;</span>: cmd,<br>		&#125;,<br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>常量，<code>constants/code.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">CodeCreateCmdCategoryFail = <span class="hljs-number">1020</span>  <span class="hljs-comment">// 创建指令模板类别失败</span><br>CodeGetCmdCategoryFail = <span class="hljs-number">1021</span> <span class="hljs-comment">// 无法获取指令模板类别列表！</span><br>CodeCreateCmdFail = <span class="hljs-number">1022</span> <span class="hljs-comment">// 添加指令模板信息失败！</span><br>CodeGetCmdFail = <span class="hljs-number">1023</span> <span class="hljs-comment">// 指令模板不存在！！</span><br></code></pre></td></tr></table></figure>

<p><code>application/router/command.go</code>，路由，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;bingo/application/api&quot;</span><br>	<span class="hljs-string">&quot;bingo/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo/application/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitCmdRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	指令模板相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	cmdRouter := Router.Group(<span class="hljs-string">&quot;cmd&quot;</span>)<br><br>	&#123;<br>		<span class="hljs-comment">// 指令模板类别-添加</span><br>		utils.Register(cmdRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.CmdCategoryCreate)<br>		<span class="hljs-comment">// 指令模板类别-列表</span><br>		utils.Register(cmdRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;category&quot;</span>, middleware.JWTAuthorization(), api.CmdCategoryList)<br>		<span class="hljs-comment">// 指令模板-添加</span><br>		utils.Register(cmdRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, middleware.JWTAuthorization(), api.CmdCreate)<br>		<span class="hljs-comment">// 指令模板-列表</span><br>		utils.Register(cmdRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;&quot;</span>, middleware.JWTAuthorization(), api.CmdList)<br>		<span class="hljs-comment">// 指令模板-信息</span><br>		utils.Register(cmdRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;:id/info&quot;</span>, middleware.JWTAuthorization(), api.CmdInfo)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>路由初始化文件中加载command.go中的路由组，<code>application/initialize/router.go</code>，代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;bingo/application/middleware&quot;</span><br>	<span class="hljs-string">&quot;bingo/application/router&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouter</span><span class="hljs-params">()</span></span> *gin.Engine &#123;<br>	<span class="hljs-comment">// 1. 创建路由</span><br>	Router := gin.Default()<br>	Router.Use(middleware.GinLogger(), middleware.GinRecovery(<span class="hljs-literal">true</span>))<br>	Router.Use(middleware.ExceptionMiddleware)<br>	Router.Use(middleware.CORS)<br>	<span class="hljs-comment">// 2. Api路由分组</span><br>	ApiGroup := Router.Group(<span class="hljs-string">&quot;/api&quot;</span>)<br>	<span class="hljs-comment">// 3. 初始化用户相关路由</span><br>	router.InitUserRouter(ApiGroup)<br>	router.InitHostRouter(ApiGroup)<br>	router.InitCmdRouter(ApiGroup)<br>	zap.S().Info(<span class="hljs-string">&quot;路由初始化完成....&quot;</span>)<br>	<span class="hljs-keyword">return</span> Router<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-3-2、客户端展示指令模板界面与功能的实现"><a href="#5-3-2、客户端展示指令模板界面与功能的实现" class="headerlink" title="5.3.2、客户端展示指令模板界面与功能的实现"></a>5.3.2、客户端展示指令模板界面与功能的实现</h3><p>展示模板列表页面以及获取模板分类和模板信息的列表数据，创建组件，<code>src/views/TemplateManage.vue</code>，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;template_manager&quot;&gt;<br>    &lt;div class=&quot;template-top&quot;&gt;<br>      &lt;a-row&gt;<br>        &lt;a-col :span=&quot;5&quot;&gt;<br>          &lt;a-form-item label=&quot;模板类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;<br>            &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; @change=&quot;handleSelectChange&quot;<br>                      v-model:value=&quot;search.category_id&quot;&gt;<br>              &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value) in template_category_list.data&quot; :key=&quot;value.id&quot;&gt;<br>                &#123;&#123; value.name &#125;&#125;<br>              &lt;/a-select-option&gt;<br>            &lt;/a-select&gt;<br>          &lt;/a-form-item&gt;<br>        &lt;/a-col&gt;<br>        &lt;a-col :span=&quot;10&quot;&gt;<br>          &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;模板名称：&quot;&gt;<br>            &lt;a-input v-model:value=&quot;search.name&quot; placeholder=&quot;请输入&quot; @change=&quot;handleInputChange&quot;/&gt;<br>          &lt;/a-form-item&gt;<br>        &lt;/a-col&gt;<br>        &lt;a-col :span=&quot;2&quot;&gt;<br>          &lt;a-button type=&quot;primary&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;refresh_data&quot;&gt;<br>            &lt;sync-outlined&gt;&lt;/sync-outlined&gt;<br>            刷新<br>          &lt;/a-button&gt;<br>        &lt;/a-col&gt;<br>      &lt;/a-row&gt;<br>    &lt;/div&gt;<br>    &lt;div style=&quot;margin-top: 20px;&quot;&gt;<br>      &lt;a-button type=&quot;primary&quot; @click=&quot;showModal&quot;&gt;<br>        &lt;plus-outlined&gt;&lt;/plus-outlined&gt;<br>        新建<br>      &lt;/a-button&gt;<br>      &lt;!-- 新建指令模板的弹窗 --&gt;<br>      &lt;a-modal :visible=&quot;visible&quot; title=&quot;新建模板&quot; ok-text=&quot;添加&quot; cancel-text=&quot;取消&quot; @ok=&quot;handleSubmit&quot; @cancel=&quot;hideModel&quot;<br>               width=&quot;960px&quot;&gt;<br>        &lt;a-form-item label=&quot;模板类别&quot;&gt;<br>          &lt;a-row&gt;<br>            &lt;a-col :span=&quot;6&quot;&gt;<br>              &lt;a-select placeholder=&quot;&quot; v-model:value=&quot;template_form.category_id&quot;&gt;<br>                &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value) in template_category_list.data&quot; :key=&quot;value.id&quot;&gt;<br>                  &#123;&#123; value.name &#125;&#125;<br>                &lt;/a-select-option&gt;<br>              &lt;/a-select&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;6&quot;&gt;<br>              &lt;a-button type=&quot;link&quot; @click=&quot;showTemplateCategoryFormModal&quot;&gt;添加类别&lt;/a-button&gt;<br>            &lt;/a-col&gt;<br>          &lt;/a-row&gt;<br>        &lt;/a-form-item&gt;<br>        &lt;a-form-item label=&quot;模板名称&quot;&gt;<br>          &lt;a-input v-model:value=&quot;template_form.name&quot;/&gt;<br>        &lt;/a-form-item&gt;<br>        &lt;a-form-item label=&quot;模板内容&quot;&gt;<br>          &lt;v-ace-editor v-model:value=&quot;template_form.content&quot; lang=&quot;sh&quot; theme=&quot;chrome&quot;<br>                        style=&quot;height: 300px; font-size: 20px;margin-bottom: 1rem;&quot;&gt;&lt;/v-ace-editor&gt;<br>        &lt;/a-form-item&gt;<br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br>    &lt;!-- 新建模板分类弹窗 --&gt;<br>    &lt;a-modal<br>        :width=&quot;600&quot;<br>        title=&quot;新建模板类别&quot;<br>        :visible=&quot;templateCategoryFromVisible&quot;<br>        @cancel=&quot;templateCategoryFormCancel&quot;<br>        ok-text=&quot;提交&quot;<br>        cancel-text=&quot;取消&quot;<br>        @ok=&quot;onTemplateCategoryFromSubmit&quot;<br>    &gt;<br>      &lt;a-form-model ref=&quot;hostCategoryRuleForm&quot; :model=&quot;templateCategoryForm.form&quot; :rules=&quot;templateCategoryForm.rules&quot;<br>                    :label-col=&quot;templateCategoryForm.labelCol&quot; :wrapper-col=&quot;templateCategoryForm.wrapperCol&quot;&gt;<br>        &lt;a-form-model-item ref=&quot;name&quot; label=&quot;类别名称&quot; prop=&quot;name&quot;&gt;<br>          &lt;a-row&gt;<br>            &lt;a-col :span=&quot;24&quot;&gt;<br>              &lt;a-input placeholder=&quot;请输入模板类别名称&quot; v-model:value=&quot;templateCategoryForm.form.name&quot;/&gt;<br>            &lt;/a-col&gt;<br>          &lt;/a-row&gt;<br>        &lt;/a-form-model-item&gt;<br>      &lt;/a-form-model&gt;<br>    &lt;/a-modal&gt;<br>    &lt;div style=&quot;margin-top: 10px;&quot;&gt;<br>      &lt;a-table :columns=&quot;columns&quot; :data-source=&quot;templates_list.data&quot; :rowKey=&quot;record =&gt; record.id&quot;&gt;<br>        &lt;template #bodyCell=&quot;&#123; column, text, record &#125;&quot;&gt;<br>          &lt;template v-if=&quot;column.dataIndex === &#x27;action&#x27;&quot;&gt;<br>            &lt;a-popconfirm v-if=&quot;templates_list.data.length&quot; title=&quot;您确认要删除当前主机信息吗?&quot;&gt;<br>              &lt;a href=&quot;javascript:;&quot;&gt;删除&lt;/a&gt; |<br>            &lt;/a-popconfirm&gt;<br>            &lt;a href=&quot;javascript:;&quot;&gt;编辑&lt;/a&gt;<br>          &lt;/template&gt;<br>        &lt;/template&gt;<br>      &lt;/a-table&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;reactive, ref&#125; from &quot;vue&quot;;<br>import axios from &quot;@/utils/http&quot;;<br>import &#123;message&#125; from &quot;ant-design-vue&quot;;<br>import settings from &quot;@/settings&quot;;<br>import &#123;PlusOutlined, SyncOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import &#123;VAceEditor&#125; from &#x27;vue3-ace-editor&#x27;;<br>import &#x27;ace-builds/src-noconflict/theme-chrome&#x27;;<br>import &#x27;ace-builds/src-noconflict/ext-language_tools&#x27;;<br>import &#x27;ace-builds/src-noconflict/mode-sh&#x27;;<br><br>const formItemLayout = reactive(&#123;<br>  labelCol: &#123;span: 6&#125;,<br>  wrapperCol: &#123;span: 14&#125;<br>&#125;)<br><br>const columns = ref([<br>  &#123;<br>    title: &#x27;ID&#x27;,<br>    dataIndex: &#x27;id&#x27;,<br>    key: &#x27;id&#x27;,<br>    sorter: &#123;<br>      compare: (a, b) =&gt; a.id - b.id,<br>      multiple: 3,<br>    &#125;,<br>  &#125;,<br>  &#123;<br>    title: &#x27;模板类型&#x27;,<br>    dataIndex: &#x27;category_name&#x27;,<br>    key: &#x27;category_name&#x27;<br>  &#125;,<br>  &#123;<br>    title: &#x27;模板名称&#x27;,<br>    dataIndex: &#x27;name&#x27;,<br>    key: &#x27;name&#x27;,<br>  &#125;,<br>  &#123;<br>    title: &#x27;模板内容&#x27;,<br>    dataIndex: &#x27;content&#x27;,<br>    key: &#x27;content&#x27;,<br>    width: 200<br>  &#125;,<br>  &#123;<br>    title: &#x27;操作&#x27;,<br>    key: &#x27;action&#x27;,<br>    dataIndex: &#x27;action&#x27;,<br>    width: 200,<br>    scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;<br>  &#125;<br>])<br><br>// 是否显示弹窗<br>const visible = ref(false)<br><br>// 指令模板分类列表<br>const template_category_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 指令模板列表<br>const templates_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 添加指令模板时的cmd指令<br>const content = ref(&#x27;&#x27;)<br><br>const template_form = reactive(&#123;<br>  category_id: undefined,<br>  name: &#x27;&#x27;,<br>  content: &#x27;&#x27;<br>&#125;)<br><br>const search = reactive(&#123;<br>  category: null,<br>  name: &quot;&quot;,<br>&#125;)<br><br><br>const showModal = () =&gt; &#123;<br>  visible.value = true<br>&#125;<br><br>const hideModel = () =&gt; &#123;<br>  visible.value = false;<br>&#125;<br><br>const refresh_data = () =&gt; &#123;<br>  search.category = null<br>  search.name = &quot;&quot;;<br>  get_templates_list(search.category)<br>&#125;<br><br>const handleSelectChange = (value) =&gt; &#123;<br>  // 切换模板分类<br>  search.name = &quot;&quot;;<br>  get_templates_list(value)<br>&#125;<br><br>const handleInputChange = () =&gt; &#123;<br>  search.category_id = undefined<br>  console.log(search.name)<br>  get_templates_list(null, search.name)<br>&#125;<br><br>// 获取指令模板列表<br>const get_templates_list = (category = null, template_name = null) =&gt; &#123;<br>  // 查询参数<br>  let params = &#123;&#125;<br>  if (category !== null) &#123;<br>    // 如果有指定模板分类ID，则根据模板分类ID查询模板列表<br>    params.command_category_id = category<br>  &#125;<br>  if (template_name !== null) &#123;<br>    // 如果有执行模板名称，则根据模板名称查询模板列表<br>    params.name = template_name<br>  &#125;<br>  axios.get(`$&#123;settings.host&#125;/cmd`, &#123;<br>    params: params,<br>  &#125;).then(response =&gt; &#123;<br>    templates_list.data = response.data.data.cmd_list<br>  &#125;)<br>&#125;<br><br>get_templates_list()<br><br><br>// 获取模板指令分类列表<br>const get_templates_category_list = () =&gt; &#123;<br>  axios.get(`$&#123;settings.host&#125;/cmd/category`).then(response =&gt; &#123;<br>    template_category_list.data = response.data.data.cmd_category_list<br>  &#125;)<br>&#125;<br>get_templates_category_list()<br><br>const handleSubmit = () =&gt; &#123; // handleSubmit必须声明并使用这个方法，名字不能改<br>  let params = &#123;&#125;<br>  params.name = template_form.name<br>  params.command_category_id = template_form.category_id<br>  params.content = template_form.content<br>  // 拿到验证成功之后的数据<br>  // 发送添加模板的请求<br>  axios.post(`$&#123;settings.host&#125;/cmd`, params)<br>      .then(response =&gt; &#123;<br>        console.log(response)<br>        visible.value = false<br>        get_templates_list()<br>      &#125;)<br>&#125;<br><br>// 是否显示添加主机类别的弹窗<br>const templateCategoryFromVisible = ref(false)<br><br>// 添加模板类别需要的数据属性<br>const templateCategoryForm = reactive(&#123;<br>  labelCol: &#123;span: 6&#125;,<br>  wrapperCol: &#123;span: 14&#125;,<br>  other: &#x27;&#x27;,<br>  form: &#123;<br>    name: &#x27;&#x27;<br>  &#125;,<br>  rules: &#123;<br>    name: [<br>      &#123;required: true, message: &#x27;请输入类别名称&#x27;, trigger: &#x27;blur&#x27;&#125;,<br>      &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;<br>    ]<br>  &#125;<br>&#125;)<br><br>const showTemplateCategoryFormModal = () =&gt; &#123;<br>  // 显示新建主机类别的表单窗口<br>  templateCategoryFromVisible.value = true<br>&#125;<br><br>const hostCategoryFormCancel = () =&gt; &#123;<br>  // 取消并关闭添加主机类别的表单窗口<br>  resetTemplateCategoryForm() // 清空表单内容<br>  templateCategoryFromVisible.value = false // 关闭对话框<br>&#125;<br><br>const resetTemplateCategoryForm = () =&gt; &#123;<br>  // 重置添加主机类别的表单信息<br>  templateCategoryForm.form.name = &quot;&quot;;<br>&#125;<br><br>const templateCategoryFormCancel = () =&gt; &#123;<br>  // 取消并关闭添加主机类别的表单窗口<br>  resetTemplateCategoryForm() // 清空表单内容<br>  templateCategoryFromVisible.value = false // 关闭对话框<br>&#125;<br><br>const onTemplateCategoryFromSubmit = () =&gt; &#123;<br>  // 添加主机类别的表单提交处理<br>  axios.post(&quot;cmd/category&quot;, templateCategoryForm.form).then(response =&gt; &#123;<br>    if (response.data.code === 0) &#123;<br>      message.success(&#123;<br>        content: &quot;创建模板类别成功!&quot;,<br>        duration: 2,<br>      &#125;).then(() =&gt; &#123;<br>        template_category_list.data.push(response.data.data.cmdCategory)<br>        // 清空表单数据，并关闭添加主机分类表单窗口<br>        hostCategoryFormCancel()<br>      &#125;)<br>    &#125;<br>  &#125;)<br>&#125;<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.template-top &#123;<br>  margin-top: 15px;<br>  margin-bottom: 15px;<br>&#125;<br><br>.template_manager &#123;<br>  text-align: left;<br>&#125;<br>&lt;/style&gt;<br><br></code></pre></td></tr></table></figure>

<p>路由，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 代码省略。。。。</span><br>&#123;<br><span class="hljs-attr">meta</span>: &#123;<br>		<span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;指令模板&#x27;</span>,<br>		<span class="hljs-attr">authenticate</span>: <span class="hljs-literal">true</span><br>&#125;,<br><span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;template_manage&#x27;</span>,<br><span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;TemplateManage&#x27;</span>,<br><span class="hljs-attr">component</span>: <span class="hljs-title class_">TemplateManage</span><br>&#125;,<br></code></pre></td></tr></table></figure>

<p>好了，指令模板可以创建了，那么我们可以在批量执行指令的功能上，添加上选择模板执行指令的功能，并点击执行。</p>
<p><img src="/pages_images/Bingo/image-20230109111857349-8013031.png" srcset="/img/loading.gif" lazyload alt="image-20230109111857349"></p>
<p><img src="/pages_images/Bingo/image-20230109111921050-8013031.png" srcset="/img/loading.gif" lazyload alt="image-20230109111921050"></p>
<h3 id="5-3-3、执行已有的指令"><a href="#5-3-3、执行已有的指令" class="headerlink" title="5.3.3、执行已有的指令"></a>5.3.3、执行已有的指令</h3><p>在<code>src/views/MultiExec.vue</code>，中新增选择指令模板功能，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;multi_exec&quot;&gt;<br>    &lt;div&gt;<br>      &lt;h3&gt;执行主机：&lt;/h3&gt;<br>      &lt;div&gt;<br>        &lt;a-tag closable @close=&quot;delete_select_host(info_index)&quot; v-for=&quot;(info,info_index) in show_host_info.data&quot;<br>               :key=&quot;info.id&quot;&gt;<br>          &#123;&#123; `$&#123;info.name&#125;($&#123;info.ip_addr&#125;:$&#123;info.port&#125;)` &#125;&#125;<br>        &lt;/a-tag&gt;<br>      &lt;/div&gt;<br>    &lt;/div&gt;<br>    &lt;div style=&quot;margin-top: 10px;&quot;&gt;<br>      &lt;a-button @click=&quot;showModal&quot;&gt;<br>        &lt;plus-outlined/&gt;<br>        从主机列表中选择<br>      &lt;/a-button&gt;<br>      &lt;a-modal :visible=&quot;visible&quot; title=&quot;选择执行主机&quot; @ok=&quot;handleOk&quot; @cancel=&quot;hideModel&quot; width=&quot;960px&quot;&gt;<br>        &lt;div&gt;<br>          &lt;a-row&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item label=&quot;主机类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;<br>                &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; v-model:value=&quot;host_form.form.category&quot;<br>                          @change=&quot;has_change_category&quot;&gt;<br>                  &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value, index) in category_list.data&quot; :key=&quot;value.id&quot;&gt;<br>                    &#123;&#123; value.name &#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;8&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;主机别名：&quot;&gt;<br>                &lt;a-input placeholder=&quot;请输入&quot;/&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;已选：&quot;&gt;<br>                &lt;span style=&quot;margin-left: 8px&quot;&gt;<br>									&#123;&#123; `$&#123;selectedRowKeys.length&#125;` &#125;&#125;台主机<br>                &lt;/span&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-button type=&quot;primary&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;refresh_data&quot;&gt;<br>                &lt;sync-outlined&gt;&lt;/sync-outlined&gt;<br>                刷新<br>              &lt;/a-button&gt;<br>            &lt;/a-col&gt;<br>          &lt;/a-row&gt;<br>        &lt;/div&gt;<br>        &lt;div&gt;<br>          &lt;a-table<br>              :columns=&quot;columns&quot;<br>              :data-source=&quot;host_list.data&quot;<br>              :pagination=&quot;false&quot;<br>              :rowKey=&quot;record =&gt; record.id&quot;<br>              :row-selection=&quot;&#123; selectedRowKeys: selectedRowKeys, onChange: onSelectChange &#125;&quot;<br>          &gt;&lt;/a-table&gt;<br>        &lt;/div&gt;<br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br><br>    &lt;div class=&quot;cmd&quot;&gt;<br>      &lt;div&gt;执行指令：&lt;/div&gt;<br>      &lt;v-ace-editor v-model:value=&quot;content&quot; lang=&quot;sh&quot; theme=&quot;chrome&quot;<br>                    style=&quot;height: 300px; font-size: 20px;margin-bottom: 1rem;&quot;&gt;&lt;/v-ace-editor&gt;<br>    &lt;/div&gt;<br>    &lt;div style=&quot;margin-top: 20px; margin-bottom: 20px;&quot;&gt;<br>      &lt;a-button @click=&quot;showModal2&quot;&gt;<br>        &lt;plus-outlined/&gt;<br>        从执行模板中选择<br>      &lt;/a-button&gt;<br>      &lt;a-modal :visible=&quot;visible2&quot; title=&quot;选择执行模板&quot; @ok=&quot;handleOk2&quot; width=&quot;960px&quot; @cancel=&quot;hideModel2&quot;&gt;<br>        &lt;div&gt;<br>          &lt;a-row&gt;<br>            &lt;a-col :span=&quot;10&quot;&gt;<br>              &lt;a-form-item label=&quot;模板类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;<br>                &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; @change=&quot;handleSelectChange2&quot;<br>                          v-model=&quot;template_form.form.category&quot;&gt;<br>                  &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value) in template_category_list.data&quot; :key=&quot;value.id&quot;&gt;<br>                    &#123;&#123; value.name &#125;&#125;<br>                  &lt;/a-select-option&gt;<br>                &lt;/a-select&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;10&quot;&gt;<br>              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;模板名称：&quot;&gt;<br>                &lt;a-input placeholder=&quot;请输入&quot; v-model:value=&quot;template_form.form.name&quot;/&gt;<br>              &lt;/a-form-item&gt;<br>            &lt;/a-col&gt;<br>            &lt;a-col :span=&quot;4&quot;&gt;<br>              &lt;a-button type=&quot;primary&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;refresh_data2&quot;&gt;<br>                &lt;sync-outlined&gt;&lt;/sync-outlined&gt;<br>                刷新<br>              &lt;/a-button&gt;<br>            &lt;/a-col&gt;<br>          &lt;/a-row&gt;<br>        &lt;/div&gt;<br>        &lt;div&gt;<br>          &lt;a-table<br>              :columns=&quot;tem_columns&quot;<br>              :data-source=&quot;template_list.data&quot;<br>              :rowKey=&quot;record =&gt; record.id&quot;<br>              :row-selection=&quot;&#123; radioselectedRow: radioselectedRow, onChange: onSelectChange2,type: &#x27;radio&#x27; &#125;&quot;<br>          &gt;<br>          &lt;/a-table&gt;<br>        &lt;/div&gt;<br>      &lt;/a-modal&gt;<br>    &lt;/div&gt;<br>    &lt;div&gt;<br>      &lt;a-button type=&quot;primary&quot; @click=&quot;execute_cmd&quot;&gt;<br>        &lt;thunderbolt-outlined&gt;&lt;/thunderbolt-outlined&gt;<br>        开始执行<br>      &lt;/a-button&gt;<br>    &lt;/div&gt;<br><br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>import &#123;computed, reactive, ref&#125; from &quot;vue&quot;;<br>import &#123;PlusOutlined, SyncOutlined, ThunderboltOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;<br>import settings from &quot;../settings&quot;;<br>import axios from &quot;@/utils/http&quot;;<br>import &#123;message&#125; from &quot;ant-design-vue&quot;;<br><br>import &#123;VAceEditor&#125; from &#x27;vue3-ace-editor&#x27;;<br>import &#x27;ace-builds/src-noconflict/theme-chrome&#x27;;<br>import &#x27;ace-builds/src-noconflict/ext-language_tools&#x27;;<br>import &#x27;ace-builds/src-noconflict/mode-sh&#x27;;<br><br><br>// 表单分栏布局长度，弹窗的首行表单配置信息<br>const formItemLayout = reactive(&#123;<br>  labelCol: &#123;span: 8&#125;,<br>  wrapperCol: &#123;span: 14&#125;<br>&#125;)<br>// 表单的字段设置，弹窗的表格的每一列数据的配置信息<br>const columns = ref([<br>  &#123;<br>    slots: &#123;title: &#x27;customTitle&#x27;&#125;,<br>    scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;<br>  &#125;, &#123;<br>    title: &#x27;类别&#x27;,<br>    dataIndex: &#x27;category_name&#x27;,<br>    key: &#x27;category_name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;主机名称&#x27;,<br>    dataIndex: &#x27;name&#x27;,<br>    key: &#x27;name&#x27;<br>  &#125;, &#123;<br>    title: &#x27;连接地址&#x27;,<br>    dataIndex: &#x27;ip_addr&#x27;,<br>    key: &#x27;ip_addr&#x27;,<br>    width: 200<br>  &#125;, &#123;<br>    title: &#x27;端口&#x27;,<br>    dataIndex: &#x27;port&#x27;,<br>    key: &#x27;port&#x27;<br>  &#125;, &#123;<br>    title: &#x27;备注信息&#x27;,<br>    dataIndex: &#x27;description&#x27;,<br>    key: &#x27;description&#x27;<br>  &#125;<br>])<br><br>// 显示选中的所有主机内容<br>const show_host_info = reactive(&#123;<br>  data: []<br>&#125;)<br>const visible = ref(false) // 是否显示主机列表的弹窗<br><br>// 主机表单信息<br>const host_form = reactive(&#123;<br>  form: &#123;<br>    category: undefined // 当前选择的主机分类ID<br>  &#125;<br>&#125;)<br><br>// 当前显示咋表格中的主机列表数据<br>const host_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 主机分类列表<br>const category_list = reactive(&#123;<br>  data: []<br>&#125;)<br><br>// 已经勾选的主机ID列表<br>const selectedRowKeys = ref([])<br>// 选中的主机id列表<br>const selected_host_ids = ref([])<br><br>// 计算属性<br>const hasSelected = computed(() =&gt; &#123;<br>  return selectedRowKeys.length &gt; 0<br>&#125;)<br><br>// 显示弹窗<br>const showModal = () =&gt; &#123;<br>  visible.value = true<br>&#125;<br><br>// 关闭弹窗<br>const hideModel = () =&gt; &#123;<br>  visible.value = false;<br>&#125;<br><br>// 选中主机时触发的，selectedRowKeys被选中的主机id列表<br>const onSelectChange = (selectedKeys) =&gt; &#123;<br>  selectedRowKeys.value = selectedKeys<br>&#125;<br><br>const get_host_category_list = () =&gt; &#123;<br>  // 获取主机类别<br>  axios.get(`$&#123;settings.host&#125;/host/category`).then((response) =&gt; &#123;<br>    category_list.data = response.data.data.host_category_list<br>  &#125;)<br>&#125;<br>get_host_category_list()<br><br><br>const get_host_list = (category = null) =&gt; &#123;<br>  // 获取主机列表<br>  let params = &#123;&#125;<br>  if (category !== null) &#123;<br>    params.host_category_id = category<br>  &#125;<br>  axios.get(`$&#123;settings.host&#125;/host`, &#123;<br>    params: params,<br>  &#125;).then((response) =&gt; &#123;<br>    host_list.data = response.data.data.host_list<br>  &#125;)<br>&#125;<br><br>get_host_list()<br><br>const has_change_category = (category) =&gt; &#123;<br>  // 切换主机分类时，重新获取主机列表<br>  get_host_list(category)<br>&#125;<br><br>const refresh_data = () =&gt; &#123;<br>  // 刷新页面<br>  // location.reload()<br>  // 刷新数据<br>  get_host_list()<br>  host_form.form.category = undefined<br>  selectedRowKeys.value = []<br>&#125;<br><br>const handleOk = () =&gt; &#123;<br>  selected_host_ids.value = []<br>  show_host_info.data = []<br>  host_list.data.forEach((v, k) =&gt; &#123;<br>    if (selectedRowKeys.value.includes(v.id)) &#123; // 判断某元素是否在数组中用includes比较合适，不能用in<br>      show_host_info.data.push(&#123;<br>        id: v.id,<br>        name: v.name,<br>        ip_addr: v.ip_addr,<br>        port: v.port<br>      &#125;)<br>      selected_host_ids.value.push(v.id)<br>    &#125;<br>  &#125;)<br>  // 关闭弹窗<br>  visible.value = false<br>&#125;<br><br>const delete_select_host = (infoIndex) =&gt; &#123;<br>  // 移除已经勾选的主机信息<br>  show_host_info.data.splice(infoIndex, 1)<br>  let idsList = selected_host_ids.value.splice(infoIndex, 1)<br>  let idIndex = selectedRowKeys.value.indexOf(idsList[0])<br>  selectedRowKeys.value.splice(idIndex, 1)<br>&#125;<br><br>// 用户输入的模板命令<br>const content = ref(&quot;&quot;)<br><br>const execute_cmd = () =&gt; &#123;<br>  // 远程执行命令<br>  // console.log(content.value)<br>  // console.log(selected_host_ids)<br>  // 执行指令操作<br>  axios.post(`$&#123;settings.host&#125;/host/cmd`, &#123;<br>    host_ids: selected_host_ids.value,<br>    cmd: content.value<br>  &#125;).then((res) =&gt; &#123;<br>    message.success(&quot;远程主机已经执行命令...&quot;)<br>  &#125;).catch((error =&gt; &#123;<br>    message.error(&quot;远程主机执行命令失败！&quot;)<br>  &#125;))<br>&#125;<br><br>// 是否显示选择指令模板的窗口<br>const visible2 = ref(false);<br>// 搜索指令模板的数据的表单<br>const template_form = reactive(&#123;<br>  form: &#123;<br>    category: undefined,<br>    name: &quot;&quot;,<br>  &#125;<br>&#125;)<br><br>// 指令模板分类列表<br>const template_category_list = reactive(&#123;<br>  data: [],<br>&#125;)<br><br>const tem_columns = ref([<br>  &#123;<br>    title: &#x27;模板类型&#x27;,<br>    dataIndex: &#x27;category_name&#x27;,<br>    key: &#x27;category_name&#x27;<br>  &#125;,<br>  &#123;<br>    title: &#x27;模板名称&#x27;,<br>    dataIndex: &#x27;name&#x27;,<br>    key: &#x27;name&#x27;<br><br>  &#125;,<br>  &#123;<br>    title: &#x27;模板内容&#x27;,<br>    dataIndex: &#x27;content&#x27;,<br>    key: &#x27;content&#x27;,<br>    width: 200<br>  &#125;<br>])<br><br>// 指令模板列表<br>const template_list = reactive(&#123;<br>  data: [],<br>&#125;)<br><br>// 选项的指令模板的列表<br>const radioselectedRow = ref([]);<br><br>// 显示选择指令模板的弹窗<br>const showModal2 = () =&gt; &#123;<br>  visible2.value = true<br>&#125;<br><br>// 隐藏选择指令模板的弹窗<br>const hideModel2 = () =&gt; &#123;<br>  visible2.value = false;<br>&#125;<br><br>// 当选择指令模板时<br>const handleOk2 = (e) =&gt; &#123;<br>  let tid = radioselectedRow.value[0] // 选中的模板id值<br>  // 通过模板id值，找到该模板记录中的cmd值，并赋值给content属性<br>  template_list.data.forEach((v, k) =&gt; &#123;<br>    if (v.id === tid) &#123;<br>      // 把用户选择的指令模板内容显示到编辑器中<br>      content.value = v.content<br>    &#125;<br>  &#125;)<br>  visible2.value = false<br>&#125;<br><br>const onSelectChange2 = (selectedRow) =&gt; &#123;<br>  // [6, 7, 8, 9]<br>  console.log(&#x27;&gt;&gt;&gt;&gt;&gt; &#x27;, selectedRow)<br>  radioselectedRow.value = selectedRow<br>&#125;<br><br>const handleSelectChange2 = (value) =&gt; &#123;<br>  // 切换模板分类<br>  get_templates_list(value)<br>&#125;<br><br>const refresh_data2 = () =&gt; &#123;<br>  get_templates_list();<br>&#125;<br><br>// 获取指令模板分类列表<br>const get_templates_category_list = () =&gt; &#123;<br>  axios.get(`$&#123;settings.host&#125;/cmd/category`)<br>      .then(response =&gt; &#123;<br>        template_category_list.data = response.data.data.cmd_category_list<br>      &#125;)<br>&#125;<br><br>get_templates_category_list()<br><br>// 获取指令模板列表<br>const get_templates_list = (category = null) =&gt; &#123;<br>  let params = &#123;&#125;<br>  if (category !== null) &#123;<br>    params.command_category_id = category<br>  &#125;<br>  axios.get(`$&#123;settings.host&#125;/cmd`, &#123;<br>    params: params,<br>  &#125;).then(response =&gt; &#123;<br>    template_list.data = response.data.data.cmd_list<br>  &#125;)<br>&#125;<br><br>get_templates_list()<br><br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>.multi_exec &#123;<br>  text-align: left;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>

<h1 id="六、任务调度"><a href="#六、任务调度" class="headerlink" title="六、任务调度"></a>六、任务调度</h1><h2 id="6-1、第三方包"><a href="#6-1、第三方包" class="headerlink" title="6.1、第三方包"></a>6.1、第三方包</h2><h3 id="【1】linux的crontab"><a href="#【1】linux的crontab" class="headerlink" title="【1】linux的crontab"></a>【1】linux的crontab</h3><p>Linux 的 crontab 是一个用于定时执行任务的工具。通过 crontab，您可以在指定的时间点或时间间隔内运行脚本、命令或其他任务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs linux">常用命令：<br>crontab -help查看帮助<br>crontab -e创建定时任务<br>crontab -l查看定时任务<br>crontab -r删除定时任务<br><br>例：*/5 * * * * echo &quot;hello world&quot; &gt;&gt; /tmp/test.log<br>(1)表示分钟，可以取0-59<br>(2)表示小时，可以取0-23<br>(3)表示日期，可以取1-31<br>(4)表示月份，可以取1-12<br>(5)表示周几，可以取0-7，0和7表示的都是星期日<br>只支持以上5种设置，可以简记为：分时日月周<br><br>(1)星号(*)：代表所有可能的值<br>(2)逗号(,)：指定一个列表范围，例如&quot;1,2,5,9&quot;放分钟位，代表第1,2,5,9分钟<br>(3)中杆(-)：表示整数范围，例如&quot;2-6&quot;放分钟位，代表第2,3,4,5,6分钟<br>(4)反斜杆(/)：指的是时间的间隔频率，例如&quot;0-23/2&quot;放小时位，也可写成&quot;*/2&quot;，代表每2小时执行一次<br><br>每小时的第2和第20分钟执行command<br>2,20 * * * * command<br><br>在上午7点到10点的第2和第20分钟执行command<br>2,20 7-10 * * * command<br><br>每个星期一的上午7点到10点的第2和第20分钟执行command<br>2,20 7-10 * * 1 command<br><br>每隔两天的上午7到10点的第2和第20分钟执行<br>2,20 7-10 */2 ** command<br></code></pre></td></tr></table></figure>

<h3 id="【2】golang的cronexpr包"><a href="#【2】golang的cronexpr包" class="headerlink" title="【2】golang的cronexpr包"></a>【2】golang的cronexpr包</h3><p>案例1：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gorhill/cronexpr&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// * * * * * * *</span><br><span class="hljs-comment">// 秒 分 时 日 月 周 年</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 解析表达式</span><br>	expr, err := cronexpr.Parse(<span class="hljs-string">&quot;*/5 * * * * * *&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// 10:05:47</span><br>	now := time.Now()<br>	fmt.Println(<span class="hljs-string">&quot;now = &quot;</span>, now)<br>	nextTime := expr.Next(now)<br>	<span class="hljs-comment">// 是下次执行时间，不是单纯加5秒</span><br>	<span class="hljs-comment">// 5，10，15，20...秒</span><br>	fmt.Println(<span class="hljs-string">&quot;nextTime = &quot;</span>, nextTime)<br>	<span class="hljs-comment">// 执行匿名函数</span><br>	time.AfterFunc(nextTime.Sub(now), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;任务执行，时间为 &quot;</span>, nextTime)<br>	&#125;)<br>	time.Sleep(<span class="hljs-number">100</span> * time.Second)<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>案例2：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gorhill/cronexpr&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// 结合time.AfterFunc实现定时任务的执行</span><br><br><span class="hljs-comment">// 封装任务结构体</span><br><br><span class="hljs-keyword">type</span> CronJob <span class="hljs-keyword">struct</span> &#123;<br>	expr     *cronexpr.Expression<br>	nextTime time.Time<br>&#125;<br><br><span class="hljs-comment">// * * * * * * *</span><br><span class="hljs-comment">// 秒 分 时 日 月 周 年</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	cronMap := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*CronJob)<br>	now := time.Now()<br>	expr, err := cronexpr.Parse(<span class="hljs-string">&quot;*/5 * * * * * *&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	cronJob := &amp;CronJob&#123;<br>		expr:     expr,<br>		nextTime: expr.Next(now),<br>	&#125;<br>	cronMap[<span class="hljs-string">&quot;job1&quot;</span>] = cronJob<br>	<span class="hljs-comment">// 创建定时任务2</span><br>	expr, err = cronexpr.Parse(<span class="hljs-string">&quot;*/1 * * * * * *&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	cronJob = &amp;CronJob&#123;<br>		expr:     expr,<br>		nextTime: expr.Next(now),<br>	&#125;<br>	cronMap[<span class="hljs-string">&quot;job2&quot;</span>] = cronJob<br>	<span class="hljs-comment">// 调度协程，需要检查过期的任务</span><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			now = time.Now()<br>			<span class="hljs-comment">// 遍历map，取出每一个任务，检查是否过期</span><br>			<span class="hljs-keyword">for</span> jobName, cronJob := <span class="hljs-keyword">range</span> cronMap &#123;<br>				<span class="hljs-comment">// 下次执行时间在当前时间之前，或者等于当前时间</span><br>				<span class="hljs-keyword">if</span> cronJob.nextTime.Before(now) || cronJob.nextTime.Equal(now) &#123;<br>					<span class="hljs-comment">// 执行协程，更新时间</span><br>					<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(jobName <span class="hljs-type">string</span>)</span></span> &#123;<br>						fmt.Println(<span class="hljs-string">&quot;执行：&quot;</span>, jobName)<br>					&#125;(jobName)<br>					<span class="hljs-comment">// 更新时间</span><br>					cronJob.nextTime = cronJob.expr.Next(now)<br>					<span class="hljs-comment">// fmt.Println(jobName, &quot;下次执行时间：&quot;, cronJob.nextTime)</span><br>				&#125;<br>			&#125;<br>			<span class="hljs-comment">// 程序休息100毫秒再执行，提高程序性能</span><br>			<span class="hljs-keyword">select</span> &#123;<br>			<span class="hljs-keyword">case</span> &lt;-time.NewTimer(<span class="hljs-number">100</span> * time.Millisecond).C:<br>			&#125;<br>		&#125;<br>	&#125;()<br>	time.Sleep(<span class="hljs-number">100</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="【3】sort包"><a href="#【3】sort包" class="headerlink" title="【3】sort包"></a>【3】sort包</h3><ul>
<li>sort包中实现了三种基本的排序算法：插入排序、快排、堆排序，是包的内部使用，用户在使用sort包进行排序时无需考虑使用哪种排序方式，sort包会根据实际数据自动选择高效的排序算法</li>
<li>需要重写sort包中接口定义的三个方法：获取数据集合长度的Len()方法、比较两个元素大小的Less()方法、交换两个元素位置的Swap()方法</li>
<li>利用sort包，按切片中结构体的某个字段，对切片中结构体进行排序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sort&quot;</span><br>)<br><br><span class="hljs-comment">// 按切片中结构体的某个字段，对切片中结构体进行排序</span><br><br><span class="hljs-keyword">type</span> Value <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// 按num字段进行排序</span><br>	Num  <span class="hljs-type">int</span><br>	Name <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-comment">// 定义切片</span><br><span class="hljs-keyword">type</span> byNum []*Value<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	data := byNum&#123;<br>		&amp;Value&#123;<span class="hljs-number">1</span>, <span class="hljs-string">&quot;num1&quot;</span>&#125;,<br>		&amp;Value&#123;<span class="hljs-number">10</span>, <span class="hljs-string">&quot;num2&quot;</span>&#125;,<br>		&amp;Value&#123;<span class="hljs-number">8</span>, <span class="hljs-string">&quot;num3&quot;</span>&#125;,<br>		&amp;Value&#123;<span class="hljs-number">3</span>, <span class="hljs-string">&quot;num4&quot;</span>&#125;,<br>	&#125;<br>	sort.Sort(data)<br>	<span class="hljs-keyword">for</span> _, d := <span class="hljs-keyword">range</span> data &#123;<br>		fmt.Println(*d)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">//Len() int</span><br><span class="hljs-comment">//Less(i, j int) bool</span><br><span class="hljs-comment">//Swap(i, j int)</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s byNum)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(s)<br>&#125;<br><br><span class="hljs-comment">// 比较大小</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s byNum)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-comment">// 升序排序</span><br>	<span class="hljs-keyword">if</span> s[i].Num &lt;= s[j].Num &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// 交换</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s byNum)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123;<br>	s[i], s[j] = s[j], s[i]<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="【4】smtp包"><a href="#【4】smtp包" class="headerlink" title="【4】smtp包"></a>【4】smtp包</h3><ul>
<li>SMTP是一种从一端向另一端发送邮件的机制，适用于TCP &#x2F; IP模型的应用程序层</li>
<li>golang标准包net&#x2F;smtp提供了相关API，代码实现发送邮件，需要登录邮箱，开启SMTP服务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">golang13121758648@126.com<br>13121758648Yuan<br></code></pre></td></tr></table></figure>

<p><img src="/pages_images/Bingo/image-20231006153615310-6577777.png" srcset="/img/loading.gif" lazyload alt="image-20231006153615310"></p>
<p><img src="/pages_images/Bingo/image-20231006153845387-6577926.png" srcset="/img/loading.gif" lazyload alt="image-20231006153845387"></p>
<p><img src="/pages_images/Bingo/image-20231006154047978-6578049.png" srcset="/img/loading.gif" lazyload alt="image-20231006154047978"></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;net/smtp&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-comment">// 开启服务的邮箱： golang13121758648 // AVMCPJYMJLONERDT</span><br><span class="hljs-comment">// 接收邮件的邮箱： golang19131640303</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 设置发送方信息</span><br>	<span class="hljs-comment">//  Usually identity should be the empty string, to act as username.</span><br>	auth := smtp.PlainAuth(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;golang13121758648@126.com&quot;</span>,<br>		<span class="hljs-string">&quot;AVMCPJYMJLONERDT&quot;</span>, <span class="hljs-string">&quot;smtp.126.com&quot;</span>)<br>	<span class="hljs-comment">// 接收方地址</span><br>	to := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;golang19131640303@126.com&quot;</span>&#125;<br>	<span class="hljs-comment">// 接收方姓名</span><br>	nickname := <span class="hljs-string">&quot;golang19131640303&quot;</span><br>	<span class="hljs-comment">// 发送方user</span><br>	user := <span class="hljs-string">&quot;golang13121758648@126.com&quot;</span><br>	<span class="hljs-comment">// 消息格式设置</span><br>	content_type := <span class="hljs-string">&quot;Content-Type:text/plain;charset=UTF-8&quot;</span><br>	<span class="hljs-comment">// 设置邮件摘要</span><br>	subject := <span class="hljs-string">&quot;test email&quot;</span><br>	body := <span class="hljs-string">&quot;hello email&quot;</span><br>	<span class="hljs-comment">// 拼接发送的内容</span><br>	msg := []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;To: &quot;</span> + strings.Join(to, <span class="hljs-string">&quot;,&quot;</span>) + <span class="hljs-string">&quot;\r\nFrom: &quot;</span> + nickname +<br>		<span class="hljs-string">&quot;&lt;&quot;</span> + user + <span class="hljs-string">&quot;&gt;\r\nSubject: &quot;</span> + subject + <span class="hljs-string">&quot;\r\n&quot;</span> + content_type + <span class="hljs-string">&quot;\r\n\r\n\r\n&quot;</span> + body)<br>	<span class="hljs-comment">// smpt包发邮件</span><br>	err := smtp.SendMail(<span class="hljs-string">&quot;smtp.126.com:25&quot;</span>, auth, user, to, msg)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(err)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;邮件发送成功&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-2、Email初始化"><a href="#6-2、Email初始化" class="headerlink" title="6.2、Email初始化"></a>6.2、Email初始化</h2><p><code>config.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;smtp.126.com&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;25&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;from&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;golang123456&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;golang123456@126.com&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CIZFMAGBMFFEXFBM&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;pool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><code>config/config.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Config 整个项目的配置</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>	Mode                <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;mode&quot;`</span><br>	Host                <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;host&quot;`</span><br>	Port                <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;port&quot;`</span><br>	SecretKey           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;secret_key&quot;`</span><br>	*LogConfig          <span class="hljs-string">`json:&quot;log&quot;`</span><br>	*DatabaseConfig     <span class="hljs-string">`json:&quot;database&quot;`</span><br>	*jwt.StandardClaims <span class="hljs-string">`json:&quot;jwt&quot;`</span><br>	*SSHGlobalKeys      <span class="hljs-string">`json:&quot;ssh_global_keys&quot;`</span><br>	StartTime           <span class="hljs-type">int64</span><br><br>	*EmailConfig <span class="hljs-string">`json:&quot;email&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// 定义邮件配置结构体，根据app.conf</span><br><span class="hljs-keyword">type</span> EmailConfig <span class="hljs-keyword">struct</span> &#123;<br>	Host <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;host&quot;`</span><br>	Port <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;port&quot;`</span><br>	<span class="hljs-comment">// 谁发送的</span><br>	From <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;from&quot;`</span><br>	User <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user&quot;`</span><br>	Pwd  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pwd&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>email初始化：<code>application/main.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/initialize&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;path/filepath&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 路由映射</span><br>	router := initialize.InitRouter()<br>	<span class="hljs-comment">// 配置文件</span><br>	dir, err := filepath.Abs(filepath.Dir(<span class="hljs-string">&quot;.&quot;</span>))<br>	fmt.Println(<span class="hljs-string">&quot;dir:::&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>	<span class="hljs-comment">// 配置初始化</span><br>	<span class="hljs-keyword">if</span> err := InitConfig(fmt.Sprintf(<span class="hljs-string">&quot;%s/config.json&quot;</span>, dir)); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;Conf:::&quot;</span>, Conf)<br><br>	<span class="hljs-comment">// 日志初始化</span><br>	initialize.InitLogger(Conf.LogConfig)<br>	<span class="hljs-comment">// zap 提供了一个S函数和L函数给我们开发者使用，调用S函数或L函数，可以得到一个全局的线程安全的logger对象</span><br>	zap.S().Infof(<span class="hljs-string">&quot;服务端启动...端口：%d&quot;</span>, Conf.Port)<br>	<span class="hljs-comment">// 数据库MySQL的配置</span><br>	initialize.InitDB(Conf.DatabaseConfig)<br><br>	<span class="hljs-comment">// email初始化</span><br>	InitEmail(Conf.EmailConfig)<br>  <br>	<span class="hljs-comment">// 监听端口</span><br>	router.Run(fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, Conf.Host, Conf.Port))<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>utils/email.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>	<span class="hljs-string">&quot;net/smtp&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// 定义邮件结构体</span><br><span class="hljs-keyword">type</span> Email <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">//msg := []byte(&quot;To: &quot; + strings.Join(to, &quot;,&quot;) + &quot;\r\nFrom: &quot; + nickname +</span><br>	<span class="hljs-comment">//&quot;&lt;&quot; + user + &quot;&gt;\r\nSubject: &quot; + subject + &quot;\r\n&quot; + content_type + &quot;\r\n\r\n\r\n&quot; + body)</span><br>	<span class="hljs-comment">// 邮件主题</span><br>	Subject <span class="hljs-type">string</span><br>	<span class="hljs-comment">// 具体内容</span><br>	Body <span class="hljs-type">string</span><br>	<span class="hljs-comment">// 发送给谁</span><br>	To <span class="hljs-type">string</span><br>	<span class="hljs-comment">// 邮件解析格式</span><br>	Format <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-comment">// 定义全局变量</span><br><span class="hljs-keyword">var</span> (<br>	<span class="hljs-comment">// 邮件管道</span><br>	emailChan <span class="hljs-keyword">chan</span> *Email<br>)<br><br><span class="hljs-comment">// 1.读配置，组装邮件对象</span><br><span class="hljs-comment">// 2.创建邮件管道</span><br><span class="hljs-comment">// 3.开启子协程，监听邮件管道，来数据发邮件</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitEmail</span><span class="hljs-params">(emailConfig *EmailConfig)</span></span> &#123;<br><br>	fmt.Println(<span class="hljs-string">&quot;emailConfig:::&quot;</span>, emailConfig)<br>	host := emailConfig.Host<br>	port := emailConfig.Port<br>	<span class="hljs-comment">//from := emailConfig.From</span><br>	username := emailConfig.User<br>	password := emailConfig.Pwd<br>	poolSize := <span class="hljs-number">10</span><br>	<span class="hljs-comment">// 2.创建邮件管道</span><br>	emailChan = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Email, poolSize)<br>	<span class="hljs-comment">// 3.开启子协程，监听邮件管道，来数据发邮件</span><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-comment">// 监听管道数据</span><br>			<span class="hljs-keyword">select</span> &#123;<br>			<span class="hljs-keyword">case</span> email, ok := &lt;-emailChan:<br>				<span class="hljs-keyword">if</span> !ok &#123;<br>					<span class="hljs-keyword">return</span><br>				&#125;<br>				<span class="hljs-comment">// 发邮件的逻辑</span><br>				<span class="hljs-comment">// 设置发送方邮箱用户名。。。前提是开启了SMTP</span><br>				fmt.Println(<span class="hljs-string">&quot;PPP:::&quot;</span>, username, password, host)<br>				auth := smtp.PlainAuth(<span class="hljs-string">&quot;&quot;</span>, username, password, host)<br>				fmt.Println(<span class="hljs-string">&quot;auth:::&quot;</span>, auth)<br>				<span class="hljs-comment">// 处理发送给谁</span><br>				sendTo := strings.Split(email.To, <span class="hljs-string">&quot;;&quot;</span>)<br>				fmt.Println(<span class="hljs-string">&quot;sendTo:::&quot;</span>, sendTo)<br>				<span class="hljs-comment">// 设置邮箱的解析格式</span><br>				<span class="hljs-keyword">var</span> contentType <span class="hljs-type">string</span><br>				<span class="hljs-keyword">if</span> email.Format == <span class="hljs-string">&quot;&quot;</span> &#123;<br>					contentType = <span class="hljs-string">&quot;Content-Type:text/plain;charset=UTF-8&quot;</span><br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					contentType = <span class="hljs-string">&quot;Content-Type: &quot;</span> + email.Format + <span class="hljs-string">&quot;;charset=UTF-8&quot;</span><br>				&#125;<br>				msg := []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;To: &quot;</span> + email.To + <span class="hljs-string">&quot;\r\nFrom: &quot;</span> + username +<br>					<span class="hljs-string">&quot;\r\nSubject: &quot;</span> + email.Subject + <span class="hljs-string">&quot;\r\n&quot;</span> + contentType + <span class="hljs-string">&quot;\r\n&quot;</span> + email.Body)<br>				<span class="hljs-comment">// 发送邮件</span><br>				err := smtp.SendMail(host+<span class="hljs-string">&quot;:&quot;</span>+port, auth, username, sendTo, msg)<br>				fmt.Println(<span class="hljs-string">&quot;err:::&quot;</span>, err)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					zap.S().Error(<span class="hljs-string">&quot;SendEmail:&quot;</span>, err.Error())<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;()<br>&#125;<br><br><span class="hljs-comment">// 提供一个其他包调用的发邮件的方法</span><br><span class="hljs-comment">// 1.邮件接收方</span><br><span class="hljs-comment">// 2.邮件摘要/标题</span><br><span class="hljs-comment">// 3.邮件内容</span><br><span class="hljs-comment">// 4.邮件格式</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SendToChan</span><span class="hljs-params">(to, subject, body, mailtype <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-comment">// 组装对象</span><br>	email := &amp;Email&#123;<br>		Body:    body,<br>		Subject: subject,<br>		Format:  mailtype,<br>		To:      to,<br>	&#125;<br>	<span class="hljs-keyword">select</span> &#123;<br>	<span class="hljs-keyword">case</span> emailChan &lt;- email:<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	<span class="hljs-keyword">case</span> &lt;-time.After(time.Second * <span class="hljs-number">3</span>):<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="6-3、任务相关model"><a href="#6-3、任务相关model" class="headerlink" title="6.3、任务相关model"></a>6.3、任务相关model</h2><p><code>model/tasks.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> model<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/database&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">// 用常量定义了任务状态</span><br><span class="hljs-comment">// 0-正常 -1-错误 -2-超时</span><br><span class="hljs-keyword">const</span> (<br>	TASK_SUCESS  = <span class="hljs-number">0</span><br>	TASK_ERROR   = <span class="hljs-number">-1</span><br>	TSAK_TIMEOUT = <span class="hljs-number">-2</span><br>)<br><br><span class="hljs-comment">// 任务</span><br><span class="hljs-keyword">type</span> Task <span class="hljs-keyword">struct</span> &#123;<br>	Id            <span class="hljs-type">int</span><br>	GroupId       <span class="hljs-type">int</span><br>	ServerId      <span class="hljs-type">int</span><br>	TaskName      <span class="hljs-type">string</span><br>	Description   <span class="hljs-type">string</span><br>	CronSpec      <span class="hljs-type">string</span><br>	Concurrent    <span class="hljs-type">int</span><br>	Command       <span class="hljs-type">string</span><br>	Timeout       <span class="hljs-type">int</span><br>	ExecuteTimes  <span class="hljs-type">int</span><br>	PrevTime      <span class="hljs-type">int64</span><br>	IsNotify      <span class="hljs-type">int</span><br>	NotifyType    <span class="hljs-type">int</span><br>	NotifyUserIds <span class="hljs-type">string</span><br>	Status        <span class="hljs-type">int</span><br>	CreateTime    <span class="hljs-type">int64</span><br>	CreateId      <span class="hljs-type">int</span><br>	UpdateTime    <span class="hljs-type">int64</span><br>	UpdateId      <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(task *Task)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pp_task&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(task *Task)</span></span> Update(fields ...<span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>	err := Orm.Model(task).Select(fields).Updates(task).Error<br>	fmt.Println(<span class="hljs-string">&quot;Update task status&quot;</span>, task.Status)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TaskGetList</span><span class="hljs-params">(page, pageSize <span class="hljs-type">int</span>, filters ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> ([]*Task, <span class="hljs-type">int64</span>) &#123;<br>	fmt.Println(<span class="hljs-string">&quot;filter&gt;&gt;&gt;&quot;</span>, page, pageSize, filters)<br>	<span class="hljs-keyword">var</span> tasks []*Task<br>	<span class="hljs-keyword">var</span> total <span class="hljs-type">int64</span><br>	query := Orm.Model(&amp;Task&#123;&#125;)<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(filters) &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// 使用循环设置多个条件</span><br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(filters); i += <span class="hljs-number">2</span> &#123;<br>			field := filters[i].(<span class="hljs-type">string</span>)<br>			value := filters[i+<span class="hljs-number">1</span>]<br><br>			query = query.Where(fmt.Sprintf(<span class="hljs-string">&quot;%s = ?&quot;</span>, field), value)<br>		&#125;<br><br>		fmt.Println(<span class="hljs-string">&quot;query:::&quot;</span>, query)<br><br>	&#125;<br><br>	<span class="hljs-comment">//offset := (page - 1) * pageSize</span><br><br>	query.Find(&amp;tasks)<br>	fmt.Println(<span class="hljs-string">&quot;tasks:::&quot;</span>, tasks)<br>	<span class="hljs-keyword">return</span> tasks, total<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TaskGetById</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> (*Task, <span class="hljs-type">error</span>) &#123;<br>	task := &amp;Task&#123;&#125;<br>	err := Orm.First(task, id).Error<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> task, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 任务分组</span><br><span class="hljs-keyword">type</span> Group <span class="hljs-keyword">struct</span> &#123;<br>	Id          <span class="hljs-type">int</span><br>	GroupName   <span class="hljs-type">string</span><br>	Description <span class="hljs-type">string</span><br>	CreateId    <span class="hljs-type">int</span><br>	CreateTime  <span class="hljs-type">int64</span><br>	UpdateId    <span class="hljs-type">int</span><br>	UpdateTime  <span class="hljs-type">int64</span><br>	<span class="hljs-comment">// 1-正常 0-删除</span><br>	Status <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(group *Group)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pp_task_group&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GroupGetList</span><span class="hljs-params">(page, pageSize <span class="hljs-type">int</span>, filters ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> ([]*Group, <span class="hljs-type">int64</span>) &#123;<br><br>	<span class="hljs-keyword">var</span> groups []*Group<br>	<span class="hljs-keyword">var</span> total <span class="hljs-type">int64</span><br><br>	query := Orm.Model(&amp;Group&#123;&#125;)<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(filters) &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// 使用循环设置多个条件</span><br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(filters); i += <span class="hljs-number">2</span> &#123;<br>			field := filters[i].(<span class="hljs-type">string</span>)<br>			value := filters[i+<span class="hljs-number">1</span>]<br>			query = query.Where(field, value)<br>		&#125;<br><br>		fmt.Println(<span class="hljs-string">&quot;query:::&quot;</span>, query)<br><br>	&#125;<br><br>	query.Count(&amp;total)<br><br>	offset := (page - <span class="hljs-number">1</span>) * pageSize<br>	query.Offset(offset).Limit(pageSize).Order(<span class="hljs-string">&quot;id DESC&quot;</span>).Find(&amp;groups)<br><br>	<span class="hljs-keyword">return</span> groups, total<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(group *Group)</span></span> Update(fields ...<span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br><br>	err := Orm.Model(group).Select(fields).Updates(group).Error<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TaskGroupGetById</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> (*Group, <span class="hljs-type">error</span>) &#123;<br><br>	group := &amp;Group&#123;&#125;<br>	err := Orm.First(group, id).Error<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> group, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">type</span> TaskLog <span class="hljs-keyword">struct</span> &#123;<br>	Id     <span class="hljs-type">int</span><br>	TaskId <span class="hljs-type">int</span><br>	Output <span class="hljs-type">string</span><br>	Error  <span class="hljs-type">string</span><br>	<span class="hljs-comment">// 0-正常 -1-错误 -2-超时</span><br>	Status <span class="hljs-type">int</span><br>	<span class="hljs-comment">// 任务耗时</span><br>	ProcessTime <span class="hljs-type">int</span><br>	CreateTime  <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tasklog *TaskLog)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pp_task_log&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TaskLogAdd</span><span class="hljs-params">(t *TaskLog)</span></span> <span class="hljs-type">error</span> &#123;<br>	Orm.Create(t)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TaskLogGetList</span><span class="hljs-params">(page, pageSize <span class="hljs-type">int</span>, filters ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> ([]*TaskLog, <span class="hljs-type">int64</span>) &#123;<br><br>	query := Orm.Table(<span class="hljs-string">&quot;pp_task_log&quot;</span>)<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(filters) &gt; <span class="hljs-number">0</span> &#123;<br>		l := <span class="hljs-built_in">len</span>(filters)<br>		<span class="hljs-keyword">for</span> k := <span class="hljs-number">0</span>; k &lt; l; k += <span class="hljs-number">2</span> &#123;<br>			query = query.Where(filters[k].(<span class="hljs-type">string</span>)+<span class="hljs-string">&quot; = ?&quot;</span>, filters[k+<span class="hljs-number">1</span>])<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">var</span> total <span class="hljs-type">int64</span><br>	query.Count(&amp;total)<br>	<span class="hljs-keyword">var</span> list []*TaskLog<br>	offset := (page - <span class="hljs-number">1</span>) * pageSize<br>	err := query.Order(<span class="hljs-string">&quot;id DESC&quot;</span>).Limit(pageSize).Offset(offset).Find(&amp;list).Error<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(err)<br>	&#125;<br>	<span class="hljs-keyword">return</span> list, total<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TaskLogGetById</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> (*TaskLog, <span class="hljs-type">error</span>) &#123;<br><br>	taskLog := &amp;TaskLog&#123;&#125;<br>	err := Orm.First(taskLog, id).Error<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> taskLog, <span class="hljs-literal">nil</span><br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TaskLogDelById</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> &#123;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="6-4、任务初始化"><a href="#6-4、任务初始化" class="headerlink" title="6.4、任务初始化"></a>6.4、任务初始化</h2><p><code>application/main.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"> <span class="hljs-comment">// ... </span><br> <span class="hljs-comment">// 任务初始化</span><br>initialize.InitJob()<br><span class="hljs-comment">// 监听端口</span><br>router.Run(fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, Conf.Host, Conf.Port))<br></code></pre></td></tr></table></figure>

<p><code>initialize/jobs.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> initialize<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	. <span class="hljs-string">&quot;bingo_api/application/services&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;go.uber.org/zap&quot;</span><br>)<br><br><span class="hljs-comment">// 项目启动时，需要初始化任务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitJob</span><span class="hljs-params">()</span></span> &#123;<br><br>	<span class="hljs-comment">// 初始化cron</span><br>	MainCron = New()<br>	<span class="hljs-comment">// 开启调度协程</span><br>	MainCron.Start()<br>	<span class="hljs-comment">// 查询所有状态为1的任务</span><br>	list, _ := model.TaskGetList(<span class="hljs-number">1</span>, <span class="hljs-number">10000000</span>, <span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">1</span>)<br>	fmt.Println(<span class="hljs-string">&quot;list:::&quot;</span>, list)<br>	<span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> list &#123;<br>		fmt.Println(<span class="hljs-string">&quot;√&quot;</span>, task.ServerId)<br>		<span class="hljs-comment">// 创建job</span><br>		job, err := NewJobFromTask(task)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			zap.S().Error(<span class="hljs-string">&quot;初始化job失败&quot;</span>)<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-comment">// 添加任务到管道</span><br>		MainCron.AddJob(task.CronSpec, *job)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;Job初始化了&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;-------------------------------------------------&quot;</span>)<br>	fmt.Println(<span class="hljs-built_in">len</span>(list))<br>	fmt.Println(<span class="hljs-string">&quot;-------------------------------------------------&quot;</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>services/jobs.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> services<br><br><span class="hljs-keyword">import</span> (<br>	. <span class="hljs-string">&quot;bingo_api/application/database&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;errors&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/astaxie/beego&quot;</span><br>	<span class="hljs-string">&quot;github.com/astaxie/beego/logs&quot;</span><br>	<span class="hljs-string">&quot;strconv&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// 定义job结构体</span><br><span class="hljs-keyword">type</span> Job <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// 任务id</span><br>	Id <span class="hljs-type">int</span><br>	<span class="hljs-comment">// 任务名</span><br>	Name <span class="hljs-type">string</span><br>	<span class="hljs-comment">// 直接拿task表</span><br>	Task *model.Task<br>	<span class="hljs-comment">// 用于任务日志的字段</span><br>	<span class="hljs-comment">// 1.任务输出</span><br>	<span class="hljs-comment">// 2.错误提示</span><br>	<span class="hljs-comment">// 3.系统错误信息</span><br>	<span class="hljs-comment">// 4.是否超时</span><br>	RunFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(duration time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>, <span class="hljs-type">error</span>, <span class="hljs-type">bool</span>)<br>	<span class="hljs-comment">// 任务状态</span><br>	Status <span class="hljs-type">int</span><br>	<span class="hljs-comment">// 是否允许并发 true   false</span><br>	Concurrent <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-comment">//实现cron中的Job接口的Run()方法</span><br><span class="hljs-comment">//1.判断是否允许并发执行</span><br><span class="hljs-comment">//2.修改任务状态</span><br><span class="hljs-comment">//3.执行任务，需要设置超时时间，若超时则返回失败日志</span><br><span class="hljs-comment">//4.把日志存数据库</span><br><span class="hljs-comment">//5.若任务需要邮件提示错误，给指定管理员发邮件</span><br><span class="hljs-comment">//6.更新上次下次时间即可</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(job *Job)</span></span> Run() &#123;<br><br>	<span class="hljs-comment">// 状态</span><br>	<span class="hljs-comment">// -1-删除 0-停用 1-启用 2-待审核 3-审核不通过</span><br>	<span class="hljs-keyword">if</span> !job.Concurrent &amp;&amp; job.Status &gt; <span class="hljs-number">0</span> &#123;<br>		logs.Error(<span class="hljs-string">&quot;任务不允许并发执行&quot;</span>)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// 任务异常处理</span><br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>			logs.Error(err)<br>		&#125;<br>	&#125;()<br>	<span class="hljs-comment">// 该修改状态执行任务</span><br>	logs.Debug(fmt.Sprintf(<span class="hljs-string">&quot;开始执行任务：%d&quot;</span>, job.Id))<br>	start := time.Now()<br>	<span class="hljs-comment">/*	job.Status++</span><br><span class="hljs-comment">		defer func() &#123;</span><br><span class="hljs-comment">			job.Status--</span><br><span class="hljs-comment">		&#125;()*/</span><br>	<span class="hljs-comment">// 设置任务超时时间</span><br>	timeout := time.Duration(<span class="hljs-number">30</span> * time.Second)<br>	<span class="hljs-keyword">if</span> job.Task.Timeout &gt; <span class="hljs-number">0</span> &#123;<br>		timeout = time.Duration(job.Task.Timeout)<br>	&#125;<br>	<span class="hljs-comment">// 任务执行</span><br>	<span class="hljs-comment">// 1.任务输出</span><br>	<span class="hljs-comment">// 2.错误提示</span><br>	<span class="hljs-comment">// 3.系统错误信息</span><br>	<span class="hljs-comment">// 4.是否超时</span><br>	cmdOut, cmdErr, err, isTimeout := job.RunFunc(timeout)<br>	fmt.Println(<span class="hljs-string">&quot;cmdOut, cmdErr, err, isTimeout::::&quot;</span>, cmdOut, cmdErr, err, isTimeout)<br>	<span class="hljs-comment">// 构建task日志对象，用于存数据库</span><br>	log := <span class="hljs-built_in">new</span>(model.TaskLog)<br>	log.TaskId = job.Id<br>	log.Output = cmdOut<br>	log.Error = cmdErr<br>	<span class="hljs-comment">// ProcessTime int</span><br>	<span class="hljs-comment">// CreateTime  int64</span><br>	<span class="hljs-comment">//end := time.Now()</span><br>	<span class="hljs-comment">//log.ProcessTime = int(time.Since(start))</span><br>	log.ProcessTime = <span class="hljs-number">0</span><br>	log.CreateTime = start.Unix()<br>	<span class="hljs-comment">// 判断任务是否超时</span><br>	<span class="hljs-keyword">if</span> isTimeout &#123;<br>		<span class="hljs-comment">// 任务超时</span><br>		log.Status = model.TSAK_TIMEOUT<br>		log.Error = fmt.Sprintf(<span class="hljs-string">&quot;任务超时&quot;</span>)<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">// 任务出错</span><br>		log.Status = model.TASK_ERROR<br>		log.Error = fmt.Sprintf(<span class="hljs-string">&quot;任务出错&quot;</span>)<br>	&#125;<br>	<span class="hljs-comment">// 异常任务，发警报邮件相关</span><br>	<span class="hljs-comment">// 0-正常 -1-错误 -2-超时</span><br>	TextStatus := []<span class="hljs-type">string</span>&#123;<br>		<span class="hljs-string">&quot;&lt;font color=&#x27;red&#x27;&gt;超时&lt;/font&gt;&quot;</span>,<br>		<span class="hljs-string">&quot;&lt;font color=&#x27;red&#x27;&gt;错误&lt;/font&gt;&quot;</span>,<br>		<span class="hljs-string">&quot;&lt;font color=&#x27;green&#x27;&gt;正常&lt;/font&gt;&quot;</span>,<br>	&#125;<br>	<span class="hljs-comment">// 用于TextStatus切片的取值</span><br>	email_status_index := log.Status + <span class="hljs-number">2</span><br>	<span class="hljs-comment">// 判断任务执行失败，且失败需要邮件通知</span><br>	<span class="hljs-keyword">if</span> log.Status &lt; <span class="hljs-number">0</span> &amp;&amp; job.Task.IsNotify == <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-comment">// 判断需要通知的人的id不为空</span><br>		<span class="hljs-keyword">if</span> job.Task.NotifyUserIds != <span class="hljs-string">&quot;0&quot;</span> &amp;&amp; job.Task.NotifyUserIds != <span class="hljs-string">&quot;&quot;</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;发送报警邮件&quot;</span>)<br>			<span class="hljs-comment">// 收邮件的管理员的email</span><br>			toEmail := <span class="hljs-string">&quot;&quot;</span><br>			<span class="hljs-comment">// 根据NotifyUserIds查询接收邮件的所有的管理员</span><br>			toEmail_slice := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;golang19131640303@126.com&quot;</span>&#125;<br>			<span class="hljs-keyword">for</span> _, to := <span class="hljs-keyword">range</span> toEmail_slice &#123;<br>				<span class="hljs-keyword">if</span> job.Task.NotifyType == <span class="hljs-number">0</span> &amp;&amp; to != <span class="hljs-string">&quot;&quot;</span> &#123;<br>					subject := fmt.Sprintf(<span class="hljs-string">&quot;CronJob定时任务异常：%s&quot;</span>, job.Task.TaskName)<br>					body := fmt.Sprintf(<br>						<span class="hljs-string">`</span><br><span class="hljs-string">					&lt;html&gt;</span><br><span class="hljs-string">						&lt;body&gt;</span><br><span class="hljs-string">						Hello，定时任务出错了：</span><br><span class="hljs-string">						&lt;p style=&quot;font-size:16px;&quot;&gt;任务执行详情：&lt;/p&gt;</span><br><span class="hljs-string">						&lt;p style=&quot;display:block; padding:10px; background:#efefef;border:1px solid #e4e4e4&quot;&gt;</span><br><span class="hljs-string">						任务 ID：%d&lt;br/&gt;</span><br><span class="hljs-string">						任务名称：%s&lt;br/&gt;</span><br><span class="hljs-string">						执行时间：%s&lt;br/&gt;</span><br><span class="hljs-string">						执行耗时：%f秒&lt;br/&gt;</span><br><span class="hljs-string">						执行状态：%s</span><br><span class="hljs-string">						&lt;/p&gt;</span><br><span class="hljs-string">						&lt;br/&gt;</span><br><span class="hljs-string">						&lt;p&gt;-----------------------------------------------------------------&lt;br /&gt;</span><br><span class="hljs-string">						本邮件由CronJob定时系统自动发出，请勿回复&lt;br /&gt;</span><br><span class="hljs-string">						如果要取消邮件通知，请登录到系统进行设置&lt;br /&gt;</span><br><span class="hljs-string">						&lt;/p&gt;</span><br><span class="hljs-string">						&lt;/body&gt;</span><br><span class="hljs-string">					&lt;/html&gt;</span><br><span class="hljs-string">						`</span>, job.Task.Id,<br>						job.Task.TaskName,<br>						beego.Date(time.Unix(log.CreateTime, <span class="hljs-number">0</span>), <span class="hljs-string">&quot;Y-m-d H:i:s&quot;</span>),<br>						<span class="hljs-type">float64</span>(log.ProcessTime)/<span class="hljs-number">1000</span>,<br>						TextStatus[email_status_index])<br>					mailtype := <span class="hljs-string">&quot;text/html&quot;</span><br>					ok := utils.SendToChan(to, subject, body, mailtype)<br>					<span class="hljs-keyword">if</span> !ok &#123;<br>						fmt.Println(<span class="hljs-string">&quot;发送邮件错误&quot;</span>, toEmail)<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 将日志插入到数据库表</span><br>	err = model.TaskLogAdd(log)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logs.Error(<span class="hljs-string">&quot;插入task_log异常&quot;</span>)<br>	&#125;<br>	<span class="hljs-comment">// 更改task数据库表记录</span><br>	job.Task.PrevTime = time.Now().Unix()<br>	job.Task.ExecuteTimes++<br>	err = job.Task.Update(<span class="hljs-string">&quot;PrevTime&quot;</span>, <span class="hljs-string">&quot;ExecuteTimes&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logs.Error(<span class="hljs-string">&quot;更新task异常&quot;</span>)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AllUserInfo</span><span class="hljs-params">(userIds <span class="hljs-type">string</span>)</span></span> []*model.User &#123;<br>	Filters := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-number">0</span>)<br>	Filters = <span class="hljs-built_in">append</span>(Filters, <span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">var</span> notifyUserIds []<span class="hljs-type">int</span><br>	<span class="hljs-keyword">if</span> userIds != <span class="hljs-string">&quot;0&quot;</span> &amp;&amp; userIds != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		notifyUserIdStr := strings.Split(userIds, <span class="hljs-string">&quot;,&quot;</span>)<br>		<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> notifyUserIdStr &#123;<br>			i, _ := strconv.Atoi(v)<br>			notifyUserIds = <span class="hljs-built_in">append</span>(notifyUserIds, i)<br>		&#125;<br>		<span class="hljs-comment">//Filters = append(Filters, &quot;id__in&quot;, notifyUserIdStr)</span><br>	&#125;<br>	notifyUserIdStr := strings.Split(userIds, <span class="hljs-string">&quot;,&quot;</span>)<br>	<span class="hljs-comment">// 查询出所有符合条件的Admin</span><br>	<span class="hljs-comment">// select * from pp_admin where status = 1 and id in(5,3,2)</span><br>	<span class="hljs-keyword">var</span> users []*model.User<br>	fmt.Println(<span class="hljs-string">&quot;notifyUserIdStr:::&quot;</span>, notifyUserIdStr)<br>	Orm.Where(<span class="hljs-string">&quot;id in (?)&quot;</span>, []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>&#125;).Find(&amp;users)<br>	fmt.Println(<span class="hljs-string">&quot;通知用户：&quot;</span>, users)<br>	<span class="hljs-keyword">return</span> users<br>&#125;<br><br><span class="hljs-comment">//实现管道中job创建、添加、查询、删除。。。供外部调用的方法</span><br><span class="hljs-comment">//创建job</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewJobFromTask</span><span class="hljs-params">(task *model.Task)</span></span> (*Job, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">// 严谨判断，例如任务id合规等</span><br>	<span class="hljs-comment">// 1.本地执行的任务</span><br>	<span class="hljs-keyword">if</span> task.ServerId == <span class="hljs-number">0</span> &#123;<br><br>	&#125;<br>	<span class="hljs-comment">// 2.远程执行的任务</span><br>	<span class="hljs-comment">// 先根据serverId，把服务器找到</span><br>	<span class="hljs-keyword">var</span> server model.Host<br>	fmt.Println(<span class="hljs-string">&quot;task.ServerId:::&quot;</span>, task.ServerId)<br>	err := server.GetOneById(<span class="hljs-type">uint</span>(task.ServerId))<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logs.Error(<span class="hljs-string">&quot;查询server失败&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> server.ID != <span class="hljs-number">0</span> &#123;<br><br>		<span class="hljs-comment">// 组装job数据</span><br>		job := &amp;Job&#123;<br>			Id:   task.Id,<br>			Name: task.TaskName,<br>		&#125;<br>		job.RunFunc = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>, <span class="hljs-type">error</span>, <span class="hljs-type">bool</span>) &#123;<br>			fmt.Println(<span class="hljs-string">&quot;执行远程命令...&quot;</span>)<br><br>			cli := utils.NewSSH(server.IpAddr, server.Username, server.Password, server.PrivateKey, <span class="hljs-string">&quot;password&quot;</span>, <span class="hljs-type">int</span>(server.Port))<br>			<span class="hljs-keyword">if</span> err := cli.Connect(); err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;err:&quot;</span>, err)<br>				<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;连接主机失败！&quot;</span>, err, <span class="hljs-literal">false</span><br>			&#125;<br><br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cli *utils.SSH)</span></span> &#123;<br>				_ = cli.Client.Close()<br>				_ = cli.Session.Close()<br>			&#125;(cli)<br><br>			output, err := cli.Run(task.Command)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;执行命令失败！&quot;</span>, err, <span class="hljs-literal">false</span><br>			&#125;<br><br>			<span class="hljs-keyword">return</span> output, <span class="hljs-string">&quot;&quot;</span>, err, <span class="hljs-literal">false</span><br><br>		&#125;<br>		job.Task = task<br>		job.Concurrent = task.Concurrent == <span class="hljs-number">1</span><br><br>		<span class="hljs-keyword">return</span> job, <span class="hljs-literal">nil</span><br><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;job创建失败&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">var</span> MainCron *Cron<br><br><span class="hljs-comment">// job添加</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddJob</span><span class="hljs-params">(spec <span class="hljs-type">string</span>, job Job)</span></span> <span class="hljs-type">bool</span> &#123;<br><br>	<span class="hljs-comment">// 1.加锁</span><br>	<span class="hljs-comment">// 2.管道里查一下</span><br>	<span class="hljs-keyword">if</span> GetEntryById(job.Id) != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	<span class="hljs-comment">// 添加job到管道</span><br>	err := MainCron.AddJob(spec, job)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logs.Error(<span class="hljs-string">&quot;添加job失败&quot;</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// 根据id查管道任务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetEntryById</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> *Entry &#123;<br>	entries := MainCron.Entries()<br>	<span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> entries &#123;<br><br>		<span class="hljs-keyword">if</span> e.Job.Id == id &#123;<br>			<span class="hljs-keyword">return</span> e<br>		&#125;<br><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 查询即将执行的几个任务，首页要执行的job</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetEntries</span><span class="hljs-params">(size <span class="hljs-type">int</span>)</span></span> []*Entry &#123;<br>	entry := MainCron.Entries()<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entry) &gt; size &#123;<br>		<span class="hljs-keyword">return</span> entry[:size]<br>	&#125;<br>	<span class="hljs-keyword">return</span> entry<br>&#125;<br><br><span class="hljs-comment">// 删除</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RemoveJob</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> &#123;<br>	MainCron.RemoveJob(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *Entry)</span></span> <span class="hljs-type">bool</span> &#123;<br><br>		<span class="hljs-keyword">return</span> e.Job.Id == id<br><br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>services/cron.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> services<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gorhill/cronexpr&quot;</span><br>	<span class="hljs-string">&quot;sort&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// 单封装每一个任务的结构体</span><br><span class="hljs-keyword">type</span> Entry <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// 任务时间表达式</span><br>	Schedule cronexpr.Expression<br>	<span class="hljs-comment">// 下一次执行的时间</span><br>	Next time.Time<br>	<span class="hljs-comment">// 上一次执行的时间</span><br>	Prev time.Time<br>	<span class="hljs-comment">// 具体执行什么</span><br>	Job<br>&#125;<br><br><span class="hljs-comment">// true：删除</span><br><span class="hljs-comment">// false：不删除</span><br><br><span class="hljs-keyword">type</span> RemoveFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *Entry)</span></span> <span class="hljs-type">bool</span><br><br><span class="hljs-keyword">type</span> Cron <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// 任务列表</span><br>	entries []*Entry<br>	<span class="hljs-comment">// 停止的管道</span><br>	stop <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>	<span class="hljs-comment">// 添加的管道</span><br>	add <span class="hljs-keyword">chan</span> *Entry<br>	<span class="hljs-comment">// 删除的管道</span><br>	remove <span class="hljs-keyword">chan</span> RemoveFunc<br>	<span class="hljs-comment">// 复制的管道</span><br>	snapshot <span class="hljs-keyword">chan</span> []*Entry<br>	<span class="hljs-comment">// 标识任务似乎否正在运行</span><br>	running <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-comment">// 提供一个构造函数，初始化</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">()</span></span> *Cron &#123;<br>	<span class="hljs-keyword">return</span> &amp;Cron&#123;<br>		entries:  <span class="hljs-literal">nil</span>,<br>		stop:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;),<br>		add:      <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Entry),<br>		remove:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> RemoveFunc),<br>		snapshot: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> []*Entry),<br>		running:  <span class="hljs-literal">false</span>,<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 启动cron</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cron)</span></span> Start() &#123;<br>	<span class="hljs-comment">// 标识任务正在运行</span><br>	c.running = <span class="hljs-literal">true</span><br>	<span class="hljs-comment">// 开启调度协程</span><br>	<span class="hljs-keyword">go</span> c.run()<br>&#125;<br><br><span class="hljs-comment">// 调度协程</span><br><span class="hljs-comment">// 1.遍历所有在运行的任务，根据当前时间，计算出下一次执行时间</span><br><span class="hljs-comment">// 2.循环根据下一次运行时间，对所有任务进行排序，得到最近一次执行时间</span><br><span class="hljs-comment">// 3.调度协程根据管道数据做不同调度</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cron)</span></span> run() &#123;<br>	<span class="hljs-comment">// 1.遍历所有在运行的任务，根据当前时间，计算出下一次执行时间</span><br>	<span class="hljs-comment">// 获取当前时间</span><br>	now := time.Now().Local()<br>	fmt.Println(<span class="hljs-string">&quot;run c.entries:::&quot;</span>, c.entries)<br>	<span class="hljs-keyword">for</span> _, entry := <span class="hljs-keyword">range</span> c.entries &#123;<br>		entry.Next = entry.Schedule.Next(now)<br>	&#125;<br>	<span class="hljs-comment">// 2. 循环根据下一次运行时间，对所有任务进行排序，得到最近一次执行时间</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;监听 c.entries&quot;</span>)<br>		<span class="hljs-comment">// 根据Entry的Next，对下一次运行时间，对任务进行排序</span><br>		sort.Sort(byTime(c.entries))<br>		<span class="hljs-comment">// 获取最近一次要执行的时间</span><br>		<span class="hljs-keyword">var</span> nearTime time.Time<br>		<span class="hljs-comment">// 判断，若没有任务在运行，下一次执行时间赋值</span><br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(c.entries) == <span class="hljs-number">0</span> || c.entries[<span class="hljs-number">0</span>].Next.IsZero() &#123;<br>			nearTime = now.AddDate(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// 得到最近的执行时间</span><br>			nearTime = c.entries[<span class="hljs-number">0</span>].Next<br>		&#125;<br><br>		fmt.Println(<span class="hljs-string">&quot;nearTime::::&quot;</span>, nearTime)<br><br>		<span class="hljs-comment">// 3.调度协程根据管道数据做不同调度</span><br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> now = &lt;-time.After(nearTime.Sub(now)):<br>			<span class="hljs-comment">// 执行任务，循环遍历，可能有多个任务同时执行</span><br>			fmt.Println(nearTime, <span class="hljs-string">&quot;时间到&quot;</span>)<br><br>			<span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> c.entries &#123;<br>				<span class="hljs-keyword">if</span> e.Next != nearTime &#123;<br>					<span class="hljs-keyword">break</span><br>				&#125;<br>				<span class="hljs-keyword">go</span> e.Job.Run()<br>				<span class="hljs-comment">// 更新下任务相关的时间字段</span><br>				e.Prev = e.Next<br>				e.Next = e.Schedule.Next(nearTime)<br>			&#125;<br>		<span class="hljs-comment">//  stop:     make(chan struct&#123;&#125;),</span><br>		<span class="hljs-comment">//	add:      make(chan *Entry),</span><br>		<span class="hljs-comment">//	remove:   make(chan RemoveFunc),</span><br>		<span class="hljs-comment">//	snapshot: make(chan [] *Entry),</span><br>		<span class="hljs-keyword">case</span> newEntry := &lt;-c.add:<br><br>			c.entries = <span class="hljs-built_in">append</span>(c.entries, newEntry)<br>			newEntry.Next = newEntry.Schedule.Next(now)<br>		<span class="hljs-keyword">case</span> cb := &lt;-c.remove:<br>			<span class="hljs-comment">// 存储不删除的任务</span><br>			newEntries := <span class="hljs-built_in">make</span>([]*Entry, <span class="hljs-number">0</span>)<br>			<span class="hljs-comment">// 遍历之前的切片</span><br>			<span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> c.entries &#123;<br>				<span class="hljs-keyword">if</span> !cb(e) &#123;<br>					newEntries = <span class="hljs-built_in">append</span>(newEntries, e)<br>				&#125;<br>			&#125;<br>			<span class="hljs-comment">// 删除处理后的切片，赋值给原切片</span><br>			c.entries = newEntries<br>		<span class="hljs-keyword">case</span> &lt;-c.snapshot:<br>			<span class="hljs-comment">// 取到当前是所有任务复制，扔过滤给后续用</span><br>			c.snapshot &lt;- c.snapshotEntry()<br>		<span class="hljs-keyword">case</span> &lt;-c.stop:<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 复制任务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cron)</span></span> snapshotEntry() []*Entry &#123;<br>	entries := []*Entry&#123;&#125;<br><br>	<span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> c.entries &#123;<br>		<span class="hljs-comment">// 因为是指针，若如下写法，最终会一样</span><br>		<span class="hljs-comment">// entries = append(entries, e)</span><br>		entries = <span class="hljs-built_in">append</span>(entries, &amp;Entry&#123;<br>			Schedule: e.Schedule,<br>			Next:     e.Next,<br>			Prev:     e.Prev,<br>			Job:      e.Job,<br>		&#125;)<br>	&#125;<br>	<span class="hljs-keyword">return</span> entries<br>&#125;<br><br><span class="hljs-comment">// 切片类型</span><br><span class="hljs-keyword">type</span> byTime []*Entry<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s byTime)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(s)<br>&#125;<br><br><span class="hljs-comment">// 交换</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s byTime)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123;<br>	s[i], s[j] = s[j], s[i]<br>&#125;<br><br><span class="hljs-comment">// 比较大小</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s byTime)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-comment">// 根据Next字段排序</span><br>	<span class="hljs-comment">// 判断下一次执行时间是Time类型的零值，表明任务时间无效</span><br>	<span class="hljs-keyword">if</span> s[i].Next.IsZero() &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> s[j].Next.IsZero() &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-comment">// 比较i时间在j时间之前，若不在则返回false</span><br>	<span class="hljs-keyword">return</span> s[i].Next.Before(s[j].Next)<br>&#125;<br><br><span class="hljs-comment">// 添加任务到管道</span><br><span class="hljs-comment">// 参数：时间表达式，任务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cron)</span></span> AddJob(spec <span class="hljs-type">string</span>, job Job) <span class="hljs-type">error</span> &#123;<br><br>	fmt.Println(<span class="hljs-string">&quot;c.running:::&quot;</span>, c.running)<br>	<span class="hljs-comment">// 解析时间表达式</span><br>	schedule, err := cronexpr.Parse(spec)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	entry := &amp;Entry&#123;<br>		Schedule: *schedule,<br>		Job:      job,<br>	&#125;<br>	<span class="hljs-keyword">if</span> !c.running &#123;<br>		<span class="hljs-comment">// 未占用时，直接添加即可</span><br>		c.entries = <span class="hljs-built_in">append</span>(c.entries, entry)<br>	&#125;<br>	<span class="hljs-comment">// 任务被占用时，add进管道等待处理</span><br>	c.add &lt;- entry<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 删除</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cron)</span></span> RemoveJob(rf RemoveFunc) &#123;<br>	c.remove &lt;- rf<br>&#125;<br><br><span class="hljs-comment">// 复制</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cron)</span></span> Entries() []*Entry &#123;<br>	fmt.Println(<span class="hljs-string">&quot;c.running::::&quot;</span>, c.running)<br>	<span class="hljs-keyword">if</span> !c.running &#123;<br>		<span class="hljs-comment">// 若占用，通过管道</span><br>		c.snapshot &lt;- <span class="hljs-literal">nil</span><br>		x := &lt;-c.snapshot<br>		<span class="hljs-keyword">return</span> x<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;QQQQ:&quot;</span>, c)<br>	<span class="hljs-keyword">return</span> c.snapshotEntry()<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="6-5、任务启动与暂停"><a href="#6-5、任务启动与暂停" class="headerlink" title="6.5、任务启动与暂停"></a>6.5、任务启动与暂停</h2><p><code>api/tasks.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> api<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/model&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/services&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;strconv&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// 分页查询任务列表</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetTaskList</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	<span class="hljs-comment">// 获取当前页码</span><br>	page, err := strconv.Atoi(ctx.Query(<span class="hljs-string">&quot;page&quot;</span>))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || page &lt;= <span class="hljs-number">0</span> &#123;<br>		page = <span class="hljs-number">1</span><br>	&#125;<br><br>	<span class="hljs-comment">// 获取每页显示的数量</span><br>	limit, err := strconv.Atoi(ctx.Query(<span class="hljs-string">&quot;limit&quot;</span>))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || limit &lt;= <span class="hljs-number">0</span> &#123;<br>		limit = <span class="hljs-number">20</span><br>	&#125;<br><br>	<span class="hljs-comment">// 过滤条件</span><br>	<span class="hljs-keyword">var</span> filters []<span class="hljs-keyword">interface</span>&#123;&#125;<br>	<span class="hljs-comment">// 状态</span><br>	<span class="hljs-comment">// -1-删除 0-停用 1-启用 2-待审核 3-审核不通过</span><br>	statusIn := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br>	filters = <span class="hljs-built_in">append</span>(filters, <span class="hljs-string">&quot;status IN (?)&quot;</span>, statusIn)<br><br>	taskName := strings.TrimSpace(ctx.Query(<span class="hljs-string">&quot;task_name&quot;</span>))<br>	<span class="hljs-keyword">if</span> taskName != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		filters = <span class="hljs-built_in">append</span>(filters, <span class="hljs-string">&quot;task_name LIKE ?&quot;</span>, <span class="hljs-string">&quot;%&quot;</span>+taskName+<span class="hljs-string">&quot;%&quot;</span>)<br>	&#125;<br><br>	groupID, err := strconv.Atoi(ctx.Query(<span class="hljs-string">&quot;group_id&quot;</span>))<br>	<span class="hljs-keyword">if</span> groupID &gt; <span class="hljs-number">0</span> &#123;<br>		filters = <span class="hljs-built_in">append</span>(filters, <span class="hljs-string">&quot;group_id = ?&quot;</span>, groupID)<br>	&#125;<br><br>	tasks, count := model.TaskGetList(page, limit, filters...)<br><br>	<span class="hljs-comment">// 响应数据</span><br>	list := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-built_in">len</span>(tasks))<br>	<span class="hljs-comment">// 遍历分页数据，组装map切片</span><br>	<span class="hljs-keyword">for</span> index, task := <span class="hljs-keyword">range</span> tasks &#123;<br>		row := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)<br>		<span class="hljs-comment">// id task_name description next_time pre_time execute_times</span><br>		row[<span class="hljs-string">&quot;id&quot;</span>] = task.Id<br>		<span class="hljs-comment">// 分组名-任务名</span><br>		taskGroup := taskGroupLists()<br>		fmt.Println(<span class="hljs-string">&quot;taskGroup:::&quot;</span>, taskGroup)<br>		groupName := <span class="hljs-string">&quot;默认分组&quot;</span><br>		<span class="hljs-keyword">if</span> name, ok := taskGroup[task.GroupId]; ok &#123;<br>			groupName = name<br>		&#125;<br><br>		<span class="hljs-comment">// 状态</span><br>		<span class="hljs-comment">// -1-删除 0-停用 1-启用 2-待审核 3-审核不通过</span><br>		row[<span class="hljs-string">&quot;task_name&quot;</span>] = groupName + <span class="hljs-string">&quot;-&quot;</span> + task.TaskName<br>		row[<span class="hljs-string">&quot;description&quot;</span>] = task.Description<br>		<span class="hljs-comment">/*e := services.GetEntryById(task.Id)</span><br><span class="hljs-comment">		if e != nil &#123;</span><br><span class="hljs-comment">			// 正在运行</span><br><span class="hljs-comment">			row[&quot;next_time&quot;] = e.Next.Format(&quot;2006-01-02 15:04:05&quot;)</span><br><span class="hljs-comment">			row[&quot;pre_time&quot;] = e.Prev.Format(&quot;2006-01-02 15:04:05&quot;)</span><br><span class="hljs-comment">		&#125; else &#123;</span><br><span class="hljs-comment">			row[&quot;next_time&quot;] = &quot;-&quot;</span><br><span class="hljs-comment">			row[&quot;pre_time&quot;] = time.Unix(task.PrevTime, 0).Format(&quot;2006-01-02 15:04:05&quot;)</span><br><span class="hljs-comment">		&#125;*/</span><br>		row[<span class="hljs-string">&quot;execute_times&quot;</span>] = task.ExecuteTimes<br>		list[index] = row<br>	&#125;<br>	<span class="hljs-comment">// c.ajaxList(&quot;成功&quot;, MSG_OK, count, list)</span><br><br>	ctx.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>		<span class="hljs-string">&quot;code&quot;</span>:  <span class="hljs-number">200</span>,<br>		<span class="hljs-string">&quot;count&quot;</span>: count,<br>		<span class="hljs-string">&quot;data&quot;</span>:  list,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">// 获取任务分组信息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">taskGroupLists</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span> &#123;<br>	groupFilters := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-number">0</span>)<br>	<span class="hljs-comment">// 1-正常 0-删除</span><br>	<span class="hljs-comment">// groupFilters = append(groupFilters, &quot;status&quot;, 1)</span><br>	groupResult, n := model.GroupGetList(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>, groupFilters...)<br>	<span class="hljs-comment">// 组装返回数据</span><br>	res := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>, n)<br>	<span class="hljs-keyword">for</span> _, gv := <span class="hljs-keyword">range</span> groupResult &#123;<br>		res[gv.Id] = gv.GroupName<br>	&#125;<br>	<span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-comment">// 启动任务，支持批量操作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AjaxBatchStart</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	ids := ctx.PostForm(<span class="hljs-string">&quot;ids&quot;</span>)<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ids:::&quot;</span>, ids)<br>	idArr := strings.Split(ids, <span class="hljs-string">&quot;,&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;idArr:::&quot;</span>, <span class="hljs-built_in">len</span>(idArr), idArr)<br>	<span class="hljs-keyword">if</span> ids == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		ctx.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;MSG_ERR&quot;</span>: <span class="hljs-string">&quot;请选择要操作的任务！&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// 遍历用户选的id</span><br>	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> idArr &#123;<br>		id, _ := strconv.Atoi(v)<br>		<span class="hljs-keyword">if</span> id &lt; <span class="hljs-number">1</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> task, err := model.TaskGetById(id); err == <span class="hljs-literal">nil</span> &#123;<br><br>			<span class="hljs-comment">// 启动任务</span><br>			job, err := services.NewJobFromTask(task)<br><br>			<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-comment">// 将当前job添加到切片中</span><br>				services.AddJob(task.CronSpec, *job)<br>				<span class="hljs-comment">// 修改任务的状态为启动</span><br>				task.Status = <span class="hljs-number">1</span><br>				<span class="hljs-comment">// 更新入库</span><br>				err := task.Update(<span class="hljs-string">&quot;status&quot;</span>)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					fmt.Println(err)<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 返回ajax提示信息</span><br>	ctx.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>		<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;启动任务成功&quot;</span>,<br>		<span class="hljs-string">&quot;status&quot;</span>:  <span class="hljs-number">0</span>,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">// 停止任务，支持批量操作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AjaxBatchPause</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	ids := ctx.PostForm(<span class="hljs-string">&quot;ids&quot;</span>)<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ids:::&quot;</span>, ids)<br>	idArr := strings.Split(ids, <span class="hljs-string">&quot;,&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;idArr:::&quot;</span>, <span class="hljs-built_in">len</span>(idArr), idArr)<br>	<span class="hljs-keyword">if</span> ids == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		ctx.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;MSG_ERR&quot;</span>: <span class="hljs-string">&quot;请选择要操作的任务！&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// 遍历用户选的id</span><br>	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> idArr &#123;<br>		id, _ := strconv.Atoi(v)<br>		<span class="hljs-keyword">if</span> id &lt; <span class="hljs-number">1</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		services.RemoveJob(id)<br>		<span class="hljs-keyword">if</span> task, err := model.TaskGetById(id); err == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-comment">// 修改任务的状态为暂停</span><br>			task.Status = <span class="hljs-number">0</span><br>			<span class="hljs-comment">// 更新入库</span><br>			err := task.Update(<span class="hljs-string">&quot;status&quot;</span>)<br>			fmt.Println(<span class="hljs-string">&quot;修改任务后：&quot;</span>, task)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;修改任务的状态失败:::&quot;</span>, err)<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 返回ajax提示信息</span><br>	ctx.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>		<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;暂停成功&quot;</span>,<br>		<span class="hljs-string">&quot;status&quot;</span>:  <span class="hljs-number">0</span>,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">// 任务详情</span><br><span class="hljs-comment">// /task/detail</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Detail</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	id, _ := strconv.Atoi(c.Query(<span class="hljs-string">&quot;id&quot;</span>))<br><br>	<span class="hljs-comment">// 根据id查task</span><br>	task, err := model.TaskGetById(id)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	TextStatus := []<span class="hljs-type">string</span>&#123;<br>		<span class="hljs-string">&quot;暂停&quot;</span>,<br>		<span class="hljs-string">&quot;运行中&quot;</span>,<br>		<span class="hljs-string">&quot;待审核&quot;</span>,<br>		<span class="hljs-string">&quot;审核失败&quot;</span>,<br>	&#125;<br><br>	groupName := <span class="hljs-string">&quot;默认分组&quot;</span><br>	group, err := model.TaskGroupGetById(task.GroupId)<br>	<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>		groupName = group.GroupName<br>	&#125;<br><br>	<span class="hljs-comment">// 服务器名</span><br>	serverName := <span class="hljs-string">&quot;默认服务器&quot;</span><br>	<span class="hljs-keyword">if</span> task.ServerId == <span class="hljs-number">0</span> &#123;<br>		serverName = <span class="hljs-string">&quot;本地服务器&quot;</span><br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> task.ServerId &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">var</span> host = model.Host&#123;&#125;<br>		err := host.GetOneById(<span class="hljs-type">uint</span>(task.ServerId))<br>		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>			serverName = host.Name<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 通知人</span><br>	<span class="hljs-keyword">var</span> adminInfo []*model.User<br>	<span class="hljs-keyword">if</span> task.NotifyUserIds != <span class="hljs-string">&quot;0&quot;</span> &amp;&amp; task.NotifyUserIds != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		adminInfo = services.AllUserInfo(task.NotifyUserIds)<br>	&#125;<br><br>	createTime := time.Unix(task.CreateTime, <span class="hljs-number">0</span>).Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>)<br>	<span class="hljs-comment">// CreateName</span><br>	createName := <span class="hljs-string">&quot;默认创建人&quot;</span><br>	<span class="hljs-comment">// UpdateTime  UpdateName</span><br>	updateTime := time.Unix(task.UpdateTime, <span class="hljs-number">0</span>).Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>)<br>	updateName := <span class="hljs-string">&quot;默认修改人&quot;</span><br><br>	c.JSON(http.StatusOK, gin.H&#123;<br>		<span class="hljs-string">&quot;Task&quot;</span>:       task,<br>		<span class="hljs-string">&quot;TextStatus&quot;</span>: TextStatus[task.Status],<br>		<span class="hljs-string">&quot;GroupName&quot;</span>:  groupName,<br>		<span class="hljs-string">&quot;ServerName&quot;</span>: serverName,<br>		<span class="hljs-string">&quot;AdminInfo&quot;</span>:  adminInfo,<br>		<span class="hljs-string">&quot;CreateTime&quot;</span>: createTime,<br>		<span class="hljs-string">&quot;CreateName&quot;</span>: createName,<br>		<span class="hljs-string">&quot;UpdateTime&quot;</span>: updateTime,<br>		<span class="hljs-string">&quot;UpdateName&quot;</span>: updateName,<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">// 测试任务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AjaxRun</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><br>	id, _ := strconv.Atoi(ctx.Query(<span class="hljs-string">&quot;id&quot;</span>))<br><br>	<span class="hljs-comment">// 根据id查task</span><br>	task, err := model.TaskGetById(id)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusOK, gin.H&#123;<br>			<span class="hljs-string">&quot;err&quot;</span>: <span class="hljs-string">&quot;查不到该任务，无法运行&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	job, err := services.NewJobFromTask(task)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		ctx.JSON(http.StatusOK, gin.H&#123;<br>			<span class="hljs-string">&quot;err&quot;</span>: <span class="hljs-string">&quot;任务创建失败，无法运行&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> job != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">// 运行一次，不加入运行时切片</span><br>		timeout := time.Duration(<span class="hljs-number">10</span> * time.Second)<br>		cmdOut, cmdErr, err, _ := job.RunFunc(timeout)<br><br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			ctx.JSON(http.StatusOK, gin.H&#123;<br>				<span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;任务运行失败！&quot;</span>,<br>				<span class="hljs-string">&quot;err&quot;</span>: cmdErr,<br>			&#125;)<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			ctx.JSON(http.StatusOK, gin.H&#123;<br>				<span class="hljs-string">&quot;msg&quot;</span>:    <span class="hljs-string">&quot;任务测试成功！&quot;</span>,<br>				<span class="hljs-string">&quot;cmdOut&quot;</span>: cmdOut,<br>			&#125;)<br>		&#125;<br>	&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>application/router/task.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/api&quot;</span><br>	<span class="hljs-string">&quot;bingo_api/application/utils&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitTaskRouter</span><span class="hljs-params">(Router *gin.RouterGroup)</span></span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	主机相关的路由组</span><br><span class="hljs-comment">	*/</span><br>	TasksRouter := Router.Group(<span class="hljs-string">&quot;tasks&quot;</span>)<br><br>	&#123;<br><br>		utils.Register(TasksRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;sysInfo&quot;</span>, api.GetSystemInfo)<br>		utils.Register(TasksRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;taskLogs&quot;</span>, api.GetTasklogs)<br>		utils.Register(TasksRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;table&quot;</span>, api.GetTaskList)<br>		utils.Register(TasksRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;ajaxbatchstart&quot;</span>, api.AjaxBatchStart)<br>		utils.Register(TasksRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;POST&quot;</span>&#125;, <span class="hljs-string">&quot;ajaxbatchpause&quot;</span>, api.AjaxBatchPause)<br>		utils.Register(TasksRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;detail&quot;</span>, api.Detail)<br>		utils.Register(TasksRouter, []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;GET&quot;</span>&#125;, <span class="hljs-string">&quot;test&quot;</span>, api.AjaxRun)<br><br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-6、系统信息"><a href="#6-6、系统信息" class="headerlink" title="6.6、系统信息"></a>6.6、系统信息</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> api<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bingo_api/application/config&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;math&quot;</span><br>	<span class="hljs-string">&quot;runtime&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetSystemInfo</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>	startTime := config.Conf.StartTime<br>	<span class="hljs-keyword">var</span> afterLastGC <span class="hljs-type">string</span><br>	goNum := runtime.NumGoroutine()<br>	cpuNum := runtime.NumCPU()<br>	mstat := &amp;runtime.MemStats&#123;&#125;<br>	runtime.ReadMemStats(mstat)<br>	now := time.Now().Unix()<br>	fmt.Println(now)<br>	fmt.Println(startTime)<br>	costTime := <span class="hljs-type">int</span>(now - startTime)<br>	fmt.Println(costTime)<br>	mb := <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span><br>	<span class="hljs-keyword">if</span> mstat.LastGC != <span class="hljs-number">0</span> &#123;<br>		afterLastGC = fmt.Sprintf(<span class="hljs-string">&quot;%.1fs&quot;</span>, <span class="hljs-type">float64</span>(time.Now().UnixNano()-<span class="hljs-type">int64</span>(mstat.LastGC))/<span class="hljs-number">1000</span>/<span class="hljs-number">1000</span>/<span class="hljs-number">1000</span>)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		afterLastGC = <span class="hljs-string">&quot;0&quot;</span><br>	&#125;<br>	ctx.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br><br>		<span class="hljs-string">&quot;服务运行时间&quot;</span>:    fmt.Sprintf(<span class="hljs-string">&quot;%d天%d小时%d分%d秒&quot;</span>, costTime/(<span class="hljs-number">3600</span>*<span class="hljs-number">24</span>), costTime%(<span class="hljs-number">3600</span>*<span class="hljs-number">24</span>)/<span class="hljs-number">3600</span>, costTime%<span class="hljs-number">3600</span>/<span class="hljs-number">60</span>, costTime%(<span class="hljs-number">60</span>)),<br>		<span class="hljs-string">&quot;goroute数量&quot;</span>: goNum,<br>		<span class="hljs-string">&quot;cpu核心数&quot;</span>:    cpuNum,<br>		<span class="hljs-string">&quot;当前内存使用量&quot;</span>:   MemorySize(<span class="hljs-type">int64</span>(mstat.Alloc)),<br>		<span class="hljs-string">&quot;所有被分配的内存&quot;</span>:  MemorySize(<span class="hljs-type">int64</span>(mstat.TotalAlloc)),<br>		<span class="hljs-string">&quot;内存占用量&quot;</span>:     MemorySize(<span class="hljs-type">int64</span>(mstat.Sys)),<br>		<span class="hljs-string">&quot;指针查找次数&quot;</span>:    mstat.Lookups,<br>		<span class="hljs-string">&quot;内存分配次数&quot;</span>:    mstat.Mallocs,<br>		<span class="hljs-string">&quot;内存释放次数&quot;</span>:    mstat.Frees,<br>		<span class="hljs-string">&quot;距离上次GC时间&quot;</span>:  afterLastGC,<br>		<span class="hljs-string">&quot;下次GC内存回收量&quot;</span>: fmt.Sprintf(<span class="hljs-string">&quot;%.3fMB&quot;</span>, <span class="hljs-type">float64</span>(mstat.NextGC)/<span class="hljs-type">float64</span>(mb)),<br>		<span class="hljs-string">&quot;GC暂停时间总量&quot;</span>:  fmt.Sprintf(<span class="hljs-string">&quot;%.3fs&quot;</span>, <span class="hljs-type">float64</span>(mstat.PauseTotalNs)/<span class="hljs-number">1000</span>/<span class="hljs-number">1000</span>/<span class="hljs-number">1000</span>),<br>	&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MemorySize</span><span class="hljs-params">(s <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	sizes := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;KB&quot;</span>, <span class="hljs-string">&quot;MB&quot;</span>, <span class="hljs-string">&quot;GB&quot;</span>, <span class="hljs-string">&quot;TB&quot;</span>, <span class="hljs-string">&quot;PB&quot;</span>, <span class="hljs-string">&quot;EB&quot;</span>&#125;<br>	mod := <span class="hljs-number">1024.0</span><br>	i := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">var</span> newnum <span class="hljs-type">float64</span> = <span class="hljs-type">float64</span>(s)<br>	<span class="hljs-keyword">for</span> newnum &gt;= mod &#123;<br>		newnum /= mod<br>		i++<br>	&#125;<br>	<span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%.0f&quot;</span>, math.Round(newnum)) + sizes[i]<br>&#125;<br><br></code></pre></td></tr></table></figure>
















                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Bingo/" class="category-chain-item">Bingo</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Bingo</div>
      <div>http://example.com/2024/01/26/Bingo/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年1月26日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/01/26/Mysql%E5%9F%BA%E7%A1%80%20/" title="Mysql">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Mysql</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/12/Go_Gin%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8%E5%88%B0%E7%8B%82%E6%9A%B4/" title="GO Gin框架入门">
                        <span class="hidden-mobile">GO Gin框架入门</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
